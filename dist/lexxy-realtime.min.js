import{createBinding as e,initLocalState as t,syncLexicalUpdateToYjs as s,syncYjsChangesToLexical as i}from"@lexical/yjs";import{Doc as r}from"yjs";import{Awareness as n}from"y-protocols/awareness";import{createConsumer as o}from"@anycable/web";import{WebsocketProvider as a}from"@y-rb/actioncable";import{$getNodeByKey as l,$getSelection as c,$isRangeSelection as h}from"lexical";const d=o({protocol:"actioncable-v1-ext-json"});var u=class{constructor(e,t,s){this.editor=e,this.provider=t,this.awareness=t.awareness,this.container=s,this.cursors=new Map,this.selections=new Map,this.localClientId=this.awareness.clientID,this.lastSeenTimestamps=new Map,this.updateQueue=new Set,this.rafId=null,this.resizeObserver=null,this.mutationObserver=null,this.lastUpdate=0,this.UPDATE_THROTTLE=16,this.INACTIVE_TIMEOUT=3e4,this.heartbeatInterval=null,this.overlayContainer=this.createOverlayContainer(),this.handleAwarenessUpdate=this.handleAwarenessUpdate.bind(this),this.handleEditorUpdate=this.handleEditorUpdate.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleResize=this.handleResize.bind(this),this.processUpdateQueue=this.processUpdateQueue.bind(this),this.checkInactiveUsers=this.checkInactiveUsers.bind(this),this.init()}init(){this.awareness.on("update",this.handleAwarenessUpdate),this.unsubscribeEditor=this.editor.registerUpdateListener(this.handleEditorUpdate),this.scrollableElement=this.findScrollableParent(this.container),this.scrollableElement.addEventListener("scroll",this.handleScroll,{passive:!0}),this.resizeObserver=new ResizeObserver(this.handleResize),this.resizeObserver.observe(this.container),this.mutationObserver=new MutationObserver(()=>{this.queueUpdate("mutation")}),this.mutationObserver.observe(this.container,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat(),this.checkInactiveUsers()},5e3),setTimeout(()=>{this.renderAllCursors()},100)}sendHeartbeat(){this.awareness.setLocalStateField("lastSeen",Date.now())}checkInactiveUsers(){const e=Date.now();this.awareness.getStates().forEach((t,s)=>{if(s===this.localClientId)return;const i=t?.lastSeen;if(i){const t=e-i;t>this.INACTIVE_TIMEOUT?(console.log(`Removing inactive user ${s} (last seen ${Math.round(t/1e3)}s ago)`),this.removeCursor(s),this.removeSelection(s),this.lastSeenTimestamps.delete(s)):this.lastSeenTimestamps.set(s,i)}})}createOverlayContainer(){const e=document.createElement("div");return e.className="lexxy-cursor-overlay",e.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 1000;\n    ",this.container.style.position="relative",this.container.appendChild(e),e}handleAwarenessUpdate({added:e,updated:t,removed:s}){try{s.forEach(e=>{this.removeCursor(e),this.removeSelection(e),this.lastSeenTimestamps.delete(e)}),[...e,...t].forEach(e=>{if(e!==this.localClientId)try{const t=this.awareness.getStates().get(e);t?(t.lastSeen&&this.lastSeenTimestamps.set(e,t.lastSeen),t.cursor?this.updateCursorFromState(e,t):(this.removeCursor(e),this.removeSelection(e))):(this.removeCursor(e),this.removeSelection(e))}catch(t){console.warn("Failed to update cursor for client",e,t),this.removeCursor(e),this.removeSelection(e)}}),this.queueUpdate("awareness")}catch(e){console.error("Error in handleAwarenessUpdate:",e)}}handleEditorUpdate({editorState:e}){e.read(()=>{this.queueUpdate("editor")})}handleScroll(){this.queueUpdate("scroll")}handleResize(){this.queueUpdate("resize")}queueUpdate(e){if(this.updateQueue.add(e),this.rafId)return;const t=Date.now()-this.lastUpdate;t<this.UPDATE_THROTTLE?setTimeout(()=>{this.rafId=requestAnimationFrame(this.processUpdateQueue)},this.UPDATE_THROTTLE-t):this.rafId=requestAnimationFrame(this.processUpdateQueue)}processUpdateQueue(){this.rafId=null,this.lastUpdate=Date.now(),this.updateQueue.clear(),this.editor.getEditorState().read(()=>{this.updateAllCursorPositions()})}updateCursorFromState(e,t){const s=t.cursor,i=t.user;if(!s)return this.removeCursor(e),void this.removeSelection(e);if(!s.anchorPos||!s.focusPos)return this.removeCursor(e),void this.removeSelection(e);console.log(`Updating cursor for client ${e}, user:`,i);const r={clientId:e,user:i||{name:`User ${e}`,color:this.getColorForClient(e)},anchor:s.anchorPos,focus:s.focusPos};this.cursors.set(e,r),this.isCollapsed(s.anchorPos,s.focusPos)?(this.removeSelection(e),this.selections.delete(e)):this.selections.set(e,r)}isCollapsed(e,t){return!e||!t||e.key===t.key&&e.offset===t.offset}updateAllCursorPositions(){this.cursors.forEach((e,t)=>{this.updateCursorPosition(t,e)}),this.selections.forEach((e,t)=>{this.updateSelectionPosition(t,e)})}updateCursorPosition(e,t){const{anchor:s,user:i}=t,r=this.getPositionFromPoint(s);if(!r)return void this.removeCursor(e);let n=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);n||(n=this.createCursorElement(e,i),this.overlayContainer.appendChild(n)),n.style.transform=`translate(${r.x}px, ${r.y}px)`,n.style.height=`${r.height}px`;const o=this.isPositionVisible(r);n.style.opacity=o?"1":"0.3"}updateSelectionPosition(e,t){const{anchor:s,focus:i,user:r}=t,n=this.getSelectionRects(s,i);if(!n||0===n.length)return void this.removeSelection(e);let o=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);o||(o=this.createSelectionContainer(e,r),this.overlayContainer.appendChild(o)),o.innerHTML="",n.forEach(e=>{const t=document.createElement("div");t.className="lexxy-selection-rect";var s,i;t.style.cssText=`\n        position: absolute;\n        background-color: ${s=r.color,i=.3,`rgba(${parseInt(s.slice(1,3),16)}, ${parseInt(s.slice(3,5),16)}, ${parseInt(s.slice(5,7),16)}, ${i})`};\n        left: ${e.x}px;\n        top: ${e.y}px;\n        width: ${e.width}px;\n        height: ${e.height}px;\n        pointer-events: none;\n        mix-blend-mode: multiply;\n      `,o.appendChild(t)})}getPositionFromPoint(e){if(!l(e.key))return null;const t=this.editor.getElementByKey(e.key);if(!t)return null;try{if(""===t.textContent||"\n"===t.textContent){const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}const s=this.createRangeFromPoint(t,e.offset);if(!s)return null;const i=s.getBoundingClientRect(),r=this.container.getBoundingClientRect();if(0===i.width&&0===i.height){const e=t.getBoundingClientRect();return{x:e.left-r.left,y:e.top-r.top,height:e.height||20}}return{x:i.left-r.left,y:i.top-r.top,height:i.height||20}}catch(e){console.warn("Failed to get position from point:",e);try{const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}catch(e){return null}}}createRangeFromPoint(e,t){const s=document.createRange();if(e.nodeType===Node.TEXT_NODE){const i=e.textContent.length,r=Math.min(t,i);s.setStart(e,r),s.setEnd(e,r)}else{const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let r=0,n=null,o=0;for(;i.nextNode();){const e=i.currentNode,s=e.textContent.length;if(r+s>=t){n=e,o=t-r;break}r+=s}if(n)s.setStart(n,o),s.setEnd(n,o);else try{s.selectNodeContents(e),s.collapse(0===t)}catch(t){s.setStartBefore(e),s.setEndBefore(e)}}return s}getSelectionRects(e,t){return this.editor.getEditorState().read(()=>{const s=l(e.key),i=l(t.key);if(!s||!i)return null;const r=this.editor.getElementByKey(e.key),n=this.editor.getElementByKey(t.key);if(!r||!n)return null;try{const s=document.createRange(),i=e.key===t.key?e.offset>t.offset:r.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_PRECEDING,o=i?t:e,a=i?e:t,l=i?n:r,c=i?r:n,h=this.createRangeFromPoint(l,o.offset);if(!h)return null;s.setStart(h.startContainer,h.startOffset);const d=this.createRangeFromPoint(c,a.offset);if(!d)return null;s.setEnd(d.endContainer,d.endOffset);const u=Array.from(s.getClientRects()),p=this.container.getBoundingClientRect();return console.log(`Selection rects for client: ${u.length} rects found`),u.map(e=>({x:e.left-p.left,y:e.top-p.top,width:e.width,height:e.height}))}catch(e){return console.warn("Failed to get selection rects:",e),null}})}createCursorElement(e,t){const s=document.createElement("div");s.className="lexxy-cursor",s.dataset.cursorId=e;const i=document.createElement("div");i.className="lexxy-cursor-caret",i.style.backgroundColor=t.color;const r=document.createElement("div");return r.className="lexxy-cursor-label",r.textContent=t.name,r.style.cssText=`\n      position: absolute;\n      bottom: 100%;\n      left: 0;\n      background-color: ${t.color};\n      color: white;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 11px;\n      font-family: system-ui, -apple-system, sans-serif;\n      white-space: nowrap;\n      margin-bottom: 2px;\n      pointer-events: none;\n      user-select: none;\n    `,s.appendChild(i),s.appendChild(r),s}createSelectionContainer(e,t){const s=document.createElement("div");return s.className="lexxy-selection",s.dataset.selectionId=e,s.style.cssText="position: absolute; pointer-events: none; z-index: 999;",s}removeCursor(e){const t=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);t&&t.remove(),this.cursors.delete(e)}removeSelection(e){const t=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);t&&t.remove(),this.selections.delete(e)}isPositionVisible(e){const t=this.scrollableElement.scrollTop,s=t+this.scrollableElement.clientHeight;return e.y>=t-50&&e.y<=s+50}findScrollableParent(e){let t=e.parentElement;for(;t;){const e=window.getComputedStyle(t).overflow;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return document.documentElement}renderAllCursors(){try{const e=this.awareness.getStates();console.log("All awareness states:",e),e.forEach((e,t)=>{if(t!==this.localClientId&&e?.cursor){console.log(`Rendering cursor for client ${t}, state:`,e);try{this.updateCursorFromState(t,e)}catch(e){console.warn("Failed to render cursor for client",t,e)}}}),this.queueUpdate("initial")}catch(e){console.error("Error in renderAllCursors:",e)}}getColorForClient(e){const t=["#FF6B6B","#FF006E","#C1121F","#FF4365","#E63946","#DC2F02","#D00000","#9D0208","#FF0A54","#FF5C8A","#F77F00","#FCBF49","#FFB700","#FFA400","#FF9500","#F4A261","#E76F51","#FF8C42","#FFD60A","#FFB627","#06FFA5","#00F5FF","#55A630","#2D6A4F","#52B788","#40916C","#1B5E20","#2E7D32","#43A047","#66BB6A","#4ECDC4","#96CEB4","#88D498","#36C9C6","#06FFB4","#0077B6","#0096C7","#00B4D8","#48CAE4","#90E0EF","#023E8A","#0466C8","#5390D9","#4361EE","#4895EF","#4CC9F0","#45B7D1","#2196F3","#1976D2","#0D47A1","#7209B7","#B5179E","#F72585","#7B2CBF","#6A4C93","#6C5CE7","#A8E6CF","#DDA0DD","#9C27B0","#8E24AA","#AB47BC","#CE93D8","#6A1B9A","#4A148C","#9D4EDD","#8D5524","#A0522D","#964B00","#6F4E37","#8B4513","#14213D","#006D77","#2C7DA0","#468FAF","#61A5C2","#007EA7","#003459","#00A8CC","#005F73","#0A9396","#540B0E","#702632","#A4133C","#800E13","#590D22","#370617","#6A040F","#9D0208","#D00000","#DC2F02"];let s=0;const i=String(e);for(let e=0;e<i.length;e++)s=(s<<5)-s+i.charCodeAt(e),s&=s;return t[Math.abs(s)%t.length]}destroy(){this.awareness.off("update",this.handleAwarenessUpdate),this.unsubscribeEditor&&this.unsubscribeEditor(),this.scrollableElement&&this.scrollableElement.removeEventListener("scroll",this.handleScroll),this.resizeObserver&&this.resizeObserver.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.rafId&&cancelAnimationFrame(this.rafId),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.overlayContainer&&this.overlayContainer.remove(),this.cursors.clear(),this.selections.clear(),this.lastSeenTimestamps.clear(),this.updateQueue.clear()}};var p=class extends HTMLElement{connectedCallback(){this.editorElement=this.closest("lexxy-editor"),this.editor=this.editorElement.editor,this.editor&&this.editor.isReady&&this.editor.isReady()?(console.log("Editor already initialized, starting collaboration"),this.#e()):this.editor?(console.log("Editor exists, starting collaboration"),this.#e()):this.editorElement.addEventListener("lexxy:initialize",(...e)=>{console.log("Editor initialized event, starting collaboration",e),this.editor=this.editorElement.editor,this.#e()},{once:!0})}disconnectedCallback(){this.cursorManager&&this.cursorManager.destroy(),this.unsubscribeCursorSync&&this.unsubscribeCursorSync(),this.unsubscribeListeners&&this.unsubscribeListeners(),this.provider&&this.provider.disconnect()}async#e(){const o=this.getAttribute("id")||"main",l=this.getAttribute("name")||"Example User",p=this.getAttribute("color")||"#958DF1",m=this.getAttribute("channel-name")||"SyncChannel",f=this.getAttribute("channel-params")||"{}",C="string"==typeof f?JSON.parse(f):f,g=!this.hasAttribute("disable-bc")||"false"!==this.getAttribute("disable-bc"),y=this.consumer||d,E=this.doc||new r,b=this.awareness||new n(E),v=new Map;v.set(o,E);const F=new a(E,y,m,C,{awareness:b,disableBc:g}),S=e(this.editor,F,o,E,v),A=function(e,t,r){let n=!1;const o=e.registerUpdateListener(({dirtyElements:i,dirtyLeaves:o,editorState:a,normalizedNodes:l,prevEditorState:c,tags:h})=>{n?n=!1:e.getEditorState().read(()=>{!1===h.has("skip-collab")&&s(r,t,c,a,i,o,l,h)})}),a=(e,s)=>{s.origin!==r&&i(r,t,e,!1)};return r.root.getSharedType().observeDeep(a),()=>{o(),r.root.getSharedType().unobserveDeep(a)}}(this.editor,F,S);b.setLocalStateField("user",{name:l,color:p}),b.setLocalStateField("lastSeen",Date.now()),t(F,l,p,!0,{name:l,color:p}),b.setLocalStateField("user",{name:l,color:p}),b.setLocalStateField("lastSeen",Date.now());const x=this.editorElement.querySelector(".lexxy-editor-container")||this.editorElement;this.cursorManager=new u(this.editor,F,x),this.unsubscribeCursorSync=function(e,t){const s=t.awareness;return e.registerUpdateListener(()=>{e.getEditorState().read(()=>{const e=c();if(!e||!h(e))return void s.setLocalStateField("cursor",null);const t=e.anchor,i=e.focus,r={anchorPos:{key:t.key,offset:t.offset,type:t.type},focusPos:{key:i.key,offset:i.offset,type:i.type}};s.setLocalStateField("cursor",r)})})}(this.editor,F),this.provider=F,this.binding=S,this.unsubscribeListeners=A}};customElements.define("lexxy-collaboration",p);