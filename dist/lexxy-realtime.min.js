import{createBinding as e,initLocalState as t,syncLexicalUpdateToYjs as s,syncYjsChangesToLexical as n}from"@lexical/yjs";import*as r from"yjs";import{Doc as i}from"yjs";import{$getNodeByKey as o,$getSelection as a,$isRangeSelection as l}from"lexical";const c=Math.floor,h=(Number.isNaN,127),d=Number.MAX_SAFE_INTEGER,u=(Number.MIN_SAFE_INTEGER,Number.isInteger,Number.isNaN,Number.parseInt,()=>new Set),p=Array.from,f=(Array.isArray,String.fromCharCode),m=(String.fromCodePoint,f(65535),"undefined"!=typeof TextEncoder?new TextEncoder:null),g=m?e=>m.encode(e):e=>{const t=unescape(encodeURIComponent(e)),s=t.length,n=new Uint8Array(s);for(let e=0;e<s;e++)n[e]=t.codePointAt(e);return n};let y="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});y&&1===y.decode(new Uint8Array).length&&(y=null);var b=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}};const v=(e,t)=>{const s=e.cbuf.length;e.cpos===s&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*s),e.cpos=0),e.cbuf[e.cpos++]=t},C=(e,t)=>{for(;t>h;)v(e,128|h&t),t=c(t/128);v(e,h&t)},E=new Uint8Array(3e4),S=E.length/3,w=m&&m.encodeInto?(e,t)=>{if(t.length<S){const s=m.encodeInto(t,E).written||0;C(e,s);for(let t=0;t<s;t++)v(e,E[t])}else A(e,g(t))}:(e,t)=>{const s=unescape(encodeURIComponent(t)),n=s.length;C(e,n);for(let t=0;t<n;t++)v(e,s.codePointAt(t))},A=(e,t)=>{C(e,t.byteLength),((e,t)=>{const s=e.cbuf.length,n=e.cpos,r=(i=s-n,o=t.length,i<o?i:o);var i,o;const a=t.length-r;e.cbuf.set(t.subarray(0,r),n),e.cpos+=r,a>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(((e,t)=>e>t?e:t)(2*s,a)),e.cbuf.set(t.subarray(r)),e.cpos=a)})(e,t)},F=e=>new Error(e),U=F("Unexpected end of array"),x=F("Integer out of Range");var I=class{constructor(e){this.arr=e,this.pos=0}};const D=e=>((e,t)=>{const s=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,s})(e,k(e)),T=e=>e.arr[e.pos++],k=e=>{let t=0,s=1;const n=e.arr.length;for(;e.pos<n;){const n=e.arr[e.pos++];if(t+=(n&h)*s,s*=128,n<128)return t;if(t>d)throw x}throw U},P=y?e=>y.decode(D(e)):e=>{let t=k(e);if(0===t)return"";{let s=String.fromCodePoint(T(e));if(--t<100)for(;t--;)s+=String.fromCodePoint(T(e));else for(;t>0;){const n=t<1e4?t:1e4,r=e.arr.subarray(e.pos,e.pos+n);e.pos+=n,s+=String.fromCodePoint.apply(null,r),t-=n}return decodeURIComponent(escape(s))}},B=Date.now,L=()=>new Map;var N=class{constructor(){this._observers=L()}on(e,t){((e,t,s)=>{let n=e.get(t);return void 0===n&&e.set(t,n=s()),n})(this._observers,e,u).add(t)}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return p((this._observers.get(e)||L()).values()).forEach(e=>e(...t))}destroy(){this._observers=L()}};const R=Object.keys,O=e=>R(e).length,M=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),z=Symbol("Equality"),$=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[z])return e[z](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;break;case Set:if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;break;case Map:if(e.size!==t.size)return!1;for(const s of e.keys())if(!t.has(s)||!$(e.get(s),t.get(s)))return!1;break;case Object:if(O(e)!==O(t))return!1;for(const s in e)if(!M(e,s)||!$(e[s],t[s]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!$(e[s],t[s]))return!1;break;default:return!1}return!0},_=3e4;var H=class extends N{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=B();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((s,n)=>{n!==this.clientID&&_<=e-s.lastUpdated&&this.states.has(n)&&t.push(n)}),t.length>0&&q(this,t,"timeout")},c(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,s=this.meta.get(t),n=void 0===s?0:s.clock+1,r=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:n,lastUpdated:B()});const i=[],o=[],a=[],l=[];null===e?l.push(t):null==r?null!=e&&i.push(t):(o.push(t),$(r,e)||a.push(t)),(i.length>0||a.length>0||l.length>0)&&this.emit("change",[{added:i,updated:a,removed:l},"local"]),this.emit("update",[{added:i,updated:o,removed:l},"local"])}setLocalStateField(e,t){const s=this.getLocalState();null!==s&&this.setLocalState({...s,[e]:t})}getStates(){return this.states}};const q=(e,t,s)=>{const n=[];for(let s=0;s<t.length;s++){const r=t[s];if(e.states.has(r)){if(e.states.delete(r),r===e.clientID){const t=e.meta.get(r);e.meta.set(r,{clock:t.clock+1,lastUpdated:B()})}n.push(r)}}n.length>0&&(e.emit("change",[{added:[],updated:[],removed:n},s]),e.emit("update",[{added:[],updated:[],removed:n},s]))},Q=(e,t,s=e.states)=>{const n=t.length,r=new b;C(r,n);for(let i=0;i<n;i++){const n=t[i],o=s.get(n)||null,a=e.meta.get(n).clock;C(r,n),C(r,a),w(r,JSON.stringify(o))}return(e=>{const t=new Uint8Array((e=>{let t=e.cpos;for(let s=0;s<e.bufs.length;s++)t+=e.bufs[s].length;return t})(e));let s=0;for(let n=0;n<e.bufs.length;n++){const r=e.bufs[n];t.set(r,s),s+=r.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),s),t})(r)},j=(e,t,s)=>{const n=new I(t);const r=B(),i=[],o=[],a=[],l=[],c=k(n);for(let t=0;t<c;t++){const t=k(n);let s=k(n);const c=JSON.parse(P(n)),h=e.meta.get(t),d=e.states.get(t),u=void 0===h?0:h.clock;(u<s||u===s&&null===c&&e.states.has(t))&&(null===c?t===e.clientID&&null!=e.getLocalState()?s++:e.states.delete(t):e.states.set(t,c),e.meta.set(t,{clock:s,lastUpdated:r}),void 0===h&&null!==c?i.push(t):void 0!==h&&null===c?l.push(t):null!==c&&($(c,d)||a.push(t),o.push(t)))}(i.length>0||a.length>0||l.length>0)&&e.emit("change",[{added:i,updated:a,removed:l},s]),(i.length>0||o.length>0||l.length>0)&&e.emit("update",[{added:i,updated:o,removed:l},s])};function V(e){const t=Array.from(e).map(e=>String.fromCharCode(e)).join("");return btoa(t)}function G(e){const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s}var J=class{#e;#t;#s;constructor(e,t,s,n={},r={}){this.doc=e,this.consumer=t,this.channelName=s,this.channelParams=n,this.awareness=r.awareness||null,this.subscription=null,this.connected=!1,this.#s=!1,this.#e=(e,t)=>{if(t!==this&&this.subscription){const t=V(e);this.subscription.send({type:"update",update:t,client_id:this.doc.clientID})}},this.#t=(e,t)=>{if(t===this)return;const s=e.added||[],n=e.updated||[],r=e.removed||[],i=s.concat(n).concat(r);if(!this.awareness)return;const o=Q(this.awareness,i);if(this.subscription&&this.connected){const e={type:"awareness",update:V(o)};this.subscription.whisper?this.subscription.whisper(e):this.subscription.send(e)}}}connect(){this.subscription||(this.subscription=this.consumer.subscriptions.create({channel:this.channelName,...this.channelParams},{connected:()=>{this.connected=!0},disconnected:()=>{this.connected=!1,this.#s=!1},received:e=>{this.#n(e)}}),this.doc.on("update",this.#e),this.awareness&&this.awareness.on("update",this.#t))}disconnect(){this.subscription&&(this.doc.off("update",this.#e),this.awareness&&this.awareness.off("update",this.#t),this.consumer.subscriptions.remove(this.subscription),this.subscription=null,this.connected=!1,this.#s=!1)}destroy(){this.disconnect()}get synced(){return this.#s}#n(e){switch(e.type){case"sync":this.#r(e.updates);break;case"update":this.#i(e.update);break;case"awareness":this.#o(e.update);break;default:console.warn("CustomYjsProvider: Unknown message type",e.type)}}#r(e){e.forEach((e,t)=>{const s=G(e);r.applyUpdate(this.doc,s,this)}),this.#s=!0}#i(e){const t=G(e);r.applyUpdate(this.doc,t,this)}#o(e){if(!this.awareness)return;const t=G(e);j(this.awareness,t,this)}},K=class{constructor(e,t,s){this.editor=e,this.provider=t,this.awareness=t.awareness,this.container=s,this.cursors=new Map,this.selections=new Map,this.localClientId=this.awareness.clientID,this.lastSeenTimestamps=new Map,this.updateQueue=new Set,this.rafId=null,this.resizeObserver=null,this.mutationObserver=null,this.lastUpdate=0,this.UPDATE_THROTTLE=16,this.INACTIVE_TIMEOUT=3e4,this.heartbeatInterval=null,this.overlayContainer=this.createOverlayContainer(),this.handleAwarenessUpdate=this.handleAwarenessUpdate.bind(this),this.handleEditorUpdate=this.handleEditorUpdate.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleResize=this.handleResize.bind(this),this.processUpdateQueue=this.processUpdateQueue.bind(this),this.checkInactiveUsers=this.checkInactiveUsers.bind(this),this.init()}init(){this.awareness.on("update",this.handleAwarenessUpdate),this.unsubscribeEditor=this.editor.registerUpdateListener(this.handleEditorUpdate),this.scrollableElement=this.findScrollableParent(this.container),this.scrollableElement.addEventListener("scroll",this.handleScroll,{passive:!0}),this.resizeObserver=new ResizeObserver(this.handleResize),this.resizeObserver.observe(this.container),this.mutationObserver=new MutationObserver(()=>{this.queueUpdate("mutation")}),this.mutationObserver.observe(this.container,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat(),this.checkInactiveUsers()},5e3),setTimeout(()=>{this.renderAllCursors()},100)}sendHeartbeat(){this.awareness.setLocalStateField("lastSeen",Date.now())}checkInactiveUsers(){const e=Date.now();this.awareness.getStates().forEach((t,s)=>{if(s===this.localClientId)return;const n=t?.lastSeen;if(n){const t=e-n;t>this.INACTIVE_TIMEOUT?(console.log(`Removing inactive user ${s} (last seen ${Math.round(t/1e3)}s ago)`),this.removeCursor(s),this.removeSelection(s),this.lastSeenTimestamps.delete(s)):this.lastSeenTimestamps.set(s,n)}})}createOverlayContainer(){const e=document.createElement("div");return e.className="lexxy-cursor-overlay",e.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 1000;\n    ",this.container.style.position="relative",this.container.appendChild(e),e}handleAwarenessUpdate({added:e,updated:t,removed:s}){try{s.forEach(e=>{this.removeCursor(e),this.removeSelection(e),this.lastSeenTimestamps.delete(e)}),[...e,...t].forEach(e=>{if(e!==this.localClientId)try{const t=this.awareness.getStates().get(e);t?(t.lastSeen&&this.lastSeenTimestamps.set(e,t.lastSeen),t.cursor?this.updateCursorFromState(e,t):(this.removeCursor(e),this.removeSelection(e))):(this.removeCursor(e),this.removeSelection(e))}catch(t){console.warn("Failed to update cursor for client",e,t),this.removeCursor(e),this.removeSelection(e)}}),this.queueUpdate("awareness")}catch(e){console.error("Error in handleAwarenessUpdate:",e)}}handleEditorUpdate({editorState:e}){e.read(()=>{this.queueUpdate("editor")})}handleScroll(){this.queueUpdate("scroll")}handleResize(){this.queueUpdate("resize")}queueUpdate(e){if(this.updateQueue.add(e),this.rafId)return;const t=Date.now()-this.lastUpdate;t<this.UPDATE_THROTTLE?setTimeout(()=>{this.rafId=requestAnimationFrame(this.processUpdateQueue)},this.UPDATE_THROTTLE-t):this.rafId=requestAnimationFrame(this.processUpdateQueue)}processUpdateQueue(){this.rafId=null,this.lastUpdate=Date.now(),this.updateQueue.clear(),this.editor.getEditorState().read(()=>{this.updateAllCursorPositions()})}updateCursorFromState(e,t){const s=t.cursor,n=t.user;if(!s)return this.removeCursor(e),void this.removeSelection(e);if(!s.anchorPos||!s.focusPos)return this.removeCursor(e),void this.removeSelection(e);console.log(`Updating cursor for client ${e}, user:`,n);const r={clientId:e,user:n||{name:`User ${e}`,color:this.getColorForClient(e)},anchor:s.anchorPos,focus:s.focusPos};this.cursors.set(e,r),this.isCollapsed(s.anchorPos,s.focusPos)?(this.removeSelection(e),this.selections.delete(e)):this.selections.set(e,r)}isCollapsed(e,t){return!e||!t||e.key===t.key&&e.offset===t.offset}updateAllCursorPositions(){this.cursors.forEach((e,t)=>{this.updateCursorPosition(t,e)}),this.selections.forEach((e,t)=>{this.updateSelectionPosition(t,e)})}updateCursorPosition(e,t){const{anchor:s,user:n}=t,r=this.getPositionFromPoint(s);if(!r)return void this.removeCursor(e);let i=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);i||(i=this.createCursorElement(e,n),this.overlayContainer.appendChild(i)),i.style.transform=`translate(${r.x}px, ${r.y}px)`,i.style.height=`${r.height}px`;const o=this.isPositionVisible(r);i.style.opacity=o?"1":"0.3"}updateSelectionPosition(e,t){const{anchor:s,focus:n,user:r}=t,i=this.getSelectionRects(s,n);if(!i||0===i.length)return void this.removeSelection(e);let o=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);o||(o=this.createSelectionContainer(e,r),this.overlayContainer.appendChild(o)),o.innerHTML="",i.forEach(e=>{const t=document.createElement("div");t.className="lexxy-selection-rect";var s,n;t.style.cssText=`\n        position: absolute;\n        background-color: ${s=r.color,n=.3,`rgba(${parseInt(s.slice(1,3),16)}, ${parseInt(s.slice(3,5),16)}, ${parseInt(s.slice(5,7),16)}, ${n})`};\n        left: ${e.x}px;\n        top: ${e.y}px;\n        width: ${e.width}px;\n        height: ${e.height}px;\n        pointer-events: none;\n        mix-blend-mode: multiply;\n      `,o.appendChild(t)})}getPositionFromPoint(e){if(!o(e.key))return null;const t=this.editor.getElementByKey(e.key);if(!t)return null;try{if(""===t.textContent||"\n"===t.textContent){const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}const s=this.createRangeFromPoint(t,e.offset);if(!s)return null;const n=s.getBoundingClientRect(),r=this.container.getBoundingClientRect();if(0===n.width&&0===n.height){const e=t.getBoundingClientRect();return{x:e.left-r.left,y:e.top-r.top,height:e.height||20}}return{x:n.left-r.left,y:n.top-r.top,height:n.height||20}}catch(e){console.warn("Failed to get position from point:",e);try{const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}catch(e){return null}}}createRangeFromPoint(e,t){const s=document.createRange();if(e.nodeType===Node.TEXT_NODE){const n=e.textContent.length,r=Math.min(t,n);s.setStart(e,r),s.setEnd(e,r)}else{const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let r=0,i=null,o=0;for(;n.nextNode();){const e=n.currentNode,s=e.textContent.length;if(r+s>=t){i=e,o=t-r;break}r+=s}if(i)s.setStart(i,o),s.setEnd(i,o);else try{s.selectNodeContents(e),s.collapse(0===t)}catch(t){s.setStartBefore(e),s.setEndBefore(e)}}return s}getSelectionRects(e,t){return this.editor.getEditorState().read(()=>{const s=o(e.key),n=o(t.key);if(!s||!n)return null;const r=this.editor.getElementByKey(e.key),i=this.editor.getElementByKey(t.key);if(!r||!i)return null;try{const s=document.createRange(),n=e.key===t.key?e.offset>t.offset:r.compareDocumentPosition(i)&Node.DOCUMENT_POSITION_PRECEDING,o=n?t:e,a=n?e:t,l=n?i:r,c=n?r:i,h=this.createRangeFromPoint(l,o.offset);if(!h)return null;s.setStart(h.startContainer,h.startOffset);const d=this.createRangeFromPoint(c,a.offset);if(!d)return null;s.setEnd(d.endContainer,d.endOffset);const u=Array.from(s.getClientRects()),p=this.container.getBoundingClientRect();return console.log(`Selection rects for client: ${u.length} rects found`),u.map(e=>({x:e.left-p.left,y:e.top-p.top,width:e.width,height:e.height}))}catch(e){return console.warn("Failed to get selection rects:",e),null}})}createCursorElement(e,t){const s=document.createElement("div");s.className="lexxy-cursor",s.dataset.cursorId=e;const n=document.createElement("div");n.className="lexxy-cursor-caret",n.style.backgroundColor=t.color;const r=document.createElement("div");return r.className="lexxy-cursor-label",r.textContent=t.name,r.style.cssText=`\n      position: absolute;\n      bottom: 100%;\n      left: 0;\n      background-color: ${t.color};\n      color: white;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 11px;\n      font-family: system-ui, -apple-system, sans-serif;\n      white-space: nowrap;\n      margin-bottom: 2px;\n      pointer-events: none;\n      user-select: none;\n    `,s.appendChild(n),s.appendChild(r),s}createSelectionContainer(e,t){const s=document.createElement("div");return s.className="lexxy-selection",s.dataset.selectionId=e,s.style.cssText="position: absolute; pointer-events: none; z-index: 999;",s}removeCursor(e){const t=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);t&&t.remove(),this.cursors.delete(e)}removeSelection(e){const t=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);t&&t.remove(),this.selections.delete(e)}isPositionVisible(e){const t=this.scrollableElement.scrollTop,s=t+this.scrollableElement.clientHeight;return e.y>=t-50&&e.y<=s+50}findScrollableParent(e){let t=e.parentElement;for(;t;){const e=window.getComputedStyle(t).overflow;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return document.documentElement}renderAllCursors(){try{const e=this.awareness.getStates();console.log("All awareness states:",e),e.forEach((e,t)=>{if(t!==this.localClientId&&e?.cursor){console.log(`Rendering cursor for client ${t}, state:`,e);try{this.updateCursorFromState(t,e)}catch(e){console.warn("Failed to render cursor for client",t,e)}}}),this.queueUpdate("initial")}catch(e){console.error("Error in renderAllCursors:",e)}}getColorForClient(e){const t=["#FF6B6B","#FF006E","#C1121F","#FF4365","#E63946","#DC2F02","#D00000","#9D0208","#FF0A54","#FF5C8A","#F77F00","#FCBF49","#FFB700","#FFA400","#FF9500","#F4A261","#E76F51","#FF8C42","#FFD60A","#FFB627","#06FFA5","#00F5FF","#55A630","#2D6A4F","#52B788","#40916C","#1B5E20","#2E7D32","#43A047","#66BB6A","#4ECDC4","#96CEB4","#88D498","#36C9C6","#06FFB4","#0077B6","#0096C7","#00B4D8","#48CAE4","#90E0EF","#023E8A","#0466C8","#5390D9","#4361EE","#4895EF","#4CC9F0","#45B7D1","#2196F3","#1976D2","#0D47A1","#7209B7","#B5179E","#F72585","#7B2CBF","#6A4C93","#6C5CE7","#A8E6CF","#DDA0DD","#9C27B0","#8E24AA","#AB47BC","#CE93D8","#6A1B9A","#4A148C","#9D4EDD","#8D5524","#A0522D","#964B00","#6F4E37","#8B4513","#14213D","#006D77","#2C7DA0","#468FAF","#61A5C2","#007EA7","#003459","#00A8CC","#005F73","#0A9396","#540B0E","#702632","#A4133C","#800E13","#590D22","#370617","#6A040F","#9D0208","#D00000","#DC2F02"];let s=0;const n=String(e);for(let e=0;e<n.length;e++)s=(s<<5)-s+n.charCodeAt(e),s&=s;return t[Math.abs(s)%t.length]}destroy(){this.awareness.off("update",this.handleAwarenessUpdate),this.unsubscribeEditor&&this.unsubscribeEditor(),this.scrollableElement&&this.scrollableElement.removeEventListener("scroll",this.handleScroll),this.resizeObserver&&this.resizeObserver.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.rafId&&cancelAnimationFrame(this.rafId),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.overlayContainer&&this.overlayContainer.remove(),this.cursors.clear(),this.selections.clear(),this.lastSeenTimestamps.clear(),this.updateQueue.clear()}};var X=class extends HTMLElement{connectedCallback(){this.editorElement=this.closest("lexxy-editor"),this.editor=this.editorElement.editor,this.editor&&this.editor.isReady&&this.editor.isReady()?(console.log("Editor already initialized, starting collaboration"),this.#a()):this.editor?(console.log("Editor exists, starting collaboration"),this.#a()):this.editorElement.addEventListener("lexxy:initialize",(...e)=>{console.log("Editor initialized event, starting collaboration",e),this.editor=this.editorElement.editor,this.#a()},{once:!0})}disconnectedCallback(){this.cursorManager&&this.cursorManager.destroy(),this.unsubscribeCursorSync&&this.unsubscribeCursorSync(),this.unsubscribeListeners&&this.unsubscribeListeners(),this.provider&&this.provider.disconnect()}async#a(){const r=this.getAttribute("id")||"main",o=this.getAttribute("name")||"Example User",c=this.getAttribute("color")||"#958DF1",h=this.getAttribute("channel-name")||"SyncChannel",d=this.getAttribute("channel-params")||"{}",u="string"==typeof d?JSON.parse(d):d;this.hasAttribute("disable-bc")&&this.getAttribute("disable-bc");const p=this.doc||new i,f=this.awareness||new H(p),m=this.provider||new J(p,this.consumer,h,u,{awareness:f}),g=new Map;g.set(r,p);const y=e(this.editor,m,r,p,g),b=function(e,t,r){let i=!1;const o=e.registerUpdateListener(({dirtyElements:n,dirtyLeaves:o,editorState:a,normalizedNodes:l,prevEditorState:c,tags:h})=>{i?i=!1:e.getEditorState().read(()=>{!1===h.has("skip-collab")&&s(r,t,c,a,n,o,l,h)})}),a=(e,s)=>{s.origin!==r&&n(r,t,e,!1)};return r.root.getSharedType().observeDeep(a),()=>{o(),r.root.getSharedType().unobserveDeep(a)}}(this.editor,m,y);f.setLocalStateField("user",{name:o,color:c}),f.setLocalStateField("lastSeen",Date.now()),t(m,o,c,!0,{name:o,color:c}),f.setLocalStateField("user",{name:o,color:c}),f.setLocalStateField("lastSeen",Date.now());const v=this.editorElement.querySelector(".lexxy-editor-container")||this.editorElement;this.cursorManager=new K(this.editor,m,v),this.unsubscribeCursorSync=function(e,t){const s=t.awareness;return e.registerUpdateListener(()=>{e.getEditorState().read(()=>{const e=a();if(!e||!l(e))return void s.setLocalStateField("cursor",null);const t=e.anchor,n=e.focus,r={anchorPos:{key:t.key,offset:t.offset,type:t.type},focusPos:{key:n.key,offset:n.offset,type:n.type}};s.setLocalStateField("cursor",r)})})}(this.editor,m),this.provider=m,this.binding=y,this.unsubscribeListeners=b}};customElements.define("lexxy-collaboration",X);