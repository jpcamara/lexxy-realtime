import{createBinding as e,initLocalState as t,syncLexicalUpdateToYjs as s,syncYjsChangesToLexical as r}from"@lexical/yjs";import{Doc as i}from"yjs";import{createConsumer as n}from"@anycable/web";import{WebsocketProvider as o}from"@y-rb/actioncable";import{$getNodeByKey as a,$getSelection as l,$isRangeSelection as c}from"lexical";const h=Math.floor,d=(Number.isNaN,()=>new Set),u=Array.from,p=(Array.isArray,Date.now),m=()=>new Map;var f=class{constructor(){this._observers=m()}on(e,t){((e,t,s)=>{let r=e.get(t);return void 0===r&&e.set(t,r=s()),r})(this._observers,e,d).add(t)}once(e,t){const s=(...r)=>{this.off(e,s),t(...r)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return u((this._observers.get(e)||m()).values()).forEach(e=>e(...t))}destroy(){this._observers=m()}};const g=Object.keys,y=e=>g(e).length,b=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),v=Symbol("Equality"),C=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[v])return e[v](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;break;case Set:if(e.size!==t.size)return!1;for(const s of e)if(!t.has(s))return!1;break;case Map:if(e.size!==t.size)return!1;for(const s of e.keys())if(!t.has(s)||!C(e.get(s),t.get(s)))return!1;break;case Object:if(y(e)!==y(t))return!1;for(const s in e)if(!b(e,s)||!C(e[s],t[s]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!C(e[s],t[s]))return!1;break;default:return!1}return!0},E=3e4;var S=class extends f{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=p();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((s,r)=>{r!==this.clientID&&E<=e-s.lastUpdated&&this.states.has(r)&&t.push(r)}),t.length>0&&F(this,t,"timeout")},h(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,s=this.meta.get(t),r=void 0===s?0:s.clock+1,i=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:r,lastUpdated:p()});const n=[],o=[],a=[],l=[];null===e?l.push(t):null==i?null!=e&&n.push(t):(o.push(t),C(i,e)||a.push(t)),(n.length>0||a.length>0||l.length>0)&&this.emit("change",[{added:n,updated:a,removed:l},"local"]),this.emit("update",[{added:n,updated:o,removed:l},"local"])}setLocalStateField(e,t){const s=this.getLocalState();null!==s&&this.setLocalState({...s,[e]:t})}getStates(){return this.states}};const F=(e,t,s)=>{const r=[];for(let s=0;s<t.length;s++){const i=t[s];if(e.states.has(i)){if(e.states.delete(i),i===e.clientID){const t=e.meta.get(i);e.meta.set(i,{clock:t.clock+1,lastUpdated:p()})}r.push(i)}}r.length>0&&(e.emit("change",[{added:[],updated:[],removed:r},s]),e.emit("update",[{added:[],updated:[],removed:r},s]))},A=n({protocol:"actioncable-v1-ext-json"});var w=class{constructor(e,t,s){this.editor=e,this.provider=t,this.awareness=t.awareness,this.container=s,this.cursors=new Map,this.selections=new Map,this.localClientId=this.awareness.clientID,this.lastSeenTimestamps=new Map,this.updateQueue=new Set,this.rafId=null,this.resizeObserver=null,this.mutationObserver=null,this.lastUpdate=0,this.UPDATE_THROTTLE=16,this.INACTIVE_TIMEOUT=3e4,this.heartbeatInterval=null,this.overlayContainer=this.createOverlayContainer(),this.handleAwarenessUpdate=this.handleAwarenessUpdate.bind(this),this.handleEditorUpdate=this.handleEditorUpdate.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleResize=this.handleResize.bind(this),this.processUpdateQueue=this.processUpdateQueue.bind(this),this.checkInactiveUsers=this.checkInactiveUsers.bind(this),this.init()}init(){this.awareness.on("update",this.handleAwarenessUpdate),this.unsubscribeEditor=this.editor.registerUpdateListener(this.handleEditorUpdate),this.scrollableElement=this.findScrollableParent(this.container),this.scrollableElement.addEventListener("scroll",this.handleScroll,{passive:!0}),this.resizeObserver=new ResizeObserver(this.handleResize),this.resizeObserver.observe(this.container),this.mutationObserver=new MutationObserver(()=>{this.queueUpdate("mutation")}),this.mutationObserver.observe(this.container,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat(),this.checkInactiveUsers()},5e3),setTimeout(()=>{this.renderAllCursors()},100)}sendHeartbeat(){this.awareness.setLocalStateField("lastSeen",Date.now())}checkInactiveUsers(){const e=Date.now();this.awareness.getStates().forEach((t,s)=>{if(s===this.localClientId)return;const r=t?.lastSeen;if(r){const t=e-r;t>this.INACTIVE_TIMEOUT?(console.log(`Removing inactive user ${s} (last seen ${Math.round(t/1e3)}s ago)`),this.removeCursor(s),this.removeSelection(s),this.lastSeenTimestamps.delete(s)):this.lastSeenTimestamps.set(s,r)}})}createOverlayContainer(){const e=document.createElement("div");return e.className="lexxy-cursor-overlay",e.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 1000;\n    ",this.container.style.position="relative",this.container.appendChild(e),e}handleAwarenessUpdate({added:e,updated:t,removed:s}){try{s.forEach(e=>{this.removeCursor(e),this.removeSelection(e),this.lastSeenTimestamps.delete(e)}),[...e,...t].forEach(e=>{if(e!==this.localClientId)try{const t=this.awareness.getStates().get(e);t?(t.lastSeen&&this.lastSeenTimestamps.set(e,t.lastSeen),t.cursor?this.updateCursorFromState(e,t):(this.removeCursor(e),this.removeSelection(e))):(this.removeCursor(e),this.removeSelection(e))}catch(t){console.warn("Failed to update cursor for client",e,t),this.removeCursor(e),this.removeSelection(e)}}),this.queueUpdate("awareness")}catch(e){console.error("Error in handleAwarenessUpdate:",e)}}handleEditorUpdate({editorState:e}){e.read(()=>{this.queueUpdate("editor")})}handleScroll(){this.queueUpdate("scroll")}handleResize(){this.queueUpdate("resize")}queueUpdate(e){if(this.updateQueue.add(e),this.rafId)return;const t=Date.now()-this.lastUpdate;t<this.UPDATE_THROTTLE?setTimeout(()=>{this.rafId=requestAnimationFrame(this.processUpdateQueue)},this.UPDATE_THROTTLE-t):this.rafId=requestAnimationFrame(this.processUpdateQueue)}processUpdateQueue(){this.rafId=null,this.lastUpdate=Date.now(),this.updateQueue.clear(),this.editor.getEditorState().read(()=>{this.updateAllCursorPositions()})}updateCursorFromState(e,t){const s=t.cursor,r=t.user;if(!s)return this.removeCursor(e),void this.removeSelection(e);if(!s.anchorPos||!s.focusPos)return this.removeCursor(e),void this.removeSelection(e);console.log(`Updating cursor for client ${e}, user:`,r);const i={clientId:e,user:r||{name:`User ${e}`,color:this.getColorForClient(e)},anchor:s.anchorPos,focus:s.focusPos};this.cursors.set(e,i),this.isCollapsed(s.anchorPos,s.focusPos)?(this.removeSelection(e),this.selections.delete(e)):this.selections.set(e,i)}isCollapsed(e,t){return!e||!t||e.key===t.key&&e.offset===t.offset}updateAllCursorPositions(){this.cursors.forEach((e,t)=>{this.updateCursorPosition(t,e)}),this.selections.forEach((e,t)=>{this.updateSelectionPosition(t,e)})}updateCursorPosition(e,t){const{anchor:s,user:r}=t,i=this.getPositionFromPoint(s);if(!i)return void this.removeCursor(e);let n=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);n||(n=this.createCursorElement(e,r),this.overlayContainer.appendChild(n)),n.style.transform=`translate(${i.x}px, ${i.y}px)`,n.style.height=`${i.height}px`;const o=this.isPositionVisible(i);n.style.opacity=o?"1":"0.3"}updateSelectionPosition(e,t){const{anchor:s,focus:r,user:i}=t,n=this.getSelectionRects(s,r);if(!n||0===n.length)return void this.removeSelection(e);let o=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);o||(o=this.createSelectionContainer(e,i),this.overlayContainer.appendChild(o)),o.innerHTML="",n.forEach(e=>{const t=document.createElement("div");t.className="lexxy-selection-rect";var s,r;t.style.cssText=`\n        position: absolute;\n        background-color: ${s=i.color,r=.3,`rgba(${parseInt(s.slice(1,3),16)}, ${parseInt(s.slice(3,5),16)}, ${parseInt(s.slice(5,7),16)}, ${r})`};\n        left: ${e.x}px;\n        top: ${e.y}px;\n        width: ${e.width}px;\n        height: ${e.height}px;\n        pointer-events: none;\n        mix-blend-mode: multiply;\n      `,o.appendChild(t)})}getPositionFromPoint(e){if(!a(e.key))return null;const t=this.editor.getElementByKey(e.key);if(!t)return null;try{if(""===t.textContent||"\n"===t.textContent){const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}const s=this.createRangeFromPoint(t,e.offset);if(!s)return null;const r=s.getBoundingClientRect(),i=this.container.getBoundingClientRect();if(0===r.width&&0===r.height){const e=t.getBoundingClientRect();return{x:e.left-i.left,y:e.top-i.top,height:e.height||20}}return{x:r.left-i.left,y:r.top-i.top,height:r.height||20}}catch(e){console.warn("Failed to get position from point:",e);try{const e=t.getBoundingClientRect(),s=this.container.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}catch(e){return null}}}createRangeFromPoint(e,t){const s=document.createRange();if(e.nodeType===Node.TEXT_NODE){const r=e.textContent.length,i=Math.min(t,r);s.setStart(e,i),s.setEnd(e,i)}else{const r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let i=0,n=null,o=0;for(;r.nextNode();){const e=r.currentNode,s=e.textContent.length;if(i+s>=t){n=e,o=t-i;break}i+=s}if(n)s.setStart(n,o),s.setEnd(n,o);else try{s.selectNodeContents(e),s.collapse(0===t)}catch(t){s.setStartBefore(e),s.setEndBefore(e)}}return s}getSelectionRects(e,t){return this.editor.getEditorState().read(()=>{const s=a(e.key),r=a(t.key);if(!s||!r)return null;const i=this.editor.getElementByKey(e.key),n=this.editor.getElementByKey(t.key);if(!i||!n)return null;try{const s=document.createRange(),r=e.key===t.key?e.offset>t.offset:i.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_PRECEDING,o=r?t:e,a=r?e:t,l=r?n:i,c=r?i:n,h=this.createRangeFromPoint(l,o.offset);if(!h)return null;s.setStart(h.startContainer,h.startOffset);const d=this.createRangeFromPoint(c,a.offset);if(!d)return null;s.setEnd(d.endContainer,d.endOffset);const u=Array.from(s.getClientRects()),p=this.container.getBoundingClientRect();return console.log(`Selection rects for client: ${u.length} rects found`),u.map(e=>({x:e.left-p.left,y:e.top-p.top,width:e.width,height:e.height}))}catch(e){return console.warn("Failed to get selection rects:",e),null}})}createCursorElement(e,t){const s=document.createElement("div");s.className="lexxy-cursor",s.dataset.cursorId=e;const r=document.createElement("div");r.className="lexxy-cursor-caret",r.style.backgroundColor=t.color;const i=document.createElement("div");return i.className="lexxy-cursor-label",i.textContent=t.name,i.style.cssText=`\n      position: absolute;\n      bottom: 100%;\n      left: 0;\n      background-color: ${t.color};\n      color: white;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 11px;\n      font-family: system-ui, -apple-system, sans-serif;\n      white-space: nowrap;\n      margin-bottom: 2px;\n      pointer-events: none;\n      user-select: none;\n    `,s.appendChild(r),s.appendChild(i),s}createSelectionContainer(e,t){const s=document.createElement("div");return s.className="lexxy-selection",s.dataset.selectionId=e,s.style.cssText="position: absolute; pointer-events: none; z-index: 999;",s}removeCursor(e){const t=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);t&&t.remove(),this.cursors.delete(e)}removeSelection(e){const t=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);t&&t.remove(),this.selections.delete(e)}isPositionVisible(e){const t=this.scrollableElement.scrollTop,s=t+this.scrollableElement.clientHeight;return e.y>=t-50&&e.y<=s+50}findScrollableParent(e){let t=e.parentElement;for(;t;){const e=window.getComputedStyle(t).overflow;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return document.documentElement}renderAllCursors(){try{const e=this.awareness.getStates();console.log("All awareness states:",e),e.forEach((e,t)=>{if(t!==this.localClientId&&e?.cursor){console.log(`Rendering cursor for client ${t}, state:`,e);try{this.updateCursorFromState(t,e)}catch(e){console.warn("Failed to render cursor for client",t,e)}}}),this.queueUpdate("initial")}catch(e){console.error("Error in renderAllCursors:",e)}}getColorForClient(e){const t=["#FF6B6B","#FF006E","#C1121F","#FF4365","#E63946","#DC2F02","#D00000","#9D0208","#FF0A54","#FF5C8A","#F77F00","#FCBF49","#FFB700","#FFA400","#FF9500","#F4A261","#E76F51","#FF8C42","#FFD60A","#FFB627","#06FFA5","#00F5FF","#55A630","#2D6A4F","#52B788","#40916C","#1B5E20","#2E7D32","#43A047","#66BB6A","#4ECDC4","#96CEB4","#88D498","#36C9C6","#06FFB4","#0077B6","#0096C7","#00B4D8","#48CAE4","#90E0EF","#023E8A","#0466C8","#5390D9","#4361EE","#4895EF","#4CC9F0","#45B7D1","#2196F3","#1976D2","#0D47A1","#7209B7","#B5179E","#F72585","#7B2CBF","#6A4C93","#6C5CE7","#A8E6CF","#DDA0DD","#9C27B0","#8E24AA","#AB47BC","#CE93D8","#6A1B9A","#4A148C","#9D4EDD","#8D5524","#A0522D","#964B00","#6F4E37","#8B4513","#14213D","#006D77","#2C7DA0","#468FAF","#61A5C2","#007EA7","#003459","#00A8CC","#005F73","#0A9396","#540B0E","#702632","#A4133C","#800E13","#590D22","#370617","#6A040F","#9D0208","#D00000","#DC2F02"];let s=0;const r=String(e);for(let e=0;e<r.length;e++)s=(s<<5)-s+r.charCodeAt(e),s&=s;return t[Math.abs(s)%t.length]}destroy(){this.awareness.off("update",this.handleAwarenessUpdate),this.unsubscribeEditor&&this.unsubscribeEditor(),this.scrollableElement&&this.scrollableElement.removeEventListener("scroll",this.handleScroll),this.resizeObserver&&this.resizeObserver.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.rafId&&cancelAnimationFrame(this.rafId),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.overlayContainer&&this.overlayContainer.remove(),this.cursors.clear(),this.selections.clear(),this.lastSeenTimestamps.clear(),this.updateQueue.clear()}};var x=class extends HTMLElement{connectedCallback(){this.editorElement=this.closest("lexxy-editor"),this.editor=this.editorElement.editor,this.editor&&this.editor.isReady&&this.editor.isReady()?(console.log("Editor already initialized, starting collaboration"),this.#e()):this.editor?(console.log("Editor exists, starting collaboration"),this.#e()):this.editorElement.addEventListener("lexxy:initialize",(...e)=>{console.log("Editor initialized event, starting collaboration",e),this.editor=this.editorElement.editor,this.#e()},{once:!0})}disconnectedCallback(){this.cursorManager&&this.cursorManager.destroy(),this.unsubscribeCursorSync&&this.unsubscribeCursorSync(),this.unsubscribeListeners&&this.unsubscribeListeners(),this.provider&&this.provider.disconnect()}async#e(){const n=this.getAttribute("name")||"Example User",a=this.getAttribute("color")||"#958DF1",h=this.getAttribute("channel-name")||"SyncChannel",d=this.getAttribute("channel-params")||"{}",u="string"==typeof d?JSON.parse(d):d,p=!this.hasAttribute("disable-bc")||"false"!==this.getAttribute("disable-bc"),m=this.consumer||A,f=this.doc||new i,g=this.awareness||new S(f),y=new Map;y.set(id,f);const b=new o(f,m,h,u,{awareness:g,disableBc:p}),v=e(this.editor,b,id,f,y),C=function(e,t,i){let n=!1;const o=e.registerUpdateListener(({dirtyElements:r,dirtyLeaves:o,editorState:a,normalizedNodes:l,prevEditorState:c,tags:h})=>{n?n=!1:e.getEditorState().read(()=>{!1===h.has("skip-collab")&&s(i,t,c,a,r,o,l,h)})}),a=(e,s)=>{s.origin!==i&&r(i,t,e,!1)};return i.root.getSharedType().observeDeep(a),()=>{o(),i.root.getSharedType().unobserveDeep(a)}}(this.editor,b,v);g.setLocalStateField("user",{name:n,color:a}),g.setLocalStateField("lastSeen",Date.now()),t(b,n,a,!0,{name:n,color:a}),g.setLocalStateField("user",{name:n,color:a}),g.setLocalStateField("lastSeen",Date.now());const E=this.editorElement.querySelector(".lexxy-editor-container")||this.editorElement;this.cursorManager=new w(this.editor,b,E),this.unsubscribeCursorSync=function(e,t){const s=t.awareness;return e.registerUpdateListener(()=>{e.getEditorState().read(()=>{const e=l();if(!e||!c(e))return void s.setLocalStateField("cursor",null);const t=e.anchor,r=e.focus,i={anchorPos:{key:t.key,offset:t.offset,type:t.type},focusPos:{key:r.key,offset:r.offset,type:r.type}};s.setLocalStateField("cursor",i)})})}(this.editor,b),this.provider=b,this.binding=v,this.unsubscribeListeners=C}};customElements.define("lexxy-collaboration",x);