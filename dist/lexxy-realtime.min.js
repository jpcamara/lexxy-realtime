var e=Object.defineProperty,t=t=>{let n={};for(var r in t)e(n,r,{get:t[r],enumerable:!0});return n},n=t({$addUpdateTag:()=>co,$applyNodeReplacement:()=>yo,$caretFromPoint:()=>Tl,$caretRangeFromSelection:()=>Dl,$cloneWithProperties:()=>$o,$cloneWithPropertiesEphemeral:()=>Fo,$comparePointCaretNext:()=>vl,$copyNode:()=>_o,$create:()=>Ho,$createLineBreakNode:()=>Jn,$createNodeSelection:()=>Fr,$createParagraphNode:()=>Us,$createPoint:()=>br,$createRangeSelection:()=>$r,$createRangeSelectionFromDom:()=>Kr,$createTabNode:()=>mr,$createTextNode:()=>hr,$extendCaretToRange:()=>bl,$findMatchingParent:()=>Vo,$getAdjacentChildCaret:()=>pl,$getAdjacentNode:()=>eo,$getAdjacentSiblingOrParentSiblingCaret:()=>Ul,$getCaretInDirection:()=>Kl,$getCaretRange:()=>Cl,$getCaretRangeInDirection:()=>zl,$getCharacterOffsets:()=>Nr,$getChildCaret:()=>fl,$getChildCaretAtIndex:()=>Bl,$getChildCaretOrSelf:()=>gl,$getCollapsedCaretRange:()=>Sl,$getCommonAncestor:()=>Nl,$getCommonAncestorResultBranchOrder:()=>xl,$getEditor:()=>Io,$getNearestNodeFromDOMNode:()=>Ti,$getNearestRootOrShadowRoot:()=>po,$getNodeByKey:()=>Ei,$getNodeByKeyOrThrow:()=>So,$getNodeFromDOMNode:()=>ki,$getPreviousSelection:()=>jr,$getRoot:()=>Mi,$getSelection:()=>Ur,$getSiblingCaret:()=>al,$getState:()=>he,$getStateChange:()=>fe,$getTextContent:()=>Xr,$getTextNodeOffset:()=>ul,$getTextPointCaret:()=>dl,$getTextPointCaretSlice:()=>hl,$getWritableNodeState:()=>ye,$hasAncestor:()=>uo,$hasUpdateTag:()=>lo,$insertNodes:()=>Gr,$isBlockElementNode:()=>Lr,$isChildCaret:()=>il,$isDecoratorNode:()=>Ms,$isEditorState:()=>$s,$isElementNode:()=>Ts,$isExtendableTextPointCaret:()=>Fl,$isInlineElementOrDecoratorNode:()=>go,$isLeafNode:()=>bi,$isLineBreakNode:()=>qn,$isNodeCaret:()=>rl,$isNodeSelection:()=>Er,$isParagraphNode:()=>js,$isRangeSelection:()=>vr,$isRootNode:()=>Is,$isRootOrShadowRoot:()=>mo,$isSiblingCaret:()=>sl,$isTabNode:()=>_r,$isTextNode:()=>fr,$isTextPointCaret:()=>nl,$isTextPointCaretSlice:()=>yl,$isTokenOrSegmented:()=>gi,$isTokenOrTab:()=>fi,$nodesOfType:()=>Qi,$normalizeCaret:()=>$l,$normalizeSelection__EXPERIMENTAL:()=>Te,$onUpdate:()=>ao,$parseSerializedNode:()=>ms,$removeTextFromCaretRange:()=>Rl,$rewindSiblingCaret:()=>Il,$selectAll:()=>qi,$setCompositionKey:()=>vi,$setPointFromCaret:()=>Ol,$setSelection:()=>Ii,$setSelectionFromCaretRange:()=>Al,$setState:()=>ge,$splitAtPointCaretNext:()=>Yl,$splitNode:()=>Eo,$updateRangeSelectionFromCaretRange:()=>Ml,ArtificialNode__DO_NOT_USE:()=>Ks,BLUR_COMMAND:()=>Zt,CAN_REDO_COMMAND:()=>Gt,CAN_UNDO_COMMAND:()=>Xt,CLEAR_EDITOR_COMMAND:()=>Jt,CLEAR_HISTORY_COMMAND:()=>qt,CLICK_COMMAND:()=>ht,COLLABORATION_TAG:()=>Bn,COMMAND_PRIORITY_CRITICAL:()=>Js,COMMAND_PRIORITY_EDITOR:()=>Ws,COMMAND_PRIORITY_HIGH:()=>Vs,COMMAND_PRIORITY_LOW:()=>Ys,COMMAND_PRIORITY_NORMAL:()=>Hs,CONTROLLED_TEXT_INSERTION_COMMAND:()=>mt,COPY_COMMAND:()=>Yt,CUT_COMMAND:()=>Ht,DELETE_CHARACTER_COMMAND:()=>ft,DELETE_LINE_COMMAND:()=>St,DELETE_WORD_COMMAND:()=>bt,DRAGEND_COMMAND:()=>Wt,DRAGOVER_COMMAND:()=>jt,DRAGSTART_COMMAND:()=>Ut,DROP_COMMAND:()=>zt,DecoratorNode:()=>As,ElementNode:()=>Ns,FOCUS_COMMAND:()=>Qt,FORMAT_ELEMENT_COMMAND:()=>Bt,FORMAT_TEXT_COMMAND:()=>Ct,HISTORIC_TAG:()=>$n,HISTORY_MERGE_TAG:()=>Kn,HISTORY_PUSH_TAG:()=>Fn,INDENT_CONTENT_COMMAND:()=>Ft,INSERT_LINE_BREAK_COMMAND:()=>gt,INSERT_PARAGRAPH_COMMAND:()=>pt,INSERT_TAB_COMMAND:()=>$t,INTERNAL_$isBlock:()=>Do,IS_ALL_FORMATTING:()=>I,IS_BOLD:()=>E,IS_CODE:()=>O,IS_HIGHLIGHT:()=>D,IS_ITALIC:()=>k,IS_STRIKETHROUGH:()=>N,IS_SUBSCRIPT:()=>A,IS_SUPERSCRIPT:()=>M,IS_UNDERLINE:()=>T,KEY_ARROW_DOWN_COMMAND:()=>At,KEY_ARROW_LEFT_COMMAND:()=>Nt,KEY_ARROW_RIGHT_COMMAND:()=>Et,KEY_ARROW_UP_COMMAND:()=>Ot,KEY_BACKSPACE_COMMAND:()=>It,KEY_DELETE_COMMAND:()=>Lt,KEY_DOWN_COMMAND:()=>xt,KEY_ENTER_COMMAND:()=>Mt,KEY_ESCAPE_COMMAND:()=>Pt,KEY_MODIFIER_COMMAND:()=>en,KEY_SPACE_COMMAND:()=>Dt,KEY_TAB_COMMAND:()=>Rt,LineBreakNode:()=>Hn,MOVE_TO_END:()=>kt,MOVE_TO_START:()=>Tt,NODE_STATE_KEY:()=>X,OUTDENT_CONTENT_COMMAND:()=>Kt,PASTE_COMMAND:()=>_t,PASTE_TAG:()=>zn,ParagraphNode:()=>zs,REDO_COMMAND:()=>vt,REMOVE_TEXT_COMMAND:()=>yt,RootNode:()=>Ds,SELECTION_CHANGE_COMMAND:()=>dt,SELECTION_INSERT_CLIPBOARD_NODES_COMMAND:()=>ut,SELECT_ALL_COMMAND:()=>Vt,SKIP_COLLAB_TAG:()=>Un,SKIP_DOM_SELECTION_TAG:()=>Wn,SKIP_SCROLL_INTO_VIEW_TAG:()=>jn,SKIP_SELECTION_FOCUS_TAG:()=>Yn,TEXT_TYPE_TO_FORMAT:()=>Y,TabNode:()=>pr,TextNode:()=>rr,UNDO_COMMAND:()=>wt,buildImportMap:()=>In,configExtension:()=>Vl,createCommand:()=>at,createEditor:()=>Xs,createSharedNodeState:()=>me,createState:()=>ue,declarePeerDependency:()=>Jl,defineExtension:()=>Hl,flipDirection:()=>Qo,getDOMOwnerDocument:()=>oo,getDOMSelection:()=>vo,getDOMSelectionFromTarget:()=>xo,getDOMTextNode:()=>_i,getEditorPropertyFromDOMNode:()=>ui,getNearestEditorFromDOMNode:()=>di,getRegisteredNode:()=>si,getRegisteredNodeOrThrow:()=>ri,getStaticNodeConfig:()=>Yo,getTextDirection:()=>hi,getTransformSetFromKlass:()=>Gs,isBlockDomNode:()=>Mo,isCurrentlyReadOnlyMode:()=>ls,isDOMDocumentNode:()=>mi,isDOMNode:()=>To,isDOMTextNode:()=>pi,isDOMUnmanaged:()=>Bo,isDocumentFragment:()=>Oo,isExactShortcutMatch:()=>Wi,isHTMLAnchorElement:()=>ko,isHTMLElement:()=>No,isInlineDomNode:()=>Ao,isLexicalEditor:()=>ai,isModifierMatch:()=>ji,isSelectionCapturedInDecoratorInput:()=>li,isSelectionWithinEditor:()=>ci,makeStepwiseIterator:()=>wl,removeFromParent:()=>Ci,resetRandomKey:()=>ni,safeCast:()=>ql,setDOMUnmanaged:()=>zo,setNodeIndentFromDOM:()=>Ko,shallowMergeConfig:()=>Gl});function r(e){throw new Error(e)}const s="undefined"!=typeof window&&void 0!==window.document&&void 0!==window.document.createElement,i=s&&"documentMode"in document?document.documentMode:null,o=s&&/Mac|iPod|iPhone|iPad/.test(navigator.platform),l=s&&/^(?!.*Seamonkey)(?=.*Firefox).*/i.test(navigator.userAgent),c=!(!s||!("InputEvent"in window)||i)&&"getTargetRanges"in new window.InputEvent("input"),a=s&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent),d=s&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,u=s&&/Android/.test(navigator.userAgent),h=s&&/^(?=.*Chrome).*/i.test(navigator.userAgent),f=s&&u&&h,g=s&&/AppleWebKit\/[\d.]+/.test(navigator.userAgent)&&o&&!h;function p(...e){const t=[];for(const n of e)if(n&&"string"==typeof n)for(const[e]of n.matchAll(/\S+/g))t.push(e);return t}const m=1,_=3,y=9,b=11,S=1,C=2,w=0,v=1,x=2,E=1,k=2,N=4,T=8,O=16,A=32,M=64,D=128,I=2047,P=1,L=2,R=3,$=4,F=5,K=6,z=a||d||g?" ":"​",B="\n\n",U=l?" ":z,j=new RegExp("^[^A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿‎Ⰰ-﬜︀-﹯﻽-￿]*[֑-߿יִ-﷽ﹰ-ﻼ]"),W=new RegExp("^[^֑-߿יִ-﷽ﹰ-ﻼ]*[A-Za-zÀ-ÖØ-öø-ʸ̀-֐ࠀ-῿‎Ⰰ-﬜︀-﹯﻽-￿]"),Y={bold:E,capitalize:1024,code:O,highlight:D,italic:k,lowercase:256,strikethrough:N,subscript:A,superscript:M,underline:T,uppercase:512},H={directionless:1,unmergeable:2},V={center:2,end:6,justify:4,left:1,right:3,start:5},J={[L]:"center",[K]:"end",[$]:"justify",[P]:"left",[R]:"right",[F]:"start"},q={normal:0,segmented:2,token:1},G={[w]:"normal",[x]:"segmented",[v]:"token"},X="$",Q="$config";function Z(e,t,n,r,s,i){let o=e.getFirstChild();for(;null!==o;){const e=o.__key;o.__parent===t&&(Ts(o)&&Z(o,e,n,r,s,i),n.has(e)||i.delete(e),s.push(e)),o=o.getNextSibling()}}let ee=!1,te=0;function ne(e){te=e.timeStamp}function re(e,t,n){const r="BR"===e.nodeName,s=t.__lexicalLineBreak;return s&&(e===s||r&&e.previousSibling===s)||r&&void 0!==Ni(e,n)}function se(e,t,n){const r=vo(fo(n));let s=null,i=null;null!==r&&r.anchorNode===e&&(s=r.anchorOffset,i=r.focusOffset);const o=e.nodeValue;null!==o&&zi(t,o,s,i,!1)}function ie(e,t,n){if(vr(e)){const t=e.anchor.getNode();if(t.is(n)&&e.format!==t.getFormat())return!1}return pi(t)&&n.isAttached()}function oe(e,t,n,r){for(let s=e;s&&!Bo(s);s=io(s)){const e=Ni(s,t);if(void 0!==e){const t=Ei(e,n);if(t)return Ms(t)||!No(s)?void 0:[s,t]}else if(s===r)return[r,Di(n)]}}function le(e,t,n){ee=!0;const r=performance.now()-te>100;try{xs(e,()=>{const s=Ur()||function(e){return e.getEditorState().read(()=>{const e=Ur();return null!==e?e.clone():null})}(e),i=new Map,o=e.getRootElement(),c=e._editorState,a=e._blockCursorElement;let d=!1,u="";for(let n=0;n<t.length;n++){const h=t[n],f=h.type,g=h.target,p=oe(g,e,c,o);if(!p)continue;const[m,_]=p;if("characterData"===f)r&&fr(_)&&pi(g)&&ie(s,g,_)&&se(g,_,e);else if("childList"===f){d=!0;const t=h.addedNodes;for(let n=0;n<t.length;n++){const r=t[n],s=ki(r),i=r.parentNode;if(null!=i&&r!==a&&null===s&&!re(r,i,e)){if(l){const e=(No(r)?r.innerText:null)||r.nodeValue;e&&(u+=e)}i.removeChild(r)}}const n=h.removedNodes,r=n.length;if(r>0){let t=0;for(let s=0;s<r;s++){const r=n[s];(re(r,g,e)||a===r)&&(g.appendChild(r),t++)}r!==t&&i.set(m,_)}}}if(i.size>0)for(const[t,n]of i)n.reconcileObservedMutation(t,e);const h=n.takeRecords();if(h.length>0){for(let t=0;t<h.length;t++){const n=h[t],r=n.addedNodes,s=n.target;for(let t=0;t<r.length;t++){const n=r[t],i=n.parentNode;null==i||"BR"!==n.nodeName||re(n,s,e)||i.removeChild(n)}}n.takeRecords()}null!==s&&(d&&Ii(s),l&&to(e)&&s.insertRawText(u))})}finally{ee=!1}}function ce(e){const t=e._observer;null!==t&&le(e,t.takeRecords(),t)}function ae(e){!function(e){0===te&&fo(e).addEventListener("textInput",ne,!0)}(e),e._observer=new MutationObserver((t,n)=>{le(e,t,n)})}var de=class{key;parse;unparse;isEqual;defaultValue;constructor(e,t){this.key=e,this.parse=t.parse.bind(t),this.unparse=(t.unparse||Ce).bind(t),this.isEqual=(t.isEqual||Object.is).bind(t),this.defaultValue=this.parse(void 0)}};function ue(e,t){return new de(e,t)}function he(e,t,n="latest"){const r=("latest"===n?e.getLatest():e).__state;return r?(pe(e,t,r),r.getValue(t)):t.defaultValue}function fe(e,t,n){const r=he(e,n,"direct"),s=he(t,n,"direct");return n.isEqual(r,s)?null:[r,s]}function ge(e,t,n){let r;if(cs(),"function"==typeof n){const s=e.getLatest(),i=he(s,t);if(r=n(i),t.isEqual(i,r))return s}else r=n;const s=e.getWritable(),i=ye(s);return pe(e,t,i),i.updateFromKnown(t,r),s}function pe(e,t,n){{const s=n.sharedNodeState.sharedConfigMap.get(t.key);void 0!==s&&s!==t&&r(`$setState: State key collision ${JSON.stringify(t.key)} detected in ${e.constructor.name} node with type ${e.getType()} and key ${e.getKey()}. Only one StateConfig with a given key should be used on a node.`)}}function me(e){const t=new Map,n=new Set;for(let r="function"==typeof e?e:e.replace;r.prototype&&void 0!==r.prototype.getType;r=Object.getPrototypeOf(r)){const{ownNodeConfig:e}=Yo(r);if(e&&e.stateConfigs)for(const r of e.stateConfigs){let e;"stateConfig"in r?(e=r.stateConfig,r.flat&&n.add(e.key)):e=r,t.set(e.key,e)}}return{flatKeys:n,sharedConfigMap:t}}var _e=class e{node;knownState;unknownState;sharedNodeState;size;constructor(e,t,n=void 0,s=new Map,i=void 0){this.node=e,this.sharedNodeState=t,this.unknownState=n,this.knownState=s;const{sharedConfigMap:o}=this.sharedNodeState,l=void 0!==i?i:function(e,t,n){let r=n.size;if(t)for(const s in t){const t=e.get(s);t&&n.has(t)||r++}return r}(o,n,s);void 0!==i&&l!==i&&r(`NodeState: size != computedSize (${String(i)} != ${String(l)})`);for(const e of s.keys())o.has(e.key)||r(`NodeState: sharedConfigMap missing knownState key ${e.key}`);this.size=l}getValue(e){const t=this.knownState.get(e);if(void 0!==t)return t;this.sharedNodeState.sharedConfigMap.set(e.key,e);let n=e.defaultValue;if(this.unknownState&&e.key in this.unknownState){const t=this.unknownState[e.key];void 0!==t&&(n=e.parse(t)),this.updateFromKnown(e,n)}return n}getInternalState(){return[this.unknownState,this.knownState]}toJSON(){const e={...this.unknownState},t={};for(const[t,n]of this.knownState)t.isEqual(n,t.defaultValue)?delete e[t.key]:e[t.key]=t.unparse(n);for(const n of this.sharedNodeState.flatKeys)n in e&&(t[n]=e[n],delete e[n]);return Se(e)&&(t[X]=e),t}getWritable(t){if(this.node===t)return this;const{sharedNodeState:n,unknownState:r}=this,s=new Map(this.knownState);return new e(t,n,function(e,t,n){let r;if(n)for(const[s,i]of Object.entries(n)){const n=e.get(s);n?t.has(n)||t.set(n,n.parse(i)):(r=r||{},r[s]=i)}return r}(n.sharedConfigMap,s,r),s,this.size)}updateFromKnown(e,t){const n=e.key;this.sharedNodeState.sharedConfigMap.set(n,e);const{knownState:r,unknownState:s}=this;r.has(e)||s&&n in s||(s&&(delete s[n],this.unknownState=Se(s)),this.size++),r.set(e,t)}updateFromUnknown(e,t){const n=this.sharedNodeState.sharedConfigMap.get(e);n?this.updateFromKnown(n,n.parse(t)):(this.unknownState=this.unknownState||{},e in this.unknownState||this.size++,this.unknownState[e]=t)}updateFromJSON(e){const{knownState:t}=this;for(const e of t.keys())t.set(e,e.defaultValue);if(this.size=t.size,this.unknownState=void 0,e)for(const[t,n]of Object.entries(e))this.updateFromUnknown(t,n)}};function ye(e){const t=e.getWritable(),n=t.__state?t.__state.getWritable(t):new _e(t,be(t));return t.__state=n,n}function be(e){return e.__state?e.__state.sharedNodeState:ri(Io(),e.getType()).sharedNodeState}function Se(e){if(e)for(const t in e)return e}function Ce(e){return e}function we(e,t,n){for(const[r,s]of t.knownState){if(e.has(r.key))continue;e.add(r.key);const t=n?n.getValue(r):r.defaultValue;if(t!==s&&!r.isEqual(t,s))return!0}return!1}function ve(e,t,n){const{unknownState:r}=t,s=n?n.unknownState:void 0;if(r)for(const[t,n]of Object.entries(r))if(!e.has(t)&&(e.add(t),n!==(s?s[t]:void 0)))return!0;return!1}function xe(e,t){const n=e.__state;return n&&n.node===e?n.getWritable(t):n}function Ee(e,t){const n=e.__mode,r=e.__format,s=e.__style,i=t.__mode,o=t.__format,l=t.__style,c=e.__state,a=t.__state;return(null===n||n===i)&&(null===r||r===o)&&(null===s||s===l)&&(null===e.__state||c===a||function(e,t){if(e===t)return!0;if(e&&t&&e.size!==t.size)return!1;const n=new Set;return!(e&&we(n,e,t)||t&&we(n,t,e)||e&&ve(n,e,t)||t&&ve(n,t,e))}(c,a))}function ke(e,t){const n=e.mergeWithSibling(t),r=us()._normalizedNodes;return r.add(e.__key),r.add(t.__key),n}function Ne(e){let t,n,r=e;if(""!==r.__text||!r.isSimpleText()||r.isUnmergeable()){for(;null!==(t=r.getPreviousSibling())&&fr(t)&&t.isSimpleText()&&!t.isUnmergeable();){if(""!==t.__text){if(Ee(t,r)){r=ke(t,r);break}break}t.remove()}for(;null!==(n=r.getNextSibling())&&fr(n)&&n.isSimpleText()&&!n.isUnmergeable();){if(""!==n.__text){if(Ee(r,n)){r=ke(r,n);break}break}n.remove()}}else r.remove()}function Te(e){return Oe(e.anchor),Oe(e.focus),e}function Oe(e){for(;"element"===e.type;){const t=e.getNode(),n=e.offset;let r,s;if(n===t.getChildrenSize()?(r=t.getChildAtIndex(n-1),s=!0):(r=t.getChildAtIndex(n),s=!1),fr(r)){e.set(r.__key,s?r.getTextContentSize():0,"text",!0);break}if(!Ts(r))break;e.set(r.__key,s?r.getChildrenSize():0,"element",!0)}}let Ae,Me,De,Ie,Pe,Le,Re,$e,Fe,Ke,ze="",Be=null,Ue="",je="",We=!1,Ye=!1;function He(e,t){const n=Re.get(e);if(null!==t){const n=ct(e);n.parentNode===t&&t.removeChild(n)}if($e.has(e)||Me._keyToDOMMap.delete(e),Ts(n)){const e=st(n,Re);Ve(e,0,e.length-1,null)}void 0!==n&&Xi(Ke,De,Ie,n,"destroyed")}function Ve(e,t,n,r){let s=t;for(;s<=n;++s){const t=e[s];void 0!==t&&He(t,r)}}function Je(e,t){e.setProperty("text-align",t)}const qe="40px";function Ge(e,t){const n=Ae.theme.indent;if("string"==typeof n){const r=e.classList.contains(n);t>0&&!r?e.classList.add(n):t<1&&r&&e.classList.remove(n)}const r=getComputedStyle(e).getPropertyValue("--lexical-indent-base-value")||qe;e.style.setProperty("padding-inline-start",0===t?"":`calc(${t} * ${r})`)}function Xe(e,t){const n=e.style;0===t?Je(n,""):1===t?Je(n,"left"):2===t?Je(n,"center"):3===t?Je(n,"right"):4===t?Je(n,"justify"):5===t?Je(n,"start"):6===t&&Je(n,"end")}function Qe(e,t){const n=function(e){const t=e.__dir;if(null!==t)return t;if(Is(e))return null;const n=e.getParentOrThrow();return Is(n)&&null===n.__dir?"auto":null}(t);null!==n?e.dir=n:e.removeAttribute("dir")}function Ze(e,t){const n=$e.get(e);void 0===n&&r("createNode: node does not exist in nodeMap");const s=n.createDOM(Ae,Me);if(function(e,t,n){const r=n._keyToDOMMap;(function(e,t,n){const r=`__lexicalKey_${t._key}`;e[r]=n})(t,n,e),r.set(e,t)}(e,s,Me),fr(n)?s.setAttribute("data-lexical-text","true"):Ms(n)&&s.setAttribute("data-lexical-decorator","true"),Ts(n)){const e=n.__indent,t=n.__size;if(Qe(s,n),0!==e&&Ge(s,e),0!==t){const e=t-1;et(st(n,$e),n,0,e,n.getDOMSlot(s))}const r=n.__format;0!==r&&Xe(s,r),n.isInline()||nt(null,n,s),ro(n)&&(ze+=B,je+=B)}else{const t=n.getTextContent();if(Ms(n)){const t=n.decorate(Me,Ae);null!==t&&ot(e,t),s.contentEditable="false"}ze+=t,je+=t}return null!==t&&t.insertChild(s),Object.freeze(n),Xi(Ke,De,Ie,n,"created"),s}function et(e,t,n,r,s){const i=ze;ze="";let o=n;for(;o<=r;++o){Ze(e[o],s);const t=$e.get(e[o]);null!==t&&fr(t)&&(null===Be&&(Be=t.getFormat()),""===Ue&&(Ue=t.getStyle()))}ro(t)&&(ze+=B);s.element.__lexicalTextContent=ze,ze=i+ze}function tt(e,t){if(e){const n=e.__last;if(n){const e=t.get(n);if(e)return qn(e)?"line-break":Ms(e)&&e.isInline()?"decorator":null}return"empty"}return null}function nt(e,t,n){const r=tt(e,Re),s=tt(t,$e);r!==s&&t.getDOMSlot(n).setManagedLineBreak(s)}function rt(e,t,n){var s;Be=null,Ue="",function(e,t,n){const s=ze,i=e.__size,o=t.__size;ze="";const l=n.element;if(1===i&&1===o){const n=e.__first,r=t.__first;if(n===r)it(n,l);else{const e=ct(n),t=Ze(r,null);try{l.replaceChild(t,e)}catch(s){if("object"==typeof s&&null!=s){const i=`${s.toString()} Parent: ${l.tagName}, new child: {tag: ${t.tagName} key: ${r}}, old child: {tag: ${e.tagName}, key: ${n}}.`;throw new Error(i)}throw s}He(n,null)}const s=$e.get(r);fr(s)&&(null===Be&&(Be=s.getFormat()),""===Ue&&(Ue=s.getStyle()))}else{const s=st(e,Re),c=st(t,$e);if(s.length!==i&&r("$reconcileChildren: prevChildren.length !== prevChildrenSize"),c.length!==o&&r("$reconcileChildren: nextChildren.length !== nextChildrenSize"),0===i)0!==o&&et(c,t,0,o-1,n);else if(0===o){if(0!==i){const e=null==n.after&&null==n.before&&null==n.element.__lexicalLineBreak;Ve(s,0,i-1,e?null:l),e&&(l.textContent="")}}else!function(e,t,n,r,s,i){const o=r-1,l=s-1;let c,a,d=i.getFirstChild(),u=0,h=0;for(;u<=o&&h<=l;){const e=t[u],r=n[h];if(e===r)d=lt(it(r,i.element)),u++,h++;else{void 0===c&&(c=new Set(t)),void 0===a&&(a=new Set(n));const s=a.has(e),o=c.has(r);if(s)if(o){const e=so(Me,r);e===d?d=lt(it(r,i.element)):(i.withBefore(d).insertChild(e),it(r,i.element)),u++,h++}else Ze(r,i.withBefore(d)),h++;else d=lt(ct(e)),He(e,i.element),u++}const s=$e.get(r);null!==s&&fr(s)&&(null===Be&&(Be=s.getFormat()),""===Ue&&(Ue=s.getStyle()))}const f=u>o,g=h>l;if(f&&!g){const t=n[l+1],r=void 0===t?null:Me.getElementByKey(t);et(n,e,h,l,i.withBefore(r))}else g&&!f&&Ve(t,u,o,i.element)}(t,s,c,i,o,n)}ro(t)&&(ze+=B);l.__lexicalTextContent=ze,ze=s+ze}(e,t,t.getDOMSlot(n)),s=t,null==Be||Be===s.__textFormat||Ye||s.setTextFormat(Be),function(e){""===Ue||Ue===e.__textStyle||Ye||e.setTextStyle(Ue)}(t)}function st(e,t){const n=[];let s=e.__first;for(;null!==s;){const e=t.get(s);void 0===e&&r("createChildrenArray: node does not exist in nodeMap"),n.push(s),s=e.__next}return n}function it(e,t){const n=Re.get(e);let s=$e.get(e);void 0!==n&&void 0!==s||r("reconcileNode: prevNode or nextNode does not exist in nodeMap");const i=We||Le.has(e)||Pe.has(e),o=so(Me,e);if(n===s&&!i){if(Ts(n)){const e=o.__lexicalTextContent;void 0!==e&&(ze+=e,je+=e)}else{const e=n.getTextContent();je+=e,ze+=e}return o}if(n!==s&&i&&Xi(Ke,De,Ie,s,"updated"),s.updateDOM(n,o,Ae)){const n=Ze(e,null);return null===t&&r("reconcileNode: parentDOM is null"),t.replaceChild(n,o),He(e,null),n}if(Ts(n)&&Ts(s)){const e=s.__indent;(We||e!==n.__indent)&&Ge(o,e);const t=s.__format;if((We||t!==n.__format)&&Xe(o,t),i&&(rt(n,s,o),Is(s)||s.isInline()||nt(n,s,o)),ro(s)&&(ze+=B,je+=B),(We||s.__dir!==n.__dir)&&(Qe(o,s),Is(s)&&!We))for(const e of s.getChildren())Ts(e)&&Qe(so(Me,e.getKey()),e)}else{const t=s.getTextContent();if(Ms(s)){const t=s.decorate(Me,Ae);null!==t&&ot(e,t)}ze+=t,je+=t}if(!Ye&&Is(s)&&s.__cachedText!==je){const e=s.getWritable();e.__cachedText=je,s=e}return Object.freeze(s),o}function ot(e,t){let n=Me._pendingDecorators;const r=Me._decorators;if(null===n){if(r[e]===t)return;n=Oi(Me)}n[e]=t}function lt(e){let t=e.nextSibling;return null!==t&&t===Me._blockCursorElement&&(t=t.nextSibling),t}function ct(e){const t=Fe.get(e);return void 0===t&&r(`Reconciliation: could not find DOM element for node key ${e}`),t}function at(e){return{type:e}}const dt=at("SELECTION_CHANGE_COMMAND"),ut=at("SELECTION_INSERT_CLIPBOARD_NODES_COMMAND"),ht=at("CLICK_COMMAND"),ft=at("DELETE_CHARACTER_COMMAND"),gt=at("INSERT_LINE_BREAK_COMMAND"),pt=at("INSERT_PARAGRAPH_COMMAND"),mt=at("CONTROLLED_TEXT_INSERTION_COMMAND"),_t=at("PASTE_COMMAND"),yt=at("REMOVE_TEXT_COMMAND"),bt=at("DELETE_WORD_COMMAND"),St=at("DELETE_LINE_COMMAND"),Ct=at("FORMAT_TEXT_COMMAND"),wt=at("UNDO_COMMAND"),vt=at("REDO_COMMAND"),xt=at("KEYDOWN_COMMAND"),Et=at("KEY_ARROW_RIGHT_COMMAND"),kt=at("MOVE_TO_END"),Nt=at("KEY_ARROW_LEFT_COMMAND"),Tt=at("MOVE_TO_START"),Ot=at("KEY_ARROW_UP_COMMAND"),At=at("KEY_ARROW_DOWN_COMMAND"),Mt=at("KEY_ENTER_COMMAND"),Dt=at("KEY_SPACE_COMMAND"),It=at("KEY_BACKSPACE_COMMAND"),Pt=at("KEY_ESCAPE_COMMAND"),Lt=at("KEY_DELETE_COMMAND"),Rt=at("KEY_TAB_COMMAND"),$t=at("INSERT_TAB_COMMAND"),Ft=at("INDENT_CONTENT_COMMAND"),Kt=at("OUTDENT_CONTENT_COMMAND"),zt=at("DROP_COMMAND"),Bt=at("FORMAT_ELEMENT_COMMAND"),Ut=at("DRAGSTART_COMMAND"),jt=at("DRAGOVER_COMMAND"),Wt=at("DRAGEND_COMMAND"),Yt=at("COPY_COMMAND"),Ht=at("CUT_COMMAND"),Vt=at("SELECT_ALL_COMMAND"),Jt=at("CLEAR_EDITOR_COMMAND"),qt=at("CLEAR_HISTORY_COMMAND"),Gt=at("CAN_REDO_COMMAND"),Xt=at("CAN_UNDO_COMMAND"),Qt=at("FOCUS_COMMAND"),Zt=at("BLUR_COMMAND"),en=at("KEY_MODIFIER_COMMAND"),tn=Object.freeze({}),nn=[["keydown",function(e,t){if(rn=e.timeStamp,sn=e.key,t.isComposing())return;if(no(t,xt,e))return;if(null==e.key)return;if(gn&&Vi(e))return xs(t,()=>{xn(t,pn)}),gn=!1,void(pn="");if(function(e){return Wi(e,"ArrowRight",{shiftKey:"any"})}(e))no(t,Et,e);else if(function(e){return Wi(e,"ArrowRight",Yi)}(e))no(t,kt,e);else if(function(e){return Wi(e,"ArrowLeft",{shiftKey:"any"})}(e))no(t,Nt,e);else if(function(e){return Wi(e,"ArrowLeft",Yi)}(e))no(t,Tt,e);else if(function(e){return Wi(e,"ArrowUp",{altKey:"any",shiftKey:"any"})}(e))no(t,Ot,e);else if(function(e){return Wi(e,"ArrowDown",{altKey:"any",shiftKey:"any"})}(e))no(t,At,e);else if(function(e){return Wi(e,"Enter",{altKey:"any",ctrlKey:"any",metaKey:"any",shiftKey:!0})}(e))hn=!0,no(t,Mt,e);else if(function(e){return" "===e.key}(e))no(t,Dt,e);else if(function(e){return o&&Wi(e,"o",{ctrlKey:!0})}(e))e.preventDefault(),hn=!0,no(t,gt,!0);else if(function(e){return Wi(e,"Enter",{altKey:"any",ctrlKey:"any",metaKey:"any"})}(e))hn=!1,no(t,Mt,e);else if(function(e){return Wi(e,"Backspace",{shiftKey:"any"})||o&&Wi(e,"h",{ctrlKey:!0})}(e))Vi(e)?no(t,It,e):(e.preventDefault(),no(t,ft,!0));else if(function(e){return"Escape"===e.key}(e))no(t,Pt,e);else if(function(e){return Wi(e,"Delete",{})||o&&Wi(e,"d",{ctrlKey:!0})}(e))!function(e){return"Delete"===e.key}(e)?(e.preventDefault(),no(t,ft,!1)):no(t,Lt,e);else if(function(e){return Wi(e,"Backspace",Hi)}(e))e.preventDefault(),no(t,bt,!0);else if(function(e){return Wi(e,"Delete",Hi)}(e))e.preventDefault(),no(t,bt,!1);else if(function(e){return o&&Wi(e,"Backspace",{metaKey:!0})}(e))e.preventDefault(),no(t,St,!0);else if(function(e){return o&&(Wi(e,"Delete",{metaKey:!0})||Wi(e,"k",{ctrlKey:!0}))}(e))e.preventDefault(),no(t,St,!1);else if(function(e){return Wi(e,"b",Yi)}(e))e.preventDefault(),no(t,Ct,"bold");else if(function(e){return Wi(e,"u",Yi)}(e))e.preventDefault(),no(t,Ct,"underline");else if(function(e){return Wi(e,"i",Yi)}(e))e.preventDefault(),no(t,Ct,"italic");else if(function(e){return Wi(e,"Tab",{shiftKey:"any"})}(e))no(t,Rt,e);else if(function(e){return Wi(e,"z",Yi)}(e))e.preventDefault(),no(t,wt,void 0);else if(function(e){return o?Wi(e,"z",{metaKey:!0,shiftKey:!0}):Wi(e,"y",{ctrlKey:!0})||Wi(e,"z",{ctrlKey:!0,shiftKey:!0})}(e))e.preventDefault(),no(t,vt,void 0);else{const n=t._editorState._selection;null===n||vr(n)?Ji(e)&&(e.preventDefault(),no(t,Vt,e)):!function(e){return Wi(e,"c",Yi)}(e)?!function(e){return Wi(e,"x",Yi)}(e)?Ji(e)&&(e.preventDefault(),no(t,Vt,e)):(e.preventDefault(),no(t,Ht,e)):(e.preventDefault(),no(t,Yt,e))}(function(e){return e.ctrlKey||e.shiftKey||e.altKey||e.metaKey})(e)&&no(t,en,e)}],["pointerdown",function(e,t){const n=e.target,r=e.pointerType;To(n)&&"touch"!==r&&"pen"!==r&&0===e.button&&xs(t,()=>{oi(n)||(un=!0)})}],["compositionstart",function(e,t){xs(t,()=>{const n=Ur();if(vr(n)&&!t.isComposing()){const r=n.anchor,s=n.anchor.getNode();vi(r.key),(e.timeStamp<rn+30||"element"===r.type||!n.isCollapsed()||s.getFormat()!==n.format||fr(s)&&s.getStyle()!==n.style)&&no(t,mt,U)}})}],["compositionend",function(e,t){l?fn=!0:d||!a&&!g?xs(t,()=>{xn(t,e.data)}):(gn=!0,pn=e.data)}],["input",function(e,t){e.stopPropagation(),xs(t,()=>{if(No(e.target)&&oi(e.target))return;const n=Ur(),r=e.data,s=vn(e);if(null!=r&&vr(n)&&yn(n,s,r,e.timeStamp,!1)){fn&&(xn(t,r),fn=!1);const s=n.anchor.getNode(),i=vo(fo(t));if(null===i)return;const o=n.isBackward(),u=o?n.anchor.offset:n.focus.offset,h=o?n.focus.offset:n.anchor.offset;c&&!n.isCollapsed()&&fr(s)&&null!==i.anchorNode&&s.getTextContent().slice(0,u)+r+s.getTextContent().slice(u+h)===Fi(i.anchorNode)||no(t,mt,r);const f=r.length;l&&f>1&&"insertCompositionText"===e.inputType&&!t.isComposing()&&(n.anchor.offset-=f),a||d||g||!t.isComposing()||(rn=0,vi(null))}else Ki(!1,t,null!==r?r:void 0),fn&&(xn(t,r||void 0),fn=!1);cs(),ce(us())},{event:e}),ln=null}],["click",function(e,t){xs(t,()=>{const n=Ur(),r=vo(fo(t)),s=jr();if(r)if(vr(n)){const t=n.anchor,i=t.getNode();if("element"===t.type&&0===t.offset&&n.isCollapsed()&&!Is(i)&&1===Mi().getChildrenSize()&&i.getTopLevelElementOrThrow().isEmpty()&&null!==s&&n.is(s))r.removeAllRanges(),n.dirty=!0;else if(3===e.detail&&!n.isCollapsed()&&i!==n.focus.getNode()){const e=Vo(i,e=>Ts(e)&&!e.isInline());Ts(e)&&e.select(0)}}else if("touch"===e.pointerType||"pen"===e.pointerType){const n=r.anchorNode;(No(n)||pi(n))&&Ii(zr(s,r,t,e))}no(t,ht,e)})}],["cut",tn],["copy",tn],["dragstart",tn],["dragover",tn],["dragend",tn],["paste",tn],["focus",tn],["blur",tn],["drop",tn]];c&&nn.push(["beforeinput",(e,t)=>function(e,t){const n=e.inputType,s=vn(e);if("deleteCompositionText"===n||l&&to(t))return;if("insertCompositionText"===n)return;xs(t,()=>{const i=Ur();if("deleteContentBackward"===n){if(null===i){const e=jr();if(!vr(e))return;Ii(e.clone())}if(vr(i)){const n=i.anchor.key===i.focus.key;if(o=e.timeStamp,"MediaLast"===sn&&o<rn+30&&t.isComposing()&&n){if(vi(null),rn=0,setTimeout(()=>{xs(t,()=>{vi(null)})},30),vr(i)){const e=i.anchor.getNode();e.markDirty(),fr(e)||r("Anchor node must be a TextNode"),wn(i,e)}}else{vi(null),e.preventDefault();const r=i.anchor.getNode(),s=r.getTextContent(),o=r.canInsertTextAfter(),l=0===i.anchor.offset&&i.focus.offset===s.length;let c=f&&n&&!l&&o;if(c&&i.isCollapsed()&&(c=!Ms(eo(i.anchor,!0))),!c){no(t,ft,!0);const e=Ur();f&&vr(e)&&e.isCollapsed()&&(mn=e,setTimeout(()=>mn=null))}}return}}var o;if(!vr(i))return;const l=e.data;null!==ln&&Ki(!1,t,ln),i.dirty&&null===ln||!i.isCollapsed()||Is(i.anchor.getNode())||null===s||i.applyDOMRange(s),ln=null;const c=i.anchor,a=i.focus,u=c.getNode(),h=a.getNode();if("insertText"!==n&&"insertTranspose"!==n)switch(e.preventDefault(),n){case"insertFromYank":case"insertFromDrop":case"insertReplacementText":no(t,mt,e);break;case"insertFromComposition":vi(null),no(t,mt,e);break;case"insertLineBreak":vi(null),no(t,gt,!1);break;case"insertParagraph":vi(null),hn&&!d?(hn=!1,no(t,gt,!1)):no(t,pt,void 0);break;case"insertFromPaste":case"insertFromPasteAsQuotation":no(t,_t,e);break;case"deleteByComposition":(function(e,t){return e!==t||Ts(e)||Ts(t)||!fi(e)||!fi(t)})(u,h)&&no(t,yt,e);break;case"deleteByDrag":case"deleteByCut":no(t,yt,e);break;case"deleteContent":no(t,ft,!1);break;case"deleteWordBackward":no(t,bt,!0);break;case"deleteWordForward":no(t,bt,!1);break;case"deleteHardLineBackward":case"deleteSoftLineBackward":no(t,St,!0);break;case"deleteContentForward":case"deleteHardLineForward":case"deleteSoftLineForward":no(t,St,!1);break;case"formatStrikeThrough":no(t,Ct,"strikethrough");break;case"formatBold":no(t,Ct,"bold");break;case"formatItalic":no(t,Ct,"italic");break;case"formatUnderline":no(t,Ct,"underline");break;case"historyUndo":no(t,wt,void 0);break;case"historyRedo":no(t,vt,void 0)}else{if("\n"===l)e.preventDefault(),no(t,gt,!1);else if(l===B)e.preventDefault(),no(t,pt,void 0);else if(null==l&&e.dataTransfer){const t=e.dataTransfer.getData("text/plain");e.preventDefault(),i.insertRawText(t)}else null!=l&&yn(i,s,l,e.timeStamp,!0)?(e.preventDefault(),no(t,mt,l)):ln=l;on=e.timeStamp}})}(e,t)]);let rn=0,sn=null,on=0,ln=null;const cn=new WeakMap,an=new WeakMap;let dn=!1,un=!1,hn=!1,fn=!1,gn=!1,pn="",mn=null,_n=[0,"",0,"root",0];function yn(e,t,n,r,s){const i=e.anchor,o=e.focus,l=i.getNode(),a=us(),d=vo(fo(a)),u=null!==d?d.anchorNode:null,h=i.key,f=a.getElementByKey(h),g=n.length;return h!==o.key||!fr(l)||(!s&&(!c||on<r+50)||l.isDirty()&&g<2||Li(n))&&i.offset!==o.offset&&!l.isComposing()||gi(l)||l.isDirty()&&g>1||(s||!c)&&null!==f&&!l.isComposing()&&u!==_i(f)||null!==d&&null!==t&&(!t.collapsed||t.startContainer!==d.anchorNode||t.startOffset!==d.anchorOffset)||l.getFormat()!==e.format||l.getStyle()!==e.style||function(e,t){if(t.isSegmented())return!0;if(!e.isCollapsed())return!1;const n=e.anchor.offset,r=t.getParentOrThrow(),s=fi(t);return 0===n?!t.canInsertTextBefore()||!r.canInsertTextBefore()&&!t.isComposing()||s||function(e){const t=e.getPreviousSibling();return(fr(t)||Ts(t)&&t.isInline())&&!t.canInsertTextAfter()}(t):n===t.getTextContentSize()&&(!t.canInsertTextAfter()||!r.canInsertTextAfter()&&!t.isComposing()||s)}(e,l)}function bn(e,t){return pi(e)&&null!==e.nodeValue&&0!==t&&t!==e.nodeValue.length}function Sn(e,t,n){const{anchorNode:s,anchorOffset:i,focusNode:o,focusOffset:l}=e;dn&&(dn=!1,bn(s,i)&&bn(o,l)&&!mn)||xs(t,()=>{if(!n)return void Ii(null);if(!ci(t,s,o))return;let c=Ur();if(mn&&vr(c)&&c.isCollapsed()){const e=c.anchor,t=mn.anchor;(e.key===t.key&&e.offset===t.offset+1||1===e.offset&&t.getNode().is(e.getNode().getPreviousSibling()))&&(c=mn.clone(),Ii(c))}if(mn=null,vr(c)){const n=c.anchor,s=n.getNode();if(c.isCollapsed()){"Range"===e.type&&e.anchorNode===e.focusNode&&(c.dirty=!0);const i=fo(t).event,o=i?i.timeStamp:performance.now(),[l,a,d,u,h]=_n,f=Mi(),g=!1===t.isComposing()&&""===f.getTextContent();if(o<h+200&&n.offset===d&&n.key===u)Cn(c,l,a);else if("text"===n.type)fr(s)||r("Point.getNode() must return TextNode when type is text"),wn(c,s);else if("element"===n.type&&!g){Ts(s)||r("Point.getNode() must return ElementNode when type is element");const e=n.getNode();e.isEmpty()?function(e,t){Cn(e,t.getTextFormat(),t.getTextStyle())}(c,e):Cn(c,0,"")}}else{const e=n.key,t=c.focus.key,r=c.getNodes(),s=r.length,o=c.isBackward(),a=o?l:i,d=o?i:l,u=o?t:e,h=o?e:t;let f=I,g=!1;for(let e=0;e<s;e++){const t=r[e],n=t.getTextContentSize();if(fr(t)&&0!==n&&!(0===e&&t.__key===u&&a===n||e===s-1&&t.__key===h&&0===d)&&(g=!0,f&=t.getFormat(),0===f))break}c.format=g?f:0}}no(t,dt,void 0)})}function Cn(e,t,n){e.format===t&&e.style===n||(e.format=t,e.style=n,e.dirty=!0)}function wn(e,t){Cn(e,t.getFormat(),t.getStyle())}function vn(e){if(!e.getTargetRanges)return null;const t=e.getTargetRanges();return 0===t.length?null:t[0]}function xn(e,t){const n=e._compositionKey;if(vi(null),null!==n&&null!=t){if(""===t){const t=Ei(n),r=_i(e.getElementByKey(n));return void(null!==r&&null!==r.nodeValue&&fr(t)&&zi(t,r.nodeValue,null,null,!0))}if("\n"===t[t.length-1]){const t=Ur();if(vr(t)){const n=t.focus;return t.anchor.set(n.key,n.offset,n.type),void no(e,Mt,null)}}}Ki(!0,e,t)}function En(e){let t=e.__lexicalEventHandles;return void 0===t&&(t=[],e.__lexicalEventHandles=t),t}const kn=new Map;function Nn(e){const t=xo(e.target);if(null===t)return;const n=di(t.anchorNode);if(null===n)return;un&&(un=!1,xs(n,()=>{const r=jr(),s=t.anchorNode;(No(s)||pi(s))&&Ii(zr(r,t,n,e))}));const r=Ri(n),s=r[r.length-1],i=s._key,o=kn.get(i),l=o||s;l!==n&&Sn(t,l,!1),Sn(t,n,!0),n!==s?kn.set(i,n):o&&kn.delete(i)}function Tn(e){e._lexicalHandled=!0}function On(e){return!0===e._lexicalHandled}const An=function(e){{let t=!1;return()=>{t||console.warn(e),t=!0}}}("Root element not registered");function Mn(e){const t=cn.get(e);if(void 0===t)return void An();const n=an.get(t);if(void 0===n)return void An();const s=n-1;s>=0||r("Root element count less than 0"),cn.delete(e),an.set(t,s),0===s&&t.removeEventListener("selectionchange",Nn);const i=ui(e);ai(i)?(!function(e){if(null!==e._parentEditor){const t=Ri(e),n=t[t.length-1]._key;kn.get(n)===e&&kn.delete(n)}else kn.delete(e._key)}(i),e.__lexicalEditor=null):i&&r("Attempted to remove event handlers from a node that does not belong to this build of Lexical");const o=En(e);for(let e=0;e<o.length;e++)o[e]();e.__lexicalEventHandles=[]}function Dn(e,t,n){cs();const r=e.__key,s=e.getParent();if(null===s)return;const i=function(e){const t=Ur();if(!vr(t)||!Ts(e))return t;const{anchor:n,focus:r}=t,s=n.getNode(),i=r.getNode();uo(s,e)&&n.set(e.__key,0,"element");uo(i,e)&&r.set(e.__key,0,"element");return t}(e);let o=!1;if(vr(i)&&t){const t=i.anchor,n=i.focus;t.key===r&&(Hr(t,e,s,e.getPreviousSibling(),e.getNextSibling()),o=!0),n.key===r&&(Hr(n,e,s,e.getPreviousSibling(),e.getNextSibling()),o=!0)}else Er(i)&&t&&e.isSelected()&&e.selectPrevious();if(vr(i)&&t&&!o){const t=e.getIndexWithinParent();Ci(e),Wr(i,s,t,-1)}else Ci(e);n||mo(s)||s.canBeEmpty()||!s.isEmpty()||Dn(s,t),t&&i&&Is(s)&&s.isEmpty()&&s.selectEnd()}function In(e){return e}const Pn=Symbol.for("ephemeral");function Ln(e){return e[Pn]||!1}var Rn=class{__type;__key;__parent;__prev;__next;__state;static getType(){const{ownNodeType:e}=Yo(this);return void 0===e&&r(`LexicalNode: Node ${this.name} does not implement .getType().`),e}static clone(e){r(`LexicalNode: Node ${this.name} does not implement .clone().`)}$config(){return{}}config(e,t){const n=t.extends||Object.getPrototypeOf(this.constructor);return Object.assign(t,{extends:n,type:e}),{[e]:t}}afterCloneFrom(e){this.__key===e.__key?(this.__parent=e.__parent,this.__next=e.__next,this.__prev=e.__prev,this.__state=e.__state):e.__state&&(this.__state=e.__state.getWritable(this))}static importDOM;constructor(e){this.__type=this.constructor.getType(),this.__parent=null,this.__prev=null,this.__next=null,Object.defineProperty(this,"__state",{configurable:!0,enumerable:!1,value:void 0,writable:!0}),Si(this,e),"root"!==this.__type&&function(e,t){const n=si(us(),e);void 0===n&&r(`Create node: Attempted to create node ${t.name} that was not configured to be used on the editor.`);const s=n.klass;s!==t&&r(`Create node: Type ${e} in node ${t.name} does not match registered node ${s.name} with the same type`)}(this.__type,this.constructor)}getType(){return this.__type}isInline(){r(`LexicalNode: Node ${this.constructor.name} does not implement .isInline().`)}isAttached(){let e=this.__key;for(;null!==e;){if("root"===e)return!0;const t=Ei(e);if(null===t)break;e=t.__parent}return!1}isSelected(e){const t=e||Ur();if(null==t)return!1;const n=t.getNodes().some(e=>e.__key===this.__key);if(fr(this))return n;if(vr(t)&&"element"===t.anchor.type&&"element"===t.focus.type){if(t.isCollapsed())return!1;const e=this.getParent();if(Ms(this)&&this.isInline()&&e){const n=t.isBackward()?t.focus:t.anchor;if(e.is(n.getNode())&&n.offset===e.getChildrenSize()&&this.is(e.getLastChild()))return!1}}return n}getKey(){return this.__key}getIndexWithinParent(){const e=this.getParent();if(null===e)return-1;let t=e.getFirstChild(),n=0;for(;null!==t;){if(this.is(t))return n;n++,t=t.getNextSibling()}return-1}getParent(){const e=this.getLatest().__parent;return null===e?null:Ei(e)}getParentOrThrow(){const e=this.getParent();return null===e&&r(`Expected node ${this.__key} to have a parent.`),e}getTopLevelElement(){let e=this;for(;null!==e;){const t=e.getParent();if(mo(t))return Ts(e)||e===this&&Ms(e)||r("Children of root nodes must be elements or decorators"),e;e=t}return null}getTopLevelElementOrThrow(){const e=this.getTopLevelElement();return null===e&&r(`Expected node ${this.__key} to have a top parent element.`),e}getParents(){const e=[];let t=this.getParent();for(;null!==t;)e.push(t),t=t.getParent();return e}getParentKeys(){const e=[];let t=this.getParent();for(;null!==t;)e.push(t.__key),t=t.getParent();return e}getPreviousSibling(){const e=this.getLatest().__prev;return null===e?null:Ei(e)}getPreviousSiblings(){const e=[],t=this.getParent();if(null===t)return e;let n=t.getFirstChild();for(;null!==n&&!n.is(this);)e.push(n),n=n.getNextSibling();return e}getNextSibling(){const e=this.getLatest().__next;return null===e?null:Ei(e)}getNextSiblings(){const e=[];let t=this.getNextSibling();for(;null!==t;)e.push(t),t=t.getNextSibling();return e}getCommonAncestor(e){const t=Ts(this)?this:this.getParent(),n=Ts(e)?e:e.getParent(),r=t&&n?Nl(t,n):null;return r?r.commonAncestor:null}is(e){return null!=e&&this.__key===e.__key}isBefore(e){const t=Nl(this,e);return null!==t&&("descendant"===t.type||("branch"===t.type?-1===xl(t):("same"!==t.type&&"ancestor"!==t.type&&r("LexicalNode.isBefore: exhaustiveness check"),!1)))}isParentOf(e){const t=Nl(this,e);return null!==t&&"ancestor"===t.type}getNodesBetween(e){const t=this.isBefore(e),n=[],s=new Set;let i=this;for(;null!==i;){const o=i.__key;if(s.has(o)||(s.add(o),n.push(i)),i===e)break;const l=Ts(i)?t?i.getFirstChild():i.getLastChild():null;if(null!==l){i=l;continue}const c=t?i.getNextSibling():i.getPreviousSibling();if(null!==c){i=c;continue}const a=i.getParentOrThrow();if(s.has(a.__key)||n.push(a),a===e)break;let d=null,u=a;do{if(null===u&&r("getNodesBetween: ancestor is null"),d=t?u.getNextSibling():u.getPreviousSibling(),u=u.getParent(),null===u)break;null!==d||s.has(u.__key)||n.push(u)}while(null===d);i=d}return t||n.reverse(),n}isDirty(){const e=us()._dirtyLeaves;return null!==e&&e.has(this.__key)}getLatest(){if(Ln(this))return this;const e=Ei(this.__key);return null===e&&r("Lexical node does not exist in active editor state. Avoid using the same node references between nested closures from editorState.read/editor.update."),e}getWritable(){if(Ln(this))return this;cs();const e=ds(),t=us(),n=e._nodeMap,r=this.__key,s=this.getLatest(),i=t._cloneNotNeeded,o=Ur();if(null!==o&&o.setCachedNodes(null),i.has(r))return wi(s),s;const l=$o(s);return i.add(r),wi(l),n.set(r,l),l}getTextContent(){return""}getTextContentSize(){return this.getTextContent().length}createDOM(e,t){r("createDOM: base method not extended")}updateDOM(e,t,n){r("updateDOM: base method not extended")}exportDOM(e){return{element:this.createDOM(e._config,e)}}exportJSON(){const e=this.__state?this.__state.toJSON():void 0;return{type:this.__type,version:1,...e}}static importJSON(e){r(`LexicalNode: Node ${this.name} does not implement .importJSON().`)}updateFromJSON(e){return function(e,t){const n=e.getWritable(),r=t[X];let s=r;for(const e of be(n).flatKeys)e in t&&(void 0!==s&&s!==r||(s={...r}),s[e]=t[e]);return(n.__state||s)&&ye(e).updateFromJSON(s),n}(this,e)}static transform(){return null}remove(e){Dn(this,!0,e)}replace(e,t){cs();let n=Ur();null!==n&&(n=n.clone()),bo(this,e);const s=this.getLatest(),i=this.__key,o=e.__key,l=e.getWritable(),c=this.getParentOrThrow().getWritable(),a=c.__size;Ci(l);const d=s.getPreviousSibling(),u=s.getNextSibling(),h=s.__prev,f=s.__next,g=s.__parent;if(Dn(s,!1,!0),null===d)c.__first=o;else{d.getWritable().__next=o}if(l.__prev=h,null===u)c.__last=o;else{u.getWritable().__prev=o}if(l.__next=f,l.__parent=g,c.__size=a,t&&(Ts(this)&&Ts(l)||r("includeChildren should only be true for ElementNodes"),this.getChildren().forEach(e=>{l.append(e)})),vr(n)){Ii(n);const e=n.anchor,t=n.focus;e.key===i&&Cr(e,l),t.key===i&&Cr(t,l)}return xi()===i&&vi(o),l}insertAfter(e,t=!0){cs(),bo(this,e);const n=this.getWritable(),r=e.getWritable(),s=r.getParent(),i=Ur();let o=!1,l=!1;if(null!==s){const t=e.getIndexWithinParent();if(Ci(r),vr(i)){const e=s.__key,n=i.anchor,r=i.focus;o="element"===n.type&&n.key===e&&n.offset===t+1,l="element"===r.type&&r.key===e&&r.offset===t+1}}const c=this.getNextSibling(),a=this.getParentOrThrow().getWritable(),d=r.__key,u=n.__next;if(null===c)a.__last=d;else{c.getWritable().__prev=d}if(a.__size++,n.__next=d,r.__next=u,r.__prev=n.__key,r.__parent=n.__parent,t&&vr(i)){const e=this.getIndexWithinParent();Wr(i,a,e+1);const t=a.__key;o&&i.anchor.set(t,e+2,"element"),l&&i.focus.set(t,e+2,"element")}return e}insertBefore(e,t=!0){cs(),bo(this,e);const n=this.getWritable(),r=e.getWritable(),s=r.__key;Ci(r);const i=this.getPreviousSibling(),o=this.getParentOrThrow().getWritable(),l=n.__prev,c=this.getIndexWithinParent();if(null===i)o.__first=s;else{i.getWritable().__next=s}o.__size++,n.__prev=s,r.__prev=l,r.__next=n.__key,r.__parent=n.__parent;const a=Ur();return t&&vr(a)&&Wr(a,this.getParentOrThrow(),c),e}isParentRequired(){return!1}createParentElementNode(){return Us()}selectStart(){return this.selectPrevious()}selectEnd(){return this.selectNext(0,0)}selectPrevious(e,t){cs();const n=this.getPreviousSibling(),r=this.getParentOrThrow();if(null===n)return r.select(0,0);if(Ts(n))return n.select();if(!fr(n)){const e=n.getIndexWithinParent()+1;return r.select(e,e)}return n.select(e,t)}selectNext(e,t){cs();const n=this.getNextSibling(),r=this.getParentOrThrow();if(null===n)return r.select();if(Ts(n))return n.select(0,0);if(!fr(n)){const e=n.getIndexWithinParent();return r.select(e,e)}return n.select(e,t)}markDirty(){this.getWritable()}reconcileObservedMutation(e,t){this.markDirty()}};const $n="historic",Fn="history-push",Kn="history-merge",zn="paste",Bn="collaboration",Un="skip-collab",jn="skip-scroll-into-view",Wn="skip-dom-selection",Yn="skip-selection-focus";var Hn=class e extends Rn{static getType(){return"linebreak"}static clone(t){return new e(t.__key)}constructor(e){super(e)}getTextContent(){return"\n"}createDOM(){return document.createElement("br")}updateDOM(){return!1}isInline(){return!0}static importDOM(){return{br:e=>function(e){const t=e.parentElement;if(null!==t&&Mo(t)){const n=t.firstChild;if(n===e||n.nextSibling===e&&Gn(n)){const n=t.lastChild;if(n===e||n.previousSibling===e&&Gn(n))return!0}}return!1}(e)||function(e){const t=e.parentElement;if(null!==t&&Mo(t)){const n=t.firstChild;if(n===e||n.nextSibling===e&&Gn(n))return!1;const r=t.lastChild;if(r===e||r.previousSibling===e&&Gn(r))return!0}return!1}(e)?null:{conversion:Vn,priority:0}}}static importJSON(e){return Jn().updateFromJSON(e)}};function Vn(e){return{node:Jn()}}function Jn(){return yo(new Hn)}function qn(e){return e instanceof Hn}function Gn(e){return pi(e)&&/^( |\t|\r?\n)+$/.test(e.textContent||"")}function Xn(e,t){return t&O?"code":t&D?"mark":t&A?"sub":t&M?"sup":null}function Qn(e,t){return t&E?"strong":t&k?"em":"span"}function Zn(e,t,n,r,s){const i=r.classList;let o=Gi(s,"base");void 0!==o&&i.add(...o),o=Gi(s,"underlineStrikethrough");let l=!1;const c=t&T&&t&N;void 0!==o&&(n&T&&n&N?(l=!0,c||i.add(...o)):c&&i.remove(...o));for(const e in Y){const r=Y[e];if(o=Gi(s,e),void 0!==o)if(n&r){if(l&&("underline"===e||"strikethrough"===e)){t&r&&i.remove(...o);continue}(0===(t&r)||c&&"underline"===e||"strikethrough"===e)&&i.add(...o)}else t&r&&i.remove(...o)}}function er(e,t,n){const r=t.firstChild,s=n.isComposing(),i=e+(s?z:"");if(null==r)t.textContent=i;else{const e=r.nodeValue;if(e!==i)if(s||l){const[t,n,s]=function(e,t){const n=e.length,r=t.length;let s=0,i=0;for(;s<n&&s<r&&e[s]===t[s];)s++;for(;i+s<n&&i+s<r&&e[n-i-1]===t[r-i-1];)i++;return[s,n-s-i,t.slice(s,r-i)]}(e,i);0!==n&&r.deleteData(t,n),r.insertData(t,s)}else r.nodeValue=i}}function tr(e,t,n,r,s,i){er(s,e,t);const o=i.theme.text;void 0!==o&&Zn(0,0,r,e,o)}function nr(e,t){const n=document.createElement(t);return n.appendChild(e),n}var rr=class e extends Rn{__text;__format;__style;__mode;__detail;static getType(){return"text"}static clone(t){return new e(t.__text,t.__key)}afterCloneFrom(e){super.afterCloneFrom(e),this.__text=e.__text,this.__format=e.__format,this.__style=e.__style,this.__mode=e.__mode,this.__detail=e.__detail}constructor(e="",t){super(t),this.__text=e,this.__format=0,this.__style="",this.__mode=0,this.__detail=0}getFormat(){return this.getLatest().__format}getDetail(){return this.getLatest().__detail}getMode(){return G[this.getLatest().__mode]}getStyle(){return this.getLatest().__style}isToken(){return 1===this.getLatest().__mode}isComposing(){return this.__key===xi()}isSegmented(){return 2===this.getLatest().__mode}isDirectionless(){return!!(1&this.getLatest().__detail)}isUnmergeable(){return!!(2&this.getLatest().__detail)}hasFormat(e){const t=Y[e];return 0!==(this.getFormat()&t)}isSimpleText(){return"text"===this.__type&&0===this.__mode}getTextContent(){return this.getLatest().__text}getFormatFlags(e,t){return yi(this.getLatest().__format,e,t)}canHaveFormat(){return!0}isInline(){return!0}createDOM(e,t){const n=this.__format,r=Xn(0,n),s=Qn(0,n),i=null===r?s:r,o=document.createElement(i);let l=o;this.hasFormat("code")&&o.setAttribute("spellcheck","false"),null!==r&&(l=document.createElement(s),o.appendChild(l));tr(l,this,0,n,this.__text,e);const c=this.__style;return""!==c&&(o.style.cssText=c),o}updateDOM(e,t,n){const s=this.__text,i=e.__format,o=this.__format,l=Xn(0,i),c=Xn(0,o),a=Qn(0,i),d=Qn(0,o);if((null===l?a:l)!==(null===c?d:c))return!0;if(l===c&&a!==d){const e=t.firstChild;null==e&&r("updateDOM: prevInnerDOM is null or undefined");const i=document.createElement(d);return tr(i,this,0,o,s,n),t.replaceChild(i,e),!1}let u=t;null!==c&&null!==l&&(u=t.firstChild,null==u&&r("updateDOM: innerDOM is null or undefined")),er(s,u,this);const h=n.theme.text;void 0!==h&&i!==o&&Zn(0,i,o,u,h);const f=e.__style,g=this.__style;return f!==g&&(t.style.cssText=g),!1}static importDOM(){return{"#text":()=>({conversion:cr,priority:0}),b:()=>({conversion:ir,priority:0}),code:()=>({conversion:ur,priority:0}),em:()=>({conversion:ur,priority:0}),i:()=>({conversion:ur,priority:0}),mark:()=>({conversion:ur,priority:0}),s:()=>({conversion:ur,priority:0}),span:()=>({conversion:sr,priority:0}),strong:()=>({conversion:ur,priority:0}),sub:()=>({conversion:ur,priority:0}),sup:()=>({conversion:ur,priority:0}),u:()=>({conversion:ur,priority:0})}}static importJSON(e){return hr().updateFromJSON(e)}updateFromJSON(e){return super.updateFromJSON(e).setTextContent(e.text).setFormat(e.format).setDetail(e.detail).setMode(e.mode).setStyle(e.style)}exportDOM(e){let{element:t}=super.exportDOM(e);return No(t)||r("Expected TextNode createDOM to always return a HTMLElement"),t.style.whiteSpace="pre-wrap",this.hasFormat("lowercase")?t.style.textTransform="lowercase":this.hasFormat("uppercase")?t.style.textTransform="uppercase":this.hasFormat("capitalize")&&(t.style.textTransform="capitalize"),this.hasFormat("bold")&&(t=nr(t,"b")),this.hasFormat("italic")&&(t=nr(t,"i")),this.hasFormat("strikethrough")&&(t=nr(t,"s")),this.hasFormat("underline")&&(t=nr(t,"u")),{element:t}}exportJSON(){return{detail:this.getDetail(),format:this.getFormat(),mode:this.getMode(),style:this.getStyle(),text:this.getTextContent(),...super.exportJSON()}}selectionTransform(e,t){}setFormat(e){const t=this.getWritable();return t.__format="string"==typeof e?Y[e]:e,t}setDetail(e){const t=this.getWritable();return t.__detail="string"==typeof e?H[e]:e,t}setStyle(e){const t=this.getWritable();return t.__style=e,t}toggleFormat(e){const t=yi(this.getFormat(),e,null);return this.setFormat(t)}toggleDirectionless(){const e=this.getWritable();return e.__detail^=1,e}toggleUnmergeable(){const e=this.getWritable();return e.__detail^=2,e}setMode(e){const t=q[e];if(this.__mode===t)return this;const n=this.getWritable();return n.__mode=t,n}setTextContent(e){if(this.__text===e)return this;const t=this.getWritable();return t.__text=e,t}select(e,t){cs();let n=e,r=t;const s=Ur(),i=this.getTextContent(),o=this.__key;if("string"==typeof i){const e=i.length;void 0===n&&(n=e),void 0===r&&(r=e)}else n=0,r=0;if(!vr(s))return Rr(o,n,o,r,"text","text");{const e=xi();e!==s.anchor.key&&e!==s.focus.key||vi(o),s.setTextNodeRange(this,n,this,r)}return s}selectStart(){return this.select(0,0)}selectEnd(){const e=this.getTextContentSize();return this.select(e,e)}spliceText(e,t,n,r){const s=this.getWritable(),i=s.__text,o=n.length;let l=e;l<0&&(l=o+l,l<0&&(l=0));const c=Ur();if(r&&vr(c)){const t=e+o;c.setTextNodeRange(s,t,s,t)}return s.__text=i.slice(0,l)+n+i.slice(l+t),s}canInsertTextBefore(){return!0}canInsertTextAfter(){return!0}splitText(...e){cs();const t=this.getLatest(),n=t.getTextContent();if(""===n)return[];const r=t.__key,s=xi(),i=n.length;e.sort((e,t)=>e-t),e.push(i);const o=[],l=e.length;for(let t=0,r=0;t<i&&r<=l;r++){const s=e[r];s>t&&(o.push(n.slice(t,s)),t=s)}const c=o.length;if(1===c)return[t];const a=o[0],d=t.getParent();let u;const h=t.getFormat(),f=t.getStyle(),g=t.__detail;let p=!1,m=null,_=null;const y=Ur();if(vr(y)){const[e,t]=y.isBackward()?[y.focus,y.anchor]:[y.anchor,y.focus];"text"===e.type&&e.key===r&&(m=e),"text"===t.type&&t.key===r&&(_=t)}t.isSegmented()?(u=hr(a),u.__format=h,u.__style=f,u.__detail=g,u.__state=xe(t,u),p=!0):u=t.setTextContent(a);const b=[u];for(let e=1;e<c;e++){const n=hr(o[e]);n.__format=h,n.__style=f,n.__detail=g,n.__state=xe(t,n);const i=n.__key;s===r&&vi(i),b.push(n)}const S=m?m.offset:null,C=_?_.offset:null;let w=0;for(const e of b){if(!m&&!_)break;const t=w+e.getTextContentSize();if(null!==m&&null!==S&&S<=t&&S>=w&&(m.set(e.getKey(),S-w,"text"),S<t&&(m=null)),null!==_&&null!==C&&C<=t&&C>=w){_.set(e.getKey(),C-w,"text");break}w=t}if(null!==d){!function(e){const t=e.getPreviousSibling(),n=e.getNextSibling();null!==t&&wi(t);null!==n&&wi(n)}(this);const e=d.getWritable(),t=this.getIndexWithinParent();p?(e.splice(t,0,b),this.remove()):e.splice(t,1,b),vr(y)&&Wr(y,d,t,c-1)}return b}mergeWithSibling(e){const t=e===this.getPreviousSibling();t||e===this.getNextSibling()||r("mergeWithSibling: sibling must be a previous or next sibling");const n=this.__key,s=e.__key,i=this.__text,o=i.length;xi()===s&&vi(n);const l=Ur();if(vr(l)){const r=l.anchor,i=l.focus;null!==r&&r.key===s&&Vr(r,t,n,e,o),null!==i&&i.key===s&&Vr(i,t,n,e,o)}const c=e.__text,a=t?c+i:i+c;this.setTextContent(a);const d=this.getWritable();return e.remove(),d}isTextEntity(){return!1}};function sr(e){return{forChild:gr(e.style),node:null}}function ir(e){const t=e,n="normal"===t.style.fontWeight;return{forChild:gr(t.style,n?void 0:"bold"),node:null}}const or=new WeakMap;function lr(e){if(!No(e))return!1;if("PRE"===e.nodeName)return!0;const t=e.style.whiteSpace;return"string"==typeof t&&t.startsWith("pre")}function cr(e){const t=e;null===e.parentElement&&r("Expected parentElement of Text not to be null");let n=t.textContent||"";if(null!==function(e){let t,n=e.parentNode;const r=[e];for(;null!==n&&void 0===(t=or.get(n))&&!lr(n);)r.push(n),n=n.parentNode;const s=void 0===t?n:t;for(let e=0;e<r.length;e++)or.set(r[e],s);return s}(t)){const e=n.split(/(\r?\n|\t)/),t=[],r=e.length;for(let n=0;n<r;n++){const r=e[n];"\n"===r||"\r\n"===r?t.push(Jn()):"\t"===r?t.push(mr()):""!==r&&t.push(hr(r))}return{node:t}}if(n=n.replace(/\r/g,"").replace(/[ \t\n]+/g," "),""===n)return{node:null};if(" "===n[0]){let e=t,r=!0;for(;null!==e&&null!==(e=ar(e,!1));){const t=e.textContent||"";if(t.length>0){/[ \t\n]$/.test(t)&&(n=n.slice(1)),r=!1;break}}r&&(n=n.slice(1))}if(" "===n[n.length-1]){let e=t,r=!0;for(;null!==e&&null!==(e=ar(e,!0));)if((e.textContent||"").replace(/^( |\t|\r?\n)+/,"").length>0){r=!1;break}r&&(n=n.slice(0,n.length-1))}return""===n?{node:null}:{node:hr(n)}}function ar(e,t){let n=e;for(;;){let e;for(;null===(e=t?n.nextSibling:n.previousSibling);){const e=n.parentElement;if(null===e)return null;n=e}if(n=e,No(n)){const e=n.style.display;if(""===e&&!Ao(n)||""!==e&&!e.startsWith("inline"))return null}let r=n;for(;null!==(r=t?n.firstChild:n.lastChild);)n=r;if(pi(n))return n;if("BR"===n.nodeName)return null}}const dr={code:"code",em:"italic",i:"italic",mark:"highlight",s:"strikethrough",strong:"bold",sub:"subscript",sup:"superscript",u:"underline"};function ur(e){const t=dr[e.nodeName.toLowerCase()];return void 0===t?{node:null}:{forChild:gr(e.style,t),node:null}}function hr(e=""){return yo(new rr(e))}function fr(e){return e instanceof rr}function gr(e,t){const n=e.fontWeight,r=e.textDecoration.split(" "),s="700"===n||"bold"===n,i=r.includes("line-through"),o="italic"===e.fontStyle,l=r.includes("underline"),c=e.verticalAlign;return e=>fr(e)?(s&&!e.hasFormat("bold")&&e.toggleFormat("bold"),i&&!e.hasFormat("strikethrough")&&e.toggleFormat("strikethrough"),o&&!e.hasFormat("italic")&&e.toggleFormat("italic"),l&&!e.hasFormat("underline")&&e.toggleFormat("underline"),"sub"!==c||e.hasFormat("subscript")||e.toggleFormat("subscript"),"super"!==c||e.hasFormat("superscript")||e.toggleFormat("superscript"),t&&!e.hasFormat(t)&&e.toggleFormat(t),e):e}var pr=class e extends rr{static getType(){return"tab"}static clone(t){return new e(t.__key)}constructor(e){super("\t",e),this.__detail=2}static importDOM(){return null}createDOM(e){const t=super.createDOM(e),n=Gi(e.theme,"tab");return void 0!==n&&t.classList.add(...n),t}static importJSON(e){return mr().updateFromJSON(e)}setTextContent(e){return"\t"!==e&&""!==e&&r("TabNode does not support setTextContent"),super.setTextContent("\t")}spliceText(e,t,n,s){return""===n&&0===t||"\t"===n&&1===t||r("TabNode does not support spliceText"),this}setDetail(e){return 2!==e&&r("TabNode does not support setDetail"),this}setMode(e){return"normal"!==e&&r("TabNode does not support setMode"),this}canInsertTextBefore(){return!1}canInsertTextAfter(){return!1}};function mr(){return yo(new pr)}function _r(e){return e instanceof pr}var yr=class{key;offset;type;_selection;constructor(e,t,n){Object.defineProperty(this,"_selection",{enumerable:!1,writable:!0}),this._selection=null,this.key=e,this.offset=t,this.type=n}is(e){return this.key===e.key&&this.offset===e.offset&&this.type===e.type}isBefore(e){return this.key===e.key?this.offset<e.offset:vl($l(Tl(this,"next")),$l(Tl(e,"next")))<0}getNode(){const e=Ei(this.key);return null===e&&r("Point.getNode: node not found"),e}set(e,t,n,s){const i=this._selection,o=this.key;if(!s||this.key!==e||this.offset!==t||this.type!==n){this.key=e,this.offset=t,this.type=n;{const t=Ei(e);("text"===n?fr(t):Ts(t))||r(`PointType.set: node with key ${e} is ${t?t.__type:"[not found]"} and can not be used for a ${n} point`)}ls()||(xi()===o&&vi(e),null!==i&&(i.setCachedNodes(null),i.dirty=!0))}}};function br(e,t,n){return new yr(e,t,n)}function Sr(e,t){let n=t.__key,r=e.offset,s="element";if(fr(t)){s="text";const e=t.getTextContentSize();r>e&&(r=e)}else if(!Ts(t)){const e=t.getNextSibling();if(fr(e))n=e.__key,r=0,s="text";else{const e=t.getParent();e&&(n=e.__key,r=t.getIndexWithinParent()+1)}}e.set(n,r,s)}function Cr(e,t){if(Ts(t)){const n=t.getLastDescendant();Ts(n)||fr(n)?Sr(e,n):Sr(e,t)}else Sr(e,t)}var wr=class e{_nodes;_cachedNodes;dirty;constructor(e){this._cachedNodes=null,this._nodes=e,this.dirty=!1}getCachedNodes(){return this._cachedNodes}setCachedNodes(e){this._cachedNodes=e}is(e){if(!Er(e))return!1;const t=this._nodes,n=e._nodes;return t.size===n.size&&Array.from(t).every(e=>n.has(e))}isCollapsed(){return!1}isBackward(){return!1}getStartEndPoints(){return null}add(e){this.dirty=!0,this._nodes.add(e),this._cachedNodes=null}delete(e){this.dirty=!0,this._nodes.delete(e),this._cachedNodes=null}clear(){this.dirty=!0,this._nodes.clear(),this._cachedNodes=null}has(e){return this._nodes.has(e)}clone(){return new e(new Set(this._nodes))}extract(){return this.getNodes()}insertRawText(e){}insertText(){}insertNodes(e){const t=this.getNodes(),n=t.length,r=t[n-1];let s;if(fr(r))s=r.select();else{const e=r.getIndexWithinParent()+1;s=r.getParentOrThrow().select(e,e)}s.insertNodes(e);for(let e=0;e<n;e++)t[e].remove()}getNodes(){const e=this._cachedNodes;if(null!==e)return e;const t=this._nodes,n=[];for(const e of t){const t=Ei(e);null!==t&&n.push(t)}return ls()||(this._cachedNodes=n),n}getTextContent(){const e=this.getNodes();let t="";for(let n=0;n<e.length;n++)t+=e[n].getTextContent();return t}deleteNodes(){const e=this.getNodes();if((Ur()||jr())===this&&e[0]){const t=al(e[0],"next");Al(Cl(t,t))}for(const t of e)t.remove()}};function vr(e){return e instanceof xr}var xr=class e{format;style;anchor;focus;_cachedNodes;dirty;constructor(e,t,n,r){this.anchor=e,this.focus=t,e._selection=this,t._selection=this,this._cachedNodes=null,this.format=n,this.style=r,this.dirty=!1}getCachedNodes(){return this._cachedNodes}setCachedNodes(e){this._cachedNodes=e}is(e){return!!vr(e)&&(this.anchor.is(e.anchor)&&this.focus.is(e.focus)&&this.format===e.format&&this.style===e.style)}isCollapsed(){return this.anchor.is(this.focus)}getNodes(){const e=this._cachedNodes;if(null!==e)return e;const t=function(e){const t=[],[n,r]=e.getTextSlices();n&&t.push(n.caret.origin);const s=new Set,i=new Set;for(const n of e)if(il(n)){const{origin:e}=n;0===t.length?s.add(e):(i.add(e),t.push(e))}else{const{origin:e}=n;Ts(e)&&i.has(e)||t.push(e)}r&&t.push(r.caret.origin);if(sl(e.focus)&&Ts(e.focus.origin)&&null===e.focus.getNodeAtCaret())for(let n=fl(e.focus.origin,"previous");il(n)&&s.has(n.origin)&&!n.origin.isEmpty()&&n.origin.is(t[t.length-1]);n=pl(n))s.delete(n.origin),t.pop();for(;t.length>1;){const e=t[t.length-1];if(!Ts(e)||i.has(e)||e.isEmpty()||s.has(e))break;t.pop()}if(0===t.length&&e.isCollapsed()){const n=$l(e.anchor),r=$l(e.anchor.getFlipped()),s=e=>nl(e)?e.origin:e.getNodeAtCaret(),i=s(n)||s(r)||(e.anchor.getNodeAtCaret()?n.origin:r.origin);t.push(i)}return t}(zl(Dl(this),"next"));return this.isCollapsed()&&t.length>1&&r(`RangeSelection.getNodes() returned ${String(t.length)} > 1 nodes in a collapsed selection`),ls()||(this._cachedNodes=t),t}setTextNodeRange(e,t,n,r){this.anchor.set(e.__key,t,"text"),this.focus.set(n.__key,r,"text")}getTextContent(){const e=this.getNodes();if(0===e.length)return"";const t=e[0],n=e[e.length-1],r=this.anchor,s=this.focus,i=r.isBefore(s),[o,l]=Nr(this);let c="",a=!0;for(let d=0;d<e.length;d++){const u=e[d];if(Ts(u)&&!u.isInline())a||(c+="\n"),a=!u.isEmpty();else if(a=!1,fr(u)){let e=u.getTextContent();u===t?u===n?"element"===r.type&&"element"===s.type&&s.offset!==r.offset||(e=o<l?e.slice(o,l):e.slice(l,o)):e=i?e.slice(o):e.slice(l):u===n&&(e=i?e.slice(0,l):e.slice(0,o)),c+=e}else!Ms(u)&&!qn(u)||u===n&&this.isCollapsed()||(c+=u.getTextContent())}return c}applyDOMRange(e){const t=us(),n=t.getEditorState()._selection,r=Pr(e.startContainer,e.startOffset,e.endContainer,e.endOffset,t,n);if(null===r)return;const[s,i]=r;this.anchor.set(s.key,s.offset,s.type,!0),this.focus.set(i.key,i.offset,i.type,!0),Te(this)}clone(){const t=this.anchor,n=this.focus;return new e(br(t.key,t.offset,t.type),br(n.key,n.offset,n.type),this.format,this.style)}toggleFormat(e){this.format=yi(this.format,e,null),this.dirty=!0}setFormat(e){this.format=e,this.dirty=!0}setStyle(e){this.style=e,this.dirty=!0}hasFormat(e){const t=Y[e];return 0!==(this.format&t)}insertRawText(e){const t=e.split(/(\r?\n|\t)/),n=[],r=t.length;for(let e=0;e<r;e++){const r=t[e];"\n"===r||"\r\n"===r?n.push(Jn()):"\t"===r?n.push(mr()):n.push(hr(r))}this.insertNodes(n)}insertText(e){const t=this.anchor,n=this.focus,s=this.format,i=this.style;let o=t,l=n;!this.isCollapsed()&&n.isBefore(t)&&(o=n,l=t),"element"===o.type&&function(e,t,n,r){const s=e.getNode(),i=s.getChildAtIndex(e.offset),o=hr();if(o.setFormat(n),o.setStyle(r),js(i))i.splice(0,0,[o]);else{const e=Is(s)?Us().append(o):o;null===i?s.append(e):i.insertBefore(e)}e.is(t)&&t.set(o.__key,0,"text"),e.set(o.__key,0,"text")}(o,l,s,i),"element"===l.type&&Ol(l,$l(Tl(l,"next")));const c=o.offset;let a=l.offset;const d=this.getNodes(),u=d.length;let h=d[0];fr(h)||r("insertText: first node is not a text node");const f=h.getTextContent().length,g=h.getParentOrThrow();let p=d[u-1];if(1===u&&"element"===l.type&&(a=f,l.set(o.key,a,"text")),this.isCollapsed()&&c===f&&(gi(h)||!h.canInsertTextAfter()||!g.canInsertTextAfter()&&null===h.getNextSibling())){let t=h.getNextSibling();if(fr(t)&&t.canInsertTextBefore()&&!gi(t)||(t=hr(),t.setFormat(s),t.setStyle(i),g.canInsertTextAfter()?h.insertAfter(t):g.insertAfter(t)),t.select(0,0),h=t,""!==e)return void this.insertText(e)}else if(this.isCollapsed()&&0===c&&(gi(h)||!h.canInsertTextBefore()||!g.canInsertTextBefore()&&null===h.getPreviousSibling())){let t=h.getPreviousSibling();if(fr(t)&&!gi(t)||(t=hr(),t.setFormat(s),g.canInsertTextBefore()?h.insertBefore(t):g.insertBefore(t)),t.select(),h=t,""!==e)return void this.insertText(e)}else if(h.isSegmented()&&c!==f){const e=hr(h.getTextContent());e.setFormat(s),h.replace(e),h=e}else if(!this.isCollapsed()&&""!==e){const t=p.getParent();if(!g.canInsertTextBefore()||!g.canInsertTextAfter()||Ts(t)&&(!t.canInsertTextBefore()||!t.canInsertTextAfter()))return this.insertText(""),Ir(this.anchor,this.focus,null),void this.insertText(e)}if(1===u){if(fi(h)){const t=hr(e);return t.select(),void h.replace(t)}const t=h.getFormat(),n=h.getStyle();if(c!==a||t===s&&n===i){if(_r(h)){const t=hr(e);return t.setFormat(s),t.setStyle(i),t.select(),void h.replace(t)}}else{if(""!==h.getTextContent()){const t=hr(e);if(t.setFormat(s),t.setStyle(i),t.select(),0===c)h.insertBefore(t,!1);else{const[e]=h.splitText(c);e.insertAfter(t,!1)}return void(t.isComposing()&&"text"===this.anchor.type&&(this.anchor.offset-=e.length))}h.setFormat(s),h.setStyle(i)}const r=a-c;h=h.spliceText(c,r,e,!0),""===h.getTextContent()?h.remove():"text"===this.anchor.type&&(h.isComposing()?this.anchor.offset-=e.length:(this.format=t,this.style=n))}else{const t=new Set([...h.getParentKeys(),...p.getParentKeys()]),n=Ts(h)?h:h.getParentOrThrow();let r=Ts(p)?p:p.getParentOrThrow(),s=p;if(!n.is(r)&&r.isInline())do{s=r,r=r.getParentOrThrow()}while(r.isInline());if("text"===l.type&&(0!==a||""===p.getTextContent())||"element"===l.type&&p.getIndexWithinParent()<a)if(fr(p)&&!fi(p)&&a!==p.getTextContentSize()){if(p.isSegmented()){const e=hr(p.getTextContent());p.replace(e),p=e}Is(l.getNode())||"text"!==l.type||(p=p.spliceText(0,a,"")),t.add(p.__key)}else{const e=p.getParentOrThrow();e.canBeEmpty()||1!==e.getChildrenSize()?p.remove():e.remove()}else t.add(p.__key);const i=r.getChildren(),o=new Set(d),g=n.is(r),m=n.isInline()&&null===h.getNextSibling()?n:h;for(let e=i.length-1;e>=0;e--){const t=i[e];if(t.is(h)||Ts(t)&&t.isParentOf(h))break;t.isAttached()&&(!o.has(t)||t.is(s)?g||m.insertAfter(t,!1):t.remove())}if(!g){let e=r,n=null;for(;null!==e;){const r=e.getChildren(),s=r.length;(0===s||r[s-1].is(n))&&(t.delete(e.__key),n=e),e=e.getParent()}}if(fi(h))if(c===f)h.select();else{const t=hr(e);t.select(),h.replace(t)}else h=h.spliceText(c,f-c,e,!0),""===h.getTextContent()?h.remove():h.isComposing()&&"text"===this.anchor.type&&(this.anchor.offset-=e.length);for(let e=1;e<u;e++){const n=d[e],r=n.__key;t.has(r)||n.remove()}}}removeText(){const e=Ur()===this;Ml(this,Rl(Dl(this))),e&&Ur()!==this&&Ii(this)}formatText(e,t=null){if(this.isCollapsed())return this.toggleFormat(e),void vi(null);const n=this.getNodes(),r=[];for(const e of n)fr(e)&&r.push(e);const s=t=>{n.forEach(n=>{if(Ts(n)){const r=n.getFormatFlags(e,t);n.setTextFormat(r)}})},i=r.length;if(0===i)return this.toggleFormat(e),vi(null),void s(t);const o=this.anchor,l=this.focus,c=this.isBackward(),a=c?l:o,d=c?o:l;let u=0,h=r[0],f="element"===a.type?0:a.offset;if("text"===a.type&&f===h.getTextContentSize()&&(u=1,h=r[1],f=0),null==h)return;const g=h.getFormatFlags(e,t);s(g);const p=i-1;let m=r[p];const _="text"===d.type?d.offset:m.getTextContentSize();if(h.is(m)){if(f===_)return;if(gi(h)||0===f&&_===h.getTextContentSize())h.setFormat(g);else{const e=h.splitText(f,_),t=0===f?e[0]:e[1];t.setFormat(g),"text"===a.type&&a.set(t.__key,0,"text"),"text"===d.type&&d.set(t.__key,_-f,"text")}return void(this.format=g)}0===f||gi(h)||([,h]=h.splitText(f),f=0),h.setFormat(g);const y=m.getFormatFlags(e,g);_>0&&(_===m.getTextContentSize()||gi(m)||([m]=m.splitText(_)),m.setFormat(y));for(let t=u+1;t<p;t++){const n=r[t],s=n.getFormatFlags(e,y);n.setFormat(s)}"text"===a.type&&a.set(h.__key,f,"text"),"text"===d.type&&d.set(m.__key,_,"text"),this.format=g|y}insertNodes(e){if(0===e.length)return;if(this.isCollapsed()||this.removeText(),"root"===this.anchor.key){this.insertParagraph();const t=Ur();return vr(t)||r("Expected RangeSelection after insertParagraph"),t.insertNodes(e)}const t=(this.isBackward()?this.focus:this.anchor).getNode(),n=Vo(t,Do),s=e[e.length-1];if(Ts(n)&&"__language"in n){if("__language"in e[0])this.insertText(e[0].getTextContent());else{const t=Qr(this);n.splice(t,0,e),s.selectEnd()}return}if(!e.some(e=>(Ts(e)||Ms(e))&&!e.isInline())){Ts(n)||r(`Expected node ${t.constructor.name} of type ${t.getType()} to have a block ElementNode ancestor`);const i=Qr(this);return n.splice(i,0,e),void s.selectEnd()}const i=function(e){const t=Us();let n=null;for(let r=0;r<e.length;r++){const s=e[r],i=qn(s);if(i||Ms(s)&&s.isInline()||Ts(s)&&s.isInline()||fr(s)||s.isParentRequired()){if(null===n&&(n=s.createParentElementNode(),t.append(n),i))continue;null!==n&&n.append(s)}else t.append(s),n=null}return t}(e),o=i.getLastDescendant(),l=i.getChildren(),c=Ts(n)&&n.isEmpty()?null:this.insertParagraph(),a=l[l.length-1];let d=l[0];var u;Ts(u=d)&&Do(u)&&!u.isEmpty()&&Ts(n)&&(!n.isEmpty()||n.canMergeWhenEmpty())&&(Ts(n)||r(`Expected node ${t.constructor.name} of type ${t.getType()} to have a block ElementNode ancestor`),n.append(...d.getChildren()),d=l[1]),d&&(null===n&&r(`Expected node ${t.constructor.name} of type ${t.getType()} to have a block ancestor`),function(e,t){const n=t.getParentOrThrow().getLastChild();let s=t;const i=[t];for(;s!==n;)s.getNextSibling()||r("insertRangeAfter: lastToInsert must be a later sibling of firstToInsert"),s=s.getNextSibling(),i.push(s);let o=e;for(const e of i)o=o.insertAfter(e)}(n,d));const h=Vo(o,Do);c&&Ts(h)&&(c.canMergeWhenEmpty()||Do(a))&&(h.append(...c.getChildren()),c.remove()),Ts(n)&&n.isEmpty()&&n.remove(),o.selectEnd();const f=Ts(n)?n.getLastChild():null;qn(f)&&h!==n&&f.remove()}insertParagraph(){if("root"===this.anchor.key){const e=Us();return Mi().splice(this.anchor.offset,0,[e]),e.select(),e}const e=Qr(this),t=Vo(this.anchor.getNode(),Do);Ts(t)||r("Expected ancestor to be a block ElementNode");const n=t.getChildAtIndex(e),s=n?[n,...n.getNextSiblings()]:[],i=t.insertNewAfter(this,!1);return i?(i.append(...s),i.selectStart(),i):null}insertLineBreak(e){const t=Jn();if(this.insertNodes([t]),e){const e=t.getParentOrThrow(),n=t.getIndexWithinParent();e.select(n,n)}}extract(){const e=[...this.getNodes()],t=e.length;let n=e[0],r=e[t-1];const[s,i]=Nr(this),o=this.isBackward(),[l,c]=o?[this.focus,this.anchor]:[this.anchor,this.focus],[a,d]=o?[i,s]:[s,i];if(0===t)return[];if(1===t){if(fr(n)&&!this.isCollapsed()){const e=n.splitText(a,d),t=0===a?e[0]:e[1];return t?(l.set(t.getKey(),0,"text"),c.set(t.getKey(),t.getTextContentSize(),"text"),[t]):[]}return[n]}if(fr(n)&&(a===n.getTextContentSize()?e.shift():0!==a&&([,n]=n.splitText(a),e[0]=n,l.set(n.getKey(),0,"text"))),fr(r)){const t=r.getTextContent().length;0===d?e.pop():d!==t&&([r]=r.splitText(d),e[e.length-1]=r,c.set(r.getKey(),r.getTextContentSize(),"text"))}return e}modify(e,t,n){if(es(this,e,t,n))return;const r="move"===e,s=us(),i=vo(fo(s));if(!i)return;const o=s._blockCursorElement,l=s._rootElement,c=this.focus.getNode();if(null===l||null===o||!Ts(c)||c.isInline()||c.canBeEmpty()||wo(o,s,l),this.dirty){let e=so(s,this.anchor.key),t=so(s,this.focus.key);"text"===this.anchor.type&&(e=_i(e)),"text"===this.focus.type&&(t=_i(t)),e&&t&&Jr(i,e,this.anchor.offset,t,this.focus.offset)}if(function(e,t,n,r){e.modify(t,n,r)}(i,e,t?"backward":"forward",n),i.rangeCount>0){const e=i.getRangeAt(0),n=this.anchor.getNode(),s=Is(n)?n:po(n);if(this.applyDOMRange(e),this.dirty=!0,!r){const n=this.getNodes(),r=[];let o=!1;for(let e=0;e<n.length;e++){const t=n[e];uo(t,s)?r.push(t):o=!0}if(o&&r.length>0)if(t){const e=r[0];Ts(e)?e.selectStart():e.getParentOrThrow().selectStart()}else{const e=r[r.length-1];Ts(e)?e.selectEnd():e.getParentOrThrow().selectEnd()}i.anchorNode===e.startContainer&&i.anchorOffset===e.startOffset||function(e){const t=e.focus,n=e.anchor,r=n.key,s=n.offset,i=n.type;n.set(t.key,t.offset,t.type,!0),t.set(r,s,i,!0)}(this)}}"lineboundary"===n&&es(this,e,t,n,"decorators")}forwardDeletion(e,t,n){if(!n&&("element"===e.type&&Ts(t)&&e.offset===t.getChildrenSize()||"text"===e.type&&e.offset===t.getTextContentSize())){const e=t.getParent(),n=t.getNextSibling()||(null===e?null:e.getNextSibling());if(Ts(n)&&n.isShadowRoot())return!0}return!1}deleteCharacter(e){const t=this.isCollapsed();if(this.isCollapsed()){const t=this.anchor;let n=t.getNode();if(this.forwardDeletion(t,n,e))return;const s=bl(Tl(t,e?"previous":"next"));if(s.getTextSlices().every(e=>null===e||0===e.distance)){let e={type:"initial"};for(const t of s.iterNodeCarets("shadowRoot"))if(il(t))if(t.origin.isInline());else{if(t.origin.isShadowRoot()){if("merge-block"===e.type)break;if(Ts(s.anchor.origin)&&s.anchor.origin.isEmpty()){const e=$l(t);Ml(this,Cl(e,e)),s.anchor.origin.remove()}return}"merge-next-block"!==e.type&&"merge-block"!==e.type||(e={block:e.block,caret:t,type:"merge-block"})}else{if("merge-block"===e.type)break;if(sl(t)){if(Ts(t.origin)){if(t.origin.isInline()){if(!t.origin.isParentOf(s.anchor.origin))break}else e={block:t.origin,type:"merge-next-block"};continue}if(Ms(t.origin)){if(t.origin.isIsolated());else if("merge-next-block"===e.type&&(t.origin.isKeyboardSelectable()||!t.origin.isInline())&&Ts(s.anchor.origin)&&s.anchor.origin.isEmpty()){s.anchor.origin.remove();const e=Fr();e.add(t.origin.getKey()),Ii(e)}else t.origin.remove();return}break}}if("merge-block"===e.type){const{caret:t,block:n}=e;return Ml(this,Cl(!t.origin.isEmpty()&&n.isEmpty()?Il(al(n,t.direction)):s.anchor,t)),this.removeText()}}const i=this.focus;if(this.modify("extend",e,"character"),this.isCollapsed()){if(e&&0===t.offset&&Tr(this,t.getNode()))return}else{const s="text"===i.type?i.getNode():null;if(n="text"===t.type?t.getNode():null,null!==s&&s.isSegmented()){const t=i.offset,r=s.getTextContentSize();if(s.is(n)||e&&t!==r||!e&&0!==t)return void Ar(s,e,t)}else if(null!==n&&n.isSegmented()){const r=t.offset,i=n.getTextContentSize();if(n.is(s)||e&&0!==r||!e&&r!==i)return void Ar(n,e,r)}!function(e,t){const n=e.anchor,s=e.focus,i=n.getNode();if(i===s.getNode()&&"text"===n.type&&"text"===s.type){const e=n.offset,o=s.offset,l=e<o,c=l?e:o,a=l?o:e,d=a-1;c!==d&&function(e){e.length>1||r("shouldDeleteExactlyOneCodeUnit: expecting to be called only with sequences of two or more code units");return!(Li(e)||Or(e))}(i.getTextContent().slice(c,a))&&(t?s.set(s.key,d,s.type):n.set(n.key,d,n.type))}}(this,e)}}if(this.removeText(),e&&!t&&this.isCollapsed()&&"element"===this.anchor.type&&0===this.anchor.offset){const e=this.anchor.getNode();e.isEmpty()&&Is(e.getParent())&&null===e.getPreviousSibling()&&Tr(this,e)}}deleteLine(e){this.isCollapsed()&&this.modify("extend",e,"lineboundary"),this.isCollapsed()?this.deleteCharacter(e):this.removeText()}deleteWord(e){if(this.isCollapsed()){const t=this.anchor,n=t.getNode();if(this.forwardDeletion(t,n,e))return;this.modify("extend",e,"word")}this.removeText()}isBackward(){return this.focus.isBefore(this.anchor)}getStartEndPoints(){return[this.anchor,this.focus]}};function Er(e){return e instanceof wr}function kr(e){const t=e.offset;if("text"===e.type)return t;const n=e.getNode();return t===n.getChildrenSize()?n.getTextContent().length:0}function Nr(e){const t=e.getStartEndPoints();if(null===t)return[0,0];const[n,r]=t;return"element"===n.type&&"element"===r.type&&n.key===r.key&&n.offset===r.offset?[0,0]:[kr(n),kr(r)]}function Tr(e,t){for(let n=t;n;n=n.getParent()){if(Ts(n)){if(n.collapseAtStart(e))return!0;if(mo(n))break}if(n.getPreviousSibling())break}return!1}const Or=(()=>{try{const e=new RegExp("\\p{Emoji}","u"),t=e.test.bind(e);if(t("❤️")&&t("#️⃣")&&t("👍"))return t}catch(e){}return()=>!1})();function Ar(e,t,n){const r=e,s=r.getTextContent().split(/(?=\s)/g),i=s.length;let o=0,l=0;for(let e=0;e<i;e++){const r=e===i-1;if(l=o,o+=s[e].length,t&&o===n||o>n||r){s.splice(e,1),r&&(l=void 0);break}}const c=s.join("").trim();""===c?r.remove():(r.setTextContent(c),r.select(l,l))}function Mr(e,t,n,s){let i,o=t;if(No(e)){let l=!1;const c=e.childNodes,a=c.length,d=s._blockCursorElement;o===a&&(l=!0,o=a-1);let u=c[o],h=!1;if(u===d)u=c[o+1],h=!0;else if(null!==d){const n=d.parentNode;e===n&&t>Array.prototype.indexOf.call(n.children,d)&&o--}if(i=Pi(u),fr(i))o=ul(i,l?"next":"previous");else{let c=Pi(e);if(null===c)return null;if(Ts(c)){const a=s.getElementByKey(c.getKey());null===a&&r("$internalResolveSelectionPoint: node in DOM but not keyToDOMMap");const d=c.getDOMSlot(a);[c,o]=d.resolveChildIndex(c,a,e,t),Ts(c)||r("$internalResolveSelectionPoint: resolvedElement is not an ElementNode"),l&&o>=c.getChildrenSize()&&(o=Math.max(0,c.getChildrenSize()-1));let u=c.getChildAtIndex(o);if(Ts(u)&&function(e,t,n){const r=e.getParent();return null===n||null===r||!r.canBeEmpty()||r!==n.getNode()}(u,0,n)){const e=l?u.getLastDescendant():u.getFirstDescendant();null===e?c=u:(u=e,c=Ts(u)?u:u.getParentOrThrow()),o=0}fr(u)?(i=u,c=null,o=ul(u,l?"next":"previous")):u!==c&&l&&!h&&(Ts(c)||r("invariant"),o=Math.min(c.getChildrenSize(),o+1))}else{const n=c.getIndexWithinParent();o=0===t&&Ms(c)&&Pi(e)===c?n:n+1,c=c.getParentOrThrow()}if(Ts(c))return br(c.__key,o,"element")}}else i=Pi(e);return fr(i)?br(i.__key,ul(i,o,"clamp"),"text"):null}function Dr(e,t,n){const r=e.offset,s=e.getNode();if(0===r){const r=s.getPreviousSibling(),i=s.getParent();if(t){if((n||!t)&&null===r&&Ts(i)&&i.isInline()){const t=i.getPreviousSibling();fr(t)&&e.set(t.__key,t.getTextContent().length,"text")}}else Ts(r)&&!n&&r.isInline()?e.set(r.__key,r.getChildrenSize(),"element"):fr(r)&&e.set(r.__key,r.getTextContent().length,"text")}else if(r===s.getTextContent().length){const r=s.getNextSibling(),i=s.getParent();if(t&&Ts(r)&&r.isInline())e.set(r.__key,0,"element");else if((n||t)&&null===r&&Ts(i)&&i.isInline()&&!i.canInsertTextAfter()){const t=i.getNextSibling();fr(t)&&e.set(t.__key,0,"text")}}}function Ir(e,t,n){if("text"===e.type&&"text"===t.type){const r=e.isBefore(t),s=e.is(t);Dr(e,r,s),Dr(t,!r,s),s&&t.set(e.key,e.offset,e.type);const i=us();if(i.isComposing()&&i._compositionKey!==e.key&&vr(n)){const r=n.anchor,s=n.focus;e.set(r.key,r.offset,r.type,!0),t.set(s.key,s.offset,s.type,!0)}}}function Pr(e,t,n,r,s,i){if(null===e||null===n||!ci(s,e,n))return null;const o=Mr(e,t,vr(i)?i.anchor:null,s);if(null===o)return null;const l=Mr(n,r,vr(i)?i.focus:null,s);if(null===l)return null;if(Br("anchor",o),Br("focus",l),"element"===o.type&&"element"===l.type){const t=Pi(e),r=Pi(n);if(Ms(t)&&Ms(r))return null}return Ir(o,l,i),[o,l]}function Lr(e){return Ts(e)&&!e.isInline()}function Rr(e,t,n,r,s,i){const o=ds(),l=new xr(br(e,t,s),br(n,r,i),0,"");return l.dirty=!0,o._selection=l,l}function $r(){return new xr(br("root",0,"element"),br("root",0,"element"),0,"")}function Fr(){return new wr(new Set)}function Kr(e,t){return zr(null,e,t,null)}function zr(e,t,n,r){const s=n._window;if(null===s)return null;const i=r||s.event,o=i?i.type:void 0,l="selectionchange"===o,c=!ee&&(l||"beforeinput"===o||"compositionstart"===o||"compositionend"===o||"click"===o&&i&&3===i.detail||"drop"===o||void 0===o);let a,d,u,h;if(vr(e)&&!c)return e.clone();if(null===t)return null;if(a=t.anchorNode,d=t.focusNode,u=t.anchorOffset,h=t.focusOffset,(l||void 0===o)&&vr(e)&&!ci(n,a,d))return e.clone();const f=Pr(a,u,d,h,n,e);if(null===f)return null;const[g,p]=f;return new xr(g,p,vr(e)?e.format:0,vr(e)?e.style:"")}function Br(e,t){const n=Ei(t.key);if(void 0===n&&r(`$validatePoint: ${e} key ${t.key} not found in current editorState`),"text"===t.type){fr(n)||r(`$validatePoint: ${e} key ${t.key} is not a TextNode`);const s=n.getTextContentSize();t.offset<=s||r(`$validatePoint: ${e} point.offset > node.getTextContentSize() (${String(t.offset)} > ${String(s)})`)}else{Ts(n)||r(`$validatePoint: ${e} key ${t.key} is not an ElementNode`);const s=n.getChildrenSize();t.offset<=s||r(`$validatePoint: ${e} point.offset > node.getChildrenSize() (${String(t.offset)} > ${String(s)})`)}}function Ur(){return ds()._selection}function jr(){return us()._editorState._selection}function Wr(e,t,n,r=1){const s=e.anchor,i=e.focus,o=s.getNode(),l=i.getNode();if(!t.is(o)&&!t.is(l))return;const c=t.__key;if(e.isCollapsed()){const t=s.offset;if(n<=t&&r>0||n<t&&r<0){const n=Math.max(0,t+r);s.set(c,n,"element"),i.set(c,n,"element"),Yr(e)}}else{const o=e.isBackward(),l=o?i:s,a=l.getNode(),d=o?s:i,u=d.getNode();if(t.is(a)){const e=l.offset;(n<=e&&r>0||n<e&&r<0)&&l.set(c,Math.max(0,e+r),"element")}if(t.is(u)){const e=d.offset;(n<=e&&r>0||n<e&&r<0)&&d.set(c,Math.max(0,e+r),"element")}}Yr(e)}function Yr(e){const t=e.anchor,n=t.offset,r=e.focus,s=r.offset,i=t.getNode(),o=r.getNode();if(e.isCollapsed()){if(!Ts(i))return;const e=i.getChildrenSize(),s=n>=e,o=s?i.getChildAtIndex(e-1):i.getChildAtIndex(n);if(fr(o)){let e=0;s&&(e=o.getTextContentSize()),t.set(o.__key,e,"text"),r.set(o.__key,e,"text")}return}if(Ts(i)){const e=i.getChildrenSize(),r=n>=e,s=r?i.getChildAtIndex(e-1):i.getChildAtIndex(n);if(fr(s)){let e=0;r&&(e=s.getTextContentSize()),t.set(s.__key,e,"text")}}if(Ts(o)){const e=o.getChildrenSize(),t=s>=e,n=t?o.getChildAtIndex(e-1):o.getChildAtIndex(s);if(fr(n)){let e=0;t&&(e=n.getTextContentSize()),r.set(n.__key,e,"text")}}}function Hr(e,t,n,r,s){let i=null,o=0,l=null;null!==r?(i=r.__key,fr(r)?(o=r.getTextContentSize(),l="text"):Ts(r)&&(o=r.getChildrenSize(),l="element")):null!==s&&(i=s.__key,fr(s)?l="text":Ts(s)&&(l="element")),null!==i&&null!==l?e.set(i,o,l):(o=t.getIndexWithinParent(),-1===o&&(o=n.getChildrenSize()),e.set(n.__key,o,"element"))}function Vr(e,t,n,r,s){"text"===e.type?e.set(n,e.offset+(t?0:s),"text"):e.offset>r.getIndexWithinParent()&&e.set(e.key,e.offset-1,"element")}function Jr(e,t,n,r,s){try{e.setBaseAndExtent(t,n,r,s)}catch(e){console.warn(e)}}function qr(e,t,n,r,s,i,o){const l=r.anchorNode,c=r.focusNode,a=r.anchorOffset,d=r.focusOffset,u=document.activeElement;if(s.has(Bn)&&u!==i||null!==u&&li(u))return;if(!vr(t))return void(null!==e&&ci(n,l,c)&&r.removeAllRanges());const h=t.anchor,f=t.focus,g=h.key,p=f.key,m=so(n,g),_=so(n,p),y=h.offset,b=f.offset,S=t.format,C=t.style,w=t.isCollapsed();let v=m,x=_,E=!1;if("text"===h.type){v=_i(m);const e=h.getNode();E=e.getFormat()!==S||e.getStyle()!==C}else vr(e)&&"text"===e.anchor.type&&(E=!0);var k,N,T,O,A;if(("text"===f.type&&(x=_i(_)),null!==v&&null!==x)&&(w&&(null===e||E||vr(e)&&(e.format!==S||e.style!==C))&&(k=S,N=C,T=y,O=g,A=performance.now(),_n=[k,N,T,O,A]),a!==y||d!==b||l!==v||c!==x||"Range"===r.type&&w||(null!==u&&i.contains(u)||s.has(Yn)||i.focus({preventScroll:!0}),"element"===h.type))){if(Jr(r,v,y,x,b),!s.has(jn)&&t.isCollapsed()&&null!==i&&i===document.activeElement){const e=vr(t)&&"element"===t.anchor.type?v.childNodes[y]||null:r.rangeCount>0?r.getRangeAt(0):null;if(null!==e){let t;if(e instanceof Text){const n=document.createRange();n.selectNode(e),t=n.getBoundingClientRect()}else t=e.getBoundingClientRect();!function(e,t,n){const r=oo(n),s=ho(r);if(null===r||null===s)return;let{top:i,bottom:o}=t,l=0,c=0,a=n;for(;null!==a;){const t=a===r.body;if(t)l=0,c=fo(e).innerHeight;else{const e=a.getBoundingClientRect();l=e.top,c=e.bottom}let n=0;if(i<l?n=-(l-i):o>c&&(n=o-c),0!==n)if(t)s.scrollBy(0,n);else{const e=a.scrollTop;a.scrollTop+=n;const t=a.scrollTop-e;i-=t,o-=t}if(t)break;a=io(a)}}(n,t,i)}}dn=!0}}function Gr(e){let t=Ur()||jr();null===t&&(t=Mi().selectEnd()),t.insertNodes(e)}function Xr(){const e=Ur();return null===e?"":e.getTextContent()}function Qr(e){let t=e;e.isCollapsed()||t.removeText();const n=Ur();vr(n)&&(t=n),vr(t)||r("Unexpected dirty selection to be null");const s=t.anchor;let i=s.getNode(),o=s.offset;for(;!Do(i);){const e=i;if([i,o]=Zr(i,o),e.is(i))break}return o}function Zr(e,t){const n=e.getParent();if(!n){const e=Us();return Mi().append(e),e.select(),[Mi(),0]}if(fr(e)){const r=e.splitText(t);if(0===r.length)return[n,e.getIndexWithinParent()];const s=0===t?0:1;return[n,r[0].getIndexWithinParent()+s]}if(!Ts(e)||0===t)return[n,e.getIndexWithinParent()];const r=e.getChildAtIndex(t);if(r){const n=new xr(br(e.__key,t,"element"),br(e.__key,t,"element"),0,""),s=e.insertNewAfter(n);s&&s.append(r,...r.getNextSiblings())}return[n,e.getIndexWithinParent()+1]}function es(e,t,n,r,s="decorators-and-blocks"){if("move"===t&&"character"===r&&!e.isCollapsed()){const[t,r]=n===e.isBackward()?[e.focus,e.anchor]:[e.anchor,e.focus];return r.set(t.key,t.offset,t.type),!0}const i=Tl(e.focus,n?"previous":"next"),o="lineboundary"===r,l="move"===t;let c=i,a="decorators-and-blocks"===s;if(!Fl(c)){for(const e of c){a=!1;const{origin:t}=e;if(!Ms(t)||t.isIsolated()||(c=e,!o||!t.isInline()))break}if(a)for(const e of bl(i).iterNodeCarets("extend"===t?"shadowRoot":"root")){if(il(e))e.origin.isInline()||(c=e);else{if(Ts(e.origin))continue;Ms(e.origin)&&!e.origin.isInline()&&(c=e)}break}}if(c===i)return!1;if(l&&!o&&Ms(c.origin)&&c.origin.isKeyboardSelectable()){const e=Fr();return e.add(c.origin.getKey()),Ii(e),!0}return c=$l(c),l&&Ol(e.anchor,c),Ol(e.focus,c),a||!o}let ts=null,ns=null,rs=!1,ss=!1,is=0;const os={characterData:!0,childList:!0,subtree:!0};function ls(){return rs||null!==ts&&ts._readOnly}function cs(){rs&&r("Cannot use method in read-only mode.")}function as(){is>99&&r("One or more transforms are endlessly triggering additional transforms. May have encountered infinite recursion caused by transforms that have their preconditions too lose and/or conflict with each other.")}function ds(){return null===ts&&r(`Unable to find an active editor state. State helpers or node methods can only be used synchronously during the callback of editor.update(), editor.read(), or editorState.read().${hs()}`),ts}function us(){return null===ns&&r(`Unable to find an active editor. This method can only be used synchronously during the callback of editor.update() or editor.read().${hs()}`),ns}function hs(){let e=0;const t=new Set,n=Qs.version;if("undefined"!=typeof window)for(const r of document.querySelectorAll("[contenteditable]")){const s=ui(r);if(ai(s))e++;else if(s){let e=String(s.constructor.version||"<0.17.1");e===n&&(e+=" (separately built, likely a bundler configuration issue)"),t.add(e)}}let r=` Detected on the page: ${e} compatible editor(s) with version ${n}`;return t.size&&(r+=` and incompatible editors with versions ${Array.from(t).join(", ")}`),r}function fs(e,t,n){const r=t.__type,s=ri(e,r);let i=n.get(r);void 0===i&&(i=Array.from(s.transforms),n.set(r,i));const o=i.length;for(let e=0;e<o&&(i[e](t),t.isAttached());e++);}function gs(e,t){return void 0!==e&&e.__key!==t&&e.isAttached()}function ps(e,t){if(!t)return;const n=e._updateTags;let r=t;Array.isArray(t)||(r=[t]);for(const e of r)n.add(e)}function ms(e){return _s(e,us()._nodes)}function _s(e,t){const n=e.type,s=t.get(n);void 0===s&&r(`parseEditorState: type "${n}" + not found`);const i=s.klass;e.type!==i.getType()&&r(`LexicalNode: Node ${i.name} does not implement .importJSON().`);const o=i.importJSON(e),l=e.children;if(Ts(o)&&Array.isArray(l))for(let e=0;e<l.length;e++){const n=_s(l[e],t);o.append(n)}return o}function ys(e,t,n){const r=ts,s=rs,i=ns;ts=t,rs=!0,ns=e;try{return n()}finally{ts=r,rs=s,ns=i}}function bs(e){const t=e._nodeMap;t.set=()=>{throw new Error("Cannot call set() on a frozen Lexical node map")},t.clear=()=>{throw new Error("Cannot call clear() on a frozen Lexical node map")},t.delete=()=>{throw new Error("Cannot call delete() on a frozen Lexical node map")}}function Ss(e,t){const n=e._pendingEditorState,r=e._rootElement,s=e._headless||null===r;if(null===n)return;const i=e._editorState,o=i._selection,l=n._selection,c=0!==e._dirtyType,a=ts,d=rs,u=ns,h=e._updating,f=e._observer;let g=null;if(e._pendingEditorState=null,e._editorState=n,!s&&c&&null!==f){ns=e,ts=n,rs=!1,e._updating=!0;try{const t=e._dirtyType,r=e._dirtyElements,s=e._dirtyLeaves;f.disconnect(),g=function(e,t,n,r,s,i){ze="",je="",We=r===C,Me=n,Ae=n._config,De=n._nodes,Ie=Me._listeners.mutation,Pe=s,Le=i,Re=e._nodeMap,$e=t._nodeMap,Ye=t._readOnly,Fe=new Map(n._keyToDOMMap);const o=new Map;return Ke=o,it("root",null),Me=void 0,De=void 0,Pe=void 0,Le=void 0,Re=void 0,$e=void 0,Ae=void 0,Fe=void 0,Ke=void 0,o}(i,n,e,t,r,s)}catch(t){if(t instanceof Error&&e._onError(t),ss)throw t;return qs(e,null,r,n),ae(e),e._dirtyType=C,ss=!0,Ss(e,i),void(ss=!1)}finally{f.observe(r,os),e._updating=h,ts=a,rs=d,ns=u}}n._readOnly||(n._readOnly=!0,bs(n),vr(l)&&(Object.freeze(l.anchor),Object.freeze(l.focus)),Object.freeze(l));const m=e._dirtyLeaves,_=e._dirtyElements,y=e._normalizedNodes,b=e._updateTags,S=e._deferred;c&&(e._dirtyType=0,e._cloneNotNeeded.clear(),e._dirtyLeaves=new Set,e._dirtyElements=new Map,e._normalizedNodes=new Set,e._updateTags=new Set),function(e,t){const n=e._decorators;let r=e._pendingDecorators||n;const s=t._nodeMap;let i;for(i in r)s.has(i)||(r===n&&(r=Oi(e)),delete r[i])}(e,n);const w=s?null:vo(fo(e));if(e._editable&&null!==w&&(c||null===l||l.dirty||!l.is(o))&&null!==r&&!b.has(Wn)){ns=e,ts=n;try{if(null!==f&&f.disconnect(),c||null===l||l.dirty){const t=e._blockCursorElement;null!==t&&wo(t,e,r),qr(o,l,e,w,b,r)}!function(e,t,n){let r=e._blockCursorElement;if(vr(n)&&n.isCollapsed()&&"element"===n.anchor.type&&t.contains(document.activeElement)){const s=n.anchor,i=s.getNode(),o=s.offset;let l=!1,c=null;if(o===i.getChildrenSize())Co(i.getChildAtIndex(o-1))&&(l=!0);else{const t=i.getChildAtIndex(o);if(null!==t&&Co(t)){const n=t.getPreviousSibling();(null===n||Co(n))&&(l=!0,c=e.getElementByKey(t.__key))}}if(l){const n=e.getElementByKey(i.__key);return null===r&&(e._blockCursorElement=r=function(e){const t=e.theme,n=document.createElement("div");n.contentEditable="false",n.setAttribute("data-lexical-cursor","true");let r=t.blockCursor;void 0!==r&&("string"==typeof r&&(r=t.blockCursor=p(r)),void 0!==r&&n.classList.add(...r));return n}(e._config)),t.style.caretColor="transparent",void(null===c?n.appendChild(r):n.insertBefore(r,c))}}null!==r&&wo(r,e,t)}(e,r,l)}finally{null!==f&&f.observe(r,os),ns=u,ts=a}}null!==g&&function(e,t,n,r,s){const i=Array.from(e._listeners.mutation),o=i.length;for(let e=0;e<o;e++){const[o,l]=i[e];for(const e of l){const i=t.get(e);void 0!==i&&o(i,{dirtyLeaves:r,prevEditorState:s,updateTags:n})}}}(e,g,b,m,i),vr(l)||null===l||null!==o&&o.is(l)||e.dispatchCommand(dt,void 0);const v=e._pendingDecorators;null!==v&&(e._decorators=v,e._pendingDecorators=null,Cs("decorator",e,!0,v)),function(e,t,n){const r=Ai(t),s=Ai(n);r!==s&&Cs("textcontent",e,!0,s)}(e,t||i,n),Cs("update",e,!0,{dirtyElements:_,dirtyLeaves:m,editorState:n,mutatedNodes:g,normalizedNodes:y,prevEditorState:t||i,tags:b}),function(e,t){if(e._deferred=[],0!==t.length){const n=e._updating;e._updating=!0;try{for(let e=0;e<t.length;e++)t[e]()}finally{e._updating=n}}}(e,S),function(e){const t=e._updates;if(0!==t.length){const n=t.shift();if(n){const[t,r]=n;vs(e,t,r)}}}(e)}function Cs(e,t,n,...r){const s=t._updating;t._updating=n;try{const n=Array.from(t._listeners[e]);for(let e=0;e<n.length;e++)n[e].apply(null,r)}finally{t._updating=s}}function ws(e,t){const n=e._updates;let s=t||!1;for(;0!==n.length;){const t=n.shift();if(t){const[n,i]=t,o=e._pendingEditorState;let l;void 0!==i&&(l=i.onUpdate,i.skipTransforms&&(s=!0),i.discrete&&(null===o&&r("Unexpected empty pending editor state on discrete nested update"),o._flushSync=!0),l&&e._deferred.push(l),ps(e,i.tag)),null==o?vs(e,n,i):n()}}return s}function vs(e,t,n){const s=e._updateTags;let i,o=!1,l=!1;void 0!==n&&(i=n.onUpdate,ps(e,n.tag),o=n.skipTransforms||!1,l=n.discrete||!1),i&&e._deferred.push(i);const c=e._editorState;let a=e._pendingEditorState,d=!1;(null===a||a._readOnly)&&(a=e._pendingEditorState=Ps(a||c),d=!0),a._flushSync=l;const u=ts,h=rs,f=ns,g=e._updating;ts=a,rs=!1,e._updating=!0,ns=e;const p=e._headless||null===e.getRootElement();ei(null);try{d&&(p?null!==c._selection&&(a._selection=c._selection.clone()):a._selection=function(e,t){const n=e.getEditorState()._selection,r=vo(fo(e));return vr(n)||null==n?zr(n,r,e,t):n.clone()}(e,n&&n.event||null));const s=e._compositionKey;t(),o=ws(e,o),function(e,t){const n=t.getEditorState()._selection,r=e._selection;if(vr(r)){const e=r.anchor,t=r.focus;let s;if("text"===e.type&&(s=e.getNode(),s.selectionTransform(n,r)),"text"===t.type){const e=t.getNode();s!==e&&e.selectionTransform(n,r)}}}(a,e),0!==e._dirtyType&&(o?function(e,t){const n=t._dirtyLeaves,r=e._nodeMap;for(const e of n){const t=r.get(e);fr(t)&&t.isAttached()&&t.isSimpleText()&&!t.isUnmergeable()&&Ne(t)}}(a,e):function(e,t){const n=t._dirtyLeaves,r=t._dirtyElements,s=e._nodeMap,i=xi(),o=new Map;let l=n,c=l.size,a=r,d=a.size;for(;c>0||d>0;){if(c>0){t._dirtyLeaves=new Set;for(const e of l){const r=s.get(e);fr(r)&&r.isAttached()&&r.isSimpleText()&&!r.isUnmergeable()&&Ne(r),void 0!==r&&gs(r,i)&&fs(t,r,o),n.add(e)}if(l=t._dirtyLeaves,c=l.size,c>0){is++;continue}}t._dirtyLeaves=new Set,t._dirtyElements=new Map,a.delete("root")&&a.set("root",!0);for(const e of a){const n=e[0],l=e[1];if(r.set(n,l),!l)continue;const c=s.get(n);void 0!==c&&gs(c,i)&&fs(t,c,o)}l=t._dirtyLeaves,c=l.size,a=t._dirtyElements,d=a.size,is++}t._dirtyLeaves=n,t._dirtyElements=r}(a,e),ws(e),function(e,t,n,r){const s=e._nodeMap,i=t._nodeMap,o=[];for(const[e]of r){const t=i.get(e);void 0!==t&&(t.isAttached()||(Ts(t)&&Z(t,e,s,i,o,r),s.has(e)||r.delete(e),o.push(e)))}for(const e of o)i.delete(e);for(const e of n){const t=i.get(e);void 0===t||t.isAttached()||(s.has(e)||n.delete(e),i.delete(e))}}(c,a,e._dirtyLeaves,e._dirtyElements)),s!==e._compositionKey&&(a._flushSync=!0);const i=a._selection;if(vr(i)){const e=a._nodeMap,t=i.anchor.key,n=i.focus.key;void 0!==e.get(t)&&void 0!==e.get(n)||r("updateEditor: selection has been lost because the previously selected nodes have been removed and selection wasn't moved to another node. Ensure selection changes after removing/replacing a selected node.")}else Er(i)&&0===i._nodes.size&&(a._selection=null)}catch(t){return t instanceof Error&&e._onError(t),e._pendingEditorState=c,e._dirtyType=C,e._cloneNotNeeded.clear(),e._dirtyLeaves=new Set,e._dirtyElements.clear(),void Ss(e)}finally{ts=u,rs=h,ns=f,e._updating=g,is=0}0!==e._dirtyType||e._deferred.length>0||function(e,t){const n=t.getEditorState()._selection,r=e._selection;if(null!==r){if(r.dirty||!r.is(n))return!0}else if(null!==n)return!0;return!1}(a,e)?a._flushSync?(a._flushSync=!1,Ss(e)):d&&ii(()=>{Ss(e)}):(a._flushSync=!1,d&&(s.clear(),e._deferred=[],e._pendingEditorState=null))}function xs(e,t,n){ns===e&&void 0===n?t():vs(e,t,n)}var Es=class e{element;before;after;constructor(e,t,n){this.element=e,this.before=t||null,this.after=n||null}withBefore(t){return new e(this.element,t,this.after)}withAfter(t){return new e(this.element,this.before,t)}withElement(t){return this.element===t?this:new e(t,this.before,this.after)}insertChild(e){const t=this.before||this.getManagedLineBreak();return null!==t&&t.parentElement!==this.element&&r("ElementDOMSlot.insertChild: before is not in element"),this.element.insertBefore(e,t),this}removeChild(e){return e.parentElement!==this.element&&r("ElementDOMSlot.removeChild: dom is not in element"),this.element.removeChild(e),this}replaceChild(e,t){return t.parentElement!==this.element&&r("ElementDOMSlot.replaceChild: prevDom is not in element"),this.element.replaceChild(e,t),this}getFirstChild(){const e=this.after?this.after.nextSibling:this.element.firstChild;return e===this.before||e===this.getManagedLineBreak()?null:e}getManagedLineBreak(){return this.element.__lexicalLineBreak||null}setManagedLineBreak(e){if(null===e)this.removeManagedLineBreak();else{const t="decorator"===e&&(g||d||a);this.insertManagedLineBreak(t)}}removeManagedLineBreak(){const e=this.getManagedLineBreak();if(e){const t=this.element,n="IMG"===e.nodeName?e.nextSibling:null;n&&t.removeChild(n),t.removeChild(e),t.__lexicalLineBreak=void 0}}insertManagedLineBreak(e){const t=this.getManagedLineBreak();if(t){if(e===("IMG"===t.nodeName))return;this.removeManagedLineBreak()}const n=this.element,r=this.before,s=document.createElement("br");if(n.insertBefore(s,r),e){const e=document.createElement("img");e.setAttribute("data-lexical-linebreak","true"),e.style.cssText="display: inline !important; border: 0px !important; margin: 0px !important;",e.alt="",n.insertBefore(e,s),n.__lexicalLineBreak=e}else n.__lexicalLineBreak=s}getFirstChildOffset(){let e=0;for(let t=this.after;null!==t;t=t.previousSibling)e++;return e}resolveChildIndex(e,t,n,r){if(n===this.element){const t=this.getFirstChildOffset();return[e,Math.min(t+e.getChildrenSize(),Math.max(t,r))]}const s=ks(t,n);s.push(r);const i=ks(t,this.element);let o=e.getIndexWithinParent();for(let e=0;e<i.length;e++){const t=s[e],n=i[e];if(void 0===t||t<n)break;if(t>n){o+=1;break}}return[e.getParentOrThrow(),o]}};function ks(e,t){const n=[];let s=t;for(;s!==e&&null!==s;s=s.parentNode){let e=0;for(let t=s.previousSibling;null!==t;t=t.previousSibling)e++;n.push(e)}return s!==e&&r("indexPath: root is not a parent of child"),n.reverse()}var Ns=class extends Rn{__first;__last;__size;__format;__style;__indent;__dir;__textFormat;__textStyle;constructor(e){super(e),this.__first=null,this.__last=null,this.__size=0,this.__format=0,this.__style="",this.__indent=0,this.__dir=null,this.__textFormat=0,this.__textStyle=""}afterCloneFrom(e){super.afterCloneFrom(e),this.__key===e.__key&&(this.__first=e.__first,this.__last=e.__last,this.__size=e.__size),this.__indent=e.__indent,this.__format=e.__format,this.__style=e.__style,this.__dir=e.__dir,this.__textFormat=e.__textFormat,this.__textStyle=e.__textStyle}getFormat(){return this.getLatest().__format}getFormatType(){return J[this.getFormat()]||""}getStyle(){return this.getLatest().__style}getIndent(){return this.getLatest().__indent}getChildren(){const e=[];let t=this.getFirstChild();for(;null!==t;)e.push(t),t=t.getNextSibling();return e}getChildrenKeys(){const e=[];let t=this.getFirstChild();for(;null!==t;)e.push(t.__key),t=t.getNextSibling();return e}getChildrenSize(){return this.getLatest().__size}isEmpty(){return 0===this.getChildrenSize()}isDirty(){const e=us()._dirtyElements;return null!==e&&e.has(this.__key)}isLastChild(){const e=this.getLatest(),t=this.getParentOrThrow().getLastChild();return null!==t&&t.is(e)}getAllTextNodes(){const e=[];let t=this.getFirstChild();for(;null!==t;){if(fr(t)&&e.push(t),Ts(t)){const n=t.getAllTextNodes();e.push(...n)}t=t.getNextSibling()}return e}getFirstDescendant(){let e=this.getFirstChild();for(;Ts(e);){const t=e.getFirstChild();if(null===t)break;e=t}return e}getLastDescendant(){let e=this.getLastChild();for(;Ts(e);){const t=e.getLastChild();if(null===t)break;e=t}return e}getDescendantByIndex(e){const t=this.getChildren(),n=t.length;if(e>=n){const e=t[n-1];return Ts(e)&&e.getLastDescendant()||e||null}const r=t[e];return Ts(r)&&r.getFirstDescendant()||r||null}getFirstChild(){const e=this.getLatest().__first;return null===e?null:Ei(e)}getFirstChildOrThrow(){const e=this.getFirstChild();return null===e&&r(`Expected node ${this.__key} to have a first child.`),e}getLastChild(){const e=this.getLatest().__last;return null===e?null:Ei(e)}getLastChildOrThrow(){const e=this.getLastChild();return null===e&&r(`Expected node ${this.__key} to have a last child.`),e}getChildAtIndex(e){const t=this.getChildrenSize();let n,r;if(e<t/2){for(n=this.getFirstChild(),r=0;null!==n&&r<=e;){if(r===e)return n;n=n.getNextSibling(),r++}return null}for(n=this.getLastChild(),r=t-1;null!==n&&r>=e;){if(r===e)return n;n=n.getPreviousSibling(),r--}return null}getTextContent(){let e="";const t=this.getChildren(),n=t.length;for(let r=0;r<n;r++){const s=t[r];e+=s.getTextContent(),Ts(s)&&r!==n-1&&!s.isInline()&&(e+=B)}return e}getTextContentSize(){let e=0;const t=this.getChildren(),n=t.length;for(let r=0;r<n;r++){const s=t[r];e+=s.getTextContentSize(),Ts(s)&&r!==n-1&&!s.isInline()&&(e+=2)}return e}getDirection(){return this.getLatest().__dir}getTextFormat(){return this.getLatest().__textFormat}hasFormat(e){if(""!==e){const t=V[e];return 0!==(this.getFormat()&t)}return!1}hasTextFormat(e){const t=Y[e];return 0!==(this.getTextFormat()&t)}getFormatFlags(e,t){return yi(this.getLatest().__textFormat,e,t)}getTextStyle(){return this.getLatest().__textStyle}select(e,t){cs();const n=Ur();let r=e,s=t;const i=this.getChildrenSize();if(!this.canBeEmpty())if(0===e&&0===t){const e=this.getFirstChild();if(fr(e)||Ts(e))return e.select(0,0)}else if(!(void 0!==e&&e!==i||void 0!==t&&t!==i)){const e=this.getLastChild();if(fr(e)||Ts(e))return e.select()}void 0===r&&(r=i),void 0===s&&(s=i);const o=this.__key;return vr(n)?(n.anchor.set(o,r,"element"),n.focus.set(o,s,"element"),n.dirty=!0,n):Rr(o,r,o,s,"element","element")}selectStart(){const e=this.getFirstDescendant();return e?e.selectStart():this.select()}selectEnd(){const e=this.getLastDescendant();return e?e.selectEnd():this.select()}clear(){const e=this.getWritable();return this.getChildren().forEach(e=>e.remove()),e}append(...e){return this.splice(this.getChildrenSize(),0,e)}setDirection(e){const t=this.getWritable();return t.__dir=e,t}setFormat(e){return this.getWritable().__format=""!==e?V[e]:0,this}setStyle(e){return this.getWritable().__style=e||"",this}setTextFormat(e){const t=this.getWritable();return t.__textFormat=e,t}setTextStyle(e){const t=this.getWritable();return t.__textStyle=e,t}setIndent(e){return this.getWritable().__indent=e,this}splice(e,t,n){Ln(this)&&r(`ElementNode.splice: Ephemeral nodes can not mutate their children (key ${this.__key} type ${this.__type})`);const s=this.getChildrenSize(),i=this.getWritable();e+t<=s||r(`ElementNode.splice: start + deleteCount > oldSize (${String(e)} + ${String(t)} > ${String(s)})`);const o=i.__key,l=[],c=[],a=this.getChildAtIndex(e+t);let d=null,u=s-t+n.length;if(0!==e)if(e===s)d=this.getLastChild();else{const t=this.getChildAtIndex(e);null!==t&&(d=t.getPreviousSibling())}if(t>0){let e=null===d?this.getFirstChild():d.getNextSibling();for(let n=0;n<t;n++){null===e&&r("splice: sibling not found");const t=e.getNextSibling(),n=e.__key;Ci(e.getWritable()),c.push(n),e=t}}let h=d;for(const e of n){null!==h&&e.is(h)&&(d=h=h.getPreviousSibling());const t=e.getWritable();t.__parent===o&&u--,Ci(t);const n=e.__key;if(null===h)i.__first=n,t.__prev=null;else{const e=h.getWritable();e.__next=n,t.__prev=e.__key}e.__key===o&&r("append: attempting to append self"),t.__parent=o,l.push(n),h=e}if(e+t===s){if(null!==h){h.getWritable().__next=null,i.__last=h.__key}}else if(null!==a){const e=a.getWritable();if(null!==h){const t=h.getWritable();e.__prev=h.__key,t.__next=a.__key}else e.__prev=null}if(i.__size=u,c.length){const e=Ur();if(vr(e)){const t=new Set(c),n=new Set(l),{anchor:r,focus:s}=e;Os(r,t,n)&&Hr(r,r.getNode(),this,d,a),Os(s,t,n)&&Hr(s,s.getNode(),this,d,a),0!==u||this.canBeEmpty()||mo(this)||this.remove()}}return i}getDOMSlot(e){return new Es(e)}exportDOM(e){const{element:t}=super.exportDOM(e);if(No(t)){const e=this.getIndent();e>0&&(t.style.paddingInlineStart=40*e+"px");const n=this.getDirection();n&&(t.dir=n)}return{element:t}}exportJSON(){const e={children:[],direction:this.getDirection(),format:this.getFormatType(),indent:this.getIndent(),...super.exportJSON()},t=this.getTextFormat(),n=this.getTextStyle();return 0!==t&&(e.textFormat=t),""!==n&&(e.textStyle=n),e}updateFromJSON(e){return super.updateFromJSON(e).setFormat(e.format).setIndent(e.indent).setDirection(e.direction).setTextFormat(e.textFormat||0).setTextStyle(e.textStyle||"")}insertNewAfter(e,t){return null}canIndent(){return!0}collapseAtStart(e){return!1}excludeFromCopy(e){return!1}canReplaceWith(e){return!0}canInsertAfter(e){return!0}canBeEmpty(){return!0}canInsertTextBefore(){return!0}canInsertTextAfter(){return!0}isInline(){return!1}isShadowRoot(){return!1}canMergeWith(e){return!1}extractWithChild(e,t,n){return!1}canMergeWhenEmpty(){return!1}reconcileObservedMutation(e,t){const n=this.getDOMSlot(e);let r=n.getFirstChild();for(let e=this.getFirstChild();e;e=e.getNextSibling()){const s=t.getElementByKey(e.getKey());null!==s&&(null==r?(n.insertChild(s),r=s):r!==s&&n.replaceChild(s,r),r=r.nextSibling)}}};function Ts(e){return e instanceof Ns}function Os(e,t,n){let r=e.getNode();for(;r;){const e=r.__key;if(t.has(e)&&!n.has(e))return!0;r=r.getParent()}return!1}var As=class extends Rn{decorate(e,t){return null}isIsolated(){return!1}isInline(){return!0}isKeyboardSelectable(){return!0}};function Ms(e){return e instanceof As}var Ds=class e extends Ns{__cachedText;static getType(){return"root"}static clone(){return new e}constructor(){super("root"),this.__cachedText=null}getTopLevelElementOrThrow(){r("getTopLevelElementOrThrow: root nodes are not top level elements")}getTextContent(){const e=this.__cachedText;return!ls()&&0!==us()._dirtyType||null===e?super.getTextContent():e}remove(){r("remove: cannot be called on root nodes")}replace(e){r("replace: cannot be called on root nodes")}insertBefore(e){r("insertBefore: cannot be called on root nodes")}insertAfter(e){r("insertAfter: cannot be called on root nodes")}updateDOM(e,t){return!1}splice(e,t,n){for(const e of n)Ts(e)||Ms(e)||r("rootNode.splice: Only element or decorator nodes can be inserted to the root node");return super.splice(e,t,n)}static importJSON(e){return Mi().updateFromJSON(e)}collapseAtStart(){return!0}};function Is(e){return e instanceof Ds}function Ps(e){return new Fs(new Map(e._nodeMap))}function Ls(){return new Fs(new Map([["root",new Ds]]))}function Rs(e){const t=e.exportJSON(),n=e.constructor;if(t.type!==n.getType()&&r(`LexicalNode: Node ${n.name} does not match the serialized type. Check if .exportJSON() is implemented and it is returning the correct type.`),Ts(e)){const s=t.children;Array.isArray(s)||r(`LexicalNode: Node ${n.name} is an element but .exportJSON() does not have a children array.`);const i=e.getChildren();for(let e=0;e<i.length;e++){const t=Rs(i[e]);s.push(t)}}return t}function $s(e){return e instanceof Fs}var Fs=class e{_nodeMap;_selection;_flushSync;_readOnly;constructor(e,t){this._nodeMap=e,this._selection=t||null,this._flushSync=!1,this._readOnly=!1}isEmpty(){return 1===this._nodeMap.size&&null===this._selection}read(e,t){return ys(t&&t.editor||null,this,e)}clone(t){const n=new e(this._nodeMap,void 0===t?this._selection:t);return n._readOnly=!0,n}toJSON(){return ys(null,this,()=>({root:Rs(Mi())}))}},Ks=class extends Ns{static getType(){return"artificial"}createDOM(e){return document.createElement("div")}},zs=class e extends Ns{static getType(){return"paragraph"}static clone(t){return new e(t.__key)}createDOM(e){const t=document.createElement("p"),n=Gi(e.theme,"paragraph");return void 0!==n&&t.classList.add(...n),t}updateDOM(e,t,n){return!1}static importDOM(){return{p:e=>({conversion:Bs,priority:0})}}exportDOM(e){const{element:t}=super.exportDOM(e);if(No(t)){this.isEmpty()&&t.append(document.createElement("br"));const e=this.getFormatType();e&&(t.style.textAlign=e)}return{element:t}}static importJSON(e){return Us().updateFromJSON(e)}exportJSON(){return{...super.exportJSON(),textFormat:this.getTextFormat(),textStyle:this.getTextStyle()}}insertNewAfter(e,t){const n=Us();n.setTextFormat(e.format),n.setTextStyle(e.style);const r=this.getDirection();return n.setDirection(r),n.setFormat(this.getFormatType()),n.setStyle(this.getStyle()),this.insertAfter(n,t),n}collapseAtStart(){const e=this.getChildren();if(0===e.length||fr(e[0])&&""===e[0].getTextContent().trim()){if(null!==this.getNextSibling())return this.selectNext(),this.remove(),!0;if(null!==this.getPreviousSibling())return this.selectPrevious(),this.remove(),!0}return!1}};function Bs(e){const t=Us();return e.style&&(t.setFormat(e.style.textAlign),Ko(e,t)),{node:t}}function Us(){return yo(new zs)}function js(e){return e instanceof zs}const Ws=0,Ys=1,Hs=2,Vs=3,Js=4;function qs(e,t,n,r){const s=e._keyToDOMMap;s.clear(),e._editorState=Ls(),e._pendingEditorState=r,e._compositionKey=null,e._dirtyType=0,e._cloneNotNeeded.clear(),e._dirtyLeaves=new Set,e._dirtyElements.clear(),e._normalizedNodes=new Set,e._updateTags=new Set,e._updates=[],e._blockCursorElement=null;const i=e._observer;null!==i&&(i.disconnect(),e._observer=null),null!==t&&(t.textContent=""),null!==n&&(n.textContent="",s.set("root",n))}function Gs(e){const t=new Set,n=new Set;let r=e;for(;r;){const{ownNodeConfig:e}=Yo(r),s=r.transform;if(!n.has(s)){n.add(s);const e=r.transform();e&&t.add(e)}if(e){const n=e.$transform;n&&t.add(n),r=e.extends}else{const e=Object.getPrototypeOf(r);r=e.prototype instanceof Rn&&e!==Rn?e:void 0}}return t}function Xs(e){const t=e||{},n=ns,s=t.theme||{},i=void 0===e?n:t.parentEditor||null,o=t.disableEvents||!1,l=Ls(),c=t.namespace||(null!==i?i._config.namespace:$i()),a=t.editorState,d=[Ds,rr,Hn,pr,zs,Ks,...t.nodes||[]],{onError:u,html:h}=t,f=void 0===t.editable||t.editable;let g;if(void 0===e&&null!==n)g=n._nodes;else{g=new Map;for(let e=0;e<d.length;e++){let t=d[e],n=null,s=null;if("function"!=typeof t){const e=t;t=e.replace,n=e.with,s=e.withKlass||null}Yo(t);{const e=t.name,i=jo(t,"getType")&&t.getType();s?s.prototype instanceof t||r(`${s.name} doesn't extend the ${e}`):n&&console.warn(`Override for ${e} specifies 'replace' without 'withKlass'. 'withKlass' will be required in a future version.`),"RootNode"!==e&&"root"!==i&&"artificial"!==i&&t!==Rn&&(["getType","clone"].forEach(n=>{jo(t,n)||console.warn(`${e} must implement static "${n}" method`)}),!jo(t,"importDOM")&&Wo(t)&&console.warn(`${e} should implement "importDOM" if using a custom "exportDOM" method to ensure HTML serialization (important for copy & paste) works as expected`),jo(t,"importJSON")||console.warn(`${e} should implement "importJSON" method to ensure JSON and default HTML serialization works as expected`))}const i=t.getType(),o=Gs(t);g.set(i,{exportDOM:h&&h.export?h.export.get(t):void 0,klass:t,replace:n,replaceWithKlass:s,sharedNodeState:me(d[e]),transforms:o})}}const p=new Qs(l,i,g,{disableEvents:o,namespace:c,theme:s},u||console.error,function(e,t){const n=new Map,r=new Set,s=e=>{Object.keys(e).forEach(t=>{let r=n.get(t);void 0===r&&(r=[],n.set(t,r)),r.push(e[t])})};return e.forEach(e=>{const t=e.klass.importDOM;if(null==t||r.has(t))return;r.add(t);const n=t.call(e.klass);null!==n&&s(n)}),t&&s(t),n}(g,h?h.import:void 0),f,e);return void 0!==a&&(p._pendingEditorState=a,p._dirtyType=C),p}var Qs=class{static version;_headless;_parentEditor;_rootElement;_editorState;_pendingEditorState;_compositionKey;_deferred;_keyToDOMMap;_updates;_updating;_listeners;_commands;_nodes;_decorators;_pendingDecorators;_config;_dirtyType;_cloneNotNeeded;_dirtyLeaves;_dirtyElements;_normalizedNodes;_updateTags;_observer;_key;_onError;_htmlConversions;_window;_editable;_blockCursorElement;_createEditorArgs;constructor(e,t,n,r,s,i,o,l){this._createEditorArgs=l,this._parentEditor=t,this._rootElement=null,this._editorState=e,this._pendingEditorState=null,this._compositionKey=null,this._deferred=[],this._keyToDOMMap=new Map,this._updates=[],this._updating=!1,this._listeners={decorator:new Set,editable:new Set,mutation:new Map,root:new Set,textcontent:new Set,update:new Set},this._commands=new Map,this._config=r,this._nodes=n,this._decorators={},this._pendingDecorators=null,this._dirtyType=0,this._cloneNotNeeded=new Set,this._dirtyLeaves=new Set,this._dirtyElements=new Map,this._normalizedNodes=new Set,this._updateTags=new Set,this._observer=null,this._key=$i(),this._onError=s,this._htmlConversions=i,this._editable=o,this._headless=null!==t&&t._headless,this._window=null,this._blockCursorElement=null}isComposing(){return null!=this._compositionKey}registerUpdateListener(e){const t=this._listeners.update;return t.add(e),()=>{t.delete(e)}}registerEditableListener(e){const t=this._listeners.editable;return t.add(e),()=>{t.delete(e)}}registerDecoratorListener(e){const t=this._listeners.decorator;return t.add(e),()=>{t.delete(e)}}registerTextContentListener(e){const t=this._listeners.textcontent;return t.add(e),()=>{t.delete(e)}}registerRootListener(e){const t=this._listeners.root;return e(this._rootElement,null),t.add(e),()=>{e(null,this._rootElement),t.delete(e)}}registerCommand(e,t,n){void 0===n&&r('Listener for type "command" requires a "priority".');const s=this._commands;s.has(e)||s.set(e,[new Set,new Set,new Set,new Set,new Set]);const i=s.get(e);void 0===i&&r(`registerCommand: Command ${String(e)} not found in command map`);const o=i[n];return o.add(t),()=>{o.delete(t),i.every(e=>0===e.size)&&s.delete(e)}}registerMutationListener(e,t,n){const r=this.resolveRegisteredNodeAfterReplacements(this.getRegisteredNode(e)).klass,s=this._listeners.mutation;let i=s.get(t);void 0===i&&(i=new Set,s.set(t,i)),i.add(r);const o=n&&n.skipInitialization;return void 0!==o&&o||this.initializeMutationListener(t,r),()=>{i.delete(r),0===i.size&&s.delete(t)}}getRegisteredNode(e){const t=this._nodes.get(e.getType());return void 0===t&&r(`Node ${e.name} has not been registered. Ensure node has been passed to createEditor.`),t}resolveRegisteredNodeAfterReplacements(e){for(;e.replaceWithKlass;)e=this.getRegisteredNode(e.replaceWithKlass);return e}initializeMutationListener(e,t){const n=this._editorState,r=Ro(n).get(t.getType());if(!r)return;const s=new Map;for(const e of r.keys())s.set(e,"created");s.size>0&&e(s,{dirtyLeaves:new Set,prevEditorState:n,updateTags:new Set(["registerMutationListener"])})}registerNodeTransformToKlass(e,t){const n=this.getRegisteredNode(e);return n.transforms.add(t),n}registerNodeTransform(e,t){const n=this.registerNodeTransformToKlass(e,t),r=[n],s=n.replaceWithKlass;if(null!=s){const e=this.registerNodeTransformToKlass(s,t);r.push(e)}return function(e,t){const n=Ro(e.getEditorState()),r=[];for(const e of t){const t=n.get(e);t&&r.push(t)}if(0===r.length)return;e.update(()=>{for(const e of r)for(const t of e.keys()){const e=Ei(t);e&&e.markDirty()}},null===e._pendingEditorState?{tag:Kn}:void 0)}(this,r.map(e=>e.klass.getType())),()=>{r.forEach(e=>e.transforms.delete(t))}}hasNode(e){return this._nodes.has(e.getType())}hasNodes(e){return e.every(this.hasNode.bind(this))}dispatchCommand(e,t){return no(this,e,t)}getDecorators(){return this._decorators}getRootElement(){return this._rootElement}getKey(){return this._key}setRootElement(e){const t=this._rootElement;if(e!==t){const n=Gi(this._config.theme,"root"),r=this._pendingEditorState||this._editorState;if(this._rootElement=e,qs(this,t,e,r),null!==t&&(this._config.disableEvents||Mn(t),null!=n&&t.classList.remove(...n)),null!==e){const t=ho(e),r=e.style;r.userSelect="text",r.whiteSpace="pre-wrap",r.wordBreak="break-word",e.setAttribute("data-lexical-editor","true"),this._window=t,this._dirtyType=C,ae(this),this._updateTags.add(Kn),Ss(this),this._config.disableEvents||function(e,t){const n=e.ownerDocument;cn.set(e,n);const r=an.get(n)??0;r<1&&n.addEventListener("selectionchange",Nn),an.set(n,r+1),e.__lexicalEditor=t;const s=En(e);for(let n=0;n<nn.length;n++){const[r,i]=nn[n],o="function"==typeof i?e=>{On(e)||(Tn(e),(t.isEditable()||"click"===r)&&i(e,t))}:e=>{if(On(e))return;Tn(e);const n=t.isEditable();switch(r){case"cut":return n&&no(t,Ht,e);case"copy":return no(t,Yt,e);case"paste":return n&&no(t,_t,e);case"dragstart":return n&&no(t,Ut,e);case"dragover":return n&&no(t,jt,e);case"dragend":return n&&no(t,Wt,e);case"focus":return n&&no(t,Qt,e);case"blur":return n&&no(t,Zt,e);case"drop":return n&&no(t,zt,e)}};e.addEventListener(r,o),s.push(()=>{e.removeEventListener(r,o)})}}(e,this),null!=n&&e.classList.add(...n);{const t=e.parentElement;null!=t&&["flex","inline-flex"].includes(getComputedStyle(t).display)&&console.warn('When using "display: flex" or "display: inline-flex" on an element containing content editable, Chrome may have unwanted focusing behavior when clicking outside of it. Consider wrapping the content editable within a non-flex element.')}}else this._window=null,this._updateTags.add(Kn),Ss(this);Cs("root",this,!1,e,t)}}getElementByKey(e){return this._keyToDOMMap.get(e)||null}getEditorState(){return this._editorState}setEditorState(e,t){e.isEmpty()&&r("setEditorState: the editor state is empty. Ensure the editor state's root node never becomes empty.");let n=e;n._readOnly&&(n=Ps(e),n._selection=e._selection?e._selection.clone():null),ce(this);const s=this._pendingEditorState,i=this._updateTags,o=void 0!==t?t.tag:null;null===s||s.isEmpty()||(null!=o&&i.add(o),Ss(this)),this._pendingEditorState=n,this._dirtyType=C,this._dirtyElements.set("root",!1),this._compositionKey=null,null!=o&&i.add(o),this._updating||Ss(this)}parseEditorState(e,t){return function(e,t,n){const r=Ls(),s=ts,i=rs,o=ns,l=t._dirtyElements,c=t._dirtyLeaves,a=t._cloneNotNeeded,d=t._dirtyType;t._dirtyElements=new Map,t._dirtyLeaves=new Set,t._cloneNotNeeded=new Set,t._dirtyType=0,ts=r,rs=!1,ns=t,ei(null);try{const s=t._nodes;_s(e.root,s),n&&n(),r._readOnly=!0,bs(r)}catch(e){e instanceof Error&&t._onError(e)}finally{t._dirtyElements=l,t._dirtyLeaves=c,t._cloneNotNeeded=a,t._dirtyType=d,ts=s,rs=i,ns=o}return r}("string"==typeof e?JSON.parse(e):e,this,t)}read(e){return Ss(this),this.getEditorState().read(e,{editor:this})}update(e,t){!function(e,t,n){e._updating?e._updates.push([t,n]):vs(e,t,n)}(this,e,t)}focus(e,t={}){const n=this._rootElement;null!==n&&(n.setAttribute("autocapitalize","off"),xs(this,()=>{const r=Ur(),s=Mi();null!==r?r.dirty||Ii(r.clone()):0!==s.getChildrenSize()&&("rootStart"===t.defaultSelection?s.selectStart():s.selectEnd()),co("focus"),ao(()=>{n.removeAttribute("autocapitalize"),e&&e()})}),null===this._pendingEditorState&&n.removeAttribute("autocapitalize"))}blur(){const e=this._rootElement;null!==e&&e.blur();const t=vo(this._window);null!==t&&t.removeAllRanges()}isEditable(){return this._editable}setEditable(e){this._editable!==e&&(this._editable=e,Cs("editable",this,!0,e))}toJSON(){return{editorState:this._editorState.toJSON()}}};Qs.version="0.38.2+dev.esm";let Zs=null;function ei(e){Zs=e}let ti=1;function ni(){ti=1}function ri(e,t){const n=si(e,t);return void 0===n&&r(`registeredNode: Type ${t} not found`),n}function si(e,t){return e._nodes.get(t)}const ii="function"==typeof queueMicrotask?queueMicrotask:e=>{Promise.resolve().then(e)};function oi(e){return Ms(Ti(e))}function li(e){const t=document.activeElement;if(!No(t))return!1;const n=t.nodeName;return Ms(Ti(e))&&("INPUT"===n||"TEXTAREA"===n||"true"===t.contentEditable&&null==ui(t))}function ci(e,t,n){const r=e.getRootElement();try{return null!==r&&r.contains(t)&&r.contains(n)&&null!==t&&!li(t)&&di(t)===e}catch(e){return!1}}function ai(e){return e instanceof Qs}function di(e){let t=e;for(;null!=t;){const e=ui(t);if(ai(e))return e;t=io(t)}return null}function ui(e){return e?e.__lexicalEditor:null}function hi(e){return j.test(e)?"rtl":W.test(e)?"ltr":null}function fi(e){return _r(e)||e.isToken()}function gi(e){return fi(e)||e.isSegmented()}function pi(e){return To(e)&&e.nodeType===_}function mi(e){return To(e)&&e.nodeType===y}function _i(e){let t=e;for(;null!=t;){if(pi(t))return t;t=t.firstChild}return null}function yi(e,t,n){const r=Y[t];if(null!==n&&(e&r)===(n&r))return e;let s=e^r;return"subscript"===t?s&=~Y.superscript:"superscript"===t?s&=~Y.subscript:"lowercase"===t?(s&=~Y.uppercase,s&=~Y.capitalize):"uppercase"===t?(s&=~Y.lowercase,s&=~Y.capitalize):"capitalize"===t&&(s&=~Y.lowercase,s&=~Y.uppercase),s}function bi(e){return fr(e)||qn(e)||Ms(e)}function Si(e,t){const n=function(){const e=Zs;return Zs=null,e}();if(null!=(t=t||n&&n.__key))return function(e,t,n){const s=ts;if(!s)return;const i=s._nodeMap.get(t);n&&t!==n.__key&&r(`Lexical node with constructor ${e.constructor.name} (type ${e.getType()}) has an incorrect clone implementation, got ${String(t)} for nodeKey when expecting ${n.__key}`);i&&i.constructor!==e.constructor&&(e.constructor.name!==i.constructor.name?r(`Lexical node with constructor ${e.constructor.name} attempted to re-use key from node in active editor state with constructor ${i.constructor.name}. Keys must not be re-used when the type is changed.`):r(`Lexical node with constructor ${e.constructor.name} attempted to re-use key from node in active editor state with different constructor with the same name (possibly due to invalid Hot Module Replacement). Keys must not be re-used when the type is changed.`))}(e,t,n),void(e.__key=t);cs(),as();const s=us(),i=ds(),o=""+ti++;i._nodeMap.set(o,e),Ts(e)?s._dirtyElements.set(o,!0):s._dirtyLeaves.add(o),s._cloneNotNeeded.add(o),s._dirtyType=S,e.__key=o}function Ci(e){const t=e.getParent();if(null!==t){const n=e.getWritable(),r=t.getWritable(),s=e.getPreviousSibling(),i=e.getNextSibling(),o=null!==i?i.__key:null,l=null!==s?s.__key:null,c=null!==s?s.getWritable():null,a=null!==i?i.getWritable():null;null===s&&(r.__first=o),null===i&&(r.__last=l),null!==c&&(c.__next=o),null!==a&&(a.__prev=l),n.__prev=null,n.__next=null,n.__parent=null,r.__size--}}function wi(e){as(),Ln(e)&&r(`internalMarkNodeAsDirty: Ephemeral nodes must not be marked as dirty (key ${e.__key} type ${e.__type})`);const t=e.getLatest(),n=t.__parent,s=ds(),i=us(),o=s._nodeMap,l=i._dirtyElements;null!==n&&function(e,t,n){let r=e;for(;null!==r;){if(n.has(r))return;const e=t.get(r);if(void 0===e)break;n.set(r,!1),r=e.__parent}}(n,o,l);const c=t.__key;i._dirtyType=S,Ts(e)?l.set(c,!0):i._dirtyLeaves.add(c)}function vi(e){cs();const t=us(),n=t._compositionKey;if(e!==n){if(t._compositionKey=e,null!==n){const e=Ei(n);null!==e&&e.getWritable()}if(null!==e){const t=Ei(e);null!==t&&t.getWritable()}}}function xi(){return ls()?null:us()._compositionKey}function Ei(e,t){const n=(t||ds())._nodeMap.get(e);return void 0===n?null:n}function ki(e,t){const n=Ni(e,us());return void 0!==n?Ei(n,t):null}function Ni(e,t){return e[`__lexicalKey_${t._key}`]}function Ti(e,t){let n=e;for(;null!=n;){const e=ki(n,t);if(null!==e)return e;n=io(n)}return null}function Oi(e){const t=e._decorators,n=Object.assign({},t);return e._pendingDecorators=n,n}function Ai(e){return e.read(()=>Mi().getTextContent())}function Mi(){return Di(ds())}function Di(e){return e._nodeMap.get("root")}function Ii(e){cs();const t=ds();null!==e&&(Object.isFrozen(e)&&r("$setSelection called on frozen selection object. Ensure selection is cloned before passing in."),e.dirty=!0,e.setCachedNodes(null)),t._selection=e}function Pi(e){const t=us(),n=function(e,t){let n=e;for(;null!=n;){const e=Ni(n,t);if(void 0!==e)return e;n=io(n)}return null}(e,t);return null===n?e===t.getRootElement()?Ei("root"):null:Ei(n)}function Li(e){return/[\uD800-\uDBFF][\uDC00-\uDFFF]/g.test(e)}function Ri(e){const t=[];let n=e;for(;null!==n;)t.push(n),n=n._parentEditor;return t}function $i(){return Math.random().toString(36).replace(/[^a-z]+/g,"").substring(0,5)}function Fi(e){return pi(e)?e.nodeValue:null}function Ki(e,t,n){const r=vo(fo(t));if(null===r)return;const s=r.anchorNode;let{anchorOffset:i,focusOffset:o}=r;if(null!==s){let t=Fi(s);const r=Ti(s);if(null!==t&&fr(r)){if(t===z&&n){const e=n.length;t=n,i=e,o=e}null!==t&&zi(r,t,i,o,e)}}}function zi(e,t,n,r,s){let i=e;if(i.isAttached()&&(s||!i.isDirty())){const o=i.isComposing();let l=t;(o||s)&&t[t.length-1]===z&&(l=t.slice(0,-1));const c=i.getTextContent();if(s||l!==c){if(""===l){if(vi(null),a||d||g)i.remove();else{const e=us();setTimeout(()=>{e.update(()=>{i.isAttached()&&i.remove()})},20)}return}const t=i.getParent(),s=jr(),c=i.getTextContentSize(),u=xi(),h=i.getKey();if(i.isToken()||null!==u&&h===u&&!o||vr(s)&&(null!==t&&!t.canInsertTextBefore()&&0===s.anchor.offset||s.anchor.key===e.__key&&0===s.anchor.offset&&!i.canInsertTextBefore()&&!o||s.focus.key===e.__key&&s.focus.offset===c&&!i.canInsertTextAfter()&&!o))return void i.markDirty();const f=Ur();if(!vr(f)||null===n||null===r)return void Bi(i,l,f);if(f.setTextNodeRange(i,n,i,r),i.isSegmented()){const e=hr(i.getTextContent());i.replace(e),i=e}Bi(i,l,f)}}}function Bi(e,t,n){if(e.setTextContent(t),vr(n)){const t=e.getKey();for(const r of["anchor","focus"]){const s=n[r];"text"===s.type&&s.key===t&&(s.offset=ul(e,s.offset,"clamp"))}}}function Ui(e,t,n){const r=t[n]||!1;return"any"===r||r===e[n]}function ji(e,t){return Ui(e,t,"altKey")&&Ui(e,t,"ctrlKey")&&Ui(e,t,"shiftKey")&&Ui(e,t,"metaKey")}function Wi(e,t,n){return ji(e,n)&&e.key.toLowerCase()===t.toLowerCase()}const Yi={ctrlKey:!o,metaKey:o},Hi={altKey:o,ctrlKey:!o};function Vi(e){return"Backspace"===e.key}function Ji(e){return Wi(e,"a",Yi)}function qi(e){const t=Mi();if(vr(e)){const t=e.anchor,n=e.focus,r=t.getNode().getTopLevelElementOrThrow().getParentOrThrow();return t.set(r.getKey(),0,"element"),n.set(r.getKey(),r.getChildrenSize(),"element"),Te(e),e}{const e=t.select(0,t.getChildrenSize());return Ii(Te(e)),e}}function Gi(e,t){void 0===e.__lexicalClassNameCache&&(e.__lexicalClassNameCache={});const n=e.__lexicalClassNameCache,r=n[t];if(void 0!==r)return r;const s=e[t];if("string"==typeof s){const e=p(s);return n[t]=e,e}return s}function Xi(e,t,n,s,i){if(0===n.size)return;const o=s.__type,l=s.__key,c=t.get(o);void 0===c&&r(`Type ${o} not in registeredNodes`);const a=c.klass;let d=e.get(a);void 0===d&&(d=new Map,e.set(a,d));const u=d.get(l),h="destroyed"===u&&"created"===i;(void 0===u||h)&&d.set(l,h?"updated":i)}function Qi(e){const t=e.getType(),n=ds();if(n._readOnly){const e=Ro(n).get(t);return e?Array.from(e.values()):[]}const r=n._nodeMap,s=[];for(const[,n]of r)n instanceof e&&n.__type===t&&n.isAttached()&&s.push(n);return s}function Zi(e,t,n){const r=e.getParent();let s=n,i=e;return null!==r&&(t&&0===n?(s=i.getIndexWithinParent(),i=r):t||n!==i.getChildrenSize()||(s=i.getIndexWithinParent()+1,i=r)),i.getChildAtIndex(t?s-1:s)}function eo(e,t){const n=e.offset;if("element"===e.type)return Zi(e.getNode(),t,n);{const r=e.getNode();if(t&&0===n||!t&&n===r.getTextContentSize()){const e=t?r.getPreviousSibling():r.getNextSibling();return null===e?Zi(r.getParentOrThrow(),t,r.getIndexWithinParent()+(t?0:1)):e}}return null}function to(e){const t=fo(e).event,n=t&&t.inputType;return"insertFromPaste"===n||"insertFromPasteAsQuotation"===n}function no(e,t,n){return function(e,t,n){const r=Ri(e);for(let s=4;s>=0;s--)for(let i=0;i<r.length;i++){const o=r[i],l=o._commands.get(t);if(void 0!==l){const t=l[s];if(void 0!==t){const r=Array.from(t),s=r.length;let i=!1;if(xs(o,()=>{for(let t=0;t<s;t++)if(r[t](n,e))return void(i=!0)}),i)return i}}}return!1}(e,t,n)}function ro(e){return!Is(e)&&!e.isLastChild()&&!e.isInline()}function so(e,t){const n=e._keyToDOMMap.get(t);return void 0===n&&r(`Reconciliation: could not find DOM element for node key ${t}`),n}function io(e){const t=e.assignedSlot||e.parentElement;return Oo(t)?t.host:t}function oo(e){return mi(e)?e:No(e)?e.ownerDocument:null}function lo(e){return us()._updateTags.has(e)}function co(e){cs(),us()._updateTags.add(e)}function ao(e){cs(),us()._deferred.push(e)}function uo(e,t){let n=e.getParent();for(;null!==n;){if(n.is(t))return!0;n=n.getParent()}return!1}function ho(e){const t=oo(e);return t?t.defaultView:null}function fo(e){const t=e._window;return null===t&&r("window object not found"),t}function go(e){return Ts(e)&&e.isInline()||Ms(e)&&e.isInline()}function po(e){let t=e.getParentOrThrow();for(;null!==t;){if(mo(t))return t;t=t.getParentOrThrow()}return t}function mo(e){return Is(e)||Ts(e)&&e.isShadowRoot()}function _o(e){const t=e.constructor.clone(e);return Si(t,null),t.afterCloneFrom(e),t}function yo(e){const t=us(),n=e.getType(),s=si(t,n);void 0===s&&r(`$applyNodeReplacement node ${e.constructor.name} with type ${n} must be registered to the editor. You can do this by passing the node class via the "nodes" array in the editor config.`);const{replace:i,replaceWithKlass:o}=s;if(null!==i){const t=i(e),s=t.constructor;return null!==o?t instanceof o||r(`$applyNodeReplacement failed. Expected replacement node to be an instance of ${o.name} with type ${o.getType()} but returned ${s.name} with type ${s.getType()} from original node ${e.constructor.name} with type ${n}`):t instanceof e.constructor&&s!==e.constructor||r(`$applyNodeReplacement failed. Ensure replacement node ${s.name} with type ${s.getType()} is a subclass of the original node ${e.constructor.name} with type ${n}.`),t.__key===e.__key&&r(`$applyNodeReplacement failed. Ensure that the key argument is *not* used in your replace function (from node ${e.constructor.name} with type ${n} to node ${s.name} with type ${s.getType()}), Node keys must never be re-used except by the static clone method.`),t}return e}function bo(e,t){!Is(e.getParent())||Ts(t)||Ms(t)||r("Only element or decorator nodes can be inserted in to the root node")}function So(e){const t=Ei(e);return null===t&&r(`Expected node with key ${e} to exist but it's not in the nodeMap.`),t}function Co(e){return(Ms(e)||Ts(e)&&!e.canBeEmpty())&&!e.isInline()}function wo(e,t,n){n.style.removeProperty("caret-color"),t._blockCursorElement=null;const r=e.parentElement;null!==r&&r.removeChild(e)}function vo(e){return s?(e||window).getSelection():null}function xo(e){const t=ho(e);return t?t.getSelection():null}function Eo(e,t){let n=e.getChildAtIndex(t);null==n&&(n=e),mo(e)&&r("Can not call $splitNode() on root element");const s=e=>{const t=e.getParentOrThrow(),i=mo(t),o=e!==n||i?_o(e):e;if(i)return Ts(e)&&Ts(o)||r("Children of a root must be ElementNode"),e.insertAfter(o),[e,o,o];{const[n,r,i]=s(t),l=e.getNextSiblings();return i.append(o,...l),[n,r,o]}},[i,o]=s(n);return[i,o]}function ko(e){return No(e)&&"A"===e.tagName}function No(e){return To(e)&&e.nodeType===m}function To(e){return"object"==typeof e&&null!==e&&"nodeType"in e&&"number"==typeof e.nodeType}function Oo(e){return To(e)&&e.nodeType===b}function Ao(e){const t=new RegExp(/^(a|abbr|acronym|b|cite|code|del|em|i|ins|kbd|label|mark|output|q|ruby|s|samp|span|strong|sub|sup|time|u|tt|var|#text)$/,"i");return null!==e.nodeName.match(t)}function Mo(e){const t=new RegExp(/^(address|article|aside|blockquote|canvas|dd|div|dl|dt|fieldset|figcaption|figure|footer|form|h1|h2|h3|h4|h5|h6|header|hr|li|main|nav|noscript|ol|p|pre|section|table|td|tfoot|ul|video)$/,"i");return null!==e.nodeName.match(t)}function Do(e){if(Ms(e)&&!e.isInline())return!0;if(!Ts(e)||mo(e))return!1;const t=e.getFirstChild(),n=null===t||qn(t)||fr(t)||t.isInline();return!e.isInline()&&!1!==e.canBeEmpty()&&n}function Io(){return us()}const Po=new WeakMap,Lo=new Map;function Ro(e){if(!e._readOnly&&e.isEmpty())return Lo;e._readOnly||r("getCachedTypeToNodeMap called with a writable EditorState");let t=Po.get(e);return t||(t=function(e){const t=new Map;for(const[n,r]of e._nodeMap){const e=r.__type;let s=t.get(e);s||(s=new Map,t.set(e,s)),s.set(n,r)}return t}(e),Po.set(e,t)),t}function $o(e){const t=e.constructor,n=t.clone(e);return n.afterCloneFrom(e),n.__key!==e.__key&&r(`$cloneWithProperties: ${t.name}.clone(node) (with type '${t.getType()}') did not return a node with the same key, make sure to specify node.__key as the last argument to the constructor`),n.__parent===e.__parent&&n.__next===e.__next&&n.__prev===e.__prev||r(`$cloneWithProperties: ${t.name}.clone(node) (with type '${t.getType()}') overrode afterCloneFrom but did not call super.afterCloneFrom(prevNode)`),n}function Fo(e){return(t=$o(e))[Pn]=!0,t;var t}function Ko(e,t){const n=parseInt(e.style.paddingInlineStart,10)||0,r=Math.round(n/40);t.setIndent(r)}function zo(e){e.__lexicalUnmanaged=!0}function Bo(e){return!0===e.__lexicalUnmanaged}function Uo(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function jo(e,t){return Uo(e,t)&&e[t]!==Rn[t]}function Wo(e){return Uo(e.prototype,"exportDOM")}function Yo(e){const t=Q in e.prototype?e.prototype[Q]():void 0,n=function(e){if(!(e===Rn||e.prototype instanceof Rn)){let t="<unknown>",n="<unknown>";try{t=e.getType()}catch(e){}try{Qs.version&&(n=JSON.parse(Qs.version))}catch(e){}r(`${e.name} (type ${t}) does not subclass LexicalNode from the lexical package used by this editor (version ${n}). All lexical and @lexical/* packages used by an editor must have identical versions. If you suspect the version does match, then the problem may be caused by multiple copies of the same lexical module (e.g. both esm and cjs, or included directly in multiple entrypoints).`)}return e===As||e===Ns||e===Rn}(e),s=!n&&jo(e,"getType")?e.getType():void 0;let i,o=s;if(t)if(s)i=t[s];else for(const[e,n]of Object.entries(t))o=e,i=n;if(!n&&o&&(jo(e,"getType")||(e.getType=()=>o),jo(e,"clone")||(0===rr.length&&0!==e.length&&r(`${e.name} (type ${o}) must implement a static clone method since its constructor has ${String(e.length)} required arguments (expecting 0). Use an explicit default in the first argument of your constructor(prop: T=X, nodeKey?: NodeKey).`),e.clone=t=>(ei(t),new e)),jo(e,"importJSON")||(0===rr.length&&0!==e.length&&r(`${e.name} (type ${o}) must implement a static importJSON method since its constructor has ${String(e.length)} required arguments (expecting 0). Use an explicit default in the first argument of your constructor(prop: T=X, nodeKey?: NodeKey).`),e.importJSON=i&&i.$importJSON||(t=>(new e).updateFromJSON(t))),!jo(e,"importDOM")&&i)){const{importDOM:t}=i;t&&(e.importDOM=()=>t)}return{ownNodeConfig:i,ownNodeType:o}}function Ho(e){const t=Io();return cs(),new(t.resolveRegisteredNodeAfterReplacements(t.getRegisteredNode(e)).klass)}const Vo=(e,t)=>{let n=e;for(;null!=n&&!Is(n);){if(t(n))return n;n=n.getParent()}return null},Jo={next:"previous",previous:"next"};var qo=class{origin;constructor(e){this.origin=e}[Symbol.iterator](){return wl({hasNext:sl,initial:this.getAdjacentCaret(),map:e=>e,step:e=>e.getAdjacentCaret()})}getAdjacentCaret(){return al(this.getNodeAtCaret(),this.direction)}getSiblingCaret(){return al(this.origin,this.direction)}remove(){const e=this.getNodeAtCaret();return e&&e.remove(),this}replaceOrInsert(e,t){const n=this.getNodeAtCaret();return e.is(this.origin)||e.is(n)||(null===n?this.insert(e):n.replace(e,t)),this}splice(e,t,n="next"){const s=n===this.direction?t:Array.from(t).reverse();let i=this;const o=this.getParentAtCaret(),l=new Map;for(let t=i.getAdjacentCaret();null!==t&&l.size<e;t=t.getAdjacentCaret()){const e=t.origin.getWritable();l.set(e.getKey(),e)}for(const e of s){if(l.size>0){const t=i.getNodeAtCaret();if(t)if(l.delete(t.getKey()),l.delete(e.getKey()),t.is(e)||i.origin.is(e));else{const n=e.getParent();n&&n.is(o)&&e.remove(),t.replace(e)}else null===t&&r(`NodeCaret.splice: Underflow of expected nodesToRemove during splice (keys: ${Array.from(l).join(" ")})`)}else i.insert(e);i=al(e,this.direction)}for(const e of l.values())e.remove();return this}},Go=class e extends qo{type="child";getLatest(){const e=this.origin.getLatest();return e===this.origin?this:fl(e,this.direction)}getParentCaret(e="root"){return al(Zo(this.getParentAtCaret(),e),this.direction)}getFlipped(){const e=Qo(this.direction);return al(this.getNodeAtCaret(),e)||fl(this.origin,e)}getParentAtCaret(){return this.origin}getChildCaret(){return this}isSameNodeCaret(t){return t instanceof e&&this.direction===t.direction&&this.origin.is(t.origin)}isSamePointCaret(e){return this.isSameNodeCaret(e)}};const Xo={root:Is,shadowRoot:mo};function Qo(e){return Jo[e]}function Zo(e,t="root"){return Xo[t](e)?null:e}var el=class e extends qo{type="sibling";getLatest(){const e=this.origin.getLatest();return e===this.origin?this:al(e,this.direction)}getSiblingCaret(){return this}getParentAtCaret(){return this.origin.getParent()}getChildCaret(){return Ts(this.origin)?fl(this.origin,this.direction):null}getParentCaret(e="root"){return al(Zo(this.getParentAtCaret(),e),this.direction)}getFlipped(){const e=Qo(this.direction);return al(this.getNodeAtCaret(),e)||fl(this.origin.getParentOrThrow(),e)}isSamePointCaret(t){return t instanceof e&&this.direction===t.direction&&this.origin.is(t.origin)}isSameNodeCaret(t){return(t instanceof e||t instanceof tl)&&this.direction===t.direction&&this.origin.is(t.origin)}},tl=class e extends qo{type="text";offset;constructor(e,t){super(e),this.offset=t}getLatest(){const e=this.origin.getLatest();return e===this.origin?this:dl(e,this.direction,this.offset)}getParentAtCaret(){return this.origin.getParent()}getChildCaret(){return null}getParentCaret(e="root"){return al(Zo(this.getParentAtCaret(),e),this.direction)}getFlipped(){return dl(this.origin,Qo(this.direction),this.offset)}isSamePointCaret(t){return t instanceof e&&this.direction===t.direction&&this.origin.is(t.origin)&&this.offset===t.offset}isSameNodeCaret(t){return(t instanceof el||t instanceof e)&&this.direction===t.direction&&this.origin.is(t.origin)}getSiblingCaret(){return al(this.origin,this.direction)}};function nl(e){return e instanceof tl}function rl(e){return e instanceof qo}function sl(e){return e instanceof el}function il(e){return e instanceof Go}const ol={next:class extends tl{direction="next";getNodeAtCaret(){return this.origin.getNextSibling()}insert(e){return this.origin.insertAfter(e),this}},previous:class extends tl{direction="previous";getNodeAtCaret(){return this.origin.getPreviousSibling()}insert(e){return this.origin.insertBefore(e),this}}},ll={next:class extends el{direction="next";getNodeAtCaret(){return this.origin.getNextSibling()}insert(e){return this.origin.insertAfter(e),this}},previous:class extends el{direction="previous";getNodeAtCaret(){return this.origin.getPreviousSibling()}insert(e){return this.origin.insertBefore(e),this}}},cl={next:class extends Go{direction="next";getNodeAtCaret(){return this.origin.getFirstChild()}insert(e){return this.origin.splice(0,0,[e]),this}},previous:class extends Go{direction="previous";getNodeAtCaret(){return this.origin.getLastChild()}insert(e){return this.origin.splice(this.origin.getChildrenSize(),0,[e]),this}}};function al(e,t){return e?new ll[t](e):null}function dl(e,t,n){return e?new ol[t](e,ul(e,n)):null}function ul(e,t,n="error"){const s=e.getTextContentSize();let i="next"===t?s:"previous"===t?0:t;return(i<0||i>s)&&("clamp"!==n&&r(`$getTextNodeOffset: invalid offset ${String(t)} for size ${String(s)} at key ${e.getKey()}`),i=i<0?0:s),i}function hl(e,t){return new _l(e,t)}function fl(e,t){return Ts(e)?new cl[t](e):null}function gl(e){return e&&e.getChildCaret()||e}function pl(e){return e&&gl(e.getAdjacentCaret())}var ml=class e{type="node-caret-range";direction;anchor;focus;constructor(e,t,n){this.anchor=e,this.focus=t,this.direction=n}getLatest(){const t=this.anchor.getLatest(),n=this.focus.getLatest();return t===this.anchor&&n===this.focus?this:new e(t,n,this.direction)}isCollapsed(){return this.anchor.isSamePointCaret(this.focus)}getTextSlices(){const e=e=>{const t=this[e].getLatest();return nl(t)?function(e,t){const{direction:n,origin:r}=e;return hl(e,ul(r,"focus"===t?Qo(n):n)-e.offset)}(t,e):null},t=e("anchor"),n=e("focus");if(t&&n){const{caret:e}=t,{caret:r}=n;if(e.isSameNodeCaret(r))return[hl(e,r.offset-e.offset),null]}return[t,n]}iterNodeCarets(e="root"){const t=nl(this.anchor)?this.anchor.getSiblingCaret():this.anchor.getLatest(),n=this.focus.getLatest(),r=nl(n),s=t=>t.isSameNodeCaret(n)?null:pl(t)||t.getParentCaret(e);return wl({hasNext:e=>null!==e&&!(r&&n.isSameNodeCaret(e)),initial:t.isSameNodeCaret(n)?null:s(t),map:e=>e,step:s})}[Symbol.iterator](){return this.iterNodeCarets("root")}},_l=class{type="slice";caret;distance;constructor(e,t){this.caret=e,this.distance=t}getSliceIndices(){const{distance:e,caret:{offset:t}}=this,n=t+e;return n<t?[n,t]:[t,n]}getTextContent(){const[e,t]=this.getSliceIndices();return this.caret.origin.getTextContent().slice(e,t)}getTextContentSize(){return Math.abs(this.distance)}removeTextSlice(){const{caret:{origin:e,direction:t}}=this,[n,r]=this.getSliceIndices(),s=e.getTextContent();return dl(e.setTextContent(s.slice(0,n)+s.slice(r)),t,n)}};function yl(e){return e instanceof _l}function bl(e){return Cl(e,al(Mi(),e.direction))}function Sl(e){return Cl(e,e)}function Cl(e,t){return e.direction!==t.direction&&r("$getCaretRange: anchor and focus must be in the same direction"),new ml(e,t,e.direction)}function wl(e){const{initial:t,hasNext:n,step:r,map:s}=e;let i=t;return{[Symbol.iterator](){return this},next(){if(!n(i))return{done:!0,value:void 0};const e={done:!1,value:s(i)};return i=r(i),e}}}function vl(e,t){const n=Nl(e.origin,t.origin);switch(null===n&&r(`$comparePointCaretNext: a (key ${e.origin.getKey()}) and b (key ${t.origin.getKey()}) do not have a common ancestor`),n.type){case"same":{const n="text"===e.type,r="text"===t.type;return n&&r?function(e,t){return Math.sign(e-t)}(e.offset,t.offset):e.type===t.type?0:n?-1:r?1:"child"===e.type?-1:1}case"ancestor":return"child"===e.type?-1:1;case"descendant":return"child"===t.type?1:-1;case"branch":return xl(n)}}function xl(e){const{a:t,b:n}=e,r=t.__key,s=n.__key;let i=t,o=n;for(;i&&o;i=i.getNextSibling(),o=o.getNextSibling()){if(i.__key===s)return-1;if(o.__key===r)return 1}return null===i?1:-1}function El(e,t){return t.is(e)}function kl(e){return Ts(e)?[e.getLatest(),null]:[e.getParent(),e.getLatest()]}function Nl(e,t){if(e.is(t))return{commonAncestor:e,type:"same"};const n=new Map;for(let[t,r]=kl(e);t;r=t,t=t.getParent())n.set(t,r);for(let[s,i]=kl(t);s;i=s,s=s.getParent()){const o=n.get(s);if(void 0!==o)return null===o?(El(e,s)||r("$originComparison: ancestor logic error"),{commonAncestor:s,type:"ancestor"}):null===i?(El(t,s)||r("$originComparison: descendant logic error"),{commonAncestor:s,type:"descendant"}):((Ts(o)||El(e,o))&&(Ts(i)||El(t,i))&&s.is(o.getParent())&&s.is(i.getParent())||r("$originComparison: branch logic error"),{a:o,b:i,commonAncestor:s,type:"branch"})}return null}function Tl(e,t){const{type:n,key:s,offset:i}=e,o=So(e.key);return"text"===n?(fr(o)||r(`$caretFromPoint: Node with type ${o.getType()} and key ${s} that does not inherit from TextNode encountered for text point`),dl(o,t,i)):(Ts(o)||r(`$caretFromPoint: Node with type ${o.getType()} and key ${s} that does not inherit from ElementNode encountered for element point`),Bl(o,e.offset,t))}function Ol(e,t){const{origin:n,direction:s}=t,i="next"===s;nl(t)?e.set(n.getKey(),t.offset,"text"):sl(t)?fr(n)?e.set(n.getKey(),ul(n,s),"text"):e.set(n.getParentOrThrow().getKey(),n.getIndexWithinParent()+(i?1:0),"element"):(il(t)&&Ts(n)||r("$setPointFromCaret: exhaustiveness check"),e.set(n.getKey(),i?0:n.getChildrenSize(),"element"))}function Al(e){const t=Ur(),n=vr(t)?t:$r();return Ml(n,e),Ii(n),n}function Ml(e,t){Ol(e.anchor,t.anchor),Ol(e.focus,t.focus)}function Dl(e){const{anchor:t,focus:n}=e,r=Tl(t,"next"),s=Tl(n,"next"),i=vl(r,s)<=0?"next":"previous";return Cl(Kl(r,i),Kl(s,i))}function Il(e){const{direction:t,origin:n}=e,r=al(n,Qo(t)).getNodeAtCaret();return r?al(r,t):fl(n.getParentOrThrow(),t)}function Pl(e,t="root"){const n=[e];for(let r=il(e)?e.getParentCaret(t):e.getSiblingCaret();null!==r;r=r.getParentCaret(t))n.push(Il(r));return n}function Ll(e){return!!e&&e.origin.isAttached()}function Rl(e,t="removeEmptySlices"){if(e.isCollapsed())return e;const n="root",s="next";let i=t;const o=zl(e,s),l=Pl(o.anchor,n),c=Pl(o.focus.getFlipped(),n),a=new Set,d=[];for(const e of o.iterNodeCarets(n))if(il(e))a.add(e.origin.getKey());else if(sl(e)){const{origin:t}=e;Ts(t)&&!a.has(t.getKey())||d.push(t)}for(const e of d)e.remove();for(const e of o.getTextSlices()){if(!e)continue;const{origin:t}=e.caret,n=t.getTextContentSize(),r=Il(al(t,s)),o=t.getMode();if(Math.abs(e.distance)===n&&"removeEmptySlices"===i||"token"===o&&0!==e.distance)r.remove();else if(0!==e.distance){i="removeEmptySlices";let t=e.removeTextSlice();const n=e.caret.origin;if("segmented"===o){const e=t.origin,n=hr(e.getTextContent()).setStyle(e.getStyle()).setFormat(e.getFormat());r.replaceOrInsert(n),t=dl(n,s,t.offset)}n.is(l[0].origin)&&(l[0]=t),n.is(c[0].origin)&&(c[0]=t.getFlipped())}}let u,h;for(const e of l)if(Ll(e)){u=$l(e);break}for(const e of c)if(Ll(e)){h=$l(e);break}const f=function(e,t,n){if(!e||!t)return null;const r=e.getParentAtCaret(),s=t.getParentAtCaret();if(!r||!s)return null;const i=r.getParents().reverse();i.push(r);const o=s.getParents().reverse();o.push(s);const l=Math.min(i.length,o.length);let c;for(c=0;c<l&&i[c]===o[c];c++);const a=(e,t)=>{let n;for(let r=c;r<e.length;r++){const s=e[r];if(mo(s))return;!n&&t(s)&&(n=s)}return n},d=a(i,Do),u=d&&a(o,e=>n.has(e.getKey())&&Do(e));return d&&u?[d,u]:null}(u,h,a);if(f){const[e,t]=f;fl(e,"previous").splice(0,t.getChildren()),t.remove()}const g=[u,h,...l,...c].find(Ll);if(g)return Sl(Kl($l(g),e.direction));r(`$removeTextFromCaretRange: selection was lost, could not find a new anchor given candidates with keys: ${JSON.stringify(l.map(e=>e.origin.__key))}`)}function $l(e){const t=function(e){let t=e;for(;il(t);){const e=pl(t);if(!il(e))break;t=e}return t}(e.getLatest()),{direction:n}=t;if(fr(t.origin))return nl(t)?t:dl(t.origin,n,n);const r=t.getAdjacentCaret();return sl(r)&&fr(r.origin)?dl(r.origin,n,Qo(n)):t}function Fl(e){return nl(e)&&e.offset!==ul(e.origin,e.direction)}function Kl(e,t){return e.direction===t?e:e.getFlipped()}function zl(e,t){return e.direction===t?e:Cl(Kl(e.focus,t),Kl(e.anchor,t))}function Bl(e,t,n){let r=fl(e,"next");for(let e=0;e<t;e++){const e=r.getAdjacentCaret();if(null===e)break;r=e}return Kl(r,n)}function Ul(e,t="root"){let n=0,r=e,s=pl(r);for(;null===s;){if(n--,s=r.getParentCaret(t),!s)return null;r=s,s=pl(r)}return s&&[s,n]}function jl(e){const{origin:t,offset:n,direction:s}=e;if(n===ul(t,s))return e.getSiblingCaret();if(n===ul(t,Qo(s)))return Il(e.getSiblingCaret());const[i]=t.splitText(n);return fr(i)||r("$splitTextPointCaret: splitText must return at least one TextNode"),Kl(al(i,"next"),s)}function Wl(e,t){return!0}function Yl(e,{$copyElementNode:t=_o,$splitTextPointCaretNext:n=jl,rootMode:r="shadowRoot",$shouldSplit:s=Wl}={}){if(nl(e))return n(e);const i=e.getParentCaret(r);if(i){const{origin:n}=i;if(il(e)&&(!n.canBeEmpty()||!s(n,"first")))return Il(i);const r=function(e){const t=[];for(let n=e.getAdjacentCaret();n;n=n.getAdjacentCaret())t.push(n.origin);return t}(e);(r.length>0||n.canBeEmpty()&&s(n,"last"))&&i.insert(t(n).splice(0,0,r))}return i}function Hl(e){return e}function Vl(...e){return e}function Jl(e,t){return[e,t]}function ql(e){return e}function Gl(e,t){if(!t||e===t)return e;for(const n in t)if(e[n]!==t[n])return{...e,...t};return e}const Xl=n,Ql=Xl.$addUpdateTag,Zl=(Xl.$applyNodeReplacement,Xl.$caretFromPoint),ec=Xl.$caretRangeFromSelection,tc=Xl.$cloneWithProperties,nc=Xl.$cloneWithPropertiesEphemeral,rc=(Xl.$comparePointCaretNext,Xl.$copyNode,Xl.$create,Xl.$createLineBreakNode,Xl.$createNodeSelection,Xl.$createParagraphNode),sc=(Xl.$createPoint,Xl.$createRangeSelection),ic=(Xl.$createRangeSelectionFromDom,Xl.$createTabNode,Xl.$createTextNode),oc=Xl.$extendCaretToRange,lc=Xl.$findMatchingParent,cc=(Xl.$getAdjacentChildCaret,Xl.$getAdjacentNode,Xl.$getAdjacentSiblingOrParentSiblingCaret,Xl.$getCaretInDirection,Xl.$getCaretRange,Xl.$getCaretRangeInDirection,Xl.$getCharacterOffsets),ac=(Xl.$getChildCaret,Xl.$getChildCaretAtIndex,Xl.$getChildCaretOrSelf,Xl.$getCollapsedCaretRange,Xl.$getCommonAncestor,Xl.$getCommonAncestorResultBranchOrder,Xl.$getEditor),dc=(Xl.$getNearestNodeFromDOMNode,Xl.$getNearestRootOrShadowRoot,Xl.$getNodeByKey),uc=Xl.$getNodeByKeyOrThrow,hc=(Xl.$getNodeFromDOMNode,Xl.$getPreviousSelection),fc=Xl.$getRoot,gc=Xl.$getSelection,pc=(Xl.$getSiblingCaret,Xl.$getState),mc=(Xl.$getStateChange,Xl.$getTextContent,Xl.$getTextNodeOffset,Xl.$getTextPointCaret,Xl.$getTextPointCaretSlice,Xl.$getWritableNodeState),_c=Xl.$hasAncestor,yc=(Xl.$hasUpdateTag,Xl.$insertNodes,Xl.$isBlockElementNode,Xl.$isChildCaret),bc=Xl.$isDecoratorNode,Sc=(Xl.$isEditorState,Xl.$isElementNode),Cc=Xl.$isExtendableTextPointCaret,wc=(Xl.$isInlineElementOrDecoratorNode,Xl.$isLeafNode),vc=Xl.$isLineBreakNode,xc=(Xl.$isNodeCaret,Xl.$isNodeSelection,Xl.$isParagraphNode,Xl.$isRangeSelection),Ec=Xl.$isRootNode,kc=Xl.$isRootOrShadowRoot,Nc=(Xl.$isSiblingCaret,Xl.$isTabNode,Xl.$isTextNode),Tc=(Xl.$isTextPointCaret,Xl.$isTextPointCaretSlice,Xl.$isTokenOrSegmented),Oc=(Xl.$isTokenOrTab,Xl.$nodesOfType,Xl.$normalizeCaret,Xl.$normalizeSelection__EXPERIMENTAL,Xl.$onUpdate,Xl.$parseSerializedNode,Xl.$removeTextFromCaretRange,Xl.$rewindSiblingCaret,Xl.$selectAll),Ac=(Xl.$setCompositionKey,Xl.$setPointFromCaret,Xl.$setSelection),Mc=(Xl.$setSelectionFromCaretRange,Xl.$setState,Xl.$splitAtPointCaretNext,Xl.$splitNode,Xl.$updateRangeSelectionFromCaretRange,Xl.ArtificialNode__DO_NOT_USE,Xl.BLUR_COMMAND,Xl.CAN_REDO_COMMAND,Xl.CAN_UNDO_COMMAND,Xl.CLEAR_EDITOR_COMMAND,Xl.CLEAR_HISTORY_COMMAND,Xl.CLICK_COMMAND,Xl.COLLABORATION_TAG),Dc=(Xl.COMMAND_PRIORITY_CRITICAL,Xl.COMMAND_PRIORITY_EDITOR,Xl.COMMAND_PRIORITY_HIGH,Xl.COMMAND_PRIORITY_LOW,Xl.COMMAND_PRIORITY_NORMAL,Xl.CONTROLLED_TEXT_INSERTION_COMMAND,Xl.COPY_COMMAND,Xl.CUT_COMMAND,Xl.DELETE_CHARACTER_COMMAND,Xl.DELETE_LINE_COMMAND,Xl.DELETE_WORD_COMMAND,Xl.DRAGEND_COMMAND,Xl.DRAGOVER_COMMAND,Xl.DRAGSTART_COMMAND,Xl.DROP_COMMAND,Xl.DecoratorNode,Xl.ElementNode),Ic=(Xl.FOCUS_COMMAND,Xl.FORMAT_ELEMENT_COMMAND,Xl.FORMAT_TEXT_COMMAND,Xl.HISTORIC_TAG),Pc=(Xl.HISTORY_MERGE_TAG,Xl.HISTORY_PUSH_TAG,Xl.INDENT_CONTENT_COMMAND,Xl.INSERT_LINE_BREAK_COMMAND,Xl.INSERT_PARAGRAPH_COMMAND,Xl.INSERT_TAB_COMMAND,Xl.INTERNAL_$isBlock),Lc=(Xl.IS_ALL_FORMATTING,Xl.IS_BOLD,Xl.IS_CODE,Xl.IS_HIGHLIGHT,Xl.IS_ITALIC,Xl.IS_STRIKETHROUGH,Xl.IS_SUBSCRIPT,Xl.IS_SUPERSCRIPT,Xl.IS_UNDERLINE,Xl.KEY_ARROW_DOWN_COMMAND,Xl.KEY_ARROW_LEFT_COMMAND,Xl.KEY_ARROW_RIGHT_COMMAND,Xl.KEY_ARROW_UP_COMMAND,Xl.KEY_BACKSPACE_COMMAND,Xl.KEY_DELETE_COMMAND,Xl.KEY_DOWN_COMMAND,Xl.KEY_ENTER_COMMAND,Xl.KEY_ESCAPE_COMMAND,Xl.KEY_MODIFIER_COMMAND,Xl.KEY_SPACE_COMMAND,Xl.KEY_TAB_COMMAND,Xl.LineBreakNode,Xl.MOVE_TO_END,Xl.MOVE_TO_START,Xl.NODE_STATE_KEY,Xl.OUTDENT_CONTENT_COMMAND,Xl.PASTE_COMMAND,Xl.PASTE_TAG,Xl.ParagraphNode,Xl.REDO_COMMAND,Xl.REMOVE_TEXT_COMMAND,Xl.RootNode),Rc=(Xl.SELECTION_CHANGE_COMMAND,Xl.SELECTION_INSERT_CLIPBOARD_NODES_COMMAND,Xl.SELECT_ALL_COMMAND,Xl.SKIP_COLLAB_TAG,Xl.SKIP_DOM_SELECTION_TAG,Xl.SKIP_SCROLL_INTO_VIEW_TAG),$c=(Xl.SKIP_SELECTION_FOCUS_TAG,Xl.TEXT_TYPE_TO_FORMAT,Xl.TabNode,Xl.TextNode),Fc=(Xl.UNDO_COMMAND,Xl.buildImportMap,Xl.configExtension,Xl.createCommand),Kc=Xl.createEditor,zc=(Xl.createSharedNodeState,Xl.createState),Bc=(Xl.declarePeerDependency,Xl.defineExtension,Xl.flipDirection,Xl.getDOMOwnerDocument,Xl.getDOMSelection,Xl.getDOMSelectionFromTarget,Xl.getDOMTextNode,Xl.getEditorPropertyFromDOMNode,Xl.getNearestEditorFromDOMNode,Xl.getRegisteredNode,Xl.getRegisteredNodeOrThrow,Xl.getStaticNodeConfig,Xl.getTextDirection,Xl.getTransformSetFromKlass,Xl.isBlockDomNode,Xl.isCurrentlyReadOnlyMode,Xl.isDOMDocumentNode,Xl.isDOMNode,Xl.isDOMTextNode,Xl.isDOMUnmanaged,Xl.isDocumentFragment,Xl.isExactShortcutMatch,Xl.isHTMLAnchorElement,Xl.isHTMLElement,Xl.isInlineDomNode,Xl.isLexicalEditor,Xl.isModifierMatch,Xl.isSelectionCapturedInDecoratorInput,Xl.isSelectionWithinEditor,Xl.makeStepwiseIterator,Xl.removeFromParent),Uc=(Xl.resetRandomKey,Xl.safeCast,Xl.setDOMUnmanaged,Xl.setNodeIndentFromDOM,Xl.shallowMergeConfig,()=>new Map),jc=e=>{const t=Uc();return e.forEach((e,n)=>{t.set(n,e)}),t},Wc=(e,t,n)=>{let r=e.get(t);return void 0===r&&e.set(t,r=n()),r},Yc=()=>new Set,Hc=e=>e[e.length-1],Vc=(e,t)=>{for(let n=0;n<t.length;n++)e.push(t[n])},Jc=Array.from,qc=Array.isArray;var Gc=class{constructor(){this._observers=Uc()}on(e,t){return Wc(this._observers,e,Yc).add(t),t}once(e,t){const n=(...r)=>{this.off(e,n),t(...r)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return Jc((this._observers.get(e)||Uc()).values()).forEach(e=>e(...t))}destroy(){this._observers=Uc()}},Xc=class{constructor(){this._observers=Uc()}on(e,t){Wc(this._observers,e,Yc).add(t)}once(e,t){const n=(...r)=>{this.off(e,n),t(...r)};this.on(e,n)}off(e,t){const n=this._observers.get(e);void 0!==n&&(n.delete(t),0===n.size&&this._observers.delete(e))}emit(e,t){return Jc((this._observers.get(e)||Uc()).values()).forEach(e=>e(...t))}destroy(){this._observers=Uc()}};const Qc=Math.floor,Zc=Math.abs,ea=(e,t)=>e<t?e:t,ta=(e,t)=>e>t?e:t,na=(Number.isNaN,e=>0!==e?e<0:1/e<0),ra=64,sa=128,ia=127,oa=2147483647,la=Number.MAX_SAFE_INTEGER,ca=(Number.MIN_SAFE_INTEGER,Number.isInteger||(e=>"number"==typeof e&&isFinite(e)&&Qc(e)===e)),aa=(Number.isNaN,Number.parseInt,String.fromCharCode),da=(String.fromCodePoint,aa(65535),/^\s*/g),ua=/([A-Z])/g,ha=(e,t)=>(e=>e.replace(da,""))(e.replace(ua,e=>`${t}${(e=>e.toLowerCase())(e)}`)),fa="undefined"!=typeof TextEncoder?new TextEncoder:null,ga=fa?e=>fa.encode(e):e=>{const t=unescape(encodeURIComponent(e)),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.codePointAt(e);return r};let pa="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});pa&&1===pa.decode(new Uint8Array).length&&(pa=null);var ma=class{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}};const _a=()=>new ma,ya=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},ba=e=>{const t=new Uint8Array(ya(e));let n=0;for(let r=0;r<e.bufs.length;r++){const s=e.bufs[r];t.set(s,n),n+=s.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},Sa=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(2*n),e.cpos=0),e.cbuf[e.cpos++]=t},Ca=Sa,wa=(e,t)=>{for(;t>ia;)Sa(e,sa|ia&t),t=Qc(t/128);Sa(e,ia&t)},va=(e,t)=>{const n=na(t);for(n&&(t=-t),Sa(e,(t>63?sa:0)|(n?ra:0)|63&t),t=Qc(t/64);t>0;)Sa(e,(t>ia?sa:0)|ia&t),t=Qc(t/128)},xa=new Uint8Array(3e4),Ea=xa.length/3,ka=fa&&fa.encodeInto?(e,t)=>{if(t.length<Ea){const n=fa.encodeInto(t,xa).written||0;wa(e,n);for(let t=0;t<n;t++)Sa(e,xa[t])}else Ta(e,ga(t))}:(e,t)=>{const n=unescape(encodeURIComponent(t)),r=n.length;wa(e,r);for(let t=0;t<r;t++)Sa(e,n.codePointAt(t))},Na=(e,t)=>{const n=e.cbuf.length,r=e.cpos,s=ea(n-r,t.length),i=t.length-s;e.cbuf.set(t.subarray(0,s),r),e.cpos+=s,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(ta(2*n,i)),e.cbuf.set(t.subarray(s)),e.cpos=i)},Ta=(e,t)=>{wa(e,t.byteLength),Na(e,t)},Oa=(e,t)=>{((e,t)=>{const n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(2*ta(n,t)),e.cpos=0)})(e,t);const n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},Aa=new DataView(new ArrayBuffer(4)),Ma=(e,t)=>{switch(typeof t){case"string":Sa(e,119),ka(e,t);break;case"number":ca(t)&&Zc(t)<=oa?(Sa(e,125),va(e,t)):(n=t,Aa.setFloat32(0,n),Aa.getFloat32(0)===n?(Sa(e,124),((e,t)=>{Oa(e,4).setFloat32(0,t,!1)})(e,t)):(Sa(e,123),((e,t)=>{Oa(e,8).setFloat64(0,t,!1)})(e,t)));break;case"bigint":Sa(e,122),((e,t)=>{Oa(e,8).setBigInt64(0,t,!1)})(e,t);break;case"object":if(null===t)Sa(e,126);else if(qc(t)){Sa(e,117),wa(e,t.length);for(let n=0;n<t.length;n++)Ma(e,t[n])}else if(t instanceof Uint8Array)Sa(e,116),Ta(e,t);else{Sa(e,118);const n=Object.keys(t);wa(e,n.length);for(let r=0;r<n.length;r++){const s=n[r];ka(e,s),Ma(e,t[s])}}break;case"boolean":Sa(e,t?120:121);break;default:Sa(e,127)}var n};var Da=class extends ma{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&wa(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}};const Ia=e=>{e.count>0&&(va(e.encoder,1===e.count?e.s:-e.s),e.count>1&&wa(e.encoder,e.count-2))};var Pa=class{constructor(){this.encoder=new ma,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Ia(this),this.count=1,this.s=e)}toUint8Array(){return Ia(this),ba(this.encoder)}};const La=e=>{if(e.count>0){const t=2*e.diff+(1===e.count?0:1);va(e.encoder,t),e.count>1&&wa(e.encoder,e.count-2)}};var Ra=class{constructor(){this.encoder=new ma,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(La(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return La(this),ba(this.encoder)}},$a=class{constructor(){this.sarr=[],this.s="",this.lensE=new Pa}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new ma;return this.sarr.push(this.s),this.s="",ka(e,this.sarr.join("")),Na(e,this.lensE.toUint8Array()),ba(e)}};const Fa=e=>new Error(e),Ka=()=>{throw Fa("Method unimplemented")},za=()=>{throw Fa("Unexpected case")},Ba=Fa("Unexpected end of array"),Ua=Fa("Integer out of Range");var ja=class{constructor(e){this.arr=e,this.pos=0}};const Wa=e=>new ja(e),Ya=e=>((e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n})(e,Va(e)),Ha=e=>e.arr[e.pos++],Va=e=>{let t=0,n=1;const r=e.arr.length;for(;e.pos<r;){const r=e.arr[e.pos++];if(t+=(r&ia)*n,n*=128,r<sa)return t;if(t>la)throw Ua}throw Ba},Ja=e=>{let t=e.arr[e.pos++],n=63&t,r=64;const s=(t&ra)>0?-1:1;if(0===(t&sa))return s*n;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],n+=(t&ia)*r,r*=128,t<sa)return s*n;if(n>la)throw Ua}throw Ba},qa=pa?e=>pa.decode(Ya(e)):e=>{let t=Va(e);if(0===t)return"";{let n=String.fromCodePoint(Ha(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Ha(e));else for(;t>0;){const r=t<1e4?t:1e4,s=e.arr.subarray(e.pos,e.pos+r);e.pos+=r,n+=String.fromCodePoint.apply(null,s),t-=r}return decodeURIComponent(escape(n))}},Ga=(e,t)=>{const n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},Xa=[e=>{},e=>null,Ja,e=>Ga(e,4).getFloat32(0,!1),e=>Ga(e,8).getFloat64(0,!1),e=>Ga(e,8).getBigInt64(0,!1),e=>!1,e=>!0,qa,e=>{const t=Va(e),n={};for(let r=0;r<t;r++){n[qa(e)]=Qa(e)}return n},e=>{const t=Va(e),n=[];for(let r=0;r<t;r++)n.push(Qa(e));return n},Ya],Qa=e=>Xa[127-Ha(e)](e);var Za=class extends ja{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){var e;return 0===this.count&&(this.s=this.reader(this),(e=this).pos!==e.arr.length?this.count=Va(this)+1:this.count=-1),this.count--,this.s}},ed=class extends ja{constructor(e){super(e),this.s=0,this.count=0}read(){if(0===this.count){this.s=Ja(this);const e=na(this.s);this.count=1,e&&(this.s=-this.s,this.count=Va(this)+2)}return this.count--,this.s}},td=class extends ja{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(0===this.count){const e=Ja(this),t=1&e;this.diff=Qc(e/2),this.count=1,t&&(this.count=Va(this)+2)}return this.s+=this.diff,this.count--,this.s}},nd=class{constructor(e){this.decoder=new ed(e),this.str=qa(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}};crypto.subtle;const rd=crypto.getRandomValues.bind(crypto),sd=()=>rd(new Uint32Array(1))[0],id=()=>"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^sd()&15>>e/4).toString(16)),od=Date.now,ld=e=>new Promise(e),cd=(Promise.all.bind(Promise),e=>void 0===e?null:e);let ad=new class{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}},dd=!0;try{"undefined"!=typeof localStorage&&localStorage&&(ad=localStorage,dd=!1)}catch(e){}const ud=ad,hd=Object.assign,fd=Object.keys,gd=e=>fd(e).length,pd=e=>fd(e).length,md=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),_d=Object.freeze,yd=e=>{for(const t in e){const n=e[t];"object"!=typeof n&&"function"!=typeof n||yd(e[t])}return _d(e)},bd=Symbol("Equality"),Sd=(e,t,n=0)=>{try{for(;n<e.length;n++)e[n](...t)}finally{n<e.length&&Sd(e,t,n+1)}},Cd=e=>e,wd=(e,t)=>{if(e===t)return!0;if(null==e||null==t||e.constructor!==t.constructor)return!1;if(null!=e[bd])return e[bd](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break;case Set:if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break;case Map:if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!wd(e.get(n),t.get(n)))return!1;break;case Object:if(gd(e)!==gd(t))return!1;for(const n in e)if(!md(e,n)||!wd(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!wd(e[n],t[n]))return!1;break;default:return!1}return!0},vd="undefined"!=typeof process&&process.release&&/node|io\.js/.test(process.release.name)&&"[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0),xd="undefined"!=typeof window&&"undefined"!=typeof document&&!vd;"undefined"!=typeof navigator&&/Mac/.test(navigator.platform);let Ed;const kd=[],Nd=e=>(()=>{if(void 0===Ed)if(vd){Ed=Uc();const e=process.argv;let t=null;for(let n=0;n<e.length;n++){const r=e[n];"-"===r[0]?(null!==t&&Ed.set(t,""),t=r):null!==t?(Ed.set(t,r),t=null):kd.push(r)}null!==t&&Ed.set(t,"")}else"object"==typeof location?(Ed=Uc(),(location.search||"?").slice(1).split("&").forEach(e=>{if(0!==e.length){const[t,n]=e.split("=");Ed.set(`--${ha(t,"-")}`,n),Ed.set(`-${ha(t,"-")}`,n)}})):Ed=Uc();return Ed})().has(e),Td=e=>cd(vd?process.env[e.toUpperCase().replaceAll("-","_")]:ud.getItem(e)),Od=e=>Nd("--"+e)||null!==Td(e);Od("production");var Ad;const Md=vd&&(Ad=process.env.FORCE_COLOR,["true","1","2"].includes(Ad))||!Nd("--no-colors")&&!Od("no-color")&&(!vd||process.stdout.isTTY)&&(!vd||Nd("--color")||null!==Td("COLORTERM")||(Td("TERM")||"").includes("color")),Dd=e=>new Uint8Array(e),Id=xd?e=>{let t="";for(let n=0;n<e.byteLength;n++)t+=aa(e[n]);return btoa(t)}:e=>Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64"),Pd=xd?e=>{const t=atob(e),n=Dd(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}:e=>{const t=Buffer.from(e,"base64");return n=t.buffer,r=t.byteOffset,s=t.byteLength,new Uint8Array(n,r,s);var n,r,s};var Ld=class{constructor(e,t){this.left=e,this.right=t}};const Rd=(e,t)=>new Ld(e,t),$d="undefined"!=typeof document?document:{},Fd=("undefined"!=typeof DOMParser&&new DOMParser,e=>((e,t)=>{const n=[];for(const[r,s]of e)n.push(t(s,r));return n})(e,(e,t)=>`${t}:${e};`).join("")),Kd=($d.ELEMENT_NODE,$d.TEXT_NODE,$d.CDATA_SECTION_NODE,$d.COMMENT_NODE,$d.DOCUMENT_NODE,$d.DOCUMENT_TYPE_NODE,$d.DOCUMENT_FRAGMENT_NODE,Symbol),zd=Kd(),Bd=Kd(),Ud=Kd(),jd=Kd(),Wd=Kd(),Yd=Kd(),Hd=Kd(),Vd=Kd(),Jd=Kd();od();const qd={[zd]:Rd("font-weight","bold"),[Bd]:Rd("font-weight","normal"),[Ud]:Rd("color","blue"),[Wd]:Rd("color","green"),[jd]:Rd("color","grey"),[Yd]:Rd("color","red"),[Hd]:Rd("color","purple"),[Vd]:Rd("color","orange"),[Jd]:Rd("color","black")},Gd=Md?e=>{1===e.length&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[],r=Uc();let s=[],i=0;for(;i<e.length;i++){const s=e[i],o=qd[s];if(void 0!==o)r.set(o.left,o.right);else{if(void 0===s)break;if(s.constructor!==String&&s.constructor!==Number)break;{const e=Fd(r);i>0||e.length>0?(t.push("%c"+s),n.push(e)):t.push(s)}}}for(i>0&&(s=n,s.unshift(t.join("")));i<e.length;i++){const t=e[i];t instanceof Symbol||s.push(t)}return s}:e=>{1===e.length&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[];let r=0;for(;r<e.length;r++){const n=e[r];if(void 0===n)break;if(n.constructor===String||n.constructor===Number)t.push(n);else if(n.constructor===Object)break}for(r>0&&n.push(t.join(""));r<e.length;r++){const t=e[r];t instanceof Symbol||n.push(t)}return n},Xd=(...e)=>{console.warn(...Gd(e)),e.unshift(Vd),Qd.forEach(t=>t.print(e))},Qd=Yc(),Zd=e=>({[Symbol.iterator](){return this},next:e}),eu=(e,t)=>Zd(()=>{const{done:n,value:r}=e.next();return{done:n,value:n?void 0:t(r)}});var tu=class{constructor(e,t){this.clock=e,this.len=t}},nu=class{constructor(){this.clients=new Map}};const ru=(e,t,n)=>t.clients.forEach((t,r)=>{const s=e.doc.store.clients.get(r);if(null!=s){const r=s[s.length-1],i=r.id.clock+r.length;for(let r=0,o=t[r];r<t.length&&o.clock<i;o=t[++r])oh(e,s,o.clock,o.len,n)}}),su=(e,t)=>{const n=e.clients.get(t.client);return void 0!==n&&null!==((e,t)=>{let n=0,r=e.length-1;for(;n<=r;){const s=Qc((n+r)/2),i=e[s],o=i.clock;if(o<=t){if(t<o+i.len)return s;n=s+1}else r=s-1}return null})(n,t.clock)},iu=e=>{e.clients.forEach(e=>{let t,n;for(e.sort((e,t)=>e.clock-t.clock),t=1,n=1;t<e.length;t++){const r=e[n-1],s=e[t];r.clock+r.len>=s.clock?r.len=ta(r.len,s.clock+s.len-r.clock):(n<t&&(e[n]=s),n++)}e.length=n})},ou=e=>{const t=new nu;for(let n=0;n<e.length;n++)e[n].clients.forEach((r,s)=>{if(!t.clients.has(s)){const i=r.slice();for(let t=n+1;t<e.length;t++)Vc(i,e[t].clients.get(s)||[]);t.clients.set(s,i)}});return iu(t),t},lu=(e,t,n,r)=>{Wc(e.clients,t,()=>[]).push(new tu(n,r))},cu=()=>new nu,au=e=>{const t=cu();return e.clients.forEach((e,n)=>{const r=[];for(let t=0;t<e.length;t++){const n=e[t];if(n.deleted){const s=n.id.clock;let i=n.length;if(t+1<e.length)for(let n=e[t+1];t+1<e.length&&n.deleted;n=e[1+ ++t])i+=n.length;r.push(new tu(s,i))}}r.length>0&&t.clients.set(n,r)}),t},du=(e,t)=>{wa(e.restEncoder,t.clients.size),Jc(t.clients.entries()).sort((e,t)=>t[0]-e[0]).forEach(([t,n])=>{e.resetDsCurVal(),wa(e.restEncoder,t);const r=n.length;wa(e.restEncoder,r);for(let t=0;t<r;t++){const r=n[t];e.writeDsClock(r.clock),e.writeDsLen(r.len)}})},uu=e=>{const t=new nu,n=Va(e.restDecoder);for(let r=0;r<n;r++){e.resetDsCurVal();const n=Va(e.restDecoder),r=Va(e.restDecoder);if(r>0){const s=Wc(t.clients,n,()=>[]);for(let t=0;t<r;t++)s.push(new tu(e.readDsClock(),e.readDsLen()))}}return t},hu=(e,t,n)=>{const r=new nu,s=Va(e.restDecoder);for(let i=0;i<s;i++){e.resetDsCurVal();const s=Va(e.restDecoder),i=Va(e.restDecoder),o=n.clients.get(s)||[],l=Zu(n,s);for(let n=0;n<i;n++){const n=e.readDsClock(),i=n+e.readDsLen();if(n<l){l<i&&lu(r,s,l,i-l);let e=th(o,n),c=o[e];for(!c.deleted&&c.id.clock<n&&(o.splice(e+1,0,Gf(t,c,n-c.id.clock)),e++);e<o.length&&(c=o[e++],c.id.clock<i);)c.deleted||(i<c.id.clock+c.length&&o.splice(e,0,Gf(t,c,i-c.id.clock)),c.delete(t))}else lu(r,s,n,i-n)}}if(r.clients.size>0){const e=new wu;return wa(e.restEncoder,0),du(e,r),e.toUint8Array()}return null},fu=sd;var gu=class e extends Gc{constructor({guid:e=id(),collectionid:t=null,gc:n=!0,gcFilter:r=()=>!0,meta:s=null,autoLoad:i=!1,shouldLoad:o=!0}={}){super(),this.gc=n,this.gcFilter=r,this.clientID=fu(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new Xu,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=o,this.autoLoad=i,this.meta=s,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=ld(e=>{this.on("load",()=>{this.isLoaded=!0,e(this)})});const l=()=>ld(e=>{const t=n=>{void 0!==n&&!0!==n||(this.off("sync",t),e())};this.on("sync",t)});this.on("sync",e=>{!1===e&&this.isSynced&&(this.whenSynced=l()),this.isSynced=void 0===e||!0===e,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=l()}load(){const e=this._item;null===e||this.shouldLoad||hh(e.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(Jc(this.subdocs).map(e=>e.guid))}transact(e,t=null){return hh(this,e,t)}get(e,t=$h){const n=Wc(this.share,e,()=>{const e=new t;return e._integrate(this,null),e}),r=n.constructor;if(t!==$h&&r!==t){if(r===$h){const r=new t;r._map=n._map,n._map.forEach(e=>{for(;null!==e;e=e.left)e.parent=r}),r._start=n._start;for(let e=r._start;null!==e;e=e.right)e.parent=r;return r._length=n._length,this.share.set(e,r),r._integrate(this,null),r}throw new Error(`Type with the name ${e} has already been defined with a different constructor`)}return n}getArray(e=""){return this.get(e,tf)}getText(e=""){return this.get(e,Sf)}getMap(e=""){return this.get(e,rf)}getXmlElement(e=""){return this.get(e,vf)}getXmlFragment(e=""){return this.get(e,wf)}toJSON(){const e={};return this.share.forEach((t,n)=>{e[n]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,Jc(this.subdocs).forEach(e=>e.destroy());const t=this._item;if(null!==t){this._item=null;const n=t.content;n.doc=new e({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=t,hh(t.parent.doc,e=>{const r=n.doc;t.deleted||e.subdocsAdded.add(r),e.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}},pu=class{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return Va(this.restDecoder)}readDsLen(){return Va(this.restDecoder)}},mu=class extends pu{readLeftID(){return $u(Va(this.restDecoder),Va(this.restDecoder))}readRightID(){return $u(Va(this.restDecoder),Va(this.restDecoder))}readClient(){return Va(this.restDecoder)}readInfo(){return Ha(this.restDecoder)}readString(){return qa(this.restDecoder)}readParentInfo(){return 1===Va(this.restDecoder)}readTypeRef(){return Va(this.restDecoder)}readLen(){return Va(this.restDecoder)}readAny(){return Qa(this.restDecoder)}readBuf(){return(e=>{const t=Dd(e.byteLength);return t.set(e),t})(Ya(this.restDecoder))}readJSON(){return JSON.parse(qa(this.restDecoder))}readKey(){return qa(this.restDecoder)}},_u=class{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=Va(this.restDecoder),this.dsCurrVal}readDsLen(){const e=Va(this.restDecoder)+1;return this.dsCurrVal+=e,e}},yu=class extends _u{constructor(e){super(e),this.keys=[],Va(e),this.keyClockDecoder=new td(Ya(e)),this.clientDecoder=new ed(Ya(e)),this.leftClockDecoder=new td(Ya(e)),this.rightClockDecoder=new td(Ya(e)),this.infoDecoder=new Za(Ya(e),Ha),this.stringDecoder=new nd(Ya(e)),this.parentInfoDecoder=new Za(Ya(e),Ha),this.typeRefDecoder=new ed(Ya(e)),this.lenDecoder=new ed(Ya(e))}readLeftID(){return new Lu(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Lu(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return 1===this.parentInfoDecoder.read()}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Qa(this.restDecoder)}readBuf(){return Ya(this.restDecoder)}readJSON(){return Qa(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const e=this.stringDecoder.read();return this.keys.push(e),e}}},bu=class{constructor(){this.restEncoder=_a()}toUint8Array(){return ba(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){wa(this.restEncoder,e)}writeDsLen(e){wa(this.restEncoder,e)}},Su=class extends bu{writeLeftID(e){wa(this.restEncoder,e.client),wa(this.restEncoder,e.clock)}writeRightID(e){wa(this.restEncoder,e.client),wa(this.restEncoder,e.clock)}writeClient(e){wa(this.restEncoder,e)}writeInfo(e){Ca(this.restEncoder,e)}writeString(e){ka(this.restEncoder,e)}writeParentInfo(e){wa(this.restEncoder,e?1:0)}writeTypeRef(e){wa(this.restEncoder,e)}writeLen(e){wa(this.restEncoder,e)}writeAny(e){Ma(this.restEncoder,e)}writeBuf(e){Ta(this.restEncoder,e)}writeJSON(e){ka(this.restEncoder,JSON.stringify(e))}writeKey(e){ka(this.restEncoder,e)}},Cu=class{constructor(){this.restEncoder=_a(),this.dsCurrVal=0}toUint8Array(){return ba(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const t=e-this.dsCurrVal;this.dsCurrVal=e,wa(this.restEncoder,t)}writeDsLen(e){0===e&&za(),wa(this.restEncoder,e-1),this.dsCurrVal+=e}},wu=class extends Cu{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ra,this.clientEncoder=new Pa,this.leftClockEncoder=new Ra,this.rightClockEncoder=new Ra,this.infoEncoder=new Da(Ca),this.stringEncoder=new $a,this.parentInfoEncoder=new Da(Ca),this.typeRefEncoder=new Pa,this.lenEncoder=new Pa}toUint8Array(){const e=_a();return wa(e,0),Ta(e,this.keyClockEncoder.toUint8Array()),Ta(e,this.clientEncoder.toUint8Array()),Ta(e,this.leftClockEncoder.toUint8Array()),Ta(e,this.rightClockEncoder.toUint8Array()),Ta(e,ba(this.infoEncoder)),Ta(e,this.stringEncoder.toUint8Array()),Ta(e,ba(this.parentInfoEncoder)),Ta(e,this.typeRefEncoder.toUint8Array()),Ta(e,this.lenEncoder.toUint8Array()),Na(e,ba(this.restEncoder)),ba(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Ma(this.restEncoder,e)}writeBuf(e){Ta(this.restEncoder,e)}writeJSON(e){Ma(this.restEncoder,e)}writeKey(e){const t=this.keyMap.get(e);void 0===t?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}};const vu=(e,t,n)=>{const r=new Map;n.forEach((e,n)=>{Zu(t,n)>e&&r.set(n,e)}),Qu(t).forEach((e,t)=>{n.has(t)||r.set(t,0)}),wa(e.restEncoder,r.size),Jc(r.entries()).sort((e,t)=>t[0]-e[0]).forEach(([n,r])=>{((e,t,n,r)=>{r=ta(r,t[0].id.clock);const s=th(t,r);wa(e.restEncoder,t.length-s),e.writeClient(n),wa(e.restEncoder,r);const i=t[s];i.write(e,r-i.id.clock);for(let n=s+1;n<t.length;n++)t[n].write(e,0)})(e,t.clients.get(n),n,r)})},xu=(e,t,n,r=new yu(e))=>hh(t,e=>{e.local=!1;let t=!1;const n=e.doc,s=n.store,i=((e,t,n)=>{const r=[];let s=Jc(n.keys()).sort((e,t)=>e-t);if(0===s.length)return null;const i=()=>{if(0===s.length)return null;let e=n.get(s[s.length-1]);for(;e.refs.length===e.i;){if(s.pop(),!(s.length>0))return null;e=n.get(s[s.length-1])}return e};let o=i();if(null===o)return null;const l=new Xu,c=new Map,a=(e,t)=>{const n=c.get(e);(null==n||n>t)&&c.set(e,t)};let d=o.refs[o.i++];const u=new Map,h=()=>{for(const e of r){const t=e.id.client,r=n.get(t);r?(r.i--,l.clients.set(t,r.refs.slice(r.i)),n.delete(t),r.i=0,r.refs=[]):l.clients.set(t,[e]),s=s.filter(e=>e!==t)}r.length=0};for(;;){if(d.constructor!==ng){const s=Wc(u,d.id.client,()=>Zu(t,d.id.client))-d.id.clock;if(s<0)r.push(d),a(d.id.client,d.id.clock-1),h();else{const i=d.getMissing(e,t);if(null!==i){r.push(d);const e=n.get(i)||{refs:[],i:0};if(e.refs.length!==e.i){d=e.refs[e.i++];continue}a(i,Zu(t,i)),h()}else(0===s||s<d.length)&&(d.integrate(e,s),u.set(d.id.client,d.id.clock+d.length))}}if(r.length>0)d=r.pop();else if(null!==o&&o.i<o.refs.length)d=o.refs[o.i++];else{if(o=i(),null===o)break;d=o.refs[o.i++]}}if(l.clients.size>0){const e=new wu;return vu(e,l,new Map),wa(e.restEncoder,0),{missing:c,update:e.toUint8Array()}}return null})(e,s,((e,t)=>{const n=Uc(),r=Va(e.restDecoder);for(let s=0;s<r;s++){const r=Va(e.restDecoder),s=new Array(r),i=e.readClient();let o=Va(e.restDecoder);n.set(i,{i:0,refs:s});for(let n=0;n<r;n++){const r=e.readInfo();switch(31&r){case 0:{const t=e.readLen();s[n]=new Tf($u(i,o),t),o+=t;break}case 10:{const t=Va(e.restDecoder);s[n]=new ng($u(i,o),t),o+=t;break}default:{const l=!(192&r),c=new Zf($u(i,o),null,(r&sa)===sa?e.readLeftID():null,null,(r&ra)===ra?e.readRightID():null,l?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,!l||32&~r?null:e.readString(),eg(e,r));s[n]=c,o+=c.length}}}}return n})(r,n)),o=s.pendingStructs;if(o){for(const[e,n]of o.missing)if(n<Zu(s,e)){t=!0;break}if(i){for(const[e,t]of i.missing){const n=o.missing.get(e);(null==n||n>t)&&o.missing.set(e,t)}o.update=Ch([o.update,i.update])}}else s.pendingStructs=i;const l=hu(r,e,s);if(s.pendingDs){const t=new yu(Wa(s.pendingDs));Va(t.restDecoder);const n=hu(t,e,s);s.pendingDs=l&&n?Ch([l,n]):l||n}else s.pendingDs=l;if(t){const t=s.pendingStructs.update;s.pendingStructs=null,Eu(e.doc,t)}},n,!1),Eu=(e,t,n,r=yu)=>{const s=Wa(t);xu(s,e,n,new r(s))},ku=(e,t=new Uint8Array([0]),n=new wu)=>{((e,t,n=new Map)=>{vu(e,t.store,n),du(e,au(t.store))})(n,e,Nu(t));const r=[n.toUint8Array()];if(e.store.pendingDs&&r.push(e.store.pendingDs),e.store.pendingStructs&&r.push(wh(e.store.pendingStructs.update,t)),r.length>1){if(n.constructor===Su)return bh(r.map((e,t)=>0===t?e:kh(e)));if(n.constructor===wu)return Ch(r)}return r[0]},Nu=e=>(e=>{const t=new Map,n=Va(e.restDecoder);for(let r=0;r<n;r++){const n=Va(e.restDecoder),r=Va(e.restDecoder);t.set(n,r)}return t})(new pu(Wa(e))),Tu=(e,t)=>(wa(e.restEncoder,t.size),Jc(t.entries()).sort((e,t)=>t[0]-e[0]).forEach(([t,n])=>{wa(e.restEncoder,t),wa(e.restEncoder,n)}),e),Ou=(e,t=new Cu)=>(e instanceof Map?Tu(t,e):((e,t)=>{Tu(e,Qu(t.store))})(t,e),t.toUint8Array());var Au=class{constructor(){this.l=[]}};const Mu=()=>new Au,Du=(e,t)=>e.l.push(t),Iu=(e,t)=>{const n=e.l,r=n.length;e.l=n.filter(e=>t!==e),r===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Pu=(e,t,n)=>Sd(e.l,[t,n]);var Lu=class{constructor(e,t){this.client=e,this.clock=t}};const Ru=(e,t)=>e===t||null!==e&&null!==t&&e.client===t.client&&e.clock===t.clock,$u=(e,t)=>new Lu(e,t),Fu=e=>{for(const[t,n]of e.doc.share.entries())if(n===e)return t;throw za()},Ku=(e,t)=>{for(;null!==t;){if(t.parent===e)return!0;t=t.parent._item}return!1};var zu=class{constructor(e,t=e.getMap("users")){const n=new Map;this.yusers=t,this.doc=e,this.clients=new Map,this.dss=n;const r=(e,t)=>{const n=e.get("ds"),r=e.get("ids"),s=e=>this.clients.set(e,t);n.observe(e=>{e.changes.added.forEach(e=>{e.content.getContent().forEach(e=>{e instanceof Uint8Array&&this.dss.set(t,ou([this.dss.get(t)||cu(),uu(new pu(Wa(e)))]))})})}),this.dss.set(t,ou(n.map(e=>uu(new pu(Wa(e)))))),r.observe(e=>e.changes.added.forEach(e=>e.content.getContent().forEach(s))),r.forEach(s)};t.observe(e=>{e.keysChanged.forEach(e=>r(t.get(e),e))}),t.forEach(r)}setUserMapping(e,t,n,{filter:r=()=>!0}={}){const s=this.yusers;let i=s.get(n);i||(i=new rf,i.set("ids",new tf),i.set("ds",new tf),s.set(n,i)),i.get("ids").push([t]),s.observe(e=>{setTimeout(()=>{const e=s.get(n);if(e!==i){i=e,this.clients.forEach((e,t)=>{n===e&&i.get("ids").push([t])});const t=new bu,r=this.dss.get(n);r&&(du(t,r),i.get("ds").push([t.toUint8Array()]))}},0)}),e.on("afterTransaction",e=>{setTimeout(()=>{const t=i.get("ds"),n=e.deleteSet;if(e.local&&n.clients.size>0&&r(e,n)){const e=new bu;du(e,n),t.push([e.toUint8Array()])}})})}getUserByClientId(e){return this.clients.get(e)||null}getUserByDeletedId(e){for(const[t,n]of this.dss.entries())if(su(n,e))return t;return null}},Bu=class{constructor(e,t,n,r=0){this.type=e,this.tname=t,this.item=n,this.assoc=r}},Uu=class{constructor(e,t,n=0){this.type=e,this.index=t,this.assoc=n}};const ju=(e,t,n)=>{let r=null,s=null;return null===e._item?s=Fu(e):r=$u(e._item.id.client,e._item.id.clock),new Bu(r,s,t,n)},Wu=(e,t,n=0)=>{let r=e._start;if(n<0){if(0===t)return ju(e,null,n);t--}for(;null!==r;){if(!r.deleted&&r.countable){if(r.length>t)return ju(e,$u(r.id.client,r.id.clock+t),n);t-=r.length}if(null===r.right&&n<0)return ju(e,r.lastId,n);r=r.right}return ju(e,null,n)},Yu=(e,t,n=!0)=>{const r=t.store,s=e.item,i=e.type,o=e.tname,l=e.assoc;let c=null,a=0;if(null!==s){if(Zu(r,s.client)<=s.clock)return null;const e=n?Jf(r,s):((e,t)=>{const n=nh(e,t);return{item:n,diff:t.clock-n.id.clock}})(r,s),t=e.item;if(!(t instanceof Zf))return null;if(c=t.parent,null===c._item||!c._item.deleted){a=t.deleted||!t.countable?0:e.diff+(l>=0?0:1);let n=t.left;for(;null!==n;)!n.deleted&&n.countable&&(a+=n.length),n=n.left}}else{if(null!==o)c=t.get(o);else{if(null===i)throw za();{if(Zu(r,i.client)<=i.clock)return null;const{item:e}=n?Jf(r,i):{item:nh(r,i)};if(!(e instanceof Zf&&e.content instanceof Vf))return null;c=e.content.type}}a=l>=0?c._length:0}return((e,t,n=0)=>new Uu(e,t,n))(c,a,e.assoc)};var Hu=class{constructor(e,t){this.ds=e,this.sv=t}};const Vu=(e,t)=>new Hu(e,t),Ju=Vu(cu(),new Map),qu=(e,t)=>void 0===t?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!su(t.ds,e.id),Gu=(e,t)=>{const n=Wc(e.meta,Gu,Yc),r=e.doc.store;n.has(t)||(t.sv.forEach((t,n)=>{t<Zu(r,n)&&sh(e,$u(n,t))}),ru(e,t.ds,e=>{}),n.add(t))};var Xu=class{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}};const Qu=e=>{const t=new Map;return e.clients.forEach((e,n)=>{const r=e[e.length-1];t.set(n,r.id.clock+r.length)}),t},Zu=(e,t)=>{const n=e.clients.get(t);if(void 0===n)return 0;const r=n[n.length-1];return r.id.clock+r.length},eh=(e,t)=>{let n=e.clients.get(t.id.client);if(void 0===n)n=[],e.clients.set(t.id.client,n);else{const e=n[n.length-1];if(e.id.clock+e.length!==t.id.clock)throw za()}n.push(t)},th=(e,t)=>{let n=0,r=e.length-1,s=e[r],i=s.id.clock;if(i===t)return r;let o=Qc(t/(i+s.length-1)*r);for(;n<=r;){if(s=e[o],i=s.id.clock,i<=t){if(t<i+s.length)return o;n=o+1}else r=o-1;o=Qc((n+r)/2)}throw za()},nh=(e,t)=>{const n=e.clients.get(t.client);return n[th(n,t.clock)]},rh=(e,t,n)=>{const r=th(t,n),s=t[r];return s.id.clock<n&&s instanceof Zf?(t.splice(r+1,0,Gf(e,s,n-s.id.clock)),r+1):r},sh=(e,t)=>{const n=e.doc.store.clients.get(t.client);return n[rh(e,n,t.clock)]},ih=(e,t,n)=>{const r=t.clients.get(n.client),s=th(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Tf&&r.splice(s+1,0,Gf(e,i,n.clock-i.id.clock+1)),i},oh=(e,t,n,r,s)=>{if(0===r)return;const i=n+r;let o,l=rh(e,t,n);do{o=t[l++],i<o.id.clock+o.length&&rh(e,t,i),s(o)}while(l<t.length&&t[l].id.clock<i)};var lh=class{constructor(e,t,n){this.doc=e,this.deleteSet=new nu,this.beforeState=Qu(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=n,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}};const ch=(e,t)=>!(0===t.deleteSet.clients.size&&!((e,t)=>{for(const[n,r]of e)if(t(r,n))return!0;return!1})(t.afterState,(e,n)=>t.beforeState.get(n)!==e))&&(iu(t.deleteSet),((e,t)=>{vu(e,t.doc.store,t.beforeState)})(e,t),du(e,t.deleteSet),!0),ah=(e,t,n)=>{const r=t._item;(null===r||r.id.clock<(e.beforeState.get(r.id.client)||0)&&!r.deleted)&&Wc(e.changed,t,Yc).add(n)},dh=(e,t)=>{let n=e[t],r=e[t-1],s=t;for(;s>0&&(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n));n=r,r=e[--s-1])n instanceof Zf&&null!==n.parentSub&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);const i=t-s;return i&&e.splice(t+1-i,i),i},uh=(e,t)=>{if(t<e.length){const n=e[t],r=n.doc,s=r.store,i=n.deleteSet,o=n._mergeStructs;try{iu(i),n.afterState=Qu(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const e=[];n.changed.forEach((t,r)=>e.push(()=>{null!==r._item&&r._item.deleted||r._callObserver(n,t)})),e.push(()=>{n.changedParentTypes.forEach((e,t)=>{t._dEH.l.length>0&&(null===t._item||!t._item.deleted)&&((e=e.filter(e=>null===e.target._item||!e.target._item.deleted)).forEach(e=>{e.currentTarget=t,e._path=null}),e.sort((e,t)=>e.path.length-t.path.length),Pu(t._dEH,e,n))})}),e.push(()=>r.emit("afterTransaction",[n,r])),Sd(e,[]),n._needFormattingCleanup&&_f(n)}finally{r.gc&&((e,t,n)=>{for(const[r,s]of e.clients.entries()){const e=t.clients.get(r);for(let r=s.length-1;r>=0;r--){const i=s[r],o=i.clock+i.len;for(let r=th(e,i.clock),s=e[r];r<e.length&&s.id.clock<o;s=e[++r]){const s=e[r];if(i.clock+i.len<=s.id.clock)break;s instanceof Zf&&s.deleted&&!s.keep&&n(s)&&s.gc(t,!1)}}}})(i,s,r.gcFilter),((e,t)=>{e.clients.forEach((e,n)=>{const r=t.clients.get(n);for(let t=e.length-1;t>=0;t--){const n=e[t];for(let e=ea(r.length-1,1+th(r,n.clock+n.len-1)),t=r[e];e>0&&t.id.clock>=n.clock;t=r[e])e-=1+dh(r,e)}})})(i,s),n.afterState.forEach((e,t)=>{const r=n.beforeState.get(t)||0;if(r!==e){const e=s.clients.get(t),n=ta(th(e,r),1);for(let t=e.length-1;t>=n;)t-=1+dh(e,t)}});for(let e=o.length-1;e>=0;e--){const{client:t,clock:n}=o[e].id,r=s.clients.get(t),i=th(r,n);i+1<r.length&&dh(r,i+1)>1||i>0&&dh(r,i)}if(n.local||n.afterState.get(r.clientID)===n.beforeState.get(r.clientID)||(((...e)=>{console.log(...Gd(e)),Qd.forEach(t=>t.print(e))})(Vd,zd,"[yjs] ",Bd,Yd,"Changed the client-id because another client seems to be using it."),r.clientID=fu()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const e=new Su;ch(e,n)&&r.emit("update",[e.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const e=new wu;ch(e,n)&&r.emit("updateV2",[e.toUint8Array(),n.origin,r,n])}const{subdocsAdded:l,subdocsLoaded:c,subdocsRemoved:a}=n;(l.size>0||a.size>0||c.size>0)&&(l.forEach(e=>{e.clientID=r.clientID,null==e.collectionid&&(e.collectionid=r.collectionid),r.subdocs.add(e)}),a.forEach(e=>r.subdocs.delete(e)),r.emit("subdocs",[{loaded:c,added:l,removed:a},r,n]),a.forEach(e=>e.destroy())),e.length<=t+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,e])):uh(e,t+1)}}},hh=(e,t,n=null,r=!0)=>{const s=e._transactionCleanups;let i=!1,o=null;null===e._transaction&&(i=!0,e._transaction=new lh(e,n,r),s.push(e._transaction),1===s.length&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{o=t(e._transaction)}finally{if(i){const t=e._transaction===s[0];e._transaction=null,t&&uh(s,0)}}return o};var fh=class{constructor(e,t){this.insertions=t,this.deletions=e,this.meta=new Map}};const gh=(e,t,n)=>{ru(e,n.deletions,n=>{n instanceof Zf&&t.scope.some(t=>t===e.doc||Ku(t,n))&&qf(n,!1)})},ph=(e,t,n)=>{let r=null;const s=e.doc,i=e.scope;hh(s,n=>{for(;t.length>0&&null===e.currStackItem;){const r=s.store,o=t.pop(),l=new Set,c=[];let a=!1;ru(n,o.insertions,e=>{if(e instanceof Zf){if(null!==e.redone){let{item:t,diff:s}=Jf(r,e.id);s>0&&(t=sh(n,$u(t.id.client,t.id.clock+s))),e=t}!e.deleted&&i.some(t=>t===n.doc||Ku(t,e))&&c.push(e)}}),ru(n,o.deletions,e=>{e instanceof Zf&&i.some(t=>t===n.doc||Ku(t,e))&&!su(o.insertions,e.id)&&l.add(e)}),l.forEach(t=>{a=null!==Qf(n,t,l,o.insertions,e.ignoreRemoteMapChanges,e)||a});for(let t=c.length-1;t>=0;t--){const r=c[t];e.deleteFilter(r)&&(r.delete(n),a=!0)}e.currStackItem=a?o:null}n.changed.forEach((e,t)=>{e.has(null)&&t._searchMarker&&(t._searchMarker.length=0)}),r=n},e);const o=e.currStackItem;if(null!=o){const t=r.changedParentTypes;e.emit("stack-item-popped",[{stackItem:o,type:n,changedParentTypes:t,origin:e},e]),e.currStackItem=null}return o};var mh=class extends Gc{constructor(e,{captureTimeout:t=500,captureTransaction:n=e=>!0,deleteFilter:r=()=>!0,trackedOrigins:s=new Set([null]),ignoreRemoteMapChanges:i=!1,doc:o=(qc(e)?e[0].doc:e instanceof gu?e:e.doc)}={}){super(),this.scope=[],this.doc=o,this.addToScope(e),this.deleteFilter=r,s.add(this),this.trackedOrigins=s,this.captureTransaction=n,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=i,this.captureTimeout=t,this.afterTransactionHandler=e=>{if(!(this.captureTransaction(e)&&this.scope.some(t=>e.changedParentTypes.has(t)||t===this.doc)&&(this.trackedOrigins.has(e.origin)||e.origin&&this.trackedOrigins.has(e.origin.constructor))))return;const t=this.undoing,n=this.redoing,r=t?this.redoStack:this.undoStack;t?this.stopCapturing():n||this.clear(!1,!0);const s=new nu;e.afterState.forEach((t,n)=>{const r=e.beforeState.get(n)||0,i=t-r;i>0&&lu(s,n,r,i)});const i=od();let o=!1;if(this.lastChange>0&&i-this.lastChange<this.captureTimeout&&r.length>0&&!t&&!n){const t=r[r.length-1];t.deletions=ou([t.deletions,e.deleteSet]),t.insertions=ou([t.insertions,s])}else r.push(new fh(e.deleteSet,s)),o=!0;t||n||(this.lastChange=i),ru(e,e.deleteSet,t=>{t instanceof Zf&&this.scope.some(n=>n===e.doc||Ku(n,t))&&qf(t,!0)});const l=[{stackItem:r[r.length-1],origin:e.origin,type:t?"redo":"undo",changedParentTypes:e.changedParentTypes},this];o?this.emit("stack-item-added",l):this.emit("stack-item-updated",l)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(e){const t=new Set(this.scope);(e=qc(e)?e:[e]).forEach(e=>{t.has(e)||(t.add(e),(e instanceof $h?e.doc!==this.doc:e!==this.doc)&&Xd("[yjs#509] Not same Y.Doc"),this.scope.push(e))})}addTrackedOrigin(e){this.trackedOrigins.add(e)}removeTrackedOrigin(e){this.trackedOrigins.delete(e)}clear(e=!0,t=!0){(e&&this.canUndo()||t&&this.canRedo())&&this.doc.transact(n=>{e&&(this.undoStack.forEach(e=>gh(n,this,e)),this.undoStack=[]),t&&(this.redoStack.forEach(e=>gh(n,this,e)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:e,redoStackCleared:t}])})}stopCapturing(){this.lastChange=0}undo(){let e;this.undoing=!0;try{e=ph(this,this.undoStack,"undo")}finally{this.undoing=!1}return e}redo(){let e;this.redoing=!0;try{e=ph(this,this.redoStack,"redo")}finally{this.redoing=!1}return e}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}};var _h=class{constructor(e,t){this.gen=function*(e){const t=Va(e.restDecoder);for(let n=0;n<t;n++){const t=Va(e.restDecoder),n=e.readClient();let r=Va(e.restDecoder);for(let s=0;s<t;s++){const t=e.readInfo();if(10===t){const t=Va(e.restDecoder);yield new ng($u(n,r),t),r+=t}else if(31&t){const s=!(192&t),i=new Zf($u(n,r),null,(t&sa)===sa?e.readLeftID():null,null,(t&ra)===ra?e.readRightID():null,s?e.readParentInfo()?e.readString():e.readLeftID():null,!s||32&~t?null:e.readString(),eg(e,t));yield i,r+=i.length}else{const t=e.readLen();yield new Tf($u(n,r),t),r+=t}}}}(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do{this.curr=this.gen.next().value||null}while(this.filterSkips&&null!==this.curr&&this.curr.constructor===ng);return this.curr}},yh=class{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}};const bh=e=>Ch(e,mu,Su),Sh=(e,t)=>{if(e.constructor===Tf){const{client:n,clock:r}=e.id;return new Tf($u(n,r+t),e.length-t)}if(e.constructor===ng){const{client:n,clock:r}=e.id;return new ng($u(n,r+t),e.length-t)}{const n=e,{client:r,clock:s}=n.id;return new Zf($u(r,s+t),null,$u(r,s+t-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(t))}},Ch=(e,t=yu,n=wu)=>{if(1===e.length)return e[0];const r=e.map(e=>new t(Wa(e)));let s=r.map(e=>new _h(e,!0)),i=null;const o=new n,l=new yh(o);for(;s=s.filter(e=>null!==e.curr),s.sort((e,t)=>{if(e.curr.id.client===t.curr.id.client){const n=e.curr.id.clock-t.curr.id.clock;return 0===n?e.curr.constructor===t.curr.constructor?0:e.curr.constructor===ng?1:-1:n}return t.curr.id.client-e.curr.id.client}),0!==s.length;){const e=s[0],t=e.curr.id.client;if(null!==i){let n=e.curr,r=!1;for(;null!==n&&n.id.clock+n.length<=i.struct.id.clock+i.struct.length&&n.id.client>=i.struct.id.client;)n=e.next(),r=!0;if(null===n||n.id.client!==t||r&&n.id.clock>i.struct.id.clock+i.struct.length)continue;if(t!==i.struct.id.client)xh(l,i.struct,i.offset),i={struct:n,offset:0},e.next();else if(i.struct.id.clock+i.struct.length<n.id.clock)if(i.struct.constructor===ng)i.struct.length=n.id.clock+n.length-i.struct.id.clock;else{xh(l,i.struct,i.offset);const e=n.id.clock-i.struct.id.clock-i.struct.length;i={struct:new ng($u(t,i.struct.id.clock+i.struct.length),e),offset:0}}else{const t=i.struct.id.clock+i.struct.length-n.id.clock;t>0&&(i.struct.constructor===ng?i.struct.length-=t:n=Sh(n,t)),i.struct.mergeWith(n)||(xh(l,i.struct,i.offset),i={struct:n,offset:0},e.next())}}else i={struct:e.curr,offset:0},e.next();for(let n=e.curr;null!==n&&n.id.client===t&&n.id.clock===i.struct.id.clock+i.struct.length&&n.constructor!==ng;n=e.next())xh(l,i.struct,i.offset),i={struct:n,offset:0}}return null!==i&&(xh(l,i.struct,i.offset),i=null),Eh(l),du(o,ou(r.map(e=>uu(e)))),o.toUint8Array()},wh=(e,t,n=yu,r=wu)=>{const s=Nu(t),i=new r,o=new yh(i),l=new n(Wa(e)),c=new _h(l,!1);for(;c.curr;){const e=c.curr,t=e.id.client,n=s.get(t)||0;if(c.curr.constructor!==ng)if(e.id.clock+e.length>n)for(xh(o,e,ta(n-e.id.clock,0)),c.next();c.curr&&c.curr.id.client===t;)xh(o,c.curr,0),c.next();else for(;c.curr&&c.curr.id.client===t&&c.curr.id.clock+c.curr.length<=n;)c.next();else c.next()}return Eh(o),du(i,uu(l)),i.toUint8Array()},vh=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:ba(e.encoder.restEncoder)}),e.encoder.restEncoder=_a(),e.written=0)},xh=(e,t,n)=>{e.written>0&&e.currClient!==t.id.client&&vh(e),0===e.written&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),wa(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},Eh=e=>{vh(e);const t=e.encoder.restEncoder;wa(t,e.clientStructs.length);for(let n=0;n<e.clientStructs.length;n++){const r=e.clientStructs[n];wa(t,r.written),Na(t,r.restEncoder)}},kh=e=>((e,t,n,r)=>{const s=new n(Wa(e)),i=new _h(s,!1),o=new r,l=new yh(o);for(let e=i.curr;null!==e;e=i.next())xh(l,t(e),0);return Eh(l),du(o,uu(s)),o.toUint8Array()})(e,Cd,yu,Su),Nh="You must not compute changes after the event-handler fired.";var Th=class{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=Oh(this.currentTarget,this.target))}deletes(e){return su(this.transaction.deleteSet,e.id)}get keys(){if(null===this._keys){if(0===this.transaction.doc._transactionCleanups.length)throw Fa(Nh);const e=new Map,t=this.target;this.transaction.changed.get(t).forEach(n=>{if(null!==n){const r=t._map.get(n);let s,i;if(this.adds(r)){let e=r.left;for(;null!==e&&this.adds(e);)e=e.left;if(this.deletes(r)){if(null===e||!this.deletes(e))return;s="delete",i=Hc(e.content.getContent())}else null!==e&&this.deletes(e)?(s="update",i=Hc(e.content.getContent())):(s="add",i=void 0)}else{if(!this.deletes(r))return;s="delete",i=Hc(r.content.getContent())}e.set(n,{action:s,oldValue:i})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(null===e){if(0===this.transaction.doc._transactionCleanups.length)throw Fa(Nh);const t=this.target,n=Yc(),r=Yc(),s=[];if(e={added:n,deleted:r,delta:s,keys:this.keys},this.transaction.changed.get(t).has(null)){let e=null;const i=()=>{e&&s.push(e)};for(let s=t._start;null!==s;s=s.right)s.deleted?this.deletes(s)&&!this.adds(s)&&(null!==e&&void 0!==e.delete||(i(),e={delete:0}),e.delete+=s.length,r.add(s)):this.adds(s)?(null!==e&&void 0!==e.insert||(i(),e={insert:[]}),e.insert=e.insert.concat(s.content.getContent()),n.add(s)):(null!==e&&void 0!==e.retain||(i(),e={retain:0}),e.retain+=s.length);null!==e&&void 0===e.retain&&i()}this._changes=e}return e}};const Oh=(e,t)=>{const n=[];for(;null!==t._item&&t!==e;){if(null!==t._item.parentSub)n.unshift(t._item.parentSub);else{let e=0,r=t._item.parent._start;for(;r!==t._item&&null!==r;)!r.deleted&&r.countable&&(e+=r.length),r=r.right;n.unshift(e)}t=t._item.parent}return n},Ah=()=>{Xd("Invalid access: Add Yjs type to a document before reading data.")};let Mh=0;var Dh=class{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=Mh++}};const Ih=(e,t,n)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=Mh++},Ph=(e,t)=>{if(null===e._start||0===t||null===e._searchMarker)return null;const n=0===e._searchMarker.length?null:e._searchMarker.reduce((e,n)=>Zc(t-e.index)<Zc(t-n.index)?e:n);let r=e._start,s=0;for(null!==n&&(r=n.p,s=n.index,(e=>{e.timestamp=Mh++})(n));null!==r.right&&s<t;){if(!r.deleted&&r.countable){if(t<s+r.length)break;s+=r.length}r=r.right}for(;null!==r.left&&s>t;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;null!==r.left&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return null!==n&&Zc(n.index-s)<r.parent.length/80?(Ih(n,r,s),n):((e,t,n)=>{if(e.length>=80){const r=e.reduce((e,t)=>e.timestamp<t.timestamp?e:t);return Ih(r,t,n),r}{const r=new Dh(t,n);return e.push(r),r}})(e._searchMarker,r,s)},Lh=(e,t,n)=>{for(let r=e.length-1;r>=0;r--){const s=e[r];if(n>0){let t=s.p;for(t.marker=!1;t&&(t.deleted||!t.countable);)t=t.left,t&&!t.deleted&&t.countable&&(s.index-=t.length);if(null===t||!0===t.marker){e.splice(r,1);continue}s.p=t,t.marker=!0}(t<s.index||n>0&&t===s.index)&&(s.index=ta(t,s.index+n))}},Rh=(e,t,n)=>{const r=e,s=t.changedParentTypes;for(;Wc(s,e,()=>[]).push(n),null!==e._item;)e=e._item.parent;Pu(r._eH,n,t)};var $h=class{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Mu(),this._dEH=Mu(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw Ka()}clone(){throw Ka()}_write(e){}get _first(){let e=this._start;for(;null!==e&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){Du(this._eH,e)}observeDeep(e){Du(this._dEH,e)}unobserve(e){Iu(this._eH,e)}unobserveDeep(e){Iu(this._dEH,e)}toJSON(){}};const Fh=(e,t,n)=>{e.doc??Ah(),t<0&&(t=e._length+t),n<0&&(n=e._length+n);let r=n-t;const s=[];let i=e._start;for(;null!==i&&r>0;){if(i.countable&&!i.deleted){const e=i.content.getContent();if(e.length<=t)t-=e.length;else{for(let n=t;n<e.length&&r>0;n++)s.push(e[n]),r--;t=0}}i=i.right}return s},Kh=e=>{e.doc??Ah();const t=[];let n=e._start;for(;null!==n;){if(n.countable&&!n.deleted){const e=n.content.getContent();for(let n=0;n<e.length;n++)t.push(e[n])}n=n.right}return t},zh=(e,t)=>{let n=0,r=e._start;for(e.doc??Ah();null!==r;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let r=0;r<s.length;r++)t(s[r],n++,e)}r=r.right}},Bh=(e,t)=>{const n=[];return zh(e,(r,s)=>{n.push(t(r,s,e))}),n},Uh=e=>{let t=e._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(null===n){for(;null!==t&&t.deleted;)t=t.right;if(null===t)return{done:!0,value:void 0};n=t.content.getContent(),r=0,t=t.right}const e=n[r++];return n.length<=r&&(n=null),{done:!1,value:e}}}},jh=(e,t)=>{e.doc??Ah();const n=Ph(e,t);let r=e._start;for(null!==n&&(r=n.p,t-=n.index);null!==r;r=r.right)if(!r.deleted&&r.countable){if(t<r.length)return r.content.getContent()[t];t-=r.length}},Wh=(e,t,n,r)=>{let s=n;const i=e.doc,o=i.clientID,l=i.store,c=null===n?t._start:n.right;let a=[];const d=()=>{a.length>0&&(s=new Zf($u(o,Zu(l,o)),s,s&&s.lastId,c,c&&c.id,t,null,new $f(a)),s.integrate(e,0),a=[])};r.forEach(n=>{if(null===n)a.push(n);else switch(n.constructor){case Number:case Object:case Boolean:case Array:case String:a.push(n);break;default:switch(d(),n.constructor){case Uint8Array:case ArrayBuffer:s=new Zf($u(o,Zu(l,o)),s,s&&s.lastId,c,c&&c.id,t,null,new Of(new Uint8Array(n))),s.integrate(e,0);break;case gu:s=new Zf($u(o,Zu(l,o)),s,s&&s.lastId,c,c&&c.id,t,null,new Df(n)),s.integrate(e,0);break;default:if(!(n instanceof $h))throw new Error("Unexpected content type in insert operation");s=new Zf($u(o,Zu(l,o)),s,s&&s.lastId,c,c&&c.id,t,null,new Vf(n)),s.integrate(e,0)}}}),d()},Yh=()=>Fa("Length exceeded!"),Hh=(e,t,n,r)=>{if(n>t._length)throw Yh();if(0===n)return t._searchMarker&&Lh(t._searchMarker,n,r.length),Wh(e,t,null,r);const s=n,i=Ph(t,n);let o=t._start;for(null!==i&&(o=i.p,0===(n-=i.index)&&(o=o.prev,n+=o&&o.countable&&!o.deleted?o.length:0));null!==o;o=o.right)if(!o.deleted&&o.countable){if(n<=o.length){n<o.length&&sh(e,$u(o.id.client,o.id.clock+n));break}n-=o.length}return t._searchMarker&&Lh(t._searchMarker,s,r.length),Wh(e,t,o,r)},Vh=(e,t,n,r)=>{if(0===r)return;const s=n,i=r,o=Ph(t,n);let l=t._start;for(null!==o&&(l=o.p,n-=o.index);null!==l&&n>0;l=l.right)!l.deleted&&l.countable&&(n<l.length&&sh(e,$u(l.id.client,l.id.clock+n)),n-=l.length);for(;r>0&&null!==l;)l.deleted||(r<l.length&&sh(e,$u(l.id.client,l.id.clock+r)),l.delete(e),r-=l.length),l=l.right;if(r>0)throw Yh();t._searchMarker&&Lh(t._searchMarker,s,-i+r)},Jh=(e,t,n)=>{const r=t._map.get(n);void 0!==r&&r.delete(e)},qh=(e,t,n,r)=>{const s=t._map.get(n)||null,i=e.doc,o=i.clientID;let l;if(null==r)l=new $f([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:l=new $f([r]);break;case Uint8Array:l=new Of(r);break;case gu:l=new Df(r);break;default:if(!(r instanceof $h))throw new Error("Unexpected content type");l=new Vf(r)}new Zf($u(o,Zu(i.store,o)),s,s&&s.lastId,null,null,t,n,l).integrate(e,0)},Gh=(e,t)=>{e.doc??Ah();const n=e._map.get(t);return void 0===n||n.deleted?void 0:n.content.getContent()[n.length-1]},Xh=e=>{const t={};return e.doc??Ah(),e._map.forEach((e,n)=>{e.deleted||(t[n]=e.content.getContent()[e.length-1])}),t},Qh=(e,t)=>{e.doc??Ah();const n=e._map.get(t);return void 0!==n&&!n.deleted},Zh=e=>{return e.doc??Ah(),t=e._map.entries(),n=e=>!e[1].deleted,Zd(()=>{let e;do{e=t.next()}while(!e.done&&!n(e.value));return e});var t,n};var ef=class extends Th{},tf=class e extends $h{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const n=new e;return n.push(t),n}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new e}clone(){const t=new e;return t.insert(0,this.toArray().map(e=>e instanceof $h?e.clone():e)),t}get length(){return this.doc??Ah(),this._length}_callObserver(e,t){super._callObserver(e,t),Rh(this,e,new ef(this,e))}insert(e,t){null!==this.doc?hh(this.doc,n=>{Hh(n,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){null!==this.doc?hh(this.doc,t=>{((e,t,n)=>{let r=(t._searchMarker||[]).reduce((e,t)=>t.index>e.index?t:e,{index:0,p:t._start}).p;if(r)for(;r.right;)r=r.right;Wh(e,t,r,n)})(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){null!==this.doc?hh(this.doc,n=>{Vh(n,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return jh(this,e)}toArray(){return Kh(this)}slice(e=0,t=this.length){return Fh(this,e,t)}toJSON(){return this.map(e=>e instanceof $h?e.toJSON():e)}map(e){return Bh(this,e)}forEach(e){zh(this,e)}[Symbol.iterator](){return Uh(this)}_write(e){e.writeTypeRef(zf)}};var nf=class extends Th{constructor(e,t,n){super(e,t),this.keysChanged=n}},rf=class e extends $h{constructor(e){super(),this._prelimContent=null,this._prelimContent=void 0===e?new Map:new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((e,t)=>{this.set(t,e)}),this._prelimContent=null}_copy(){return new e}clone(){const t=new e;return this.forEach((e,n)=>{t.set(n,e instanceof $h?e.clone():e)}),t}_callObserver(e,t){Rh(this,e,new nf(this,e,t))}toJSON(){this.doc??Ah();const e={};return this._map.forEach((t,n)=>{if(!t.deleted){const r=t.content.getContent()[t.length-1];e[n]=r instanceof $h?r.toJSON():r}}),e}get size(){return[...Zh(this)].length}keys(){return eu(Zh(this),e=>e[0])}values(){return eu(Zh(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return eu(Zh(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??Ah(),this._map.forEach((t,n)=>{t.deleted||e(t.content.getContent()[t.length-1],n,this)})}[Symbol.iterator](){return this.entries()}delete(e){null!==this.doc?hh(this.doc,t=>{Jh(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return null!==this.doc?hh(this.doc,n=>{qh(n,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return Gh(this,e)}has(e){return Qh(this,e)}clear(){null!==this.doc?hh(this.doc,e=>{this.forEach(function(t,n,r){Jh(e,r,n)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Bf)}};const sf=(e,t)=>e===t||"object"==typeof e&&"object"==typeof t&&e&&t&&((e,t)=>e===t||pd(e)===pd(t)&&((e,t)=>{for(const n in e)if(!t(e[n],n))return!1;return!0})(e,(e,n)=>(void 0!==e||md(t,n))&&t[n]===e))(e,t);var of=class{constructor(e,t,n,r){this.left=e,this.right=t,this.index=n,this.currentAttributes=r}forward(){if(null===this.right&&za(),this.right.content.constructor===Pf)this.right.deleted||df(this.currentAttributes,this.right.content);else this.right.deleted||(this.index+=this.right.length);this.left=this.right,this.right=this.right.right}};const lf=(e,t,n)=>{for(;null!==t.right&&n>0;){if(t.right.content.constructor===Pf)t.right.deleted||df(t.currentAttributes,t.right.content);else t.right.deleted||(n<t.right.length&&sh(e,$u(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);t.left=t.right,t.right=t.right.right}return t},cf=(e,t,n,r)=>{const s=new Map,i=r?Ph(t,n):null;return i?lf(e,new of(i.p.left,i.p,i.index,s),n-i.index):lf(e,new of(null,t._start,0,s),n)},af=(e,t,n,r)=>{for(;null!==n.right&&(!0===n.right.deleted||n.right.content.constructor===Pf&&sf(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=e.doc,i=s.clientID;r.forEach((r,o)=>{const l=n.left,c=n.right,a=new Zf($u(i,Zu(s.store,i)),l,l&&l.lastId,c,c&&c.id,t,null,new Pf(o,r));a.integrate(e,0),n.right=a,n.forward()})},df=(e,t)=>{const{key:n,value:r}=t;null===r?e.delete(n):e.set(n,r)},uf=(e,t)=>{for(;null!==e.right&&(e.right.deleted||e.right.content.constructor===Pf&&sf(t[e.right.content.key]??null,e.right.content.value));)e.forward()},hf=(e,t,n,r)=>{const s=e.doc,i=s.clientID,o=new Map;for(const l in r){const c=r[l],a=n.currentAttributes.get(l)??null;if(!sf(a,c)){o.set(l,a);const{left:r,right:d}=n;n.right=new Zf($u(i,Zu(s.store,i)),r,r&&r.lastId,d,d&&d.id,t,null,new Pf(l,c)),n.right.integrate(e,0),n.forward()}}return o},ff=(e,t,n,r,s)=>{n.currentAttributes.forEach((e,t)=>{void 0===s[t]&&(s[t]=null)});const i=e.doc,o=i.clientID;uf(n,s);const l=hf(e,t,n,s),c=r.constructor===String?new Ff(r):r instanceof $h?new Vf(r):new If(r);let{left:a,right:d,index:u}=n;t._searchMarker&&Lh(t._searchMarker,n.index,c.getLength()),d=new Zf($u(o,Zu(i.store,o)),a,a&&a.lastId,d,d&&d.id,t,null,c),d.integrate(e,0),n.right=d,n.index=u,n.forward(),af(e,t,n,l)},gf=(e,t,n,r,s)=>{const i=e.doc,o=i.clientID;uf(n,s);const l=hf(e,t,n,s);e:for(;null!==n.right&&(r>0||l.size>0&&(n.right.deleted||n.right.content.constructor===Pf));){if(!n.right.deleted)switch(n.right.content.constructor){case Pf:{const{key:t,value:i}=n.right.content,o=s[t];if(void 0!==o){if(sf(o,i))l.delete(t);else{if(0===r)break e;l.set(t,i)}n.right.delete(e)}else n.currentAttributes.set(t,i);break}default:r<n.right.length&&sh(e,$u(n.right.id.client,n.right.id.clock+r)),r-=n.right.length}n.forward()}if(r>0){let s="";for(;r>0;r--)s+="\n";n.right=new Zf($u(o,Zu(i.store,o)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new Ff(s)),n.right.integrate(e,0),n.forward()}af(e,t,n,l)},pf=(e,t,n,r,s)=>{let i=t;const o=Uc();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===Pf){const e=i.content;o.set(e.key,e)}i=i.right}let l=0,c=!1;for(;t!==i;){if(n===t&&(c=!0),!t.deleted){const n=t.content;switch(n.constructor){case Pf:{const{key:i,value:a}=n,d=r.get(i)??null;o.get(i)===n&&d!==a||(t.delete(e),l++,c||(s.get(i)??null)!==a||d===a||(null===d?s.delete(i):s.set(i,d))),c||t.deleted||df(s,n);break}}}t=t.right}return l},mf=e=>{let t=0;return hh(e.doc,n=>{let r=e._start,s=e._start,i=Uc();const o=jc(i);for(;s;){if(!1===s.deleted)if(s.content.constructor===Pf)df(o,s.content);else t+=pf(n,r,s,i,o),i=jc(o),r=s;s=s.right}}),t},_f=e=>{const t=new Set,n=e.doc;for(const[r,s]of e.afterState.entries()){const i=e.beforeState.get(r)||0;s!==i&&oh(e,n.store.clients.get(r),i,s,e=>{e.deleted||e.content.constructor!==Pf||e.constructor===Tf||t.add(e.parent)})}hh(n,n=>{ru(e,e.deleteSet,e=>{if(e instanceof Tf||!e.parent._hasFormatting||t.has(e.parent))return;const r=e.parent;e.content.constructor===Pf?t.add(r):((e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const n=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===Pf){const r=t.content.key;n.has(r)?t.delete(e):n.add(r)}t=t.left}})(n,e)});for(const e of t)mf(e)})},yf=(e,t,n)=>{const r=n,s=jc(t.currentAttributes),i=t.right;for(;n>0&&null!==t.right;){if(!1===t.right.deleted)switch(t.right.content.constructor){case Vf:case If:case Ff:n<t.right.length&&sh(e,$u(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e)}t.forward()}i&&pf(e,i,t.right,s,t.currentAttributes);const o=(t.left||t.right).parent;return o._searchMarker&&Lh(o._searchMarker,t.index,-r+n),t};var bf=class extends Th{constructor(e,t,n){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,n.forEach(e=>{null===e?this.childListChanged=!0:this.keysChanged.add(e)})}get changes(){return null===this._changes&&(this._changes={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set}),this._changes}get delta(){if(null===this._delta){const e=this.target.doc,t=[];hh(e,e=>{const n=new Map,r=new Map;let s=this.target._start,i=null;const o={};let l="",c=0,a=0;const d=()=>{if(null!==i){let e=null;switch(i){case"delete":a>0&&(e={delete:a}),a=0;break;case"insert":("object"==typeof l||l.length>0)&&(e={insert:l},n.size>0&&(e.attributes={},n.forEach((t,n)=>{null!==t&&(e.attributes[n]=t)}))),l="";break;case"retain":c>0&&(e={retain:c},(e=>{for(const t in e)return!1;return!0})(o)||(e.attributes=hd({},o))),c=0}e&&t.push(e),i=null}};for(;null!==s;){switch(s.content.constructor){case Vf:case If:this.adds(s)?this.deletes(s)||(d(),i="insert",l=s.content.getContent()[0],d()):this.deletes(s)?("delete"!==i&&(d(),i="delete"),a+=1):s.deleted||("retain"!==i&&(d(),i="retain"),c+=1);break;case Ff:this.adds(s)?this.deletes(s)||("insert"!==i&&(d(),i="insert"),l+=s.content.str):this.deletes(s)?("delete"!==i&&(d(),i="delete"),a+=s.length):s.deleted||("retain"!==i&&(d(),i="retain"),c+=s.length);break;case Pf:{const{key:t,value:l}=s.content;if(this.adds(s))this.deletes(s)||(sf(n.get(t)??null,l)?null!==l&&s.delete(e):("retain"===i&&d(),sf(l,r.get(t)??null)?delete o[t]:o[t]=l));else if(this.deletes(s)){r.set(t,l);const e=n.get(t)??null;sf(e,l)||("retain"===i&&d(),o[t]=e)}else if(!s.deleted){r.set(t,l);const n=o[t];void 0!==n&&(sf(n,l)?null!==n&&s.delete(e):("retain"===i&&d(),null===l?delete o[t]:o[t]=l))}s.deleted||("insert"===i&&d(),df(n,s.content));break}}s=s.right}for(d();t.length>0;){const e=t[t.length-1];if(void 0===e.retain||void 0!==e.attributes)break;t.pop()}}),this._delta=t}return this._delta}},Sf=class e extends $h{constructor(e){super(),this._pending=void 0!==e?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Ah(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(e=>e())}catch(e){console.error(e)}this._pending=null}_copy(){return new e}clone(){const t=new e;return t.applyDelta(this.toDelta()),t}_callObserver(e,t){super._callObserver(e,t);const n=new bf(this,e,t);Rh(this,e,n),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??Ah();let e="",t=this._start;for(;null!==t;)!t.deleted&&t.countable&&t.content.constructor===Ff&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){null!==this.doc?hh(this.doc,n=>{const r=new of(null,this._start,0,new Map);for(let s=0;s<e.length;s++){const i=e[s];if(void 0!==i.insert){const o=t||"string"!=typeof i.insert||s!==e.length-1||null!==r.right||"\n"!==i.insert.slice(-1)?i.insert:i.insert.slice(0,-1);("string"!=typeof o||o.length>0)&&ff(n,this,r,o,i.attributes||{})}else void 0!==i.retain?gf(n,this,r,i.retain,i.attributes||{}):void 0!==i.delete&&yf(n,r,i.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,n){this.doc??Ah();const r=[],s=new Map,i=this.doc;let o="",l=this._start;function c(){if(o.length>0){const e={};let t=!1;s.forEach((n,r)=>{t=!0,e[r]=n});const n={insert:o};t&&(n.attributes=e),r.push(n),o=""}}const a=()=>{for(;null!==l;){if(qu(l,e)||void 0!==t&&qu(l,t))switch(l.content.constructor){case Ff:{const r=s.get("ychange");void 0===e||qu(l,e)?void 0===t||qu(l,t)?void 0!==r&&(c(),s.delete("ychange")):void 0!==r&&r.user===l.id.client&&"added"===r.type||(c(),s.set("ychange",n?n("added",l.id):{type:"added"})):void 0!==r&&r.user===l.id.client&&"removed"===r.type||(c(),s.set("ychange",n?n("removed",l.id):{type:"removed"})),o+=l.content.str;break}case Vf:case If:{c();const e={insert:l.content.getContent()[0]};if(s.size>0){const t={};e.attributes=t,s.forEach((e,n)=>{t[n]=e})}r.push(e);break}case Pf:qu(l,e)&&(c(),df(s,l.content))}l=l.right}c()};return e||t?hh(i,n=>{e&&Gu(n,e),t&&Gu(n,t),a()},"cleanup"):a(),r}insert(e,t,n){if(t.length<=0)return;const r=this.doc;null!==r?hh(r,r=>{const s=cf(r,this,e,!n);n||(n={},s.currentAttributes.forEach((e,t)=>{n[t]=e})),ff(r,this,s,t,n)}):this._pending.push(()=>this.insert(e,t,n))}insertEmbed(e,t,n){const r=this.doc;null!==r?hh(r,r=>{const s=cf(r,this,e,!n);ff(r,this,s,t,n||{})}):this._pending.push(()=>this.insertEmbed(e,t,n||{}))}delete(e,t){if(0===t)return;const n=this.doc;null!==n?hh(n,n=>{yf(n,cf(n,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,n){if(0===t)return;const r=this.doc;null!==r?hh(r,r=>{const s=cf(r,this,e,!1);null!==s.right&&gf(r,this,s,t,n)}):this._pending.push(()=>this.format(e,t,n))}removeAttribute(e){null!==this.doc?hh(this.doc,t=>{Jh(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){null!==this.doc?hh(this.doc,n=>{qh(n,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return Gh(this,e)}getAttributes(){return Xh(this)}_write(e){e.writeTypeRef(Uf)}};var Cf=class{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??Ah()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(null!==e&&(!this._firstCall||e.deleted||!this._filter(t)))do{if(t=e.content.type,e.deleted||t.constructor!==vf&&t.constructor!==wf||null===t._start)for(;null!==e;){const t=e.next;if(null!==t){e=t;break}e=e.parent===this._root?null:e.parent._item}else e=t._start}while(null!==e&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,null===e?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}},wf=class e extends $h{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new e}clone(){const t=new e;return t.insert(0,this.toArray().map(e=>e instanceof $h?e.clone():e)),t}get length(){return this.doc??Ah(),null===this._prelimContent?this._length:this._prelimContent.length}createTreeWalker(e){return new Cf(this,e)}querySelector(e){e=e.toUpperCase();const t=new Cf(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e).next();return t.done?null:t.value}querySelectorAll(e){return e=e.toUpperCase(),Jc(new Cf(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){Rh(this,e,new xf(this,t,e))}toString(){return Bh(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},n){const r=e.createDocumentFragment();return void 0!==n&&n._createAssociation(r,this),zh(this,s=>{r.insertBefore(s.toDOM(e,t,n),null)}),r}insert(e,t){null!==this.doc?hh(this.doc,n=>{Hh(n,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(null!==this.doc)hh(this.doc,n=>{const r=e&&e instanceof $h?e._item:e;Wh(n,this,r,t)});else{const n=this._prelimContent,r=null===e?0:n.findIndex(t=>t===e)+1;if(0===r&&null!==e)throw Fa("Reference item not found");n.splice(r,0,...t)}}delete(e,t=1){null!==this.doc?hh(this.doc,n=>{Vh(n,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return Kh(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return jh(this,e)}slice(e=0,t=this.length){return Fh(this,e,t)}forEach(e){zh(this,e)}_write(e){e.writeTypeRef(Wf)}};var vf=class e extends wf{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((e,t)=>{this.setAttribute(t,e)}),this._prelimAttrs=null}_copy(){return new e(this.nodeName)}clone(){const t=new e(this.nodeName);return((e,t)=>{for(const n in e)t(e[n],n)})(this.getAttributes(),(e,n)=>{"string"==typeof e&&t.setAttribute(n,e)}),t.insert(0,this.toArray().map(e=>e instanceof $h?e.clone():e)),t}toString(){const e=this.getAttributes(),t=[],n=[];for(const t in e)n.push(t);n.sort();const r=n.length;for(let s=0;s<r;s++){const r=n[s];t.push(r+'="'+e[r]+'"')}const s=this.nodeName.toLocaleLowerCase();return`<${s}${t.length>0?" "+t.join(" "):""}>${super.toString()}</${s}>`}removeAttribute(e){null!==this.doc?hh(this.doc,t=>{Jh(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){null!==this.doc?hh(this.doc,n=>{qh(n,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return Gh(this,e)}hasAttribute(e){return Qh(this,e)}getAttributes(e){return e?((e,t)=>{const n={};return e._map.forEach((e,r)=>{let s=e;for(;null!==s&&(!t.sv.has(s.id.client)||s.id.clock>=(t.sv.get(s.id.client)||0));)s=s.left;null!==s&&qu(s,t)&&(n[r]=s.content.getContent()[s.length-1])}),n})(this,e):Xh(this)}toDOM(e=document,t={},n){const r=e.createElement(this.nodeName),s=this.getAttributes();for(const e in s){const t=s[e];"string"==typeof t&&r.setAttribute(e,t)}return zh(this,s=>{r.appendChild(s.toDOM(e,t,n))}),void 0!==n&&n._createAssociation(r,this),r}_write(e){e.writeTypeRef(jf),e.writeKey(this.nodeName)}};var xf=class extends Th{constructor(e,t,n){super(e,n),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(e=>{null===e?this.childListChanged=!0:this.attributesChanged.add(e)})}},Ef=class e extends rf{constructor(e){super(),this.hookName=e}_copy(){return new e(this.hookName)}clone(){const t=new e(this.hookName);return this.forEach((e,n)=>{t.set(n,e)}),t}toDOM(e=document,t={},n){const r=t[this.hookName];let s;return s=void 0!==r?r.createDom(this):document.createElement(this.hookName),s.setAttribute("data-yjs-hook",this.hookName),void 0!==n&&n._createAssociation(s,this),s}_write(e){e.writeTypeRef(Yf),e.writeKey(this.hookName)}};var kf=class e extends Sf{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new e}clone(){const t=new e;return t.applyDelta(this.toDelta()),t}toDOM(e=document,t,n){const r=e.createTextNode(this.toString());return void 0!==n&&n._createAssociation(r,this),r}toString(){return this.toDelta().map(e=>{const t=[];for(const n in e.attributes){const r=[];for(const t in e.attributes[n])r.push({key:t,value:e.attributes[n][t]});r.sort((e,t)=>e.key<t.key?-1:1),t.push({nodeName:n,attrs:r})}t.sort((e,t)=>e.nodeName<t.nodeName?-1:1);let n="";for(let e=0;e<t.length;e++){const r=t[e];n+=`<${r.nodeName}`;for(let e=0;e<r.attrs.length;e++){const t=r.attrs[e];n+=` ${t.key}="${t.value}"`}n+=">"}n+=e.insert;for(let e=t.length-1;e>=0;e--)n+=`</${t[e].nodeName}>`;return n}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(Hf)}};var Nf=class{constructor(e,t){this.id=e,this.length=t}get deleted(){throw Ka()}mergeWith(e){return!1}write(e,t,n){throw Ka()}integrate(e,t){throw Ka()}};var Tf=class extends Nf{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),eh(e.doc.store,this)}write(e,t){e.writeInfo(0),e.writeLen(this.length-t)}getMissing(e,t){return null}},Of=class e{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new e(this.content)}splice(e){throw Ka()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}};var Af=class e{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new e(this.len)}splice(t){const n=new e(this.len-t);return this.len=t,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){lu(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}};const Mf=(e,t)=>new gu({guid:e,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});var Df=class e{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),null!==e.meta&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new e(Mf(this.doc.guid,this.opts))}splice(e){throw Ka()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}};var If=class e{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new e(this.embed)}splice(e){throw Ka()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}};var Pf=class e{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new e(this.key,this.value)}splice(e){throw Ka()}mergeWith(e){return!1}integrate(e,t){const n=t.parent;n._searchMarker=null,n._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}};var Lf=class e{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new e(this.arr)}splice(t){const n=new e(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const n=this.arr.length;e.writeLen(n-t);for(let r=t;r<n;r++){const t=this.arr[r];e.writeString(void 0===t?"undefined":JSON.stringify(t))}}getRef(){return 2}};const Rf="development"===Td("node_env");var $f=class e{constructor(e){this.arr=e,Rf&&yd(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new e(this.arr)}splice(t){const n=new e(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const n=this.arr.length;e.writeLen(n-t);for(let r=t;r<n;r++){const t=this.arr[r];e.writeAny(t)}}getRef(){return 8}};var Ff=class e{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new e(this.str)}splice(t){const n=new e(this.str.slice(t));this.str=this.str.slice(0,t);const r=this.str.charCodeAt(t-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,t-1)+"�",n.str="�"+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(0===t?this.str:this.str.slice(t))}getRef(){return 4}};const Kf=[e=>new tf,e=>new rf,e=>new Sf,e=>new vf(e.readKey()),e=>new wf,e=>new Ef(e.readKey()),e=>new kf],zf=0,Bf=1,Uf=2,jf=3,Wf=4,Yf=5,Hf=6;var Vf=class e{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new e(this.type._copy())}splice(e){throw Ka()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;null!==t;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(t=>{t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;null!==t;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(t=>{for(;null!==t;)t.gc(e,!0),t=t.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}};const Jf=(e,t)=>{let n,r=t,s=0;do{s>0&&(r=$u(r.client,r.clock+s)),n=nh(e,r),s=r.clock-n.id.clock,r=n.redone}while(null!==r&&n instanceof Zf);return{item:n,diff:s}},qf=(e,t)=>{for(;null!==e&&e.keep!==t;)e.keep=t,e=e.parent._item},Gf=(e,t,n)=>{const{client:r,clock:s}=t.id,i=new Zf($u(r,s+n),t,$u(r,s+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),null!==t.redone&&(i.redone=$u(t.redone.client,t.redone.clock+n)),t.right=i,null!==i.right&&(i.right.left=i),e._mergeStructs.push(i),null!==i.parentSub&&null===i.right&&i.parent._map.set(i.parentSub,i),t.length=n,i},Xf=(e,t)=>((e,t)=>{for(let n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1})(e,e=>su(e.deletions,t)),Qf=(e,t,n,r,s,i)=>{const o=e.doc,l=o.store,c=o.clientID,a=t.redone;if(null!==a)return sh(e,a);let d,u=t.parent._item,h=null;if(null!==u&&!0===u.deleted){if(null===u.redone&&(!n.has(u)||null===Qf(e,u,n,r,s,i)))return null;for(;null!==u.redone;)u=sh(e,u.redone)}const f=null===u?t.parent:u.content.type;if(null===t.parentSub){for(h=t.left,d=t;null!==h;){let t=h;for(;null!==t&&t.parent._item!==u;)t=null===t.redone?null:sh(e,t.redone);if(null!==t&&t.parent._item===u){h=t;break}h=h.left}for(;null!==d;){let t=d;for(;null!==t&&t.parent._item!==u;)t=null===t.redone?null:sh(e,t.redone);if(null!==t&&t.parent._item===u){d=t;break}d=d.right}}else if(d=null,t.right&&!s){for(h=t;null!==h&&null!==h.right&&(h.right.redone||su(r,h.right.id)||Xf(i.undoStack,h.right.id)||Xf(i.redoStack,h.right.id));)for(h=h.right;h.redone;)h=sh(e,h.redone);if(h&&null!==h.right)return null}else h=f._map.get(t.parentSub)||null;const g=$u(c,Zu(l,c)),p=new Zf(g,h,h&&h.lastId,d,d&&d.id,f,t.parentSub,t.content.copy());return t.redone=g,qf(p,!0),p.integrate(e,0),p};var Zf=class e extends Nf{constructor(e,t,n,r,s,i,o,l){super(e,l.getLength()),this.origin=n,this.left=t,this.right=r,this.rightOrigin=s,this.parent=i,this.parentSub=o,this.redone=null,this.content=l,this.info=this.content.isCountable()?2:0}set marker(e){(8&this.info)>0!==e&&(this.info^=8)}get marker(){return(8&this.info)>0}get keep(){return(1&this.info)>0}set keep(e){this.keep!==e&&(this.info^=1)}get countable(){return(2&this.info)>0}get deleted(){return(4&this.info)>0}set deleted(e){this.deleted!==e&&(this.info^=4)}markDeleted(){this.info|=4}getMissing(t,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=Zu(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=Zu(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Lu&&this.id.client!==this.parent.client&&this.parent.clock>=Zu(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=ih(t,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=sh(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Tf||this.right&&this.right.constructor===Tf)this.parent=null;else if(this.parent){if(this.parent.constructor===Lu){const e=nh(n,this.parent);e.constructor===Tf?this.parent=null:this.parent=e.content.type}}else this.left&&this.left.constructor===e?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===e&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=ih(e,e.doc.store,$u(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||null!==this.right.left)||this.left&&this.left.right!==this.right){let t,n=this.left;if(null!==n)t=n.right;else if(null!==this.parentSub)for(t=this.parent._map.get(this.parentSub)||null;null!==t&&null!==t.left;)t=t.left;else t=this.parent._start;const r=new Set,s=new Set;for(;null!==t&&t!==this.right;){if(s.add(t),r.add(t),Ru(this.origin,t.origin)){if(t.id.client<this.id.client)n=t,r.clear();else if(Ru(this.rightOrigin,t.rightOrigin))break}else{if(null===t.origin||!s.has(nh(e.doc.store,t.origin)))break;r.has(nh(e.doc.store,t.origin))||(n=t,r.clear())}t=t.right}this.left=n}if(null!==this.left)this.right=this.left.right,this.left.right=this;else{let e;if(null!==this.parentSub)for(e=this.parent._map.get(this.parentSub)||null;null!==e&&null!==e.left;)e=e.left;else e=this.parent._start,this.parent._start=this;this.right=e}null!==this.right?this.right.left=this:null!==this.parentSub&&(this.parent._map.set(this.parentSub,this),null!==this.left&&this.left.delete(e)),null===this.parentSub&&this.countable&&!this.deleted&&(this.parent._length+=this.length),eh(e.doc.store,this),this.content.integrate(e,this),ah(e,this.parent,this.parentSub),(null!==this.parent._item&&this.parent._item.deleted||null!==this.parentSub&&null!==this.right)&&this.delete(e)}else new Tf(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;null!==e&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;null!==e&&e.deleted;)e=e.left;return e}get lastId(){return 1===this.length?this.id:$u(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&Ru(e.origin,this.lastId)&&this.right===e&&Ru(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&null===this.redone&&null===e.redone&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const t=this.parent._searchMarker;return t&&t.forEach(t=>{t.p===e&&(t.p=this,!this.deleted&&this.countable&&(t.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,null!==this.right&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const t=this.parent;this.countable&&null===this.parentSub&&(t._length-=this.length),this.markDeleted(),lu(e.deleteSet,this.id.client,this.id.clock,this.length),ah(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw za();this.content.gc(e),t?((e,t,n)=>{const r=e.clients.get(t.id.client);r[th(r,t.id.clock)]=n})(e,this,new Tf(this.id,this.length)):this.content=new Af(this.length)}write(e,t){const n=t>0?$u(this.id.client,this.id.clock+t-1):this.origin,r=this.rightOrigin,s=this.parentSub,i=31&this.content.getRef()|(null===n?0:sa)|(null===r?0:ra)|(null===s?0:32);if(e.writeInfo(i),null!==n&&e.writeLeftID(n),null!==r&&e.writeRightID(r),null===n&&null===r){const t=this.parent;if(void 0!==t._item){const n=t._item;if(null===n){const n=Fu(t);e.writeParentInfo(!0),e.writeString(n)}else e.writeParentInfo(!1),e.writeLeftID(n.id)}else t.constructor===String?(e.writeParentInfo(!0),e.writeString(t)):t.constructor===Lu?(e.writeParentInfo(!1),e.writeLeftID(t)):za();null!==s&&e.writeString(s)}this.content.write(e,t)}};const eg=(e,t)=>tg[31&t](e),tg=[()=>{za()},e=>new Af(e.readLen()),e=>{const t=e.readLen(),n=[];for(let r=0;r<t;r++){const t=e.readString();"undefined"===t?n.push(void 0):n.push(JSON.parse(t))}return new Lf(n)},e=>new Of(e.readBuf()),e=>new Ff(e.readString()),e=>new If(e.readJSON()),e=>new Pf(e.readKey(),e.readJSON()),e=>new Vf(Kf[e.readTypeRef()](e)),e=>{const t=e.readLen(),n=[];for(let r=0;r<t;r++)n.push(e.readAny());return new $f(n)},e=>new Df(Mf(e.readString(),e.readAny())),()=>{za()}];var ng=class extends Nf{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor===e.constructor&&(this.length+=e.length,!0)}integrate(e,t){za()}write(e,t){e.writeInfo(10),wa(e.restEncoder,this.length-t)}getMissing(e,t){return null}};const rg="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},sg="__ $YJS$ __";!0===rg[sg]&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438"),rg[sg]=!0;var ig=t({$createChildrenArray:()=>fg,$createOffsetView:()=>pg,OffsetView:()=>lg,createChildrenArray:()=>gg});function og(e){throw new Error(e)}var lg=class{_offsetMap;_firstNode;_blockOffsetSize;constructor(e,t,n=1){this._offsetMap=e,this._firstNode=t,this._blockOffsetSize=n}createSelectionFromOffsets(e,t,n){const r=this._firstNode;if(null===r)return null;let s=e,i=t,o=ag(r,s,this._blockOffsetSize),l=ag(r,i,this._blockOffsetSize);if(void 0!==n&&(s=cg(s,o,n,this,this._blockOffsetSize),o=ag(r,s,this._blockOffsetSize),i=cg(i,l,n,this,this._blockOffsetSize),l=ag(r,i,this._blockOffsetSize)),null===o||null===l)return null;let c=o.key,a=l.key;const d=dc(c),u=dc(a);if(null===d||null===u)return null;let h=0,f=0,g="element",p="element";if("text"===o.type){h=s-o.start,g="text";const e=d.getNextSibling();s!==i&&h===d.getTextContentSize()&&Nc(e)&&(h=0,c=e.__key)}else"inline"===o.type&&(c=d.getParentOrThrow().getKey(),h=i>o.start?o.end:o.start);"text"===l.type?(f=i-l.start,p="text"):"inline"===l.type&&(a=u.getParentOrThrow().getKey(),f=i>l.start?l.end:l.start);const m=sc();return null===m?null:(m.anchor.set(c,h,g),m.focus.set(a,f,p),m)}getOffsetsFromSelection(e){const t=e.anchor,n=e.focus,r=this._offsetMap,s=t.offset,i=n.offset;let o=-1,l=-1;if("text"===t.type){const e=r.get(t.key);void 0!==e&&(o=e.start+s)}else{const e=t.getNode().getDescendantByIndex(s);if(null!==e){const t=r.get(e.getKey());void 0!==t&&(o=e.getIndexWithinParent()!==s?t.end:t.start)}}if("text"===n.type){const e=r.get(n.key);void 0!==e&&(l=e.start+n.offset)}else{const e=n.getNode().getDescendantByIndex(i);if(null!==e){const t=r.get(e.getKey());void 0!==t&&(l=e.getIndexWithinParent()!==i?t.end:t.start)}}return[o,l]}};function cg(e,t,n,r,s){const i=n._offsetMap,o=r._offsetMap,l=new Set;let c=e,a=t;for(;null!==a;){const e=a.key,t=i.get(e),n=a.end-a.start;if(l.add(e),void 0===t)c+=n;else{const e=t.end-t.start;e!==n&&(c+=n-e)}const r=a.prev;if(null!==r){a=r;continue}let s=a.parent;for(;null!==s;){let e=s.prev;if(null!==e){const t=e.key,n=i.get(t),r=e.end-e.start;if(l.add(t),void 0===n)c+=r;else{const e=n.end-n.start;e!==r&&(c+=r-e)}e=e.prev}s=s.parent}break}const d=n._firstNode;if(null!==d){a=ag(d,e,s);let t=!1;for(;null!==a;){if(!l.has(a.key)){t=!0;break}a=a.parent}if(!t)for(;null!==a;){const e=a.key;if(!l.has(e)){const t=o.get(e),n=a.end-a.start;if(void 0===t)c-=n;else{const e=t.end-t.start;n!==e&&(c+=e-n)}}a=a.prev}}return c}function ag(e,t,n){let r=e;for(;null!==r;){if(t<r.end+("element"!==r.type||0===n?1:0)){const e=r.child;if(null!==e){r=e;continue}return r}const e=r.next;if(null===e)break;r=e}return null}function dg(e,t,n,r,s,i){return{child:e,end:r,key:s,next:null,parent:i,prev:null,start:n,type:t}}function ug(e,t,n,r,s,i){const o=r.get(t);void 0===o&&og("createOffsetModel: could not find node by key");const l=e.offset;if(Sc(o)){const c=fg(o,r),a=0===c.length,d=a?null:hg(e,c,null,r,s,i);e.prevIsBlock&&!a||(e.prevIsBlock=!0,e.offset+=i);const u=dg(d,"element",l,l,t,n);return null!==d&&(d.parent=u),u.end=e.offset,s.set(t,u),u}e.prevIsBlock=!1;const c=Nc(o),a=c?o.__text.length:1,d=dg(null,c?"text":"inline",l,e.offset+=a,t,n);return s.set(t,d),d}function hg(e,t,n,r,s,i){let o=null,l=null;const c=t.length;for(let a=0;a<c;a++){const c=ug(e,t[a],n,r,s,i);null===l?o=c:(c.prev=l,l.next=c),l=c}return o}function fg(e,t){const n=[];let r=e.__first;for(;null!==r;){const e=null===t?dc(r):t.get(r);null==e&&og("$createChildrenArray: node does not exist in nodeMap"),n.push(r),r=e.__next}return n}const gg=fg;function pg(e,t=1,n){const r=(n||e._pendingEditorState||e._editorState)._nodeMap,s=r.get("root"),i=new Map;return new lg(i,hg({offset:0,prevIsBlock:!1},fg(s,r),null,r,i,t),t)}const mg=ig,_g=mg.$createChildrenArray;mg.$createOffsetView,mg.OffsetView,mg.createChildrenArray;var yg=t({$addNodeStyle:()=>Pg,$cloneWithProperties:()=>tc,$copyBlockFormatIndent:()=>Kg,$ensureForwardRangeSelection:()=>Fg,$forEachSelectedTextNode:()=>$g,$getComputedStyleForElement:()=>Tg,$getComputedStyleForParent:()=>Og,$getSelectionStyleValueForProperty:()=>Qg,$isAtNodeEnd:()=>Dg,$isParentElementRTL:()=>qg,$isParentRTL:()=>Ag,$moveCaretSelection:()=>Jg,$moveCharacter:()=>Gg,$patchStyleText:()=>Rg,$selectAll:()=>Oc,$setBlocksType:()=>zg,$shouldOverrideDefaultCharacterSelection:()=>Vg,$sliceSelectedTextNodeContent:()=>Mg,$trimTextContentFromAnchor:()=>Ig,$wrapNodes:()=>jg,createDOMRange:()=>vg,createRectsFromDOMRange:()=>xg,getCSSFromStyleObject:()=>Ng,getStyleObjectFromCSS:()=>kg,trimTextContentFromAnchor:()=>Zg});function bg(e){throw new Error(e)}const Sg=new Map;function Cg(e){let t=e;for(;null!=t;){if(t.nodeType===Node.TEXT_NODE)return t;t=t.firstChild}return null}function wg(e){const t=e.parentNode;if(null==t)throw new Error("Should never happen");return[t,Array.from(t.childNodes).indexOf(e)]}function vg(e,t,n,r,s){const i=t.getKey(),o=r.getKey(),l=document.createRange();let c=e.getElementByKey(i),a=e.getElementByKey(o),d=n,u=s;if(Nc(t)&&(c=Cg(c)),Nc(r)&&(a=Cg(a)),void 0===t||void 0===r||null===c||null===a)return null;"BR"===c.nodeName&&([c,d]=wg(c)),"BR"===a.nodeName&&([a,u]=wg(a));const h=c.firstChild;c===a&&null!=h&&"BR"===h.nodeName&&0===d&&0===u&&(u=1);try{l.setStart(c,d),l.setEnd(a,u)}catch(e){return null}return!l.collapsed||d===u&&i===o||(l.setStart(a,u),l.setEnd(c,d)),l}function xg(e,t){const n=e.getRootElement();if(null===n)return[];const r=n.getBoundingClientRect(),s=getComputedStyle(n),i=parseFloat(s.paddingLeft)+parseFloat(s.paddingRight),o=Array.from(t.getClientRects());let l,c=o.length;o.sort((e,t)=>{const n=e.top-t.top;return Math.abs(n)<=3?e.left-t.left:n});for(let e=0;e<c;e++){const t=o[e],n=l&&l.top<=t.top&&l.top+l.height>t.top&&l.left+l.width>t.left,s=t.width+i===r.width;n||s?(o.splice(e--,1),c--):l=t}return o}function Eg(e){const t={};if(!e)return t;const n=e.split(";");for(const e of n)if(""!==e){const[n,r]=e.split(/:([^]+)/);n&&r&&(t[n.trim()]=r.trim())}return t}function kg(e){let t=Sg.get(e);return void 0===t&&(t=Eg(e),Sg.set(e,t)),Object.freeze(t),t}function Ng(e){let t="";for(const n in e)n&&(t+=`${n}: ${e[n]};`);return t}function Tg(e){const t=ac().getElementByKey(e.getKey());if(null===t)return null;const n=t.ownerDocument.defaultView;return null===n?null:n.getComputedStyle(t)}function Og(e){return Tg(Ec(e)?e:e.getParentOrThrow())}function Ag(e){const t=Og(e);return null!==t&&"rtl"===t.direction}function Mg(e,t,n="self"){const r=e.getStartEndPoints();if(t.isSelected(e)&&!Tc(t)&&null!==r){const[s,i]=r,o=e.isBackward(),l=s.getNode(),c=i.getNode(),a=t.is(l),d=t.is(c);if(a||d){const[r,s]=cc(e),i=l.is(c),a=t.is(o?c:l),d=t.is(o?l:c);let u,h=0;if(i)h=r>s?s:r,u=r>s?r:s;else if(a)h=o?s:r,u=void 0;else if(d){h=0,u=o?r:s}const f=t.__text.slice(h,u);f!==t.__text&&("clone"===n&&(t=nc(t)),t.__text=f)}}return t}function Dg(e){if("text"===e.type)return e.offset===e.getNode().getTextContentSize();const t=e.getNode();return Sc(t)||bg("isAtNodeEnd: node must be a TextNode or ElementNode"),e.offset===t.getChildrenSize()}function Ig(e,t,n){let r=t.getNode(),s=n;if(Sc(r)){const e=r.getDescendantByIndex(t.offset);null!==e&&(r=e)}for(;s>0&&null!==r;){if(Sc(r)){const e=r.getLastDescendant();null!==e&&(r=e)}let n=r.getPreviousSibling(),i=0;if(null===n){let e=r.getParentOrThrow(),t=e.getPreviousSibling();for(;null===t;){if(e=e.getParent(),null===e){n=null;break}t=e.getPreviousSibling()}null!==e&&(i=e.isInline()?0:2,n=t)}let o=r.getTextContent();""===o&&Sc(r)&&!r.isInline()&&(o="\n\n");const l=o.length;if(!Nc(r)||s>=l){const e=r.getParent();r.remove(),null==e||0!==e.getChildrenSize()||Ec(e)||e.remove(),s-=l+i,r=n}else{const n=r.getKey(),i=e.getEditorState().read(()=>{const e=dc(n);return Nc(e)&&e.isSimpleText()?e.getTextContent():null}),c=l-s,a=o.slice(0,c);if(null!==i&&i!==o){const e=hc();let t=r;if(r.isSimpleText())r.setTextContent(i);else{const e=ic(i);r.replace(e),t=e}if(xc(e)&&e.isCollapsed()){const n=e.anchor.offset;t.select(n,n)}}else if(r.isSimpleText()){const e=t.key===n;let i=t.offset;i<s&&(i=l);const o=e?i-s:0,a=e?i:c;if(e&&0===o){const[e]=r.splitText(o,a);e.remove()}else{const[,e]=r.splitText(o,a);e.remove()}}else{const e=ic(a);r.replace(e)}s=0}}}function Pg(e){const t=e.getStyle(),n=Eg(t);Sg.set(t,n)}function Lg(e,t){(xc(e)?e.isCollapsed():Nc(e)||Sc(e))||bg("$patchStyle must only be called with a TextNode, ElementNode, or collapsed RangeSelection");const n=kg(xc(e)?e.style:Nc(e)?e.getStyle():e.getTextStyle()),r=Object.entries(t).reduce((t,[r,s])=>("function"==typeof s?t[r]=s(n[r],e):null===s?delete t[r]:t[r]=s,t),{...n}),s=Ng(r);xc(e)||Nc(e)?e.setStyle(s):e.setTextStyle(s),Sg.set(s,r)}function Rg(e,t){if(xc(e)&&e.isCollapsed()){Lg(e,t);const n=e.anchor.getNode();Sc(n)&&n.isEmpty()&&Lg(n,t)}$g(e=>{Lg(e,t)})}function $g(e){const t=gc();if(!t)return;const n=new Map,r=e=>n.get(e.getKey())||[0,e.getTextContentSize()];if(xc(t))for(const e of ec(t).getTextSlices())e&&n.set(e.caret.origin.getKey(),e.getSliceIndices());const s=t.getNodes();for(const t of s){if(!Nc(t)||!t.canHaveFormat())continue;const[n,s]=r(t);if(s!==n)if(Tc(t)||0===n&&s===t.getTextContentSize())e(t);else{e(t.splitText(n,s)[0===n?0:1])}}xc(t)&&"text"===t.anchor.type&&"text"===t.focus.type&&t.anchor.key===t.focus.key&&Fg(t)}function Fg(e){if(e.isBackward()){const{anchor:t,focus:n}=e,{key:r,offset:s,type:i}=t;t.set(n.key,n.offset,n.type),n.set(r,s,i)}}function Kg(e,t){const n=e.getFormatType(),r=e.getIndent();n!==t.getFormatType()&&t.setFormat(n),r!==t.getIndent()&&t.setIndent(r)}function zg(e,t,n=Kg){if(null===e)return;const r=e.getStartEndPoints(),s=new Map;let i=null;if(r){const[e,t]=r;i=sc(),i.anchor.set(e.key,e.offset,e.type),i.focus.set(t.key,t.offset,t.type);const n=lc(e.getNode(),Pc),o=lc(t.getNode(),Pc);Sc(n)&&s.set(n.getKey(),n),Sc(o)&&s.set(o.getKey(),o)}for(const t of e.getNodes())if(Sc(t)&&Pc(t))s.set(t.getKey(),t);else if(null===r){const e=lc(t,Pc);Sc(e)&&s.set(e.getKey(),e)}for(const[e,r]of s){const s=t();n(r,s),r.replace(s,!0),i&&(e===i.anchor.key&&i.anchor.set(s.getKey(),i.anchor.offset,i.anchor.type),e===i.focus.key&&i.focus.set(s.getKey(),i.focus.offset,i.focus.type))}i&&e.is(gc())&&Ac(i)}function Bg(e){return e.getNode().isAttached()}function Ug(e){let t=e;for(;null!==t&&!kc(t);){const e=t.getLatest(),n=t.getParent();0===e.getChildrenSize()&&t.remove(!0),t=n}}function jg(e,t,n=null){const r=e.getStartEndPoints(),s=r?r[0]:null,i=e.getNodes(),o=i.length;if(null!==s&&(0===o||1===o&&"element"===s.type&&0===s.getNode().getChildrenSize())){const e="text"===s.type?s.getNode().getParentOrThrow():s.getNode(),r=e.getChildren();let i=t();return i.setFormat(e.getFormatType()),i.setIndent(e.getIndent()),r.forEach(e=>i.append(e)),n&&(i=n.append(i)),void e.replace(i)}let l=null,c=[];for(let r=0;r<o;r++){const s=i[r];kc(s)?(Wg(e,c,c.length,t,n),c=[],l=s):null===l||null!==l&&_c(s,l)?c.push(s):(Wg(e,c,c.length,t,n),c=[s])}Wg(e,c,c.length,t,n)}function Wg(e,t,n,r,s=null){if(0===t.length)return;const i=t[0],o=new Map,l=[];let c=Sc(i)?i:i.getParentOrThrow();c.isInline()&&(c=c.getParentOrThrow());let a=!1;for(;null!==c;){const e=c.getPreviousSibling();if(null!==e){c=e,a=!0;break}if(c=c.getParentOrThrow(),kc(c))break}const d=new Set;for(let e=0;e<n;e++){const n=t[e];Sc(n)&&0===n.getChildrenSize()&&d.add(n.getKey())}const u=new Set;for(let e=0;e<n;e++){const n=t[e];let s=n.getParent();if(null!==s&&s.isInline()&&(s=s.getParent()),null!==s&&wc(n)&&!u.has(n.getKey())){const e=s.getKey();if(void 0===o.get(e)){const t=r();t.setFormat(s.getFormatType()),t.setIndent(s.getIndent()),l.push(t),o.set(e,t),s.getChildren().forEach(e=>{t.append(e),u.add(e.getKey()),Sc(e)&&e.getChildrenKeys().forEach(e=>u.add(e))}),Ug(s)}}else if(d.has(n.getKey())){Sc(n)||bg("Expected node in emptyElements to be an ElementNode");const e=r();e.setFormat(n.getFormatType()),e.setIndent(n.getIndent()),l.push(e),n.remove(!0)}}if(null!==s)for(let e=0;e<l.length;e++){const t=l[e];s.append(t)}let h=null;if(kc(c))if(a)if(null!==s)c.insertAfter(s);else for(let e=l.length-1;e>=0;e--){const t=l[e];c.insertAfter(t)}else{const e=c.getFirstChild();if(Sc(e)&&(c=e),null===e)if(s)c.append(s);else for(let e=0;e<l.length;e++){const t=l[e];c.append(t),h=t}else if(null!==s)e.insertBefore(s);else for(let t=0;t<l.length;t++){const n=l[t];e.insertBefore(n),h=n}}else if(s)c.insertAfter(s);else for(let e=l.length-1;e>=0;e--){const t=l[e];c.insertAfter(t),h=t}const f=hc();xc(f)&&Bg(f.anchor)&&Bg(f.focus)?Ac(f.clone()):null!==h?h.selectEnd():e.dirty=!0}function Yg(e){const t=Hg(e);return null!==t&&"vertical-rl"===t.writingMode}function Hg(e){const t=e.anchor.getNode();return Sc(t)?Tg(t):Og(t)}function Vg(e,t){let n=Yg(e)?!t:t;qg(e)&&(n=!n);const r=Zl(e.focus,n?"previous":"next");if(Cc(r))return!1;for(const e of oc(r)){if(yc(e))return!e.origin.isInline();if(!Sc(e.origin)){if(bc(e.origin))return!0;break}}return!1}function Jg(e,t,n,r){e.modify(t?"extend":"move",n,r)}function qg(e){const t=Hg(e);return null!==t&&"rtl"===t.direction}function Gg(e,t,n){const r=qg(e);let s;s=Yg(e)||r?!n:n,Jg(e,t,s,"character")}function Xg(e,t,n){const r=kg(e.getStyle());return null!==r&&r[t]||n}function Qg(e,t,n=""){let r=null;const s=e.getNodes(),i=e.anchor,o=e.focus,l=e.isBackward(),c=l?o.offset:i.offset,a=l?o.getNode():i.getNode();if(xc(e)&&e.isCollapsed()&&""!==e.style){const n=kg(e.style);if(null!==n&&t in n)return n[t]}for(let e=0;e<s.length;e++){const i=s[e];if((0===e||0!==c||!i.is(a))&&Nc(i)){const e=Xg(i,t,n);if(null===r)r=e;else if(r!==e){r="";break}}}return null===r?n:r}const Zg=Ig,ep=yg,tp=(ep.$addNodeStyle,ep.$cloneWithProperties,ep.$copyBlockFormatIndent,ep.$ensureForwardRangeSelection,ep.$forEachSelectedTextNode,ep.$getComputedStyleForElement,ep.$getComputedStyleForParent,ep.$getSelectionStyleValueForProperty,ep.$isAtNodeEnd,ep.$isParentElementRTL,ep.$isParentRTL,ep.$moveCaretSelection,ep.$moveCharacter,ep.$patchStyleText,ep.$selectAll,ep.$setBlocksType,ep.$shouldOverrideDefaultCharacterSelection,ep.$sliceSelectedTextNodeContent,ep.$trimTextContentFromAnchor,ep.$wrapNodes,ep.createDOMRange),np=ep.createRectsFromDOMRange;ep.getCSSFromStyleObject,ep.getStyleObjectFromCSS,ep.trimTextContentFromAnchor;var rp=t({$getYChangeState:()=>cm,CLEAR_DIFF_VERSIONS_COMMAND__EXPERIMENTAL:()=>zm,CONNECTED_COMMAND:()=>$m,DIFF_VERSIONS_COMMAND__EXPERIMENTAL:()=>Km,TOGGLE_CONNECT_COMMAND:()=>Fm,createBinding:()=>mp,createBindingV2__EXPERIMENTAL:()=>_p,createUndoManager:()=>Bm,getAnchorAndFocusCollabNodesForUserState:()=>bm,initLocalState:()=>Um,renderSnapshot__EXPERIMENTAL:()=>am,setLocalStateFocus:()=>jm,syncCursorPositions:()=>km,syncLexicalUpdateToYjs:()=>Dm,syncLexicalUpdateToYjsV2__EXPERIMENTAL:()=>Rm,syncYjsChangesToLexical:()=>Om,syncYjsChangesToLexicalV2__EXPERIMENTAL:()=>Pm,syncYjsStateToLexicalV2__EXPERIMENTAL:()=>Lm});function sp(e){throw new Error(e)}function ip(e,t,n){const r=e.length,s=t.length;let i=0,o=0;for(;i<r&&i<s&&e[i]===t[i]&&i<n;)i++;for(;o+i<r&&o+i<s&&e[r-o-1]===t[s-o-1];)o++;for(;o+i<r&&o+i<s&&e[i]===t[i];)i++;return{index:i,insert:t.slice(i,s-o),remove:r-i-o}}var op=class{_xmlElem;_key;_parent;_type;constructor(e,t,n){this._key="",this._xmlElem=e,this._parent=t,this._type=n}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return bc(t)?t:null}getNode(){const e=dc(this._key);return bc(e)?e:null}getSharedType(){return this._xmlElem}getType(){return this._type}getKey(){return this._key}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}syncPropertiesFromLexical(e,t,n){const r=this.getPrevNode(n);Ip(e,this._xmlElem,r,t)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&sp("syncPropertiesFromYjs: could not find decorator node");Op(e,this._xmlElem,n,t)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}};function lp(e,t,n){const r=new op(e,t,n);return e._collabNode=r,r}var cp=class{_map;_key;_parent;_type;constructor(e,t){this._key="",this._map=e,this._parent=t,this._type="linebreak"}getNode(){const e=dc(this._key);return vc(e)?e:null}getKey(){return this._key}getSharedType(){return this._map}getType(){return this._type}getSize(){return 1}getOffset(){return this._parent.getChildOffset(this)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}};function ap(e,t){const n=new cp(e,t);return e._collabNode=n,n}var dp=class{_map;_key;_parent;_text;_type;_normalized;constructor(e,t,n,r){this._key="",this._map=e,this._parent=n,this._text=t,this._type=r,this._normalized=!1}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return Nc(t)?t:null}getNode(){const e=dc(this._key);return Nc(e)?e:null}getSharedType(){return this._map}getType(){return this._type}getKey(){return this._key}getSize(){return this._text.length+(this._normalized?0:1)}getOffset(){return this._parent.getChildOffset(this)}spliceText(e,t,n){const r=this._parent._xmlText,s=this.getOffset()+1+e;0!==t&&r.delete(s,t),""!==n&&r.insert(s,n)}syncPropertiesAndTextFromLexical(e,t,n){const r=this.getPrevNode(n),s=t.__text;if(Ip(e,this._map,r,t),null!==r){const e=r.__text;if(e!==s){!function(e,t,n,r){const s=gc();let i=r.length;if(xc(s)&&s.isCollapsed()){const e=s.anchor;e.key===t&&(i=e.offset)}const o=ip(n,r,i);e.spliceText(o.index,o.remove,o.insert)}(this,t.__key,e,s),this._text=s}}}syncPropertiesAndTextFromYjs(e,t){const n=this.getNode();null===n&&sp("syncPropertiesAndTextFromYjs: could not find decorator node"),Op(e,this._map,n,t);const r=this._text;n.__text!==r&&n.setTextContent(r)}destroy(e){const t=e.collabNodeMap;t.get(this._key)===this&&t.delete(this._key)}};function up(e,t,n,r){const s=new dp(e,t,n,r);return e._collabNode=s,s}var hp=class e{_key;_children;_xmlText;_type;_parent;constructor(e,t,n){this._key="",this._children=[],this._xmlText=e,this._type=n,this._parent=t}getPrevNode(e){if(null===e)return null;const t=e.get(this._key);return Sc(t)?t:null}getNode(){const e=dc(this._key);return Sc(e)?e:null}getSharedType(){return this._xmlText}getType(){return this._type}getKey(){return this._key}isEmpty(){return 0===this._children.length}getSize(){return 1}getOffset(){const e=this._parent;return null===e&&sp("getOffset: could not find collab element node"),e.getChildOffset(this)}syncPropertiesFromYjs(e,t){const n=this.getNode();null===n&&sp("syncPropertiesFromYjs: could not find element node"),Op(e,this._xmlText,n,t)}applyChildrenYjsDelta(t,n){const r=this._children;let s=0,i=null;for(let o=0;o<n.length;o++){const l=n[o],c=l.insert,a=l.delete;if(null!=l.retain)s+=l.retain;else if("number"==typeof a){let t=a;for(;t>0;){const{node:n,nodeIndex:i,offset:o,length:l}=Lp(this,s,!1);if(n instanceof e||n instanceof cp||n instanceof op)r.splice(i,1),t-=1;else{if(!(n instanceof dp))break;{const e=Math.min(t,l),s=0!==i?r[i-1]:null,c=n.getSize();if(0===o&&l===c){r.splice(i,1);const t=Pp(n._text,o,e-1,"");t.length>0&&(s instanceof dp?s._text+=t:this._xmlText.delete(o,t.length))}else n._text=Pp(n._text,o,e,"");t-=e}}}}else{if(null==c)throw new Error("Unexpected delta format");if("string"==typeof c){const{node:e,offset:t}=Lp(this,s,!0);e instanceof dp?e._text=Pp(e._text,t,0,c):this._xmlText.delete(t,c.length),s+=c.length}else{const e=c,{node:n,nodeIndex:o,length:l}=Lp(this,s,!1),a=Np(t,e,this);if(n instanceof dp&&l>0&&l<n._text.length){const e=n._text,t=e.length-l;n._text=Pp(e,t,l,""),r.splice(o+1,0,a),i=Pp(e,0,t,"")}else r.splice(o,0,a);null!==i&&a instanceof dp&&(a._text=i+a._text,i=null),s+=1}}}}syncChildrenFromYjs(t){const n=this.getNode();null===n&&sp("syncChildrenFromYjs: could not find element node");const r=n.__key,s=_g(n,null),i=s.length,o=this._children,l=o.length,c=t.collabNodeMap,a=new Set;let d,u,h=0,f=null;l!==i&&(u=n.getWritable());for(let i=0;i<l;i++){const g=s[h],p=o[i],m=p.getNode(),_=p._key;if(null!==m&&g===_){const n=Nc(m);if(a.add(g),n)if(p._key=g,p instanceof e){const e=p._xmlText;p.syncPropertiesFromYjs(t,null),p.applyChildrenYjsDelta(t,e.toDelta()),p.syncChildrenFromYjs(t)}else p instanceof dp?p.syncPropertiesAndTextFromYjs(t,null):p instanceof op?p.syncPropertiesFromYjs(t,null):p instanceof cp||sp("syncChildrenFromYjs: expected text, element, decorator, or linebreak collab node");f=m,h++}else{if(void 0===d){d=new Set;for(let e=0;e<l;e++){const t=o[e]._key;""!==t&&d.add(t)}}if(null!==m&&void 0!==g&&!d.has(g)){Bc(uc(g)),i--,h++;continue}u=n.getWritable();const e=Tp(t,p,r),s=e.__key;if(c.set(s,p),null===f){const t=u.getFirstChild();if(u.__first=s,null!==t){const n=t.getWritable();n.__prev=s,e.__next=n.__key}}else{const t=f.getWritable(),n=f.getNextSibling();if(t.__next=s,e.__prev=f.__key,null!==n){const t=n.getWritable();t.__prev=s,e.__next=t.__key}}i===l-1&&(u.__last=s),u.__size++,f=e}}for(let e=0;e<i;e++){const n=s[e];if(!a.has(n)){const e=uc(n),r=t.collabNodeMap.get(n);void 0!==r&&r.destroy(t),Bc(e)}}}syncPropertiesFromLexical(e,t,n){Ip(e,this._xmlText,this.getPrevNode(n),t)}_syncChildFromLexical(t,n,r,s,i,o){const l=this._children[n],c=uc(r);l instanceof e&&Sc(c)?(l.syncPropertiesFromLexical(t,c,s),l.syncChildrenFromLexical(t,c,s,i,o)):l instanceof dp&&Nc(c)?l.syncPropertiesAndTextFromLexical(t,c,s):l instanceof op&&bc(c)&&l.syncPropertiesFromLexical(t,c,s)}syncChildrenFromLexical(e,t,n,r,s){const i=this.getPrevNode(n),o=null===i?[]:_g(i,n),l=_g(t,null),c=o.length-1,a=l.length-1,d=e.collabNodeMap;let u,h,f=0,g=0;for(;f<=c&&g<=a;){const t=o[f],i=l[g];if(t===i)this._syncChildFromLexical(e,g,i,n,r,s),f++,g++;else{void 0===u&&(u=new Set(o)),void 0===h&&(h=new Set(l));const n=h.has(t),r=u.has(i);if(n){const t=Ep(e,uc(i),this);d.set(i,t),r?(this.splice(e,g,1,t),f++,g++):(this.splice(e,g,0,t),g++)}else this.splice(e,g,1),f++}}const p=f>c,m=g>a;if(p&&!m)for(;g<=a;++g){const t=l[g],n=Ep(e,uc(t),this);this.append(n),d.set(t,n)}else if(m&&!p)for(let t=this._children.length-1;t>=g;t--)this.splice(e,t,1)}append(t){const n=this._xmlText,r=this._children,s=r[r.length-1],i=void 0!==s?s.getOffset()+s.getSize():0;if(t instanceof e)n.insertEmbed(i,t._xmlText);else if(t instanceof dp){const e=t._map;null===e.parent&&n.insertEmbed(i,e),n.insert(i+1,t._text)}else t instanceof cp?n.insertEmbed(i,t._map):t instanceof op&&n.insertEmbed(i,t._xmlElem);this._children.push(t)}splice(t,n,r,s){const i=this._children,o=i[n];if(void 0===o)return void 0===s&&sp("splice: could not find collab element node"),void this.append(s);const l=o.getOffset();-1===l&&sp("splice: expected offset to be greater than zero");const c=this._xmlText;if(0!==r&&c.delete(l,o.getSize()),s instanceof e)c.insertEmbed(l,s._xmlText);else if(s instanceof dp){const e=s._map;null===e.parent&&c.insertEmbed(l,e),c.insert(l+1,s._text)}else s instanceof cp?c.insertEmbed(l,s._map):s instanceof op&&c.insertEmbed(l,s._xmlElem);if(0!==r){const e=i.slice(n,n+r);for(let n=0;n<e.length;n++)e[n].destroy(t)}void 0!==s?i.splice(n,r,s):i.splice(n,r)}getChildOffset(e){let t=0;const n=this._children;for(let r=0;r<n.length;r++){const s=n[r];if(s===e)return t;t+=s.getSize()}return-1}destroy(e){const t=e.collabNodeMap,n=this._children;for(let t=0;t<n.length;t++)n[t].destroy(e);t.get(this._key)===this&&t.delete(this._key)}};function fp(e,t,n){const r=new hp(e,t,n);return e._collabNode=r,r}var gp=class{_nodeMap=new Map;_sharedTypeToNodeKeys=new Map;_nodeKeyToSharedType=new Map;set(e,t){const n=t instanceof Array;this.delete(e);const r=n?t:[t];for(const e of r){const t=e.getKey();if(this._nodeKeyToSharedType.has(t)){const e=this._nodeKeyToSharedType.get(t),n=this._sharedTypeToNodeKeys.get(e).indexOf(t);-1!==n&&this._sharedTypeToNodeKeys.get(e).splice(n,1),this._nodeKeyToSharedType.delete(t),this._nodeMap.delete(t)}}if(e instanceof kf){if(n||sp("Text nodes must be mapped as an array"),0===t.length)return;this._sharedTypeToNodeKeys.set(e,t.map(e=>e.getKey()));for(const n of t)this._nodeMap.set(n.getKey(),n),this._nodeKeyToSharedType.set(n.getKey(),e)}else n&&sp("Element nodes must be mapped as a single node"),Nc(t)&&sp("Text nodes must be mapped to XmlText"),this._sharedTypeToNodeKeys.set(e,[t.getKey()]),this._nodeMap.set(t.getKey(),t),this._nodeKeyToSharedType.set(t.getKey(),e)}get(e){const t=this._sharedTypeToNodeKeys.get(e);if(void 0!==t){if(e instanceof kf){const e=Array.from(t.map(e=>this._nodeMap.get(e)));return e.length>0?e:void 0}return this._nodeMap.get(t[0])}}getSharedType(e){return this._nodeKeyToSharedType.get(e.getKey())}delete(e){const t=this._sharedTypeToNodeKeys.get(e);if(void 0!==t){for(const e of t)this._nodeMap.delete(e),this._nodeKeyToSharedType.delete(e);this._sharedTypeToNodeKeys.delete(e)}}deleteNode(e){const t=this._nodeKeyToSharedType.get(e);t&&this.delete(t),this._nodeMap.delete(e)}has(e){return this._sharedTypeToNodeKeys.has(e)}clear(){this._nodeMap.clear(),this._sharedTypeToNodeKeys.clear(),this._nodeKeyToSharedType.clear()}};function pp(e,t,n,r,s){null==n&&sp("createBinding: doc is null or undefined");const i={clientID:n.clientID,cursors:new Map,cursorsContainer:null,doc:n,docMap:r,editor:e,excludedProperties:s||new Map,id:t,nodeProperties:new Map};return function(e){const{editor:t,nodeProperties:n}=e;t.update(()=>{t._nodes.forEach(t=>{const r=new t.klass,s={};for(const[t,n]of Object.entries(r))vp(t,r,e)||(s[t]=n);n.set(r.__type,Object.freeze(s))})})}(i),i}function mp(e,t,n,r,s,i){null==r&&sp("createBinding: doc is null or undefined");const o=fp(r.get("root",kf),null,"root");return o._key="root",{...pp(e,n,r,s,i),collabNodeMap:new Map,root:o}}function _p(e,t,n,r,s={}){null==n&&sp("createBinding: doc is null or undefined");const{excludedProperties:i,rootName:o="root-v2"}=s;return{...pp(e,t,n,r,i),mapping:new gp,root:n.get(o,vf)}}function yp(e){return Object.hasOwn(e,"collabNodeMap")}const bp=new Set(["__key","__parent","__next","__prev","__state"]),Sp=new Set(["__first","__last","__size"]),Cp=new Set(["__cachedText"]),wp=new Set(["__text"]);function vp(e,t,n){if(bp.has(e)||"function"==typeof t[e])return!0;if(Nc(t)){if(wp.has(e))return!0}else if(Sc(t)&&(Sp.has(e)||Ec(t)&&Cp.has(e)))return!0;const r=t.constructor,s=n.excludedProperties.get(r);return null!=s&&s.has(e)}function xp(e,t){const n=e.__type,{nodeProperties:r}=t,s=r.get(n);return void 0===s&&sp(`Node properties for ${n} not initialized for sync`),s}function Ep(e,t,n){const r=t.__type;let s;if(Sc(t))s=fp(new kf,n,r),s.syncPropertiesFromLexical(e,t,null),s.syncChildrenFromLexical(e,t,null,null,null);else if(Nc(t))s=up(new rf,t.__text,n,r),s.syncPropertiesAndTextFromLexical(e,t,null);else if(vc(t)){const e=new rf;e.set("__type","linebreak"),s=ap(e,n)}else bc(t)?(s=lp(new vf,n,r),s.syncPropertiesFromLexical(e,t,null)):sp("Expected text, element, decorator, or linebreak node");return s._key=t.__key,s}function kp(e){const t=Ap(e,"__type");return"string"!=typeof t&&void 0!==t&&sp("Expected shared type to include type attribute"),t}function Np(e,t,n){const r=t._collabNode;if(void 0===r){const r=e.editor._nodes,s=kp(t);"string"!=typeof s&&sp("Expected shared type to include type attribute"),void 0===r.get(s)&&sp(`Node ${s} is not registered`);const i=t.parent,o=void 0===n&&null!==i?Np(e,i):n||null;if(o instanceof hp||sp("Expected parent to be a collab element node"),t instanceof kf)return fp(t,o,s);if(t instanceof rf)return"linebreak"===s?ap(t,o):up(t,"",o,s);if(t instanceof vf)return lp(t,o,s)}return r}function Tp(e,t,n){const r=t.getType(),s=e.editor._nodes.get(r);void 0===s&&sp(`Node ${r} is not registered`);const i=new s.klass;if(i.__parent=n,t._key=i.__key,t instanceof hp){const n=t._xmlText;t.syncPropertiesFromYjs(e,null),t.applyChildrenYjsDelta(e,n.toDelta()),t.syncChildrenFromYjs(e)}else t instanceof dp?t.syncPropertiesAndTextFromYjs(e,null):t instanceof op&&t.syncPropertiesFromYjs(e,null);return e.collabNodeMap.set(i.__key,t),i}function Op(e,t,n,r){const s=null===r?t instanceof rf?Array.from(t.keys()):t instanceof kf||t instanceof vf?Object.keys(t.getAttributes()):Object.keys(t):Array.from(r);let i;for(let r=0;r<s.length;r++){const o=s[r];if(vp(o,n,e)){"__state"===o&&yp(e)&&(i||(i=n.getWritable()),Dp(t,i));continue}const l=n[o];let c=Ap(t,o);if(l!==c){if(c instanceof gu){const t=e.docMap;l instanceof gu&&t.delete(l.guid);const n=Kc(),r=c.guid;n._key=r,t.set(r,c),c=n}void 0===i&&(i=n.getWritable()),i[o]=c}}}function Ap(e,t){return e instanceof rf?e.get(t):e instanceof kf||e instanceof vf?e.getAttribute(t):e[t]}function Mp(e,t,n){e instanceof rf?e.set(t,n):e.setAttribute(t,n)}function Dp(e,t){const n=Ap(e,"__state");n instanceof rf&&mc(t).updateFromJSON(n.toJSON())}function Ip(e,t,n,r){const s=Object.keys(xp(r,e)),i=e.editor.constructor;!function(e,t,n,r){const s=r.__state,i=Ap(t,"__state");if(!s)return;const[o,l]=s.getInternalState(),c=n&&n.__state,a=i instanceof rf?i:new rf;if(c===s)return;const[d,u]=c&&a.doc?c.getInternalState():[void 0,new Map];if(o)for(const[e,t]of Object.entries(o))d&&t!==d[e]&&a.set(e,t);for(const[e,t]of l)u.get(e)!==t&&a.set(e.key,e.unparse(t));i||Mp(t,"__state",a)}(0,t,n,r);for(let o=0;o<s.length;o++){const l=s[o],c=null===n?void 0:n[l];let a=r[l];if(c!==a){if(a instanceof i){const t=e.docMap;let n;if(c instanceof i){const e=c._key;n=t.get(e),t.delete(e)}const s=n||new gu,o=s.guid;a._key=o,t.set(o,s),a=s,e.editor.update(()=>{r.markDirty()})}Mp(t,l,a)}}}function Pp(e,t,n,r){return e.slice(0,t)+r+e.slice(t+n)}function Lp(e,t,n){let r=0,s=0;const i=e._children,o=i.length;for(;s<o;s++){const e=i[s],l=r;if(r+=e.getSize(),(n?r>=t:r>t)&&e instanceof dp){let n=t-l-1;return n<0&&(n=0),{length:r-t,node:e,nodeIndex:s,offset:n}}if(r>t)return{length:0,node:e,nodeIndex:s,offset:l};if(s===o-1)return{length:0,node:null,nodeIndex:s+1,offset:l+1}}return{length:0,node:null,nodeIndex:0,offset:0}}function Rp(e){const t=e.anchor,n=e.focus;let r=!1;try{const e=t.getNode(),s=n.getNode();(!e.isAttached()||!s.isAttached()||Nc(e)&&t.offset>e.getTextContentSize()||Nc(s)&&n.offset>s.getTextContentSize())&&(r=!0)}catch(e){r=!0}return r}function $p(e,t){e.doc.transact(t,e)}function Fp(e,t){const n=t._nodeMap.get(e);if(!n)return void fc().selectStart();const r=n.__prev;let s=null;r&&(s=dc(r)),null===s&&null!==n.__parent&&(s=dc(n.__parent)),null!==s?null!==s&&s.isAttached()?s.selectEnd():Fp(s.__key,t):fc().selectStart()}const Kp=e=>"UNDEFINED"===e.nodeName,zp=(e,t,n,r,s,i,o)=>{let l=t.mapping.get(e);if(l&&n&&0===n.size&&!r)return l;const c=Kp(e)?Lc.getType():e.nodeName,a=t.editor._nodes.get(c);if(void 0===a)throw new Error(`$createOrUpdateNodeFromYElement: Node ${c} is not registered`);if(l||(l=new a.klass,n=null,r=!0),r&&l instanceof Dc){const n=[],r=e=>{if(e instanceof vf){const r=zp(e,t,new Set,!1,s,i,o);null!==r&&n.push(r)}else if(e instanceof kf){const r=jp(e,t,s,i,o);null!==r&&r.forEach(e=>{null!==e&&n.push(e)})}else sp("XmlHook is not supported")};void 0===s||void 0===i?e.toArray().forEach(r):((e,t)=>{const n=[];let r=e._start;for(;null!==r;){if(r.countable&&qu(r,t)){const e=r.content.getContent();for(let t=0;t<e.length;t++)n.push(e[t])}r=r.right}return n})(e,new Hu(i.ds,s.sv)).filter(e=>!e._item.deleted||Up(e._item,s)||Up(e._item,i)).forEach(r),Bp(l,n)}const d=e.getAttributes(s);Kp(e)||void 0===s||(Up(e._item,s)?Up(e._item,i)||(d[nm("ychange")]=o?o("added",e._item.id):{type:"added"}):d[nm("ychange")]=o?o("removed",e._item.id):{type:"removed"});const u={...xp(l,t)},h={};for(const e in d)e.startsWith(tm)?h[rm(e)]=d[e]:u[e]=d[e];if(Op(t,u,l,n),n){const e=Object.keys(h).filter(e=>n.has(nm(e)));if(e.length>0){const t=mc(l);for(const n of e)t.updateFromUnknown(n,h[n])}}else mc(l).updateFromJSON(h);const f=l.getLatest();return t.mapping.set(e,f),f},Bp=(e,t)=>{const n=e.getChildren(),r=new Set(n.map(e=>e.getKey())),s=new Set(t.map(e=>e.getKey())),i=n.length-1,o=t.length-1;let l=0,c=0;for(;l<=i&&c<=o;){const i=n[l].getKey(),o=t[c].getKey();if(i===o){l++,c++;continue}const a=s.has(i),d=r.has(o);if(!a){if(0===c&&1===e.getChildrenSize())return void e.splice(c,1,t.slice(c));e.splice(c,1,[]),l++;continue}const u=t[c];d?(e.splice(c,1,[u]),l++,c++):(e.splice(c,0,[u]),c++)}const a=l>i,d=c>o;a&&!d?e.append(...t.slice(c)):d&&!a&&e.splice(t.length,e.getChildrenSize()-t.length,[])},Up=(e,t)=>void 0===t?!e.deleted:t.sv.has(e.id.client)&&t.sv.get(e.id.client)>e.id.clock&&!su(t.ds,e.id),jp=(e,t,n,r,s)=>{const i=Zp(e,n,r,s);let o=t.mapping.get(e)??[];const l=i.map(e=>e.attributes.t??$c.getType());if(o.length!==l.length||!o.every((e,t)=>e.getType()===l[t])){const e=t.editor._nodes;o=l.map(t=>{const n=e.get(t);if(void 0===n)throw new Error(`$createTextNodesFromYText: Node ${t} is not registered`);const r=new n.klass;if(!Nc(r))throw new Error(`$createTextNodesFromYText: Node ${t} is not a TextNode`);return r})}for(let e=0;e<i.length;e++){const n=o[e],{attributes:r,insert:s}=i[e];n.__text!==s&&n.setTextContent(s);const l={...xp(n,t),...r.p},c=Object.fromEntries(Object.entries(r).filter(([e])=>e.startsWith(tm)).map(([e,t])=>[rm(e),t]));Op(t,l,n,null),mc(n).updateFromJSON(c)}const c=o.map(e=>e.getLatest());return t.mapping.set(e,c),c},Wp=(e,t)=>e instanceof Array?((e,t)=>{const n=new kf;return Qp(n,e,t),n})(e,t):((e,t)=>{const n=new vf(e.getType()),r={...em(e,t),...sm(e)};for(const e in r){const t=r[e];null!==t&&n.setAttribute(e,t)}return e instanceof Dc?(n.insert(0,Vp(e).map(e=>Wp(e,t))),t.mapping.set(n,e),n):n})(e,t),Yp=e=>"object"==typeof e&&null!=e,Hp=(e,t)=>{const n=Object.keys(e).filter(t=>null!==e[t]);if(null==t)return 0===n.length;let r=n.length===Object.keys(t).filter(e=>null!==t[e]).length;for(let s=0;s<n.length&&r;s++){const i=n[s],o=e[i],l=t[i];r="ychange"===i||o===l||Yp(o)&&Yp(l)&&Hp(o,l)}return r},Vp=e=>{if(!(e instanceof Dc))return[];const t=e.getChildren(),n=[];for(let e=0;e<t.length;e++){const r=t[e];if(Nc(r)){const r=[];for(let n=t[e];e<t.length&&Nc(n);n=t[++e])r.push(n);e--,n.push(r)}else n.push(r)}return n},Jp=(e,t,n)=>{const r=Zp(e);return r.length===t.length&&r.every((e,r)=>{const s=t[r],i=e.attributes.t??$c.getType(),o=e.attributes.p??{},l=Object.fromEntries(Object.entries(e.attributes).filter(([e])=>e.startsWith(tm)));return e.insert===s.getTextContent()&&i===s.getType()&&Hp(o,em(s,n))&&Hp(l,sm(s))})},qp=(e,t,n)=>{if(e instanceof vf&&!(t instanceof Array)&&om(e,t)){const r=Vp(t);return e._length===r.length&&Hp(e.getAttributes(),{...em(t,n),...sm(t)})&&e.toArray().every((e,t)=>qp(e,r[t],n))}return e instanceof kf&&t instanceof Array&&Jp(e,t,n)},Gp=(e,t)=>e===t||e instanceof Array&&t instanceof Array&&e.length===t.length&&e.every((e,n)=>t[n]===e),Xp=(e,t,n)=>{const r=e.toArray(),s=Vp(t),i=s.length,o=r.length,l=Math.min(o,i);let c=0,a=0,d=!1;for(;c<l;c++){const e=r[c],t=s[c];if(e instanceof Ef)break;if(Gp(n.mapping.get(e),t))d=!0;else if(!qp(e,t,n))break}for(;c+a<l;a++){const e=r[o-a-1],t=s[i-a-1];if(e instanceof Ef)break;if(Gp(n.mapping.get(e),t))d=!0;else if(!qp(e,t,n))break}return{equalityFactor:c+a,foundMappedChild:d}},Qp=(e,t,n)=>{n.mapping.set(e,t);const{nAttrs:r,str:s}=(e=>{let t="",n=e._start;const r={};for(;null!==n;)n.deleted||(n.countable&&n.content instanceof Ff?t+=n.content.str:n.content instanceof Pf&&(r[n.content.key]=null)),n=n.right;return{nAttrs:r,str:t}})(e),i=t.map((e,t)=>{const s=e.getType();let i=em(e,n);return 0===Object.keys(i).length&&(i=null),{attributes:Object.assign({},r,{...s!==$c.getType()&&{t:s},p:i,...sm(e),...t>0&&{i:t}}),insert:e.getTextContent(),nodeKey:e.getKey()}}),o=i.map(e=>e.insert).join(""),l=gc();let c;if(xc(l)&&l.isCollapsed()){c=0;for(const e of i){if(e.nodeKey===l.anchor.key){c+=l.anchor.offset;break}c+=e.insert.length}}else c=o.length;const{insert:a,remove:d,index:u}=ip(s,o,c);e.delete(u,d),e.insert(u,a),e.applyDelta(i.map(e=>({attributes:e.attributes,retain:e.insert.length})))},Zp=(e,t,n,r)=>e.toDelta(t,n,r).map(e=>{const t=e.attributes??{};return"ychange"in t&&(t[nm("ychange")]=t.ychange,delete t.ychange),{...e,attributes:t}}),em=(e,t)=>{const n=xp(e,t),r={};return Object.entries(n).forEach(([t,n])=>{const s=e[t];s!==n&&(r[t]=s)}),r},tm="s_",nm=e=>`s_${e}`,rm=e=>{if(!e.startsWith(tm))throw new Error(`Invalid state key: ${e}`);return e.slice(2)},sm=e=>{const t=e.__state;if(!t)return{};const[n={},r]=t.getInternalState(),s={};for(const[e,t]of Object.entries(n))s[nm(e)]=t;for(const[e,t]of r)s[nm(e.key)]=e.unparse(t);return s},im=(e,t,n,r,s)=>{if(t instanceof vf&&t.nodeName!==n.getType()&&(!Kp(t)||n.getType()!==Lc.getType()))throw new Error("node name mismatch!");if(r.mapping.set(t,n),t instanceof vf){const e=t.getAttributes(),s={...em(n,r),...sm(n)};for(const n in s)null!=s[n]?e[n]!==s[n]&&"ychange"!==n&&t.setAttribute(n,s[n]):t.removeAttribute(n);for(const n in e)void 0===s[n]&&t.removeAttribute(n)}const i=Vp(n),o=i.length,l=t.toArray(),c=l.length,a=Math.min(o,c);let d=0,u=0;for(;d<a;d++){const t=l[d],n=i[d];if(t instanceof Ef)break;if(Gp(r.mapping.get(t),n))n instanceof Dc&&s.has(n.getKey())&&im(e,t,n,r,s);else{if(!qp(t,n,r))break;r.mapping.set(t,n)}}for(;u+d<a;u++){const t=l[c-u-1],n=i[o-u-1];if(t instanceof Ef)break;if(Gp(r.mapping.get(t),n))n instanceof Dc&&s.has(n.getKey())&&im(e,t,n,r,s);else{if(!qp(t,n,r))break;r.mapping.set(t,n)}}for(;c-d-u>0&&o-d-u>0;){const n=l[d],a=i[d],h=l[c-u-1],f=i[o-u-1];if(n instanceof kf&&a instanceof Array)Jp(n,a,r)||Qp(n,a,r),d+=1;else{let i=n instanceof vf&&om(n,a),o=h instanceof vf&&om(h,f);if(i&&o){const e=Xp(n,a,r),t=Xp(h,f,r);e.foundMappedChild&&!t.foundMappedChild?o=!1:!e.foundMappedChild&&t.foundMappedChild||e.equalityFactor<t.equalityFactor?i=!1:o=!1}i?(im(e,n,a,r,s),d+=1):o?(im(e,h,f,r,s),u+=1):(r.mapping.delete(t.get(d)),t.delete(d,1),t.insert(d,[Wp(a,r)]),d+=1)}}const h=c-d-u;if(1===c&&0===o&&l[0]instanceof kf?(r.mapping.delete(l[0]),l[0].delete(0,l[0].length)):h>0&&(t.slice(d,d+h).forEach(e=>r.mapping.delete(e)),t.delete(d,h)),d+u<o){const e=[];for(let t=d;t<o-u;t++)e.push(Wp(i[t],r));t.insert(d,e)}},om=(e,t)=>!(t instanceof Array)&&e.nodeName===t.getType(),lm=zc("ychange",{isEqual:(e,t)=>e===t,parse:e=>e??null});function cm(e){return pc(e,lm)}const am=(e,t=(e=>Vu(au(e.store),Qu(e.store)))(e.doc),n=Ju)=>{const{doc:r}=e;r.gc&&sp("GC must be disabled to render snapshot"),r.transact(s=>{const i=new zu(r);i&&i.dss.forEach(e=>{ru(s,e,e=>{})});const o=(e,t)=>({id:t,type:e,user:("added"===e?i.getUserByClientId(t.client):i.getUserByDeletedId(t))??null});e.mapping.clear(),e.editor.update(()=>{fc().clear(),zp(e.root,e,null,!0,t,n,o)})},e)};function dm(e,t){const n=t.collabNodeMap.get(e.key);if(void 0===n)return null;let r=e.offset,s=n.getSharedType();if(n instanceof dp){s=n._parent._xmlText;const e=n.getOffset();if(-1===e)return null;r=e+1+r}else if(n instanceof hp&&"element"===e.type){const t=e.getNode();Sc(t)||sp("Element point must be an element node");let n=0,s=0,i=t.getFirstChild();for(;null!==i&&s++<r;)Nc(i)?n+=i.getTextContentSize()+1:n++,i=i.getNextSibling();r=n}return Wu(s,r)}function um(e,t){const{mapping:n}=t,{offset:r}=e,s=e.getNode(),i=n.getSharedType(s);if(void 0===i)return null;if("text"===e.type){Nc(s)||sp("Text point must be a text node");let e=s.getPreviousSibling(),t=r;for(;Nc(e);)t+=e.getTextContentSize(),e=e.getPreviousSibling();return Wu(i,t)}if("element"===e.type){Sc(s)||sp("Element point must be an element node");let e=0,t=s.getFirstChild();for(;null!==t&&e<r;){if(Nc(t)){let e=t.getNextSibling();for(;Nc(e);)e=e.getNextSibling()}e++,t=t.getNextSibling()}return Wu(i,e)}return null}function hm(e,t){return Yu(e,t.doc)}function fm(e,t){if(null==e){if(null!=t)return!0}else if(null==t||!((n=e)===(r=t)||null!==n&&null!==r&&n.tname===r.tname&&Ru(n.item,r.item)&&Ru(n.type,r.type)&&n.assoc===r.assoc))return!0;var n,r;return!1}function gm(e,t){return{color:t,name:e,selection:null}}function pm(e,t){const n=e.cursorsContainer;if(null!==n){const e=t.selections,r=e.length;for(let t=0;t<r;t++)n.removeChild(e[t])}}function mm(e,t){const n=t.selection;null!==n&&pm(e,n)}function _m(e,t,n,r,s){const i=e.color,o=document.createElement("span");o.style.cssText=`position:absolute;top:0;bottom:0;right:-1px;width:1px;background-color:${i};z-index:10;`;const l=document.createElement("span");return l.textContent=e.name,l.style.cssText=`position:absolute;left:-2px;top:-16px;background-color:${i};color:#fff;line-height:12px;font-size:12px;padding:2px;font-family:Arial;font-weight:bold;white-space:nowrap;`,o.appendChild(l),{anchor:{key:t,offset:n},caret:o,color:i,focus:{key:r,offset:s},name:l,selections:[]}}function ym(e,t,n,r){const s=e.editor,i=s.getRootElement(),o=e.cursorsContainer;if(null===o||null===i)return;const l=o.offsetParent;if(null===l)return;const c=l.getBoundingClientRect(),a=t.selection;if(null===n)return null===a?void 0:(t.selection=null,void pm(e,a));t.selection=n;const d=n.caret,u=n.color,h=n.selections,f=n.anchor,g=n.focus,p=f.key,m=g.key,_=r.get(p),y=r.get(m);if(null==_||null==y)return;let b;if(_===y&&vc(_))b=[s.getElementByKey(p).getBoundingClientRect()];else{const e=tp(s,_,f.offset,y,g.offset);if(null===e)return;b=np(s,e)}const S=h.length,C=b.length;for(let e=0;e<C;e++){const t=b[e];let n=h[e];if(void 0===n){n=document.createElement("span"),h[e]=n;const t=document.createElement("span");n.appendChild(t),o.appendChild(n)}const r=`position:absolute;top:${t.top-c.top}px;left:${t.left-c.left}px;height:${t.height}px;width:${t.width}px;pointer-events:none;z-index:5;`;n.style.cssText=r,n.firstChild.style.cssText=`${r}left:0;top:0;background-color:${u};opacity:0.3;`,e===C-1&&d.parentNode!==n&&n.appendChild(d)}for(let e=S-1;e>=C;e--){const t=h[e];o.removeChild(t),h.pop()}}function bm(e,t){const{anchorPos:n,focusPos:r}=t;let s=null,i=0,o=null,l=0;if(null!==n&&null!==r){const t=hm(n,e),c=hm(r,e);null!==t&&null!==c&&([s,i]=vm(t.type,t.index),[o,l]=vm(c.type,c.index))}return{anchorCollabNode:s,anchorOffset:i,focusCollabNode:o,focusOffset:l}}function Sm(e,t){const{anchorPos:n,focusPos:r}=t,s=n?hm(n,e):null,i=r?hm(r,e):null;if(null===s||null===i)return{anchorKey:null,anchorOffset:0,focusKey:null,focusOffset:0};if(yp(e)){const[e,t]=vm(s.type,s.index),[n,r]=vm(i.type,i.index);return{anchorKey:null!==e?e.getKey():null,anchorOffset:t,focusKey:null!==n?n.getKey():null,focusOffset:r}}let[o,l]=xm(e.mapping,s),[c,a]=xm(e.mapping,i);if(c&&o&&(c!==o||a!==l)){const e=c.isBefore(o),t=e?c:o,n=e?a:l;Nc(t)&&Nc(t.getNextSibling())&&n===t.getTextContentSize()&&(e?(c=t.getNextSibling(),a=0):(o=t.getNextSibling(),l=0))}return{anchorKey:null!==o?o.getKey():null,anchorOffset:l,focusKey:null!==c?c.getKey():null,focusOffset:a}}function Cm(e,t){const n=t.awareness.getLocalState();if(null===n)return;const{anchorKey:r,anchorOffset:s,focusKey:i,focusOffset:o}=Sm(e,n);if(null!==r&&null!==i){const e=gc();if(!xc(e))return;wm(e.anchor,r,s),wm(e.focus,i,o)}}function wm(e,t,n){if(e.key!==t||e.offset!==n){let r=dc(t);if(null!==r&&!Sc(r)&&!Nc(r)){const e=r.getParentOrThrow();t=e.getKey(),n=r.getIndexWithinParent(),r=e}e.set(t,n,Sc(r)?"element":"text")}}function vm(e,t){const n=e._collabNode;if(void 0===n)return[null,0];if(n instanceof hp){const{node:e,offset:r}=Lp(n,t,!0);return null===e?[n,0]:[e,r]}return[null,0]}function xm(e,t){const n=t.type,r=t.index;if(n instanceof vf){const t=e.get(n);if(void 0===t)return[null,0];if(!Sc(t))return[t,r];let s=r,i=0;const o=t.getChildren();for(;s>0&&i<o.length;){const e=o[i];if(s-=1,i+=1,Nc(e))for(;i<o.length&&Nc(o[i]);)i+=1}return[t,i]}{const t=e.get(n);if(void 0===t)return[null,0];let s=0,i=r;for(;i>t[s].getTextContentSize()&&s+1<t.length;)i-=t[s].getTextContentSize(),s++;const o=t[s];return[o,Math.min(i,o.getTextContentSize())]}}function Em(e,t){return t.awareness.getStates()}function km(e,t,n){const{getAwarenessStates:r=Em}=n??{},s=Array.from(r(e,t)),i=e.clientID,o=e.cursors,l=e.editor,c=l._editorState._nodeMap,a=new Set;for(let t=0;t<s.length;t++){const[n,r]=s[t];if(0!==n&&n!==i){a.add(n);const{name:t,color:s,focusing:i}=r;let d=null,u=o.get(n);if(void 0===u&&(u=gm(t,s),o.set(n,u)),i){const{anchorKey:t,anchorOffset:n,focusKey:s,focusOffset:i}=l.read(()=>Sm(e,r));if(null!==t&&null!==s)if(d=u.selection,null===d)d=_m(u,t,n,s,i);else{const e=d.anchor,r=d.focus;e.key=t,e.offset=n,r.key=s,r.offset=i}}ym(e,u,d,c)}}const d=Array.from(o.keys());for(let t=0;t<d.length;t++){const n=d[t];if(!a.has(n)){const t=o.get(n);void 0!==t&&(mm(e,t),o.delete(n))}}}function Nm(e,t,n,r){const s=t.awareness,i=s.getLocalState();if(null===i)return;const{anchorPos:o,focusPos:l,name:c,color:a,focusing:d,awarenessData:u}=i;let h=null,f=null;(null!==r&&(null===o||r.is(n))||null!==n)&&(xc(r)&&(yp(e)?(h=dm(r.anchor,e),f=dm(r.focus,e)):(h=um(r.anchor,e),f=um(r.focus,e))),(fm(o,h)||fm(l,f))&&s.setLocalState({...i,anchorPos:h,awarenessData:u,color:a,focusPos:f,focusing:d,name:c}))}function Tm(e,t){if(t instanceof nf&&function(e,t){const{target:n}=t;if(!n._item||"__state"!==n._item.parentSub||void 0!==kp(n)||!(n.parent instanceof kf||n.parent instanceof vf||n.parent instanceof rf))return!1;const r=Np(e,n.parent).getNode();if(r){const e=mc(r.getWritable());for(const r of t.keysChanged)e.updateFromUnknown(r,n.get(r))}return!0}(e,t))return;const{target:n}=t,r=Np(e,n);if(r instanceof hp&&t instanceof bf){const{keysChanged:n,childListChanged:s,delta:i}=t;n.size>0&&r.syncPropertiesFromYjs(e,n),s&&(r.applyChildrenYjsDelta(e,i),r.syncChildrenFromYjs(e))}else if(r instanceof dp&&t instanceof nf){const{keysChanged:n}=t;n.size>0&&r.syncPropertiesAndTextFromYjs(e,n)}else if(r instanceof op&&t instanceof xf){const{attributesChanged:n}=t;n.size>0&&r.syncPropertiesFromYjs(e,n)}else sp("Expected text, element, or decorator event")}function Om(e,t,n,r,s=km){const i=e.editor,o=i._editorState;n.forEach(e=>e.delta),i.update(()=>{for(let t=0;t<n.length;t++){const r=n[t];Tm(e,r)}Am(o,e,t),r||Ql(Rc)},{onUpdate:()=>{s(e,t),i.update(()=>Mm())},skipTransforms:!0,tag:r?Ic:Mc})}function Am(e,t,n){const r=gc();if(xc(r))if(Rp(r)){const s=e._selection;if(xc(s)&&(Cm(t,n),Rp(r))){Fp(r.anchor.key,e)}Nm(t,n,s,gc())}else Cm(t,n)}function Mm(){0===fc().getChildrenSize()&&fc().append(rc())}function Dm(e,t,n,r,s,i,o,l){$p(e,()=>{r.read(()=>{if(l.has(Mc)||l.has(Ic))return void(o.size>0&&function(e,t){const n=Array.from(t),r=e.collabNodeMap,s=[],i=[];for(let e=0;e<n.length;e++){const t=n[e],o=dc(t),l=r.get(t);if(l instanceof dp)if(Nc(o))s.push([l,o.__text]);else{const e=l.getOffset();if(-1===e)continue;const t=l._parent;l._normalized=!0,t._xmlText.delete(e,1),i.push(l)}}for(let e=0;e<i.length;e++){const t=i[e],n=t.getKey();r.delete(n);const s=t._parent._children,o=s.indexOf(t);s.splice(o,1)}for(let e=0;e<s.length;e++){const[t,n]=s[e];t._text=n}}(e,o));if(s.has("root")){const t=n._nodeMap,r=fc(),o=e.root;o.syncPropertiesFromLexical(e,r,t),o.syncChildrenFromLexical(e,r,t,s,i)}const r=gc(),c=n._selection;Nm(e,t,c,r)})})}function Im(e,t){const{target:n}=t;if(n instanceof vf&&t instanceof xf)zp(n,e,t.attributesChanged,t.childListChanged);else if(n instanceof kf&&t instanceof bf){const t=n.parent;t instanceof vf?zp(t,e,new Set,!0):sp("Expected XmlElement parent for XmlText")}else sp("Expected xml or text event")}function Pm(e,t,n,r,s){const i=e.editor,o=i._editorState;ru(r,r.deleteSet,t=>{if(t.constructor===Zf){const n=t.content.type;n&&e.mapping.delete(n)}}),n.forEach(e=>e.delta),i.update(()=>{for(let t=0;t<n.length;t++){const r=n[t];Im(e,r)}Am(o,e,t),s||Ql(Rc)},{discrete:!0,onUpdate:()=>{km(e,t),i.update(()=>Mm())},skipTransforms:!0,tag:s?Ic:Mc})}function Lm(e,t){e.mapping.clear();const n=e.editor;n.update(()=>{fc().clear(),zp(e.root,e,null,!0),Ql(Mc)},{discrete:!0,onUpdate:()=>{km(e,t),n.update(()=>Mm())},skipTransforms:!0,tag:Mc})}function Rm(e,t,n,r,s,i,o){(o.has(Mc)||o.has(Ic))&&0===i.size||(i.forEach(t=>{e.mapping.deleteNode(t)}),$p(e,()=>{r.read(()=>{s.has("root")&&im(e.doc,e.root,fc(),e,new Set(s.keys()));const r=gc(),i=n._selection;Nm(e,t,i,r)})}))}const $m=Fc("CONNECTED_COMMAND"),Fm=Fc("TOGGLE_CONNECT_COMMAND"),Km=Fc("DIFF_VERSIONS_COMMAND"),zm=Fc("CLEAR_DIFF_VERSIONS_COMMAND");function Bm(e,t){return new mh(t,{trackedOrigins:new Set([e,null])})}function Um(e,t,n,r,s){e.awareness.setLocalState({anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:r,name:t})}function jm(e,t,n,r,s){const{awareness:i}=e;let o=i.getLocalState();null===o&&(o={anchorPos:null,awarenessData:s,color:n,focusPos:null,focusing:r,name:t}),o.focusing=r,i.setLocalState(o)}const Wm=rp,Ym=(Wm.$getYChangeState,Wm.CLEAR_DIFF_VERSIONS_COMMAND__EXPERIMENTAL,Wm.CONNECTED_COMMAND,Wm.DIFF_VERSIONS_COMMAND__EXPERIMENTAL,Wm.TOGGLE_CONNECT_COMMAND,Wm.createBinding),Hm=(Wm.createBindingV2__EXPERIMENTAL,Wm.createUndoManager,Wm.getAnchorAndFocusCollabNodesForUserState,Wm.initLocalState),Vm=(Wm.renderSnapshot__EXPERIMENTAL,Wm.setLocalStateFocus,Wm.syncCursorPositions,Wm.syncLexicalUpdateToYjs),Jm=(Wm.syncLexicalUpdateToYjsV2__EXPERIMENTAL,Wm.syncYjsChangesToLexical),qm=(Wm.syncYjsChangesToLexicalV2__EXPERIMENTAL,Wm.syncYjsStateToLexicalV2__EXPERIMENTAL,3e4);var Gm=class extends Xc{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=od();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach((n,r)=>{r!==this.clientID&&qm<=e-n.lastUpdated&&this.states.has(r)&&t.push(r)}),t.length>0&&Xm(this,t,"timeout")},Qc(3e3)),e.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,n=this.meta.get(t),r=void 0===n?0:n.clock+1,s=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:r,lastUpdated:od()});const i=[],o=[],l=[],c=[];null===e?c.push(t):null==s?null!=e&&i.push(t):(o.push(t),wd(s,e)||l.push(t)),(i.length>0||l.length>0||c.length>0)&&this.emit("change",[{added:i,updated:l,removed:c},"local"]),this.emit("update",[{added:i,updated:o,removed:c},"local"])}setLocalStateField(e,t){const n=this.getLocalState();null!==n&&this.setLocalState({...n,[e]:t})}getStates(){return this.states}};const Xm=(e,t,n)=>{const r=[];for(let n=0;n<t.length;n++){const s=t[n];if(e.states.has(s)){if(e.states.delete(s),s===e.clientID){const t=e.meta.get(s);e.meta.set(s,{clock:t.clock+1,lastUpdated:od()})}r.push(s)}}r.length>0&&(e.emit("change",[{added:[],updated:[],removed:r},n]),e.emit("update",[{added:[],updated:[],removed:r},n]))},Qm=(e,t,n=e.states)=>{const r=t.length,s=_a();wa(s,r);for(let i=0;i<r;i++){const r=t[i],o=n.get(r)||null,l=e.meta.get(r).clock;wa(s,r),wa(s,l),ka(s,JSON.stringify(o))}return ba(s)};let Zm=()=>({emit(e,...t){for(let n=this.events[e]||[],r=0,s=n.length;r<s;r++)n[r](...t)},events:{},on(e,t){return(this.events[e]||=[]).push(t),()=>{this.events[e]=this.events[e]?.filter(e=>t!==e)}}});var e_=class extends Error{constructor(e,t){e instanceof Error?(super(e.message),this.cause=e):super(e),this.reason=t,this.name="ReasonError"}},t_=class extends e_{constructor(e){super("Rejected",e),this.name="SubscriptionRejectedError"}},n_=class extends e_{constructor(e){super(e||"Timed out to receive subscription ack"),this.name="SubscriptionTimeoutError"}},r_=class extends e_{constructor(e,t){t?super(e,t):super("Disconnected",e),this.name="DisconnectedError"}},s_=class extends r_{constructor(e){super(e,"stale_connection"),this.name="StaleConnectionError"}};function i_(e){return e?`{${Object.keys(e).sort().filter(t=>void 0!==e[t]).map(t=>{let n=JSON.stringify(e[t]);return`${JSON.stringify(t)}:${n}`}).join(",")}}`:""}var o_=class{constructor(e){this.channel=e,this.listeners=[]}watch(){this.listeners.push(this.channel.on("presence",e=>{"info"!==e.type?this._state&&("join"===e.type?this._state[e.id]=e.info:"leave"===e.type&&delete this._state[e.id]):this._state||(this._state=this.stateFromInfo(e))}))}reset(){delete this._state}dispose(){delete this._info,delete this._state,this.listeners.forEach(e=>e()),this.listeners.length=0}async join(e,t){if(!this._info)return this._info={id:e,info:t},this.channel.perform("$presence:join",this._info)}async leave(){if(!this._info)return;let e=await this.channel.perform("$presence:leave");return delete this._info,e}async info(){return this._state||(this._promise||(this._promise=this._sync()),await this._promise),this._state}async _sync(){this.watch();try{let e=await this.channel.perform("$presence:info",{});return this._state=this.stateFromInfo(e),this._state}finally{delete this._promise}}stateFromInfo(e){return e.records.reduce((e,{id:t,info:n})=>(e[t]=n,e),{})}};const l_=Symbol("state");var c_=class{constructor(e={}){this.emitter=Zm(),this.params=Object.freeze(e),this.presence=new o_(this),this.initialConnect=!0,this[l_]="idle"}get identifier(){return this._identifier||(this._identifier=i_({channel:this.channelId,...this.params})),this._identifier}get channelId(){return this.constructor.identifier}get state(){return this[l_]}attached(e){if(this.receiver){if(this.receiver!==e)throw Error("Already connected to a different receiver");return!1}return this.receiver=e,!0}connecting(){this[l_]="connecting"}connected(){if("connected"===this.state)return;if("closed"===this.state)return;this[l_]="connected";let e=!1;this.initialConnect?(this.initialConnect=!1,this.emit("connect",{reconnect:!1,restored:e})):this.emit("connect",{reconnect:!0,restored:e})}restored(){if("connected"===this.state)throw Error("Already connected");this[l_]="connected";this.initialConnect=!1,this.emit("connect",{reconnect:!0,restored:!0})}disconnected(e){"disconnected"!==this.state&&"closed"!==this.state&&(this[l_]="disconnected",this.presence.reset(),this.emit("disconnect",e))}closed(e){"closed"!==this.state&&(this[l_]="closed",delete this.receiver,this.initialConnect=!0,this.presence.dispose(),this.emit("close",e))}disconnect(){"idle"!==this.state&&"closed"!==this.state&&this.receiver.unsubscribe(this)}async perform(e,t){if("idle"===this.state||"closed"===this.state)throw Error("Channel is not subscribed");return this.receiver.perform(this.identifier,e,t)}async send(e){return this.perform(void 0,e)}async whisper(e){try{await this.perform("$whisper",e)}catch(e){let t=this.receiver?this.receiver.logger:null;t&&t.warn("whisper failed: ",e)}}receive(e,t){this.emit("message",e,t)}on(e,t){return this.emitter.on(e,t)}once(e,t){let n=this.emitter.on(e,(...e)=>{n(),t(...e)});return n}emit(e,...t){return this.emitter.emit(e,...t)}ensureSubscribed(){return"connected"===this.state?Promise.resolve():"closed"===this.state?Promise.reject(Error("Channel is unsubscribed")):this.pendingSubscribe()}pendingSubscribe(){return this._pendingSubscribe||(this._pendingSubscribe=new Promise((e,t)=>{let n=[()=>delete this._pendingSubscribe];n.push(this.on("connect",()=>{n.forEach(e=>e()),e()})),n.push(this.on("close",e=>{n.forEach(e=>e()),t(e||new e_("Channel was disconnected before subscribing","canceled"))}))})),this._pendingSubscribe}},a_=class{constructor(e){this.id=e,this.intent="unsubscribed",this.state="idle",this.channels=[],this.disposed=!1,this._pendings=[]}add(e){this.channels.includes(e)||this.channels.push(e)}remove(e){let t=this.channels.indexOf(e);t>-1&&this.channels.splice(t,1)}notify(e,...t){this.state="restored"===e?"connected":e,1===t.length?this.channels.forEach(n=>n[e](t[0])):this.channels.forEach(t=>t[e]())}pending(e){this._checkIntent(e);let t=this._pendings[0];return t&&t.intent===e?t.promise:Promise.resolve()}ensureResubscribed(){this.disposed||(this.intent=void 0,this.ensureSubscribed())}ensureSubscribed(){if("subscribed"!==this.intent){if(this.disposed)throw Error("Subscription is disposed");this.intent="subscribed",this._mergeWithPending("unsubscribed")||this.subscriber(this)}}maybeUnsubscribe(){this.disposed||"unsubscribed"!==this.intent&&(this.channels.length>0||(this.intent="unsubscribed",this._mergeWithPending("subscribed")||this.unsubscriber(this)))}async acquire(e){let t;this._checkIntent(e);let n={promise:new Promise(e=>{t=e}),intent:e,release:()=>{this._pendings.splice(this._pendings.indexOf(n),1),t(n)},canceled:!1,acquired:!1},r=this._pendingTop;return this._pendings.push(n),r&&await r.promise,this.gvl&&await this.gvl.acquire(n,e),n.acquired=!0,n}close(e){this.disposed=!0,this.intent=void 0,this.notify("closed",e)}_checkIntent(e){if("unsubscribed"!==e&&"subscribed"!==e)throw Error(`Unknown subscription intent: ${e}`)}get _pendingTop(){return this._pendings.length?this._pendings[this._pendings.length-1]:void 0}_mergeWithPending(e){let t=this._pendingTop;return!!t&&(!t.acquired&&(t.intent===e&&(this._pendings.pop(),t.canceled=!0,!0)))}},d_=class{constructor(){this.queue=[]}async acquire(e,t){"subscribed"===t&&(this.queue.push(e.promise.then(()=>{this.queue.splice(this.queue.indexOf(e),1)})),this.queue.length>1&&await this.queue[this.queue.length-2])}},u_=class{constructor(e){!1===e.concurrentSubscribes&&(this.glv=new d_),this._subscriptions={},this._localToRemote={}}all(){return Object.values(this._subscriptions)}get(e){return this._subscriptions[e]}create(e,{subscribe:t,unsubscribe:n}){let r=this._subscriptions[e]=new a_(e);return r.remoteId=this._localToRemote[e],r.subscriber=t,r.unsubscriber=n,r.gvl=this.glv,r}remove(e){delete this._subscriptions[e],delete this._localToRemote[e]}storeRemoteId(e,t){this._localToRemote[e]=t;let n=this.get(e);n&&(n.remoteId=t)}},h_=class{constructor(e={}){this.subscriptions=new u_(e),this._pendingMessages=[],this._remoteToLocal={}}subscribe(e,t){this._remoteToLocal[t]=e,this.subscriptions.storeRemoteId(e,t),this.flush(t)}unsubscribe(e){let t=this.subscriptions.get(e);if(!t)return;let n=t.remoteId;n&&delete this._remoteToLocal[n],this.subscriptions.remove(e)}transmit(e,t,n){let r=this._remoteToLocal[e];if(!r)return void this._pendingMessages.push([e,t,n]);let s=this.subscriptions.get(r);s&&s.channels.forEach(e=>{e.receive(t,n)})}notify(e,t,n){let r=this._remoteToLocal[e];if(!r)return;let s=this.subscriptions.get(r);s&&s.channels.forEach(e=>e.emit(t,n))}close(){this._pendingMessages.length=0}get size(){return this.channels.length}get channels(){return this.subscriptions.all().flatMap(e=>e.channels)}flush(e){let t=[];for(let n of this._pendingMessages)n[0]===e?this.transmit(n[0],n[1],n[2]):t.push(n);this._pendingMessages=t}};const f_={debug:0,info:1,warn:2,error:3};var g_=class{constructor(e){this.level=e||"warn"}log(e,t,n){f_[e]<f_[this.level]||this.writeLogEntry(e,t,n)}writeLogEntry(){throw Error("Not implemented")}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}},p_=class extends g_{writeLogEntry(){}},m_=class{encode(e){return JSON.stringify(e)}decode(e){try{return JSON.parse(e)}catch(e){}}};let __=0;var y_=class{constructor(e={}){let{logger:t}=e;this.logger=t||new p_,this.pendingSubscriptions={},this.pendingUnsubscriptions={},this.subscribeCooldownInterval=e.subscribeCooldownInterval||250,this.subscribeRetryInterval=e.subscribeRetryInterval||5e3}attached(e){this.cable=e}subscribe(e,t){let n={channel:e};t&&Object.assign(n,t);let r=i_(n);if(this.pendingUnsubscriptions[r]){let n=1.5*this.subscribeCooldownInterval;return this.logger.debug(`unsubscribed recently, cooldown for ${n}`,r),new Promise(r=>{setTimeout(()=>{r(this.subscribe(e,t))},n)})}if(this.pendingSubscriptions[r])return this.logger.warn("subscription is already pending, skipping",r),Promise.reject(Error("Already subscribing"));let s=this.subscribeRetryInterval;return new Promise((e,t)=>{let n=++__;this.pendingSubscriptions[r]={resolve:e,reject:t,id:n},this.cable.send(this.buildSubscribeRequest(r)),this.maybeRetrySubscribe(n,r,s)})}buildSubscribeRequest(e){return{command:"subscribe",identifier:e}}maybeRetrySubscribe(e,t,n){setTimeout(()=>{let r=this.pendingSubscriptions[t];r&&r.id===e&&(this.logger.warn(`no subscription ack received in ${n}ms, retrying subscribe`,t),this.cable.send(this.buildSubscribeRequest(t)),this.maybeExpireSubscribe(e,t,n))},n)}maybeExpireSubscribe(e,t,n){setTimeout(()=>{let r=this.pendingSubscriptions[t];r&&r.id===e&&(delete this.pendingSubscriptions[t],r.reject(new n_(`Haven't received subscription ack in ${2*n}ms for ${t}`)))},n)}unsubscribe(e){return this.cable.send({command:"unsubscribe",identifier:e}),this.pendingUnsubscriptions[e]=!0,setTimeout(()=>{delete this.pendingUnsubscriptions[e]},this.subscribeCooldownInterval),Promise.resolve()}perform(e,t,n){return"$whisper"===t?this.whisper(e,n):(n||(n={}),n.action||=t,this.cable.send({command:"message",identifier:e,data:JSON.stringify(n)}),Promise.resolve())}whisper(e,t){return this.cable.send({command:"whisper",identifier:e,data:t}),Promise.resolve()}receive(e){if("object"!=typeof e)return void this.logger.error("unsupported message format",{message:e});let{type:t,identifier:n,message:r,reason:s,reconnect:i}=e;if("ping"===t)return this.cable.keepalive(e.message);if(this.cable.keepalive(),"welcome"===t){let t=e.sid;return t&&this.cable.setSessionId(t),this.cable.connected()}if("disconnect"===t){let e=new r_(s);return this.reset(e),void(!1===i?this.cable.closed(e):this.cable.disconnected(e))}if("confirm_subscription"===t){let e=this.pendingSubscriptions[n];return e?(delete this.pendingSubscriptions[n],e.resolve(n)):(this.logger.error("subscription not found, unsubscribing",{type:t,identifier:n}),void this.unsubscribe(n))}if("reject_subscription"===t){let e=this.pendingSubscriptions[n];return e?(delete this.pendingSubscriptions[n],e.reject(new t_)):this.logger.error("subscription not found",{type:t,identifier:n})}if(r)return{identifier:n,message:r};this.logger.warn(`unknown message type: ${t}`,{message:e})}reset(e){for(let t in this.pendingSubscriptions)this.pendingSubscriptions[t].reject(e);this.pendingSubscriptions={}}recoverableClosure(){return!1}};const b_=()=>Date.now()/1e3|0;var S_=class extends y_{constructor(e={}){super(e),this.streamsPositions={},this.subscriptionStreams={},this.pendingHistory={},this.pendingPresence={},this.presenceInfo={},this.restoreSince=e.historyTimestamp,this.disableSessionRecovery=e.disableSessionRecovery,void 0===this.restoreSince&&(this.restoreSince=b_()),this.sessionId=void 0,this.sendPongs=e.pongs}reset(e){for(let t in this.pendingPresence)this.pendingPresence[t].reject(e);return this.pendingPresence={},super.reset()}receive(e){if("object"!=typeof e)return void this.logger.error("unsupported message format",{message:e});let{type:t,identifier:n,message:r}=e;if("disconnect"===t)return delete this.sessionId,this.cable.setSessionId(""),super.receive(e);if("reject_subscription"===t)return super.receive(e);if("confirm_subscription"===t)return this.subscriptionStreams[n]||(this.subscriptionStreams[n]=new Set),super.receive(e);if("ping"===t)return!1==!this.restoreSince&&(this.restoreSince=b_()),this.sendPongs&&this.sendPong(),this.cable.keepalive(e.message);if(this.cable.keepalive(),"confirm_history"===t)return this.logger.debug("history result received",e),void this.cable.notify("history_received",n);if("reject_history"===t)return this.logger.warn("failed to retrieve history",e),void this.cable.notify("history_not_found",n);if("welcome"===t){if(this.disableSessionRecovery||(this.sessionId=e.sid,this.sessionId&&this.cable.setSessionId(this.sessionId)),e.restored){let t=e.restored_ids||Object.keys(this.subscriptionStreams);for(let e of t)this.cable.send({identifier:e,command:"history",history:this.historyRequestFor(e)}),this.presenceInfo[e]&&this.cable.send({identifier:e,command:"join",presence:this.presenceInfo[e]});return this.cable.restored(t)}return this.cable.connected(this.sessionId)}if("presence"===t){let e=r.type;if("info"===e){let e=this.pendingPresence[n];e&&(delete this.pendingPresence[n],e.resolve(r))}else if("error"===e){let e=this.pendingPresence[n];e&&(delete this.pendingPresence[n],e.reject(new Error("failed to retrieve presence")))}return{type:t,identifier:n,message:r}}if(r)return{identifier:n,message:r,meta:this.trackStreamPosition(n,e.stream_id,e.epoch,e.offset)};this.logger.warn(`unknown message type: ${t}`,{message:e})}perform(e,t,n){switch(t){case"$presence:join":return this.join(e,n);case"$presence:leave":return this.leave(e,n);case"$presence:info":return this.presence(e,n)}return super.perform(e,t,n)}unsubscribe(e){return delete this.presenceInfo[e],super.unsubscribe(e)}buildSubscribeRequest(e){let t=super.buildSubscribeRequest(e),n=this.historyRequestFor(e);n&&(t.history=n,this.pendingHistory[e]=!0);let r=this.presenceInfo[e];return r&&(t.presence=r),t}recoverableClosure(){return!!this.sessionId}historyRequestFor(e){let t={},n=!1;if(this.subscriptionStreams[e])for(let r of this.subscriptionStreams[e]){let e=this.streamsPositions[r];e&&(n=!0,t[r]=e)}if(n||this.restoreSince)return{since:this.restoreSince,streams:t}}trackStreamPosition(e,t,n,r){if(t&&n)return this.subscriptionStreams[e]||(this.subscriptionStreams[e]=new Set),this.subscriptionStreams[e].add(t),this.streamsPositions[t]={epoch:n,offset:r},{stream:t,epoch:n,offset:r}}async sendPong(){await new Promise(e=>setTimeout(e,0)),"connected"===this.cable.state&&this.cable.send({command:"pong"})}async join(e,t){return this.presenceInfo[e]=t,this.cable.send({command:"join",identifier:e,presence:t}),Promise.resolve()}async leave(e,t){return delete this.presenceInfo[e],this.cable.send({command:"leave",identifier:e,presence:t}),Promise.resolve()}presence(e,t){return this.pendingPresence[e]?(this.logger.warn("presence is already pending, skipping",e),Promise.reject(Error("presence request is already pending"))):new Promise((n,r)=>{this.pendingPresence[e]={resolve:n,reject:r},this.cable.send({command:"presence",identifier:e,data:t})})}},C_=class extends e_{constructor(){super("No connection","closed"),this.name="NoConnectionError"}},w_=class extends c_{static identifier="__ghost__";constructor(e,t){super(t),this.channelId=e}set channelId(e){this._channelId=e}get channelId(){return this._channelId}};var v_=class extends c_{static identifier="$pubsub";async perform(e,t){if(e.startsWith("$"))return super.perform(e,t);throw Error("not implemented")}};const x_=Symbol("state");var E_=class{constructor({transport:e,protocol:t,encoder:n,logger:r,lazy:s,hubOptions:i,performFailures:o,transportConfigurator:l}){this.emitter=Zm(),this.transport=e,this.encoder=n,this.logger=r||new p_,this.protocol=t,this.performFailures=o||"throw",this.protocol.attached(this),this.hub=new h_(i||{}),this[x_]="idle",this.handleClose=this.handleClose.bind(this),this.handleIncoming=this.handleIncoming.bind(this),this.transportConfigurator=l,this.transport.on("close",this.handleClose),this.transport.on("data",this.handleIncoming),this.initialConnect=!0,this.recovering=!1,!1===s&&this.connect().catch(()=>{})}get state(){return this[x_]}async connect(){if("connected"===this.state)return Promise.resolve();if("connecting"===this.state)return this.pendingConnect();let e="idle"===this.state;this[x_]="connecting";let t=this.pendingConnect();this.logger.debug("connecting");try{this.transportConfigurator&&await this.transportConfigurator(this.transport,{initial:e}),await this.transport.open()}catch(e){this.handleClose(e)}return t}setSessionId(e){this.sessionId=e,this.transport.setParam("sid",e)}connected(){if("connected"===this.state)return;this.logger.info("connected"),this[x_]="connected",this.recovering&&this.hub.subscriptions.all().forEach(e=>e.notify("disconnected",new r_("recovery_failed"))),this.hub.subscriptions.all().forEach(e=>this._resubscribe(e));let e=!1;this.recovering=!1,this.initialConnect?(this.initialConnect=!1,this.emit("connect",{reconnect:!1,restored:e})):this.emit("connect",{reconnect:!0,restored:e})}restored(e){this.logger.info("connection recovered",{remoteIds:e}),this[x_]="connected",this.hub.subscriptions.all().forEach(t=>{e&&t.remoteId&&e.includes(t.remoteId)?t.notify("restored"):(t.notify("disconnected",new r_("recovery_failed")),this._resubscribe(t))});let t=!this.initialConnect;this.recovering=!1,this.initialConnect=!1,this.emit("connect",{reconnect:t,restored:!0})}notify(e,t,n){t&&"string"!=typeof t&&(n=t,t=void 0),t?this.hub.notify(t,"info",{type:e,data:n}):this.emit("info",{type:e,data:n})}handleClose(e){this.logger.debug("transport closed",{error:e}),this.disconnected(new r_(e,"transport_closed"))}disconnected(e){"connected"!==this.state&&"connecting"!==this.state||(this.logger.info("disconnected",{reason:e}),this[x_]="disconnected",this.recovering=this.protocol.recoverableClosure(e),this.recovering?this.hub.subscriptions.all().forEach(e=>e.notify("connecting")):this.hub.subscriptions.all().forEach(t=>{t.notify("disconnected",e)}),this.protocol.reset(e),this.hub.close(),this.transport.close(),this.emit("disconnect",e))}closed(e){if("closed"===this.state||"idle"===this.state)return;let t;e&&(t=e instanceof r_?e:new r_(e,void 0)),this.logger.info("closed",{reason:e||"user"}),this[x_]="closed";let n=t||new r_("cable_closed");this.hub.subscriptions.all().forEach(e=>e.notify("disconnected",n)),this.hub.close(),this.protocol.reset(),this.transport.close(),this.initialConnect=!0,this.emit("close",t)}disconnect(){this.closed()}handleIncoming(e){if("closed"===this.state||"idle"===this.state)return;let t=this.encoder.decode(e);if(void 0===t)return void this.logger.error("failed to decode message",{message:e});this.logger.debug("incoming data",t);let n=this.protocol.receive(t);if(n){this.logger.debug("processed incoming message",n);let{type:e,identifier:t,message:r,meta:s}=n;e?this.hub.notify(t,e,r):this.hub.transmit(t,r,s)}}send(e){if("closed"===this.state)throw Error("Cable is closed");let t=this.encoder.encode(e);void 0!==t?(this.logger.debug("outgoing message",e),this.transport.send(t)):this.logger.error("failed to encode message",{message:e})}keepalive(e){this.emit("keepalive",e)}streamFrom(e){let t=new v_({stream_name:e});return this.subscribe(t)}streamFromSigned(e){let t=new v_({signed_stream_name:e});return this.subscribe(t)}subscribeTo(e,t){let n,r;return"string"==typeof e&&(r=e,e=w_),n=r?new e(r,t):new e(t),this.subscribe(n)}subscribe(e){if(!e.attached(this))return e;let t=e.identifier;e.connecting();let n=this.hub.subscriptions.get(t)||this.hub.subscriptions.create(t,{subscribe:t=>this._subscribe(t,e.channelId,e.params),unsubscribe:e=>this._unsubscribe(e)});return n.add(e),"subscribed"===n.intent&&"connected"===n.state&&e.connected(),n.ensureSubscribed(),e}async _resubscribe(e){"subscribed"===e.intent&&e.channels[0]&&(e.notify("connecting"),e.ensureResubscribed())}async _subscribe(e,t,n){let r=e.id;if("idle"===this.state&&this.connect().catch(()=>{}),"connected"!==this.state)return void this.logger.debug("cancel subscribe, no connection",{identifier:r});this.logger.debug("acquiring subscribe lock",{identifier:r});let s=await e.acquire("subscribed");if(s.canceled)return this.logger.debug("subscribe lock has been canceled",{identifier:r}),void s.release();if(this.logger.debug("subscribe lock has been acquired",{identifier:r}),"subscribed"!==e.intent)return this.logger.debug("cancel subscribe request, already unsubscribed"),void s.release();if("connected"!==this.state)return this.logger.debug("cancel subscribe, no connection",{identifier:r}),void s.release();if("connected"===e.state)return this.logger.debug("already connected, skip subscribe command",{identifier:r}),e.notify("connected"),void s.release();let i={identifier:t,params:n};this.logger.debug("subscribing",i);try{let s=await this.protocol.subscribe(t,n);this.hub.subscribe(r,s),this.logger.debug("subscribed",{...i,remoteId:s}),e.notify("connected")}catch(t){if(t){if(t instanceof t_&&this.logger.warn("rejected",i),t instanceof r_)return this.logger.debug("disconnected during subscription; will retry on connect",i),void s.release();this.logger.error("failed to subscribe",{error:t,...i})}e.close(t),this.hub.unsubscribe(r)}s.release()}unsubscribe(e){let t=e.identifier,n=this.hub.subscriptions.get(t);if(!n)throw Error(`Subscription not found: ${t}`);n.remove(e),e.closed(),n.maybeUnsubscribe()}async _unsubscribe(e){let t=e.id;this.logger.debug("acquiring unsubscribe lock",{identifier:t});let n=await e.acquire("unsubscribed");if(n.canceled)return this.logger.debug("unsubscribe lock has been canceled",{identifier:t}),void n.release();if(this.logger.debug("unsubscribe lock has been acquired",{identifier:t}),"unsubscribed"!==e.intent)return this.logger.debug("cancel unsubscribe, no longer needed",{identifier:t,intent:e.intent}),void n.release();if("disconnected"===e.state||"closed"===e.state)return this.logger.debug(`already ${e.state} connected, skip unsubscribe command`,{identifier:t}),void n.release();let r=e.remoteId;if(this.logger.debug("unsubscribing...",{remoteId:r}),"connected"!==this.state)return this.logger.debug("unsubscribe skipped (cable is not connected)",{id:t}),e.close(),this.hub.unsubscribe(t),void n.release();try{await this.protocol.unsubscribe(r),this.logger.debug("unsubscribed remotely",{id:t})}catch(e){e&&(e instanceof r_?this.logger.debug("cable disconnected during the unsubscribe command execution",{id:t,error:e}):this.logger.error("unsubscribe failed",{id:t,error:e}))}"unsubscribed"===e.intent?(e.close(),this.hub.unsubscribe(t)):e.state="closed",n.release()}async perform(e,t,n){if("throw"===this.performFailures)return this._perform(e,t,n);try{return await this._perform(e,t,n)}catch(e){return void("warn"===this.performFailures&&this.logger.warn("perform failed",{error:e}))}}async _perform(e,t,n){if("connecting"===this.state&&await this.pendingConnect(),"closed"===this.state||"disconnected"===this.state)throw new C_;let r=this.hub.subscriptions.get(e);if(!r)throw Error(`Subscription not found: ${e}`);if(await r.pending("subscribed"),"subscribed"!==r.intent)throw Error(`Subscription is closed: ${e}`);let s=r.remoteId,i={id:s,action:t,payload:n};this.logger.debug("perform",i);try{let e=await this.protocol.perform(s,t,n);return e&&this.logger.debug("perform result",{message:e,request:i}),e}catch(e){throw this.logger.error("perform failed",{error:e,request:i}),e}}on(e,t){return this.emitter.on(e,t)}once(e,t){let n=this.emitter.on(e,(...e)=>{n(),t(...e)});return n}emit(e,...t){return this.emitter.emit(e,...t)}pendingConnect(){return this._pendingConnect||(this._pendingConnect=new Promise((e,t)=>{let n=[()=>delete this._pendingConnect];n.push(this.on("connect",()=>{n.forEach(e=>e()),e()})),n.push(this.on("close",e=>{n.forEach(e=>e()),t(e)})),n.push(this.on("disconnect",e=>{n.forEach(e=>e()),t(e)}))})),this._pendingConnect}};const k_={maxMissingPings:2,maxReconnectAttempts:1/0},N_=()=>Date.now(),T_=(e,t)=>{t=t||{};let{backoffRate:n,jitterRatio:r,maxInterval:s}=t;return n=n||2,void 0===r&&(r=.5),t=>{let i=e*n**t,o=i+(i*n-i)*Math.random();return o*=1+2*(Math.random()-.5)*r,s&&s<o&&(o=s),o}};var O_=class{constructor({pingInterval:e,...t}){if(this.pingInterval=e,!this.pingInterval)throw Error(`Incorrect pingInterval is provided: ${e}`);if(t=Object.assign({},k_,t),this.strategy=t.reconnectStrategy,!this.strategy)throw Error("Reconnect strategy must be provided");this.maxMissingPings=t.maxMissingPings,this.maxReconnectAttempts=t.maxReconnectAttempts,this.logger=t.logger||new p_,this.state="pending_connect",this.attempts=0,this.disconnectedAt=N_()}watch(e){this.target=e,this.initListeners()}reconnectNow(){return"connected"!==this.state&&"pending_connect"!==this.state&&"closed"!==this.state&&(this.cancelReconnect(),this.state="pending_connect",this.target.connect().catch(e=>{this.logger.info("Failed at reconnecting: "+e)}),!0)}initListeners(){this.unbind=[],this.unbind.push(this.target.on("connect",()=>{this.attempts=0,this.pingedAt=N_(),this.state="connected",this.cancelReconnect(),this.startPolling()})),this.unbind.push(this.target.on("disconnect",()=>{this.disconnectedAt=N_(),this.state="disconnected",this.stopPolling(),this.scheduleReconnect()})),this.unbind.push(this.target.on("close",()=>{this.disconnectedAt=N_(),this.state="closed",this.cancelReconnect(),this.stopPolling()})),this.unbind.push(this.target.on("keepalive",()=>{this.pingedAt=N_()})),this.unbind.push(()=>{this.cancelReconnect(),this.stopPolling()})}dispose(){delete this.target,this.unbind&&this.unbind.forEach(e=>e()),delete this.unbind}startPolling(){this.pollId&&clearTimeout(this.pollId);let e=this.pingInterval+(Math.random()-.5)*this.pingInterval*.5;this.pollId=setTimeout(()=>{this.checkStale(),"connected"===this.state&&this.startPolling()},e)}stopPolling(){this.pollId&&clearTimeout(this.pollId)}checkStale(){let e=N_()-this.pingedAt;e>this.maxMissingPings*this.pingInterval&&(this.logger.warn(`Stale connection: ${e}ms without pings`),this.state="pending_disconnect",this.target.disconnected(new s_))}scheduleReconnect(){if(this.attempts>=this.maxReconnectAttempts)return void this.target.close();let e=this.strategy(this.attempts);this.attempts++,this.logger.info(`Reconnecting in ${e}ms (${this.attempts} attempt)`),this.state="pending_reconnect",this.reconnnectId=setTimeout(()=>this.reconnectNow(),e)}cancelReconnect(){this.reconnnectId&&(clearTimeout(this.reconnnectId),delete this.reconnnectId)}},A_=class{constructor(e,t={}){this.transports=e,this.transport=null,this.emitter=Zm(),this.unbind=[],this.logger=t.logger||new p_}displayName(){return"fallbacked transport"}async open(){for(let e=0;e<this.transports.length;e++){let t=this.transports[e];try{return this.transport=t,this.resetListeners(),this.logger.debug(`Trying to connect via ${t.displayName()}`),await t.open(),void this.logger.debug(`Connected via ${t.displayName()}`)}catch(e){this.logger.debug(`Failed to connect via ${t.displayName()}: ${e.message}`)}}throw this.transport=null,this.resetListeners(),new Error("Couldn't connect via any available transport")}send(e){if(!this.transport)throw new Error("No transport is open");this.transport.send(e)}async close(){if(!this.transport)throw new Error("No transport is open");await this.transport.close(),this.transport=null}setURL(){throw new Error("Not implemented. Set URL for each transport separately")}setParam(e,t){this.transports.forEach(n=>{n.setParam(e,t)})}setToken(e,t){this.transports.forEach(n=>{n.setToken(e,t)})}on(e,t){return this.emitter.on(e,t)}once(e,t){let n=this.emitter.on(e,(...e)=>{n(),t(...e)});return n}get url(){return this.transport?this.transport.url:""}resetListeners(){this.unbind.forEach(e=>e()),this.unbind.length=0,this.transport&&this.unbind.push(this.transport.on("open",()=>{this.emitter.emit("open")}),this.transport.on("data",e=>{this.emitter.emit("data",e)}),this.transport.on("close",e=>{this.emitter.emit("close",e)}),this.transport.on("error",e=>{this.emitter.emit("error",e)}))}},M_=class{constructor(e,t={}){this.url=e;let n=t.websocketImplementation;if(n)this.Impl=n;else{if("undefined"==typeof WebSocket)throw new Error("No WebSocket support");this.Impl=WebSocket}this.connected=!1,this.emitter=Zm();let{format:r,subprotocol:s,authStrategy:i}=t;this.format=r||"text",this.connectionOptions=t.websocketOptions,this.authStrategy=i||"param",this.authProtocol="",this.subprotocol=s}displayName(){return"WebSocket("+this.url+")"}open(){let e=this.subprotocol;return"sub-protocol"===this.authStrategy&&(e=[this.subprotocol,this.authProtocol]),this.connectionOptions?this.ws=new this.Impl(this.url,e,this.connectionOptions):this.ws=new this.Impl(this.url,e),this.ws.binaryType="arraybuffer",this.initListeners(),new Promise((e,t)=>{let n=[];n.push(this.once("open",()=>{n.forEach(e=>e()),e()})),n.push(this.once("close",()=>{n.forEach(e=>e()),t(Error("WS connection closed"))}))})}setURL(e){this.url=e}setParam(e,t){let n=new URL(this.url);n.searchParams.set(e,t);let r=`${n.protocol}//${n.host}${n.pathname}?${n.searchParams}`;this.setURL(r)}setToken(e,t="jid"){if("param"===this.authStrategy)this.setParam(t,e);else if("header"===this.authStrategy){this.connectionOptions=this.connectionOptions||{},this.connectionOptions.headers=this.connectionOptions.headers||{};let n=`x-${t}`.toLowerCase();n=Object.keys(this.connectionOptions.headers).find(e=>e.toLowerCase()===n)||n,this.connectionOptions.headers[n]=e}else{if("sub-protocol"!==this.authStrategy)throw new Error("Unknown auth strategy: "+this.authStrategy);this.authProtocol=`anycable-token.${e}`}}send(e){if(!this.ws||!this.connected)throw Error("WebSocket is not connected");this.ws.send(e)}close(){this.ws?this.onclose():this.connected=!1}on(e,t){return this.emitter.on(e,t)}once(e,t){let n=this.emitter.on(e,(...e)=>{n(),t(...e)});return n}initListeners(){this.ws.onerror=e=>{this.connected&&this.emitter.emit("error",e.error||new Error("WS Error"))},this.ws.onclose=()=>{this.onclose()},this.ws.onmessage=e=>{let t=e.data;"binary"===this.format&&(t=new Uint8Array(t)),this.emitter.emit("data",t)},this.ws.onopen=()=>{this.connected=!0,this.emitter.emit("open")}}onclose(){this.ws.onclose=void 0,this.ws.onmessage=void 0,this.ws.onopen=void 0,this.ws.close(),delete this.ws,this.connected=!1,this.emitter.emit("close")}},D_=class{constructor(e){this.channel=e}notify(e,...t){"function"==typeof this[e]&&this[e](...t)}perform(e,t={}){this.channel.perform(e,t)}send(e){this.channel.send(e)}whisper(e){return this.channel.whisper(e)}get identifier(){return this.channel.identifier}unsubscribe(){return this.channel.disconnect()}},I_=class extends w_{constructor(e,t,n){super(e,t),this.subscription=new D_(this),Object.assign(this.subscription,n),this.on("connect",({reconnect:e})=>this.subscription.notify("connected",{reconnected:e})),this.on("disconnect",()=>this.subscription.notify("disconnected",{allowReconnect:!0})),this.on("message",e=>this.subscription.notify("received",e)),this.on("close",e=>{e&&e instanceof t_?this.subscription.notify("rejected"):this.subscription.notify("disconnected",{allowReconnect:!1})})}},P_=class{constructor(e){this.cable=e}create(e,t){let n,r;"object"==typeof e?(n=e.channel,delete e.channel,r=e):(n=e,r={});let s=new I_(n,r,t);return s.subscription.notify("initialized"),this.cable.subscribe(s),s.subscription}findAll(e){return this.cable.hub.channels.filter(t=>t.identifier===e).map(e=>e.subscription)}},L_=class{constructor(e){this.cable=e,this.subscriptions=new P_(e)}send(e){return this.cable.send(e)}connect(){return this.cable.connect()}disconnect(){return this.cable.disconnect()}ensureActiveConnection(){return this.cable.connect()}};const R_={protocol:"actioncable-v1-json",pingInterval:3e3,maxReconnectAttempts:1/0,maxMissingPings:2,logLevel:"warn",lazy:!0};var $_=class extends g_{writeLogEntry(e,t,n){n?console[e](t,n):console[e](t)}},F_=class extends O_{watch(e){super.watch(e),this.initActivityListeners()}initActivityListeners(){if("undefined"!=typeof document&&"undefined"!=typeof window&&document.addEventListener&&window.addEventListener){let e=()=>{document.hidden||this.reconnectNow()&&this.logger.debug("Trigger reconnect due to visibility change")},t=e=>{this.reconnectNow()&&this.logger.debug("Trigger reconnect",{event:e})},n=()=>this.disconnect(new r_("page_frozen"));document.addEventListener("visibilitychange",e,!1),window.addEventListener("focus",t,!1),window.addEventListener("online",t,!1),window.addEventListener("resume",t,!1),window.addEventListener("freeze",n,!1),this.unbind.push(()=>{document.removeEventListener("visibilitychange",e,!1),window.removeEventListener("focus",t,!1),window.removeEventListener("online",t,!1),window.removeEventListener("resume",t,!1),window.removeEventListener("freeze",n,!1)})}}disconnect(e){"disconnected"!==this.state&&"closed"!==this.state&&(this.logger.info("Disconnecting",{reason:e.message}),this.cancelReconnect(),this.stopPolling(),this.state="pending_disconnect",this.target.disconnected(e))}};const K_=["cable","action-cable"],z_=(e,t)=>{for(let n of K_){let r=e.head.querySelector(`meta[name='${n}-${t}']`);if(r)return r.getAttribute("content")}},B_=e=>e.match(/wss?:\/\//)?e:"undefined"!=typeof window?`${window.location.protocol.replace("http","ws")}//${window.location.host}${e}`:e;function U_(e,t){"object"==typeof e&&void 0===t&&(t=e,e=void 0),e=e||(()=>{if("undefined"!=typeof document&&document.head){let e=z_(document,"url");if(e)return B_(e)}return B_("/cable")})(),t=t||{},t.historyTimestamp||=(()=>{if("undefined"!=typeof document&&document.head){let e=z_(document,"history-timestamp");if(e)return 0|e}})();let n=(()=>{if("undefined"!=typeof document&&document.head)return z_(document,"token")})();if(n){let e=(()=>{if("undefined"!=typeof document&&document.head)return z_(document,"token-param")})();t.auth=Object.assign({token:n,param:e},t.auth||{})}t=Object.assign({},R_,t);let{logLevel:r,logger:s,pingInterval:i,reconnectStrategy:o,maxMissingPings:l,maxReconnectAttempts:c}=t;return s=t.logger=t.logger||new $_(r),o=t.reconnectStrategy=t.reconnectStrategy||T_(i),!1!==t.monitor&&(t.monitor=t.monitor||new F_({pingInterval:i,reconnectStrategy:o,maxMissingPings:l,maxReconnectAttempts:c,logger:s})),function(e,t){if("object"==typeof e&&void 0===t&&(t=e,e=void 0),t=t||{},!e&&!t.transport)throw Error("URL or transport must be specified");t=Object.assign({},R_,t);let{protocol:n,websocketImplementation:r,websocketFormat:s,websocketOptions:i,websocketAuthStrategy:o,fallbacks:l,logLevel:c,logger:a,transport:d,encoder:u,lazy:h,monitor:f,pingInterval:g,reconnectStrategy:p,maxMissingPings:m,maxReconnectAttempts:_,subprotocol:y,tokenRefresher:b,historyTimestamp:S,protocolOptions:C,concurrentSubscribes:w,performFailures:v,transportConfigurator:x,auth:E}=t;if(a=a||new p_(c),"string"==typeof n){y=y||n;let e=n.substring(0,n.lastIndexOf("-")),t=n.substring(n.lastIndexOf("-")+1);if(C=C||{},"actioncable-v1"===e)n=new y_({logger:a,...C});else{if("actioncable-v1-ext"!==e)throw Error(`Protocol is not supported yet: ${n}`);n=new S_({logger:a,historyTimestamp:S,...C})}if("json"===t)u=u||new m_,s=s||"text";else if("msgpack"===t){if(s="binary",!u)throw Error("Msgpack encoder must be specified explicitly. Use `@anycable/msgpack-encoder` package or build your own")}else{if("protobuf"!==t)throw Error(`Protocol is not supported yet: ${n}`);if(s=s||"binary",!u)throw Error("Protobuf encoder must be specified explicitly. Use `@anycable/protobuf-encoder` package or build your own")}}if(!n)throw Error("Protocol must be specified");d=d||new M_(e,{websocketImplementation:r,websocketOptions:i,subprotocol:y,authStrategy:o,format:s}),l&&(d=new A_([d,...l],{logger:a})),E&&E.token&&d.setToken(E.token,E.param||"jid"),p=p||T_(g),!1!==f&&(f=f||new O_({pingInterval:g,reconnectStrategy:p,maxMissingPings:m,maxReconnectAttempts:_,logger:a}));let k=new E_({protocol:n,transport:d,encoder:u,logger:a,lazy:h,hubOptions:{concurrentSubscribes:w},performFailures:v,transportConfigurator:x});return f&&(f.watch(k),k.monitor=f),b&&function(e,t){let n=!1;e.on("connect",()=>n=!1),e.on("close",async r=>{r&&(n?e.logger.warn("Token auto-refresh is disabled",r):"token_expired"===r.reason&&(n=!0,await t()))})}(k,async()=>{try{await b(d)}catch(e){return a.error("Failed to refresh authentication token: "+e),!1}return k.connect().catch(()=>{}),!0}),k}(e,t)}const j_=new L_(U_({protocol:"actioncable-v1-ext-json"},W_));var W_;const Y_=(e,t)=>{wa(e,0);const n=(e=>Ou(e,new bu))(t);Ta(e,n)},H_=(e,t,n)=>{wa(e,1),Ta(e,((e,t)=>ku(e,t,new Su))(t,n))},V_=(e,t,n)=>{try{((e,t,n)=>{Eu(e,t,n,mu)})(t,Ya(e),n)}catch(e){console.error("Caught error while handling a Yjs update",e)}},J_=V_,q_=(e,t,n,r)=>{const s=Va(e);switch(s){case 0:((e,t,n)=>{H_(t,n,Ya(e))})(e,t,n);break;case 1:V_(e,n,r);break;case 2:J_(e,n,r);break;default:throw new Error("Unknown message type")}return s},G_=new Map;const X_="undefined"==typeof BroadcastChannel?class{constructor(e){var t;this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:Pd(t.newValue||"")}),t=this._onChange,dd||addEventListener("storage",t)}postMessage(e){ud.setItem(this.room,Id(new Uint8Array(e)))}close(){var e;e=this._onChange,dd||removeEventListener("storage",e)}}:BroadcastChannel,Q_=e=>Wc(G_,e,()=>{const t=Yc(),n=new X_(e);return n.onmessage=e=>t.forEach(t=>t(e.data,"broadcastchannel")),{bc:n,subs:t}}),Z_=(e,t,n=null)=>{const r=Q_(e);r.bc.postMessage(t),r.subs.forEach(e=>e(t,n))};function ey(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ny(r.key),r)}}function ty(){return ty=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},ty.apply(this,arguments)}function ny(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var ry,sy,iy;(iy=sy||(sy={}))[iy.Sync=0]="Sync",iy[iy.Awareness=1]="Awareness",iy[iy.Auth=2]="Auth",iy[iy.QueryAwareness=3]="QueryAwareness";var oy=((ry={})[sy.Sync]=function(e,t,n,r){wa(e,sy.Sync);var s=q_(t,e,n.doc,n);r&&1===s&&!n.synced&&(n.synced=!0)},ry[sy.QueryAwareness]=function(e,t,n,r,s){wa(e,sy.Awareness),Ta(e,Qm(n.awareness,Array.from(n.awareness.getStates().keys())))},ry[sy.Awareness]=function(e,t,n){((e,t,n)=>{const r=Wa(t),s=od(),i=[],o=[],l=[],c=[],a=Va(r);for(let t=0;t<a;t++){const t=Va(r);let n=Va(r);const a=JSON.parse(qa(r)),d=e.meta.get(t),u=e.states.get(t),h=void 0===d?0:d.clock;(h<n||h===n&&null===a&&e.states.has(t))&&(null===a?t===e.clientID&&null!=e.getLocalState()?n++:e.states.delete(t):e.states.set(t,a),e.meta.set(t,{clock:n,lastUpdated:s}),void 0===d&&null!==a?i.push(t):void 0!==d&&null===a?c.push(t):null!==a&&(wd(a,u)||l.push(t),o.push(t)))}(i.length>0||l.length>0||c.length>0)&&e.emit("change",[{added:i,updated:l,removed:c},n]),(i.length>0||o.length>0||c.length>0)&&e.emit("update",[{added:i,updated:o,removed:c},n])})(n.awareness,Ya(t),n)},ry[sy.Auth]=function(e,t,n){((e,t,n)=>{0===Va(e)&&n(t,qa(e))})(t,n.doc,function(e,t){return function(e,t){console.warn("Permission denied to access "+e.channelName+".\n"+t)}(n,t)})},ry),ly=function(){function e(e,t,n,r,s){var i=this,o=void 0===s?{}:s,l=o.awareness,c=void 0===l?new Gm(e):l,a=o.disableBc,d=void 0!==a&&a;this.bcSubscriber=function(e,t){if(t!==i){var n=i.process(new Uint8Array(e),!1);ya(n)>1&&Z_(i.bcChannelName,ba(n),i)}},this.updateHandler=function(e,t){if(t!==i){var n=_a();wa(n,sy.Sync),((e,t)=>{wa(e,2),Ta(e,t)})(n,e),i.send(ba(n))}},this.unloadHandler=function(){Xm(i.awareness,[i.doc.clientID],"window unload")},this.awarenessUpdateHandler=function(e,t){var n=e.added,r=e.updated,s=e.removed,o=n.concat(r).concat(s),l=_a();wa(l,sy.Awareness),Ta(l,Qm(i.awareness,o)),i.send(ba(l))},this.consumer=t,this.channelName=n,this.bcChannelName=n+"_"+Object.entries(r).map(function(e,t){return e+"-"+t}).join("_"),this.params=r,this.doc=e,this.awareness=c,this.bcconnected=!1,this.disableBc=d,this._synced=!1,this.doc.on("update",this.updateHandler),"undefined"!=typeof window?window.addEventListener("unload",this.unloadHandler):"undefined"!=typeof process&&process.on("exit",this.unloadHandler),c.on("update",this.awarenessUpdateHandler),this.connect()}var t,n,r,s=e.prototype;return s.destroy=function(){this.disconnect(),"undefined"!=typeof window?window.removeEventListener("unload",this.unloadHandler):"undefined"!=typeof process&&process.off("exit",this.unloadHandler),this.awareness.off("update",this.awarenessUpdateHandler),this.doc.off("update",this.updateHandler)},s.send=function(e){var t,n,r,s=(n=e,r=Array.from(n,function(e){return String.fromCharCode(e)}).join(""),btoa(r));null==(t=this.channel)||t.send({update:s}),this.bcconnected&&Z_(this.bcChannelName,e,this)},s.process=function(e,t){var n=Wa(e),r=_a(),s=Va(n),i=oy[s];return i?i(r,n,this,t,s):console.error("Unable to compute message"),r},s.subscribe=function(){var e=this;this.synced=!1,this.channel=this.consumer.subscriptions.create(ty({channel:this.channelName},this.params),{received:function(t){var n=function(e){return Uint8Array.from(atob(e),function(e){return e.charCodeAt(0)})}(t.update),r=e.process(n,!0);ya(r)>1&&e.send(ba(r))},disconnected:function(){e.synced=!1,Xm(e.awareness,Array.from(e.awareness.getStates().keys()).filter(function(t){return t!==e.doc.clientID}),e)},connected:function(){var t=_a();if(wa(t,sy.Sync),Y_(t,e.doc),e.send(ba(t)),null!==e.awareness.getLocalState()){var n=_a();wa(n,sy.Awareness),Ta(n,Qm(e.awareness,[e.doc.clientID])),e.send(ba(n))}}})},s.connectBc=function(){if(!this.disableBc){var e,t;this.bcconnected||(e=this.bcChannelName,t=this.bcSubscriber,Q_(e).subs.add(t),this.bcconnected=!0);var n=_a();wa(n,sy.Sync),Y_(n,this.doc),Z_(this.bcChannelName,ba(n),this);var r=_a();wa(r,sy.Sync),H_(r,this.doc),Z_(this.bcChannelName,ba(r),this);var s=_a();wa(s,sy.QueryAwareness),Z_(this.bcChannelName,ba(s),this);var i=_a();wa(i,sy.Awareness),Ta(i,Qm(this.awareness,[this.doc.clientID])),Z_(this.bcChannelName,ba(i),this)}},s.disconnectBc=function(){var e=_a();wa(e,sy.Awareness),Ta(e,Qm(this.awareness,[this.doc.clientID],new Map)),this.send(ba(e)),this.bcconnected&&(((e,t)=>{const n=Q_(e),r=n.subs.delete(t);r&&0===n.subs.size&&(n.bc.close(),G_.delete(e))})(this.bcChannelName,this.bcSubscriber),this.bcconnected=!1)},s.disconnect=function(){var e;this.disconnectBc(),null==(e=this.channel)||e.unsubscribe(),null!=this.channel&&(this.channel=void 0)},s.connect=function(){null==this.channel&&(this.subscribe(),this.connectBc())},t=e,(n=[{key:"synced",get:function(){return this._synced},set:function(e){this._synced!==e&&(this._synced=e)}}])&&ey(t.prototype,n),r&&ey(t,r),Object.defineProperty(t,"prototype",{writable:!1}),e}();var cy=class{constructor(e,t,n){this.editor=e,this.provider=t,this.awareness=t.awareness,this.container=n,this.cursors=new Map,this.selections=new Map,this.localClientId=this.awareness.clientID,this.lastSeenTimestamps=new Map,this.updateQueue=new Set,this.rafId=null,this.resizeObserver=null,this.mutationObserver=null,this.lastUpdate=0,this.UPDATE_THROTTLE=16,this.INACTIVE_TIMEOUT=3e4,this.heartbeatInterval=null,this.overlayContainer=this.createOverlayContainer(),this.handleAwarenessUpdate=this.handleAwarenessUpdate.bind(this),this.handleEditorUpdate=this.handleEditorUpdate.bind(this),this.handleScroll=this.handleScroll.bind(this),this.handleResize=this.handleResize.bind(this),this.processUpdateQueue=this.processUpdateQueue.bind(this),this.checkInactiveUsers=this.checkInactiveUsers.bind(this),this.init()}init(){this.awareness.on("update",this.handleAwarenessUpdate),this.unsubscribeEditor=this.editor.registerUpdateListener(this.handleEditorUpdate),this.scrollableElement=this.findScrollableParent(this.container),this.scrollableElement.addEventListener("scroll",this.handleScroll,{passive:!0}),this.resizeObserver=new ResizeObserver(this.handleResize),this.resizeObserver.observe(this.container),this.mutationObserver=new MutationObserver(()=>{this.queueUpdate("mutation")}),this.mutationObserver.observe(this.container,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),this.heartbeatInterval=setInterval(()=>{this.sendHeartbeat(),this.checkInactiveUsers()},5e3),setTimeout(()=>{this.renderAllCursors()},100)}sendHeartbeat(){this.awareness.setLocalStateField("lastSeen",Date.now())}checkInactiveUsers(){const e=Date.now();this.awareness.getStates().forEach((t,n)=>{if(n===this.localClientId)return;const r=t?.lastSeen;if(r){const t=e-r;t>this.INACTIVE_TIMEOUT?(console.log(`Removing inactive user ${n} (last seen ${Math.round(t/1e3)}s ago)`),this.removeCursor(n),this.removeSelection(n),this.lastSeenTimestamps.delete(n)):this.lastSeenTimestamps.set(n,r)}})}createOverlayContainer(){const e=document.createElement("div");return e.className="lexxy-cursor-overlay",e.style.cssText="\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      pointer-events: none;\n      z-index: 1000;\n    ",this.container.style.position="relative",this.container.appendChild(e),e}handleAwarenessUpdate({added:e,updated:t,removed:n}){try{n.forEach(e=>{this.removeCursor(e),this.removeSelection(e),this.lastSeenTimestamps.delete(e)}),[...e,...t].forEach(e=>{if(e!==this.localClientId)try{const t=this.awareness.getStates().get(e);t?(t.lastSeen&&this.lastSeenTimestamps.set(e,t.lastSeen),t.cursor?this.updateCursorFromState(e,t):(this.removeCursor(e),this.removeSelection(e))):(this.removeCursor(e),this.removeSelection(e))}catch(t){console.warn("Failed to update cursor for client",e,t),this.removeCursor(e),this.removeSelection(e)}}),this.queueUpdate("awareness")}catch(e){console.error("Error in handleAwarenessUpdate:",e)}}handleEditorUpdate({editorState:e}){e.read(()=>{this.queueUpdate("editor")})}handleScroll(){this.queueUpdate("scroll")}handleResize(){this.queueUpdate("resize")}queueUpdate(e){if(this.updateQueue.add(e),this.rafId)return;const t=Date.now()-this.lastUpdate;t<this.UPDATE_THROTTLE?setTimeout(()=>{this.rafId=requestAnimationFrame(this.processUpdateQueue)},this.UPDATE_THROTTLE-t):this.rafId=requestAnimationFrame(this.processUpdateQueue)}processUpdateQueue(){this.rafId=null,this.lastUpdate=Date.now(),this.updateQueue.clear(),this.editor.getEditorState().read(()=>{this.updateAllCursorPositions()})}updateCursorFromState(e,t){const n=t.cursor,r=t.user;if(!n)return this.removeCursor(e),void this.removeSelection(e);if(!n.anchorPos||!n.focusPos)return this.removeCursor(e),void this.removeSelection(e);console.log(`Updating cursor for client ${e}, user:`,r);const s={clientId:e,user:r||{name:`User ${e}`,color:this.getColorForClient(e)},anchor:n.anchorPos,focus:n.focusPos};this.cursors.set(e,s),this.isCollapsed(n.anchorPos,n.focusPos)?(this.removeSelection(e),this.selections.delete(e)):this.selections.set(e,s)}isCollapsed(e,t){return!e||!t||e.key===t.key&&e.offset===t.offset}updateAllCursorPositions(){this.cursors.forEach((e,t)=>{this.updateCursorPosition(t,e)}),this.selections.forEach((e,t)=>{this.updateSelectionPosition(t,e)})}updateCursorPosition(e,t){const{anchor:n,user:r}=t,s=this.getPositionFromPoint(n);if(!s)return void this.removeCursor(e);let i=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);i||(i=this.createCursorElement(e,r),this.overlayContainer.appendChild(i)),i.style.transform=`translate(${s.x}px, ${s.y}px)`,i.style.height=`${s.height}px`;const o=this.isPositionVisible(s);i.style.opacity=o?"1":"0.3"}updateSelectionPosition(e,t){const{anchor:n,focus:r,user:s}=t,i=this.getSelectionRects(n,r);if(!i||0===i.length)return void this.removeSelection(e);let o=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);o||(o=this.createSelectionContainer(e,s),this.overlayContainer.appendChild(o)),o.innerHTML="",i.forEach(e=>{const t=document.createElement("div");t.className="lexxy-selection-rect";var n,r;t.style.cssText=`\n        position: absolute;\n        background-color: ${n=s.color,r=.3,`rgba(${parseInt(n.slice(1,3),16)}, ${parseInt(n.slice(3,5),16)}, ${parseInt(n.slice(5,7),16)}, ${r})`};\n        left: ${e.x}px;\n        top: ${e.y}px;\n        width: ${e.width}px;\n        height: ${e.height}px;\n        pointer-events: none;\n        mix-blend-mode: multiply;\n      `,o.appendChild(t)})}getPositionFromPoint(e){if(!dc(e.key))return null;const t=this.editor.getElementByKey(e.key);if(!t)return null;try{if(""===t.textContent||"\n"===t.textContent){const e=t.getBoundingClientRect(),n=this.container.getBoundingClientRect();return{x:e.left-n.left,y:e.top-n.top,height:e.height||20}}const n=this.createRangeFromPoint(t,e.offset);if(!n)return null;const r=n.getBoundingClientRect(),s=this.container.getBoundingClientRect();if(0===r.width&&0===r.height){const e=t.getBoundingClientRect();return{x:e.left-s.left,y:e.top-s.top,height:e.height||20}}return{x:r.left-s.left,y:r.top-s.top,height:r.height||20}}catch(e){console.warn("Failed to get position from point:",e);try{const e=t.getBoundingClientRect(),n=this.container.getBoundingClientRect();return{x:e.left-n.left,y:e.top-n.top,height:e.height||20}}catch(e){return null}}}createRangeFromPoint(e,t){const n=document.createRange();if(e.nodeType===Node.TEXT_NODE){const r=e.textContent.length,s=Math.min(t,r);n.setStart(e,s),n.setEnd(e,s)}else{const r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let s=0,i=null,o=0;for(;r.nextNode();){const e=r.currentNode,n=e.textContent.length;if(s+n>=t){i=e,o=t-s;break}s+=n}if(i)n.setStart(i,o),n.setEnd(i,o);else try{n.selectNodeContents(e),n.collapse(0===t)}catch(t){n.setStartBefore(e),n.setEndBefore(e)}}return n}getSelectionRects(e,t){return this.editor.getEditorState().read(()=>{const n=dc(e.key),r=dc(t.key);if(!n||!r)return null;const s=this.editor.getElementByKey(e.key),i=this.editor.getElementByKey(t.key);if(!s||!i)return null;try{const n=document.createRange(),r=e.key===t.key?e.offset>t.offset:s.compareDocumentPosition(i)&Node.DOCUMENT_POSITION_PRECEDING,o=r?t:e,l=r?e:t,c=r?i:s,a=r?s:i,d=this.createRangeFromPoint(c,o.offset);if(!d)return null;n.setStart(d.startContainer,d.startOffset);const u=this.createRangeFromPoint(a,l.offset);if(!u)return null;n.setEnd(u.endContainer,u.endOffset);const h=Array.from(n.getClientRects()),f=this.container.getBoundingClientRect();return console.log(`Selection rects for client: ${h.length} rects found`),h.map(e=>({x:e.left-f.left,y:e.top-f.top,width:e.width,height:e.height}))}catch(e){return console.warn("Failed to get selection rects:",e),null}})}createCursorElement(e,t){const n=document.createElement("div");n.className="lexxy-cursor",n.dataset.cursorId=e;const r=document.createElement("div");r.className="lexxy-cursor-caret",r.style.backgroundColor=t.color;const s=document.createElement("div");return s.className="lexxy-cursor-label",s.textContent=t.name,s.style.cssText=`\n      position: absolute;\n      bottom: 100%;\n      left: 0;\n      background-color: ${t.color};\n      color: white;\n      padding: 2px 6px;\n      border-radius: 3px;\n      font-size: 11px;\n      font-family: system-ui, -apple-system, sans-serif;\n      white-space: nowrap;\n      margin-bottom: 2px;\n      pointer-events: none;\n      user-select: none;\n    `,n.appendChild(r),n.appendChild(s),n}createSelectionContainer(e,t){const n=document.createElement("div");return n.className="lexxy-selection",n.dataset.selectionId=e,n.style.cssText="position: absolute; pointer-events: none; z-index: 999;",n}removeCursor(e){const t=this.overlayContainer.querySelector(`[data-cursor-id="${e}"]`);t&&t.remove(),this.cursors.delete(e)}removeSelection(e){const t=this.overlayContainer.querySelector(`[data-selection-id="${e}"]`);t&&t.remove(),this.selections.delete(e)}isPositionVisible(e){const t=this.scrollableElement.scrollTop,n=t+this.scrollableElement.clientHeight;return e.y>=t-50&&e.y<=n+50}findScrollableParent(e){let t=e.parentElement;for(;t;){const e=window.getComputedStyle(t).overflow;if("auto"===e||"scroll"===e)return t;t=t.parentElement}return document.documentElement}renderAllCursors(){try{const e=this.awareness.getStates();console.log("All awareness states:",e),e.forEach((e,t)=>{if(t!==this.localClientId&&e?.cursor){console.log(`Rendering cursor for client ${t}, state:`,e);try{this.updateCursorFromState(t,e)}catch(e){console.warn("Failed to render cursor for client",t,e)}}}),this.queueUpdate("initial")}catch(e){console.error("Error in renderAllCursors:",e)}}getColorForClient(e){const t=["#FF6B6B","#FF006E","#C1121F","#FF4365","#E63946","#DC2F02","#D00000","#9D0208","#FF0A54","#FF5C8A","#F77F00","#FCBF49","#FFB700","#FFA400","#FF9500","#F4A261","#E76F51","#FF8C42","#FFD60A","#FFB627","#06FFA5","#00F5FF","#55A630","#2D6A4F","#52B788","#40916C","#1B5E20","#2E7D32","#43A047","#66BB6A","#4ECDC4","#96CEB4","#88D498","#36C9C6","#06FFB4","#0077B6","#0096C7","#00B4D8","#48CAE4","#90E0EF","#023E8A","#0466C8","#5390D9","#4361EE","#4895EF","#4CC9F0","#45B7D1","#2196F3","#1976D2","#0D47A1","#7209B7","#B5179E","#F72585","#7B2CBF","#6A4C93","#6C5CE7","#A8E6CF","#DDA0DD","#9C27B0","#8E24AA","#AB47BC","#CE93D8","#6A1B9A","#4A148C","#9D4EDD","#8D5524","#A0522D","#964B00","#6F4E37","#8B4513","#14213D","#006D77","#2C7DA0","#468FAF","#61A5C2","#007EA7","#003459","#00A8CC","#005F73","#0A9396","#540B0E","#702632","#A4133C","#800E13","#590D22","#370617","#6A040F","#9D0208","#D00000","#DC2F02"];let n=0;const r=String(e);for(let e=0;e<r.length;e++)n=(n<<5)-n+r.charCodeAt(e),n&=n;return t[Math.abs(n)%t.length]}destroy(){this.awareness.off("update",this.handleAwarenessUpdate),this.unsubscribeEditor&&this.unsubscribeEditor(),this.scrollableElement&&this.scrollableElement.removeEventListener("scroll",this.handleScroll),this.resizeObserver&&this.resizeObserver.disconnect(),this.mutationObserver&&this.mutationObserver.disconnect(),this.rafId&&cancelAnimationFrame(this.rafId),this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.overlayContainer&&this.overlayContainer.remove(),this.cursors.clear(),this.selections.clear(),this.lastSeenTimestamps.clear(),this.updateQueue.clear()}};var ay=class extends HTMLElement{connectedCallback(){this.editorElement=this.closest("lexxy-editor"),this.editor=this.editorElement.editor,this.editor&&this.editor.isReady&&this.editor.isReady()?(console.log("Editor already initialized, starting collaboration"),this.#e()):this.editor?(console.log("Editor exists, starting collaboration"),this.#e()):this.editorElement.addEventListener("lexxy:initialize",(...e)=>{console.log("Editor initialized event, starting collaboration",e),this.editor=this.editorElement.editor,this.#e()},{once:!0})}disconnectedCallback(){this.cursorManager&&this.cursorManager.destroy(),this.unsubscribeCursorSync&&this.unsubscribeCursorSync(),this.unsubscribeListeners&&this.unsubscribeListeners(),this.provider&&this.provider.disconnect()}async#e(){const e="Example User",t="#958DF1",n="main",r=new gu,s=new Gm(r),i=new Map;i.set(n,r);const o=new ly(r,j_,"SyncChannel",{id:"2"},{awareness:s,disableBc:!0}),l=Ym(this.editor,o,n,r,i),c=function(e,t,n){let r=!1;const s=e.registerUpdateListener(({dirtyElements:s,dirtyLeaves:i,editorState:o,normalizedNodes:l,prevEditorState:c,tags:a})=>{r?r=!1:e.getEditorState().read(()=>{!1===a.has("skip-collab")&&Vm(n,t,c,o,s,i,l,a)})}),i=(e,r)=>{r.origin!==n&&Jm(n,t,e,!1)};return n.root.getSharedType().observeDeep(i),()=>{s(),n.root.getSharedType().unobserveDeep(i)}}(this.editor,o,l);s.setLocalStateField("user",{name:e,color:t}),s.setLocalStateField("lastSeen",Date.now()),Hm(o,e,t,!0,{name:e,color:t}),s.setLocalStateField("user",{name:e,color:t}),s.setLocalStateField("lastSeen",Date.now());const a=this.editorElement.querySelector(".lexxy-editor-container")||this.editorElement;this.cursorManager=new cy(this.editor,o,a),this.unsubscribeCursorSync=function(e,t){const n=t.awareness;return e.registerUpdateListener(()=>{e.getEditorState().read(()=>{const e=gc();if(!e||!xc(e))return void n.setLocalStateField("cursor",null);const t=e.anchor,r=e.focus,s={anchorPos:{key:t.key,offset:t.offset,type:t.type},focusPos:{key:r.key,offset:r.offset,type:r.type}};n.setLocalStateField("cursor",s)})})}(this.editor,o),this.provider=o,this.binding=l,this.unsubscribeListeners=c}};customElements.define("lexxy-collaboration",ay);